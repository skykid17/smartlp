{% extends "base.html" %}

{% block content %}
<style>
    .mitre-matrix-container {
        display: flex;
        overflow-x: auto; /* Allow horizontal scrolling */
        padding-bottom: 15px; /* Space for scrollbar */
        border: 1px solid #ccc;
        background-color: #f8f9fa;
    }
    .tactic-column {
        min-width: 180px; /* Minimum width for each column */
        max-width: 220px; /* Maximum width */
        flex: 1 1 180px; /* Flex properties: grow, shrink, basis */
        border-left: 1px solid #ddd;
        padding: 0;
        display: flex;
        flex-direction: column; /* Stack header and techniques vertically */
    }
    .tactic-column:first-child {
        border-left: none;
    }
    .tactic-header {
        background-color: #e9ecef;
        padding: 8px 10px;
        font-weight: bold;
        text-align: center;
        border-bottom: 1px solid #ccc;
        position: sticky; /* Make header sticky */
        top: 0; /* Stick to the top */
        z-index: 10; /* Ensure it's above technique cells */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .techniques-list {
        padding: 5px;
        flex-grow: 1; /* Allow list to take remaining space */
        overflow-y: auto; /* Allow vertical scroll within column if needed */
    }
    .technique-cell {
        background-color: #fff;
        border: 1px solid #eee;
        border-radius: 3px;
        padding: 4px 6px;
        margin-bottom: 4px;
        font-size: 0.85rem; /* Smaller font */
        line-height: 1.3;
        overflow: hidden; /* Prevent long names from breaking layout */
        white-space: normal; /* Allow wrapping */
        word-wrap: break-word;
    }
    .technique-cell a {
        color: #0056b3;
        text-decoration: none;
        display: block; /* Make the whole cell clickable */
    }
     .technique-cell a:hover {
        text-decoration: underline;
    }
    .subtechnique {
        margin-left: 10px; /* Indent sub-techniques */
        border-left: 3px solid #007bff; /* Add a visual indicator */
        padding-left: 8px; /* Adjust padding */
    }
</style>

<div class="container-fluid mt-3"> {# Use container-fluid for full width #}
    <h1>MITRE ATT&CK Matrix (Enterprise)</h1>
    <p>Techniques present in the local database.</p>
     <a href="{{ url_for('smartuc') }}" class="btn btn-secondary mb-3">Back to Sigma Rules</a>

    <div class="mitre-matrix-container">
        {% for tactic_phase in tactic_order %}
            <div class="tactic-column">
                <div class="tactic-header" title="{{ tactic_names.get(tactic_phase, tactic_phase) }}">
                    {{ tactic_names.get(tactic_phase, tactic_phase) }}
                </div>
                <div class="techniques-list">
                    {% set techniques = techniques_by_tactic.get(tactic_phase, []) %}
                    {% if techniques %}
                        {% for tech in techniques %}
                            <div class="technique-cell {% if tech.is_subtechnique %}subtechnique{% endif %}"
                            title="{{ tech.name }} ({{ tech.mitre_id }})&#10;{{ tech.description | default('', true) | truncate(150, true) }}"> {# Tooltip with description #}
                           {# --- Display text directly without the <a> tag --- #}
                           {{ tech.name }}
                           <small>({{ tech.mitre_id }})</small> {# Smaller ID #}
                       </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-2 text-muted small">No techniques</div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}