{% extends "base.html" %}

{% block content %}

<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Smart Use Case</h2>
        <small class="text-muted">Browse and explore security detection rules with advanced filtering</small>
    </div>
    <div class="d-flex align-items-center gap-3">
        <!-- Status indicators removed -->
    </div>
</div>

<!-- Search and Filter Panel -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h6 class="card-title mb-0">
            <i class="fa fa-search me-2"></i>Search & Filter Rules
        </h6>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('smartuc') }}" class="smartuc-search-form row g-3 align-items-end">
            <!-- Hidden Page Reset -->
            <input type="hidden" name="page" value="1">

            <!-- Search Term -->
            <div class="col-lg-6 col-md-6">
                <label for="search" class="form-label">Search Term</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa fa-search"></i></span>
                    <input type="text" class="form-control" id="search" name="search" value="{{ search_query or '' }}"
                        placeholder="Search in titles and descriptions...">
                </div>
            </div>

            <!-- Main Type -->
            <div class="col-lg-3 col-md-6">
                <label for="main_type" class="form-label">Main Category</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa fa-folder-o"></i></span>
                    <select class="form-select" id="main_type" name="main_type">
                        <option value="all" {% if selected_main_type=='all' %}selected{% endif %}>All Categories
                        </option>
                        {% for type in main_types %}
                        <option value="{{ type }}" {% if type==selected_main_type %}selected{% endif %}>{{ type }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Sub Type -->
            <div class="col-lg-3 col-md-6">
                <label for="sub_type" class="form-label">Sub Category</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa fa-tags"></i></span>
                    <select class="form-select" id="sub_type" name="sub_type">
                        <option value="all" {% if selected_sub_type=='all' %}selected{% endif %}>All Sub Categories
                        </option>
                        {% for type in sub_types %}
                        <option value="{{ type }}" {% if type==selected_sub_type %}selected{% endif %}>{{ type }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-3 d-flex flex-wrap gap-2 justify-content-between">
                <div class="smartuc-action-buttons d-flex gap-2">
                    <button type="submit" class="btn btn-primary" title="Apply filters and search">
                        <i class="fa fa-filter me-1"></i>Apply Filters
                    </button>
                    <a href="{{ url_for('smartuc') }}" class="btn btn-secondary" title="Clear all filters">
                        <i class="fa fa-eraser me-1"></i>Reset
                    </a>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary selectEnable" id="clearSelection"
                        title="Clear selected rules" onclick="smartucSelection.clearSelection()">
                        <i class="fa fa-times me-1"></i>Clear Selection
                    </button>
                    <button type="button" class="btn btn-outline-secondary selectEnable" id="openConfigPanel"
                        title="Open Configuration Panel" onclick="handleCreateConfig()">
                        <i class="fa fa-cog me-1"></i>Open Config Panel
                    </button>
                </div>
            </div>
        </form>

    </div>
</div>
<!-- Pagination Section -->
{% if total_pages > 1 %}
<div class="card shadow-sm mb-4">
    <div class="card-body py-3">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-center gap-3">
            <!-- Pagination Navigation -->
            <nav aria-label="Page navigation" class="order-2 order-lg-1">
                <ul class="pagination mb-0 pagination-sm">
                    <!-- Previous Page -->
                    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('smartuc',
                                                              page=page-1,
                                                              per_page=per_page,
                                                              search=search_query if search_query else None,
                                                              main_type=selected_main_type,
                                                              sub_type=selected_sub_type) }}" title="Previous page">
                            <i class="fa fa-chevron-left me-1"></i>Previous
                        </a>
                    </li>

                    <!-- Page Numbers -->
                    {% for p in page_links %}
                    {% if p %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('smartuc',
                                                                      page=p,
                                                                      per_page=per_page,
                                                                      search=search_query if search_query else None,
                                                                      main_type=selected_main_type,
                                                                      sub_type=selected_sub_type) }}">{{ p }}</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    {% endfor %}

                    <!-- Next Page -->
                    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('smartuc',
                                                              page=page+1,
                                                              per_page=per_page,
                                                              search=search_query if search_query else None,
                                                              main_type=selected_main_type,
                                                              sub_type=selected_sub_type) }}" title="Next page">
                            Next<i class="fa fa-chevron-right ms-1"></i>
                        </a>
                    </li>
                </ul>
            </nav> <!-- Page Info and Jump -->
            <div class="pagination-controls order-1 order-lg-2 pe-3">
                <small class="text-muted">
                    {% if rules %}
                    Page {{ page }} of {{ total_pages }} ({{ ((page-1) * per_page + 1) }}-{{ [page * per_page,
                    rules|length + (page-1) * per_page]|min }} of {{ total_rules }} rules)
                    {% else %}
                    No rules found
                    {% endif %}
                </small>

                <!-- Rows per page selector -->
                <div class="rows-per-page-control">
                    <label for="rowsPerPage" class="form-label small mb-0 text-nowrap">Rows:</label>
                    <select id="rowsPerPage" class="form-select form-select-sm" onchange="changeRowsPerPage()"
                        title="Rows per page">
                        <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
                        <option value="15" {% if per_page==15 %}selected{% endif %}>15</option>
                        <option value="20" {% if per_page==20 %}selected{% endif %}>20</option>
                        <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                        <option value="custom" {% if per_page not in [10, 15, 20, 50] %}selected{% endif %}>Custom
                        </option>
                    </select>
                    <input type="number" id="customRowsInput" class="form-control form-control-sm" {% if per_page in
                        [10, 15, 20, 50] %}style="display: none;" {% endif %} min="1" max="200" placeholder="Custom"
                        title="Custom rows per page"
                        value="{% if per_page not in [10, 15, 20, 50] %}{{ per_page }}{% endif %}"
                        onchange="applyCustomRows()" />
                </div>

                <form id="goToPageForm" class="d-flex align-items-center gap-2" data-total-pages="{{ total_pages }}"
                    data-base-url="{{ url_for('smartuc') }}" data-per-page="{{ per_page }}"
                    data-search="{{ search_query if search_query else '' }}" data-main-type="{{ selected_main_type }}"
                    data-sub-type="{{ selected_sub_type }}">
                    <label for="goToPageInput" class="form-label small mb-0 text-nowrap">Go to:</label>
                    <input type="number" id="goToPageInput" class="form-control form-control-sm" style="width: 80px;"
                        placeholder="Page" min="1" max="{{ total_pages }}" title="Enter page number">
                    <button class="btn btn-primary-outline btn-sm" type="submit" title="Go to page">
                        <i class="fa fa-arrow-right"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
<!-- Results Table -->
<div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">
            <i class="fa fa-list me-2"></i>Detection Rules
            {% if rules %}
            <span class="badge bg-primary ms-2">{{ rules|length }} rules</span>
            {% endif %}
        </h6>
        {% if rules %}
        <small class="text-muted">
            Showing {{ ((page-1) * per_page + 1) }}-{{ [page * per_page, rules|length + (page-1) * per_page]|min }} of
            {{ total_rules }}
        </small>
        {% endif %} <div>
            <div id="smartucLogger" class="badge bg-info fs-6"></div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if rules %}
        <div class="table-responsive">
            <table class="table table-hover mb-0 rules-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 25%;">
                            <i class="fa fa-file-text-o me-1"></i>Title
                        </th>
                        <th style="width: 30%;">
                            <i class="fa fa-info-circle me-1"></i>Description
                        </th>
                        <th style="width: 15%;">
                            <i class="fa fa-tag me-1"></i>Type
                        </th>
                        <th style="width: 10%;">
                            <i class="fa fa-exclamation-triangle me-1"></i>Level
                        </th>
                        <th style="width: 10%;" class="text-center">
                            <i class="fa fa-eye me-1"></i>Actions
                        </th>
                        <th style="width: 10%;" class="text-center">
                            <i class="fa fa-check-square-o me-1"></i>Select
                        </th>
                    </tr>
                </thead>
                <tbody id="entryTableBody">
                    {% for rule in rules %}
                    <tr class="rule-row" data-rule-id="{{ rule.id }}">
                        <td class="title-cell fw-semibold">
                            {{ rule.title }}
                        </td>
                        <td class="description-cell text-muted">
                            {{ rule.description }}
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ rule.get('rule_type', 'N/A') }}</span>
                        </td>
                        <td>
                            {% set level_class = 'warning' if rule.level == 'medium' else 'danger' if rule.level ==
                            'high' else 'info' if rule.level == 'low' else 'secondary' %}
                            <span class="badge bg-{{ level_class }}">{{ rule.level|title }}</span>
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-1">
                                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#yamlModal" data-rule-id="{{ rule.id }}" title="View YAML Rule">
                                    <i class="fa fa-code me-1"></i>YAML
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#siemRuleModal" data-rule-id="{{ rule.id }}"
                                    title="View {{ activeSiem|title }} Rule">
                                    <i class="fa fa-shield me-1"></i>{{ activeSiem|title }}
                                </button>
                            </div>

                        </td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input" id="ruleSelect{{ rule.id }}"
                                name="ruleSelect" value="{{ rule.id }}">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <div class="mb-3">
                <i class="fa fa-search text-muted" style="font-size: 3rem;"></i>
            </div>
            <h5 class="text-muted">No Rules Found</h5>
            <p class="text-muted mb-4">No detection rules match your current search criteria.</p> <a
                href="{{ url_for('smartuc') }}" class="btn btn-secondary">
                <i class="fa fa-refresh me-1"></i>Reset Filters
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Config Panel Popup (SmartUC) -->
<div id="popupBox" class="popup-box collapsed">
    <div class="popup-header" onclick="smartucConfigPanel.togglePanel()">
        <button class="arrow-btn"><i class="fa fa-chevron-up"></i></button>
        <span class="flex-grow-1 text-center">Configuration Panel</span>
    </div>
    <div class="popup-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">SmartUC Config</h5>
            <small class="text-muted" id="configSelectionCounter">
                <i class="fa fa-list me-1"></i>
                <span id="configSelectionCount">0</span> rules
            </small>
        </div>
        <div class="table-responsive mb-3">
            <table class="table table-bordered table-sm mb-0">
                <thead class="table-light">
                    <!-- Dynamic headers will be rendered by JavaScript -->
                </thead>
                <tbody id="configTableBody">
                    <tr>
                        <td colspan="6" class="text-center text-muted">No entries selected</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="smartucConfigLogger"></div>
        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-secondary" onclick="smartucConfigPanel.togglePanel()">
                <i class="fa fa-times me-1"></i>Close
            </button>
            <button class="btn btn-success" id="createConfig">
                <i class="fa fa-upload me-1"></i>Create Config
            </button>
        </div>

    </div>
</div>

<!-- YAML Rule Modal -->
<div class="modal fade" id="yamlModal" tabindex="-1" aria-labelledby="yamlModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="yamlModalLabel">
                    <i class="fa fa-code me-2"></i>YAML Rule Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="position-relative">
                    <pre class="bg-light border-0 rounded-0 p-4 m-0 text-wrap position-relative"
                        style="max-height: 70vh; overflow-y: auto; font-size: 0.875rem; line-height: 1.4; width: 97%;">
                        <code id="yamlContent" class="text-dark">Loading rule details...</code>
                    </pre>
                    <button class="copy-btn btn btn-secondary btn-sm position-absolute"
                        style="top: 0.5rem; right: 0.1rem; z-index: 10;" title="Copy to clipboard">
                        <i class="fa fa-copy me-1"></i>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100 align-items-center">
                    <small class="text-muted">
                        <i class="fa fa-info-circle me-1"></i>YAML format detection rule
                    </small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SIEM Rule Modal -->
<div class="modal fade" id="siemRuleModal" tabindex="-1" aria-labelledby="siemRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="siemRuleModalLabel">
                    <i class="fa fa-shield me-2"></i>{{ activeSiem|title }} Rule
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="position-relative">
                    <pre class="bg-light border-0 rounded-0 p-4 m-0 text-wrap position-relative"
                        style="max-height: 70vh; overflow-y: auto; font-size: 0.875rem; line-height: 1.4; width: 97%;">
                        <code id="siemRuleContent" class="text-dark">Loading {{ activeSiem }} rule...</code>
                    </pre>
                    <button class="copy-btn btn btn-secondary btn-sm position-absolute"
                        style="top: 0.5rem; right: 0.1rem; z-index: 10;" title="Copy to clipboard">
                        <i class="fa fa-copy me-1"></i>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100 align-items-center">
                    <small class="text-muted">
                        <i class="fa fa-shield me-1"></i>{{ activeSiem|title }} format detection rule
                    </small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Config Modal -->
<div id="configModal" class="modal fade" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configModalLabel">Generated Config</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="codeblock-with-lines">
                    <pre class="bg-light border rounded mb-0 p-3" style="position:relative; overflow:auto;">
<code contenteditable="true" spellcheck="false" id="configPreview" class="config-preview" style="white-space:pre; display:block;">Placeholder config will appear here...</code>
                </pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-success" onclick="deploy()">Deploy</button>
                <button class="btn btn-success" id="hfBtn" onclick="deployHF()" style="display: none;">Deploy to
                    HF</button>
                <!-- Add deployment feedback area -->
                <div id="deploymentFeedback" class="w-100 mt-2" style="display: none;">
                    <div class="alert mb-0" role="alert" id="deploymentMessage"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="modal fade" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true"
    data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <label class="modal-title" id="errorModalLabel"><i class="fa fa-exclamation-triangle"
                        style="color: #ffa70f;"></i> Error</label>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{# --- JavaScript for Modal and Page Jump --- #}
<script src="/js/smartuc/smartuc.js"></script>
{% endblock %}