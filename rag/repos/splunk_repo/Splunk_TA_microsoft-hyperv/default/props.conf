##
## SPDX-FileCopyrightText: 2021 Splunk, Inc. <sales@splunk.com>
## SPDX-License-Identifier: LicenseRef-Splunk-1-2020
##
##

[microsoft:hyperv:vm]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

#Field Aliases
FIELDALIAS-HyperVvm = hypervisor AS dest , os AS product , osbuildnumber as product_version
FIELDALIAS-hypervisor_as_hypervisor_name = hypervisor AS hypervisor_name
FIELDALIAS-cpu_count-as-cpu_cores = cpu_count AS cpu_cores
FIELDALIAS-os-as-vm_os = os AS vm_os
FIELDALIAS-os_version-as-vm_os_version = os_version AS vm_os_version

#Evals
EVAL-mem_capacity = mem*1024*1024
EVAL-vendor_product = vendor + " " + os
EVAL-vm_os_version = os + " " + os_version

[microsoft:hyperv:vm:ext]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

#Field Aliases
FIELDALIAS-vm_vmid-as-vm_id = vm_vmid AS vm_id

#Evals
EVAL-power_state = if(vm_state="Off","poweredOff", if(vm_state="Running","poweredOn",vm_state))
EVAL-vendor = "Microsoft"
EVAL-product = "Hyper-V"
EVAL-vendor_product = "Microsoft Hyper-V"
EVAL-logical_cpu_count = vm_numasocketcount*vm_processorcount
EVAL-mem = vm_memoryassigned/1024/1024
EVAL-size = vm_sizeofsystemfiles/1024/1024

[microsoft:hyperv:host]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

#Field Aliases
FIELDALIAS-domain-as-datacenter = domain AS datacenter
FIELDALIAS-HyperVhost = hypervisor AS dest , description AS hyp_desc
FIELDALIAS-hypervisor-as-hypervisor_name = hypervisor AS hypervisor_name
FIELDALIAS-os-as-hypervisor_os = os AS hypervisor_os
FIELDALIAS-version-as-hypervisor_os_version = version AS hypervisor_os_version
FIELDALIAS-cpu_model-as-processor = cpu_model AS processor
FIELDALIAS-cpu_cores-as-logical_cpu_count = cpu_cores AS logical_cpu_count
FIELDALIAS-cpu_count-as-processor_socket_count = cpu_count AS processor_socket_count

#Evals
EVAL-vendor_product = vendor + " " + product
EVAL-mem_capacity = mem*1024*1024

[microsoft:hyperv:host:ext]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

FIELDALIAS-hyp_name-as-hypervisor = hyp_name AS hypervisor

[microsoft:hyperv:vm:disk]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

#Field Aliases
FIELDALIAS-name-as-datastore = name AS datastore
FIELDALIAS-name-as-datastore_name = name AS datastore_name
FIELDALIAS-path-as-datastore_volume_path = path AS datastore_volume_path
FIELDALIAS-path-as-root_url = path AS root_url
FIELDALIAS-size-as-storage_capacity = size AS storage_capacity
FIELDALIAS-id-as-datastore-id = diskidentifier AS datastore_id
FIELDALIAS-vhdtype-as-root_volume_type = vhdtype AS root_volume_type
FIELDALIAS-firmwareversion-as-datastore_version = firmwareversion AS datastore_version
FIELDALIAS-serial_number-as-serial = serial_number AS serial
FIELDALIAS-lun_id-as-root_path = lun_id AS root_path
FIELDALIAS-storage_usage-as-datastore_currentsize = storage_used AS datastore_currentsize
FIELDALIAS-path-as-mount = path AS mount
FIELDALIAS-vmsnapshotname-as-snapshot = vmsnapshotname AS snapshot
EVAL-storage = size/1024/1024

#Evals
EVAL-vendor  = if(len(manufacturer) > 0,manufacturer,"Microsoft")
EVAL-product = if(len(model) > 0,model,"Virtual Disk")
EVAL-vendor_product = if(len(manufacturer) > 0,manufacturer,"Microsoft") + " " + if(len(model) > 0,model,"Virtual Disk")

[microsoft:hyperv:vm:network]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

EVAL-vendor = "Microsoft"
EVAL-product = "Hyper-V"
EVAL-vendor_product = "Microsoft Hyper-V"

FIELDALIAS-id-as-nic_id = id AS nic_id
FIELDALIAS-computername-as-dest = computername AS dest
EVAL-mac = lower(substr(macaddress, 1,2) + ":" + substr(macaddress, 3,2) + ":" + substr(macaddress, 5,2) + ":" + substr(macaddress,7,2) + ":"+ substr(macaddress, 9,2) + ":" + substr(macaddress, 11,2))

[microsoft:hyperv:host:switch]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

EVAL-vendor = "Microsoft"
EVAL-product = "Hyper-V"
EVAL-vendor_product = "Microsoft Hyper-V"

[microsoft:hyperv:perf:host]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

EVAL-vendor = "Microsoft"
EVAL-product = "Hyper-V"
EVAL-vendor_product = "Microsoft Hyper-V"

[microsoft:hyperv:perf:vm]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

FIELDALIAS-network_total_bandwidth-as-network_usage = network_total_bandwidth AS network_usage
FIELDALIAS-network_bytes_received-as-network_bytes_in = network_bytes_received AS network_usage_in
FIELDALIAS-network_bytes_sent-as-network_bytes_out = network_bytes_sent AS network_usage_out
FIELDALIAS-memory_assigned-as-mem = memory_assigned AS mem
FIELDALIAS-total_disk-as-storage = total_disk AS storage

EVAL-mem_usage_percent = (average_ram/maximum_ram) * 100
EVAL-storage_used_percent = round(storage_used,2)
EVAL-vendor = "Microsoft"
EVAL-product = "Hyper-V"
EVAL-vendor_product = "Microsoft Hyper-V"

[microsoft:hyperv:perf:datastore]
LINE_BREAKER = ((?:\r?\n){2,})
SHOULD_LINEMERGE = false
DATETIME_CONFIG = CURRENT
TZ = UTC

FIELDALIAS-datastore_writeops-as-write_ops = datastore_writeops AS write_ops
FIELDALIAS-datastore_readops-as-write_ops = datastore_readops AS read_ops
EVAL-write_latency = datastore_write_latency * 1000
EVAL-storage_used = datastore_currentsize/1024/1024
EVAL-read_latency = datastore_read_latency * 1000
EVAL-storage_used_percent = (datastore_currentsize/datastore_max_store) * 100
EVAL-storage_free_percent = ((datastore_max_store - datastore_currentsize)/datastore_max_store) * 100
EVAL-storage_free = (datastore_max_store - datastore_currentsize)/1000000
EVAL-datastore_used_percent = (datastore_currentsize/datastore_max_store) * 100
EVAL-storage_free_space = datastore_max_store - datastore_currentsize
EVAL-vendor = "Microsoft"
EVAL-product = "Hyper-V"
EVAL-vendor_product = "Microsoft Hyper-V"

[source::WinEventLog:Microsoft-Windows-Hyper-V-*]
FIELDALIAS-ComputerName-as-dvc = ComputerName AS dvc
FIELDALIAS-ComputerName-as-src = ComputerName AS src
FIELDALIAS-ComputerName-as-src_name = ComputerName AS src_name
FIELDALIAS-User-as-user = User AS user
EVAL-vendor_product = "Microsoft Hyper-V"

[source::WinEventLog:Microsoft-Windows-Hyper-V-Compute-Admin]
EVAL-action = case(EventCode == 1001, "started", EventCode == 1003, "stopped", true(), action)
EVAL-status = if(EventCode IN (1001, 1003), "success", status)
EVAL-change_type = if(EventCode IN  (1001, 1003), "restart", change_type)
EVAL-command = if(EventCode IN (1001, 1003), "Hyper-V", command)
EVAL-object_id = if(EventCode IN (1001, 1003), "Host Compute Service", object_id)
EVAL-object = if(EventCode IN (1001, 1003), "Host Compute Service", object)
EVAL-object_category = if(EventCode IN (1001, 1003), "service", object_category)
EVAL-object_attrs = if(EventCode IN (1001, 1003), "management service", object_attrs)
EVAL-dest = if(EventCode IN (1001, 1003), ComputerName, dest)
EVAL-dest_name = if(EventCode IN (1001, 1003), ComputerName, dest_name)

[source::WinEventLog:Microsoft-Windows-Hyper-V-Hypervisor-Operational]
EVAL-action = case(EventCode == 16641, "created", EventCode == 16642, "deleted", true(), action)
EVAL-status = if(EventCode IN (16641, 16642), "success", status)
EVAL-object = if(EventCode IN (16641, 16642), replace(Message, ".*\(([^)]*).*", "\1"), object)
EVAL-object_id = if(EventCode IN (16641, 16642), replace(Message, ".*\(partition ([^)]*).*", "\1"), object_id)
EVAL-object_attrs = if(EventCode IN (16641, 16642), "partition", object_attrs)
EVAL-object_category = if(EventCode IN (16641, 16642), "partition", object_category)
EVAL-change_type = if(EventCode IN (16641, 16642), "Virtual Machine", change_type)
EVAL-command = if(EventCode IN (16641, 16642), "Hyper-V", command)
EVAL-dest = if(EventCode IN (16641, 16642), ComputerName, dest)
EVAL-dest_name = if(EventCode IN (16641, 16642), ComputerName, dest_name)

[source::WinEventLog:Microsoft-Windows-Hyper-V-SynthNic-Admin]
EVAL-action = case(EventCode == 12582, "started", EventCode IN (12597,12598), "modified", true(), action)
EVAL-status = if(EventCode IN (12582, 12597, 12598), "success", status)
EVAL-object = if(EventCode IN (12582, 12597, 12598), replace(Message, ".*\(([^)]*)\)\s.*", "\1"), object)
EVAL-object_id = if(EventCode IN (12582, 12597, 12598), replace(Message, ".*\(([^)]*)\)\s.*", "\1"), object_id)
EVAL-object_attrs = if(EventCode IN (12582, 12597, 12598), "Network Adapter", object_attrs)
EVAL-object_category = if(EventCode IN (12582, 12597, 12598), "Network Adapter", object_category)
EVAL-change_type = if(EventCode IN (12582, 12597, 12598), "restart", change_type)
EVAL-command = if(EventCode IN (12582, 12597, 12598), "Hyper-V", command)
EVAL-dest = if(EventCode IN (12582, 12597, 12598), replace(Message, "'([^']*).*", "\1"), dest)
EVAL-dest_name = if(EventCode IN (12582, 12597, 12598), replace(Message, "'([^']*).*", "\1"), dest_name)

[source::WinEventLog:Microsoft-Windows-Hyper-V-VmSwitch-Operational]
EVAL-action = case(EventCode == 69, "deleted", EventCode == 67, "created", EventCode == 64, "modified", true(), action)
EVAL-status = if(EventCode IN (69, 67, 64), "success", status)
EVAL-object = if(EventCode IN (69, 67, 64), replace(Message, "\w* ([^\s]*) \(Friendly Name:.*", "\1"), object)
EVAL-object_id = if(EventCode IN (69, 67, 64), replace(Message, "\w* ([^\s]*) \(Friendly Name:.*", "\1"), object_id)
EVAL-object_attrs = if(EventCode IN (69, 67, 64), "VM Switch", object_attrs)
EVAL-object_category = case(EventCode IN (69, 67), "Switch Port", EventCode == 64, "VM Switch", true(), object_category)
EVAL-change_type = if(EventCode IN (69,67, 64), "Virtual Machine", change_type)
EVAL-command = if(EventCode IN (69, 67, 64), "Hyper-V", command)
EVAL-dest = if(EventCode IN (69, 67, 64), ComputerName, dest)
EVAL-dest_name = if(EventCode IN (69, 67, 64), ComputerName, dest_name)
EVAL-severity_id =  if(EventCode == 220, EventType, severity_id)
EVAL-signature =  if(EventCode == 220, Message, signature)
EVAL-description =  if(EventCode == 220, Message, description)
EVAL-itsiInclude = if(EventCode == 220, "true", itsiInclude)
EVAL-subcomponent = if(EventCode == 220, "Network Adapter", subcomponent)
EVAL-app = if(EventCode == 220, "Hyper-V", app)
EVAL-vendor_severity = if(EventCode == 220, Type, vendor_severity)

[source::WinEventLog:Microsoft-Windows-Hyper-V-VMMS-Admin]
EVAL-action = case(EventCode == 13002, "created", EventCode == 14100, "stopped", EventCode == 13003, "deleted", true(), action)
EVAL-status = if(EventCode IN (13002, 14100, 13003), "success", status)
EVAL-object = case(EventCode IN (13002, 13003), replace(Message, ".*\(Virtual machine ID ([^)]*).*", "\1"), EventCode == 14100, ComputerName, true(), object)
EVAL-object_id = case(EventCode IN (13002, 13003), replace(Message, ".*\(Virtual machine ID ([^)]*).*", "\1"), EventCode == 14100, ComputerName, true(), object_id)
EVAL-object_attrs = case(EventCode IN (13002, 13003), "Virtual Machine", EventCode == 14100, "Hyper-V server", true(), object_attrs)
EVAL-object_category = case(EventCode IN (13002, 13003), "Virtual Machine", EventCode == 14100, "host", true(), object_category)
EVAL-change_type = case(EventCode IN (13002, 13003), "Virtual Machine", EventCode == 14100, "restart", true(), change_type)
EVAL-command = if(EventCode IN (13002, 14100, 13003), "Hyper-V", command)
EVAL-dest = case(EventCode IN (13002, 13003), replace(Message, ".*'([^']*)'.*\Virtual machine.*", "\1"), EventCode == 14100, ComputerName, true(), dest)
EVAL-dest_name = case(EventCode IN (13002, 13003), replace(Message, ".*'([^']*)'.*\Virtual machine.*", "\1"), EventCode == 14100, ComputerName, true(), dest_name)

[source::WinEventLog:Microsoft-Windows-Hyper-V-VMMS-Networking]
EVAL-action = if(EventCode == 26000, "created", action)
EVAL-status = if(EventCode == 26000, "success", status)
EVAL-object = if(EventCode == 26000, replace(Message, "^.*name='([^']*)',.*", "\1"), object)
EVAL-object_id = if(EventCode == 26000, replace(Message, "^.*name='([^']*)',.*", "\1"), object_id)
EVAL-object_attrs = if(EventCode == 26000, "VM Switch", object_attrs)
EVAL-object_category = if(EventCode == 26000, "VM Switch", object_category)
EVAL-change_type = if(EventCode == 26000, "Virtual Machine", change_type)
EVAL-command = if(EventCode == 26000, "Hyper-V", command)
EVAL-dest = if(EventCode == 26000, ComputerName, dest)
EVAL-dest_name = if(EventCode == 26000, ComputerName, dest_name)

[source::WinEventLog:Microsoft-Windows-Hyper-V-VMMS-Operational]
EVAL-action = case(EventCode == 27311, "created", EventCode == 27312, "modified", true(), action)
EVAL-status = if(EventCode IN (27311, 27312), "success", status)
EVAL-object = if(EventCode IN (27311, 27312), replace(Message, ".*\\\([^']*).*", "\1"), object)
EVAL-object_id = if(EventCode IN (27311, 27312), replace(Message, ".*\\\([^']*).*", "\1"), object_id)
EVAL-object_path = if(EventCode IN (27311, 27312), replace(Message, "[\w ]*'([^']*)\\\.*", "\1"), object_path)
EVAL-object_attrs = if(EventCode IN (27311, 27312), "Virtual Hard Disk", object_attrs)
EVAL-object_category = if(EventCode IN (27311, 27312), "Virtual Hard Disk", object_category)
EVAL-change_type = if(EventCode IN (27311, 27312), "filesystem", change_type)
EVAL-command = if(EventCode IN (27311, 27312), "Hyper-V", command)
EVAL-dest = if(EventCode IN (27311, 27312), ComputerName, dest)
EVAL-dest_name = if(EventCode IN (27311, 27312), ComputerName, dest_name)

[source::WinEventLog:Microsoft-Windows-Hyper-V-Worker-Admin]
EVAL-action = case(EventCode IN (18500, 12582), "started", EventCode IN (18516, 18502), "stopped", EventCode == 18518, "restarted", EventCode IN (18512,12598), "modified", EventCode == 18518, "restarted", true(), action)
EVAL-status = if(EventCode IN (18500, 18502, 18516, 18518, 18512, 12598, 12582), "success", status)
EVAL-object = case(EventCode IN (18500, 18502, 18516, 18518, 18512), replace(Message, "'([^']*).*\(Virtual machine ID ([^)]*).*", "\1"), EventCode IN (12598, 12582), replace(Message, ".*\(([^)]*)\).*", "\1"), true(), object)
EVAL-object_id = case(EventCode IN (18500, 18502, 18516, 18518, 18512), replace(Message, "'([^']*).*\(Virtual machine ID ([^)]*).*", "\2"), EventCode IN (12598, 12582), replace(Message, ".*\(([^)]*)\).*", "\1"), true(), object_id)
EVAL-object_attrs = case(EventCode IN (18500, 18502, 18516, 18518, 18512), "Virtual Machine", EventCode IN (12582, 12598), "Network Adapter", true(), object_attrs)
EVAL-object_category = case(EventCode IN (18500, 18502, 18516, 18518, 18512), "host", EventCode IN (12582, 12598), "Network Adapter", true(), object_category)
EVAL-change_type = if(EventCode IN (18500, 18502, 18516, 18518, 18512, 12598, 12582 ), "restart", change_type)
EVAL-command = if(EventCode IN (18500, 18502, 18516, 18518, 18512, 12598, 12582), "Hyper-V", command)
EVAL-dest = if(EventCode IN (18500, 18502, 18516, 18518, 18512, 12598, 12582), replace(Message, "'([^']*).*", "\1"), dest)
EVAL-dest_name = if(EventCode IN (18500, 18502, 18516, 18518, 18512, 12598, 12582), replace(Message, "'([^']*).*", "\1"), dest_name)