##
## SPDX-FileCopyrightText: 2024 Splunk, Inc.
## SPDX-License-Identifier: LicenseRef-Splunk-8-2021
##
##

[source::.../var/log/splunk/splunk_ta_cyberark_epm_*.log*]
SHOULD_LINEMERGE = false
LINE_BREAKER=([\r\n]+)\d{4}-\d{2}-\d{2}

###### APPLICATION EVENTS ######

[cyberark:epm:application:events]
SHOULD_LINEMERGE = false
KV_MODE = JSON
TIME_PREFIX = \"LastEventDate\"\s*:\s*
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%f

FIELDALIAS-dest = LastEventComputer AS dest
FIELDALIAS-process_exec = EventName AS process_exec
FIELDALIAS-process_name = EventName AS process_name
FIELDALIAS-process_hash = Hash AS process_hash
FIELDALIAS-process_path = LastEventSourceName AS process_path
FIELDALIAS-user = LastEventUserName AS user

EVAL-action = case(EventType == "Block", "blocked", true(), "allowed")
EVAL-process = LastEventSourceName."\\".process_exec
EVAL-original_file_name = replace(EventName,"[^\(]*\((.*)\)","\1")
EVAL-severity = case(EventType == "Trust" OR EventType == "ManualRequest" OR EventType == "Access" OR EventType == "Launch", "low", EventType == "Installation", "informational", EventType == "ElevationRequest", "medium", EventType == "Block", "high", EventType == "Ransomware", "critical")
EVAL-vendor_product = "CyberArk EPM"


###### POLICY AUDIT ######

[cyberark:epm:policy:audit]
SHOULD_LINEMERGE = false
KV_MODE = JSON
TIME_PREFIX = \"LastEventDate\"\s*:\s*
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%f

FIELDALIAS-dest = LastEventComputer AS dest
FIELDALIAS-process_exec = EventName AS process_exec
FIELDALIAS-process_name = EventName AS process_name
FIELDALIAS-process_hash = Hash AS process_hash
FIELDALIAS-process_path = LastEventSourceName AS process_path
FIELDALIAS-user = LastEventUserName AS user

EVAL-action = case(EventType == "Block", "blocked", true(), "allowed")
EVAL-process = LastEventSourceName."\\".process_exec
EVAL-original_file_name = replace(EventName,"[^\(]*\((.*)\)","\1")
EVAL-severity = case(EventType == "Installation" OR EventType == "Launch" OR EventType == "Computer" OR EventType == "Access", "low", EventType == "Trust", "informational", EventType == "StartElevated", "medium", EventType == "Block", "high")
EVAL-vendor_product = "CyberArk EPM"


###### THREAT DETECTION ######

[cyberark:epm:threat:detection]
SHOULD_LINEMERGE = false
KV_MODE = JSON
TIME_PREFIX = \"LastEventDate\"\s*:\s*
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%f

FIELDALIAS-dvc = host AS dvc
FIELDALIAS-dest = LastEventComputer AS dest

EVAL-action = case(ThreatDetectionAction == "Detected", "allowed", ThreatDetectionAction == "Blocked", "blocked", true(), action)
EVAL-category = case(EventName == "LSASS Credentials Harvesting", "Credentials Harvesting", EventName == "LSASS Credential Lure Used", "Credential Lure", EventName == "Chrome Credentials Theft", "Credentials Theft", true(), category)
EVAL-change_type = if(ThreatDetectionAction == "Detected", "policy", change_type)
EVAL-command = if(ThreatDetectionAction == "Detected", "API", command)
EVAL-file_hash = coalesce(Hash, file_hash)
EVAL-file_name = coalesce(LastEventFileName, file_name)
EVAL-ids_type = "host"
EVAL-object = if(ThreatDetectionAction == "Detected", EventName, object)
EVAL-object_attrs = if(ThreatDetectionAction == "Detected", EventType, object_attrs)
EVAL-object_category = if(ThreatDetectionAction == "Detected", "policy", object_category)
EVAL-object_id = if(ThreatDetectionAction == "Detected", Hash, object_id)
EVAL-severity = case(EventType == "SuspiciousActivity", "medium", EventType == "Attack", "high", true(), severity)
EVAL-signature = coalesce(EventName, signature)
EVAL-status = if(ThreatDetectionAction == "Detected", "success", status)
EVAL-user = coalesce(LastEventUserName, user)
EVAL-vendor_product = "CyberArk EPM"

###### AGGREGATED EVENTS ######

[cyberark:epm:aggregated:events]
SHOULD_LINEMERGE = false
KV_MODE = JSON
TIME_PREFIX = \"lastEventDate\"\s*:\s*
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%f

REPORT-extract_aggregated_dest_user = extract_aggregated_dest_user

FIELDALIAS-category = eventType AS category
FIELDALIAS-file_hash = hash AS file_hash

EVAL-action = case(threatDetectionAction IN ("Detect") OR eventType IN ( "Ransomware"), "allowed", threatDetectionAction IN ("Block"), "blocked", true(), action)
EVAL-dest = coalesce(lastEventComputerName, case(dest IN ("NTAUTHORITY", "NT AUTHORITY"), null(), true(), dest))
EVAL-dvc = coalesce(lastEventComputerName, case(dest IN ("NTAUTHORITY", "NT AUTHORITY"), null(), true(), dest))
EVAL-file_hash = case(hash IN ("", "null"), null(), like(hash, "%##%"), replace(hash,"^(SHA1)##(.*)", "\1=\2"), true(), hash)
EVAL-file_name = case(lastEventFileName IN ("", "null"), null(), true(), lastEventFileName)
EVAL-file_path = case(fileLocation IN ("", "null"), null(), true(), fileLocation)
EVAL-ids_type = "host"
EVAL-signature = case(isnull(policyName) OR policyName IN ("", "null"), eventType, true(), policyName)
EVAL-severity = case(eventType IN ("AttackAttempt", "AttackBlock", "SuspiciousActivityBlock", "SuspiciousActivityAttempt", "Ransomware"), "high", true(), severity)
EVAL-src = coalesce(lastEventComputerName, case(dest IN ("NTAUTHORITY","NT AUTHORITY") OR eventType == "Ransomware", null(), true(), dest))
EVAL-vendor_product = "CyberArk EPM"

###### RAW ######

[cyberark:epm:raw:events]
SHOULD_LINEMERGE = false
KV_MODE = JSON
TIME_PREFIX = \"lastEventDate\"\s*:\s*
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%f

REPORT-extract_process_exec = extract_process_exec
REPORT-extract_process_id = extract_process_id
REPORT-extract_raw_dest_user = extract_raw_dest_user

FIELDALIAS-category = eventType AS category
FIELDALIAS-file_hash = hash AS file_hash
FIELDALIAS-os = operatingSystemType as os
FIELDALIAS-process_name = process_exec as process_name

EVAL-action = case(threatProtectionAction IN ("Detect"), "allowed", threatProtectionAction IN ("Block"), "blocked", eventType IN ("Trust", "Launch", "ManualRequest", "Access", "Skipped", "Installation", "DetectAccess", "ElevationRequest", "Ransomware"), "allowed", eventType IN ("Block", "RestrictAccess"), "blocked", true(), action)
EVAL-dest = coalesce(computerName, case(dest IN ("NTAUTHORITY", "NT AUTHORITY"), null(), true(), dest))
EVAL-dvc = coalesce(computerName, case(dest IN ("NTAUTHORITY", "NT AUTHORITY"), null(), true(), dest))
EVAL-file_hash = case(hash IN ("", "null"), null(), like(hash, "%##%"), replace(hash,"^(SHA1)##(.*)", "\1=\2"), true(), hash)
EVAL-file_name = case(fileName IN ("", "null"), null(), true(), fileName)
EVAL-file_path = case(filePath IN ("", "null"), null(), true(), filePath)
EVAL-ids_type = "host"
EVAL-process = case(processCommandLine IN ("", "null") , null(), true(), process)
EVAL-process_hash = case(hash IN ("", "null"), null(), like(hash, "%##%"), replace(hash,"^(SHA1)##(.*)", "\1=\2"), true(), hash)
EVAL-process_path = case(filePath IN ("", "null"), null(), true(), filePath)
EVAL-original_file_name = case(originalFileName IN ("", "null"), fileName, true(), originalFileName)
EVAL-signature = case(policyName IN ("", "null"), eventType, true(), policyName)
EVAL-severity = case(eventType IN ("Trust", "Launch", "ManualRequest", "Access", "Skipped", "DetectAccess"), "low", eventType IN ("Installation"), "informational", eventType IN ("ElevationRequest"), "medium", eventType IN ("Block", "RestrictAccess", "Ransomware", "AttackAttempt", "AttackBlock", "SuspiciousActivityBlock", "SuspiciousActivityAttempt", "Ransomware"), "high", true(), severity)
EVAL-src = coalesce(computerName, case(dest IN ("NTAUTHORITY", "NT AUTHORITY") OR eventType == "Ransomware", null(), true(), dest))
EVAL-vendor_product = "CyberArk EPM"

###### POLICY AUDIT ######

[cyberark:epm:raw:policy:audit]
SHOULD_LINEMERGE = false
KV_MODE = JSON
TIME_PREFIX = \"lastEventDate\"\s*:\s*
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%f

REPORT-extract_raw_dest_user = extract_raw_dest_user
REPORT-extract_process_exec = extract_process_exec

FIELDALIAS-os = operatingSystemType as os
FIELDALIAS-process_name = process_exec as process_name
FIELDALIAS-process = process_exec as process

EVAL-action = case(eventType IN ("Trust", "Installation", "Launch", "Access", "StartElevated", "Computer", "Skipped"), "allowed", eventType IN ("Block"), "blocked", true(), action)
EVAL-dest = coalesce(computerName, case(dest IN ("NTAUTHORITY","NT AUTHORITY"), null(), true(), dest))
EVAL-process_hash = case(hash IN ("", "null"), null(), like(hash, "%##%"), replace(hash,"^(SHA1)##(.*)", "\1=\2"), true(), hash)
EVAL-process_path = case(isnotnull(filePath), filePath, true(), null())
EVAL-original_file_name = case(originalFileName IN ("", "null"), fileName, true(), originalFileName)
EVAL-severity = case(eventType IN ("Installation", "Launch", "Computer", "Access", "Trust"), "low", eventType IN ("StartElevated"), "medium", eventType IN ("Block"), "high", true(), severity)
EVAL-vendor_product = "CyberArk EPM"

[cyberark:epm:aggregated:policy:audit]
SHOULD_LINEMERGE = false
KV_MODE = JSON
TIME_PREFIX = \"lastEventDate\"\s*:\s*
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%f

## POLICIES ##

[cyberark:epm:policies]
SHOULD_LINEMERGE = false
KV_MODE = JSON
DATETIME_CONFIG = CURRENT

LOOKUP-action_name_from_action = action_name_lookup Action OUTPUT ActionName

###### COMPUTERS ######

[cyberark:epm:computers]
SHOULD_LINEMERGE = false
KV_MODE = JSON
DATETIME_CONFIG = CURRENT

FIELDALIAS-dest = host AS dest
FIELDALIAS-version = AgentVersion AS version
FIELDALIAS-status = Status AS status

EVAL-enabled = if(status == "Alive", "true", "false")
EVAL-user = if(LoggedIn == "", null(), LoggedIn)
EVAL-vendor_product = "CyberArk EPM"
EVAL-os = if(Platform == "Unknown", null(), Platform)

###### COMPUTER GROUPS ######

[cyberark:epm:computer:groups]
SHOULD_LINEMERGE = false
KV_MODE = JSON
DATETIME_CONFIG = CURRENT

###### ADMIN AUDIT LOGS ######
[cyberark:epm:admin:audit]
SHOULD_LINEMERGE = false
KV_MODE = JSON
TIME_PREFIX = \"EventTime\"\s*:\s*
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%f

REPORT-extract_command = extract_command
REPORT-extract_object1 = extract_object_api_event, extract_object_create_update_delete_event, extract_object_read_event, extract_object_get_event, extract_object_hash_event
REPORT-extract_object_id = extract_object_id_for_set, extract_object_id_for_computer

FIELDALIAS-dest = host as dest
FIELDALIAS-dvc = host as dvc
FIELDALIAS-src = LoggedFrom as src
FIELDALIAS-user = Administrator as user
FIELDALIAS-src_user = Administrator as src_user

EVAL-change_type = case(Feature IN ("Account Mgmt", "Custom Tokens") OR (Feature == "Public API" AND like(Description, "API Logout%")), "AAA", Feature == "Public API", "filesystem", true(), "product configuration")
EVAL-object_category = case(Feature == "Account Mgmt" OR (Feature == "Public API" AND like(Description, "API Logout%")), "user", like(Description, "%Computer Group%") AND Feature == "My Computers", "Computer Group", like(Description, "Uninstall Agent on Computers%"), "Computer", true(), Feature)
EVAL-object_attrs = if(like(Description, "Change Password%"), "password", Description)
EVAL-status = "success"
EVAL-vendor_product = "CyberArk EPM"
EVAL-user_type = if(Role == "SetAdmin", "admin", "user")
EVAL-src_user_type = if(Role == "SetAdmin", "admin", "user")
EVAL-action = case(like(Description, "Create%") OR like(Description, "(ReportController) Create%") OR like(Description, "(ReportController) Generate%") OR like(Description, "Threat intelligence scan%"), "created", like(Description, "Get%") OR like(Description, "(ReportController) Get%") OR like(Description, "(ReportController) Preview%") OR like(Description, "Read%") OR like(Description, "View%") OR like(Description, "Enter Set%") OR like(Description, "API Get%") OR like(Description, "Query%"), "read", like(Description, "Rename%") OR like(Description, "Update%") OR like(Description, "(ReportController) Update%") OR like(Description, "Deactivate%") OR like(Description, "Activate%") OR like(Description, "Uninstall%") OR Description == "Change Password finished successfully", "modified", like(Description, "(ReportController) Delete%") OR like(Description, "Delete%"), "deleted", like(Description, "Change Password for User % started"), "started", like(Description, "API Logout%"), "logout")
EVAL-command = coalesce(command, "web")
EVAL-object = case(Feature == "Account Mgmt" OR (Feature == "Public API" AND like(Description, "API Logout%")), Administrator, like(Description, "Enter Set%"), SetName, like(Description, "Query full mesh data from hosts%"), "Computer", Feature == "Reports", Feature, true(), object)
EVAL-object_id = if(Feature == "Account Mgmt" OR (Feature == "Public API" AND like(Description, "API Logout%")), Administrator, object_id)
EVAL-result = case(Feature == "Public API" AND like(Description, "API Logout%"), "API Logout", isnotnull(PermissionDescription) AND PermissionDescription != "None", PermissionDescription, true(), null())

###### ACCOUNT ADMIN AUDIT LOGS ######
[cyberark:epm:account:admin:audit]
SHOULD_LINEMERGE = false
KV_MODE = JSON
TIME_PREFIX = \"EventTime\"\s*:\s*
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%f

REPORT-extract_command = extract_command
REPORT-extract_object1 = extract_object_api_event, extract_object_create_update_delete_event, extract_object_read_event, extract_object_get_event, extract_object_hash_event

FIELDALIAS-dest = host as dest
FIELDALIAS-dvc = host as dvc
FIELDALIAS-src = LoggedFrom as src
FIELDALIAS-user = Administrator as user
FIELDALIAS-src_user = Administrator as src_user
FIELDALIAS-object = Administrator as object
FIELDALIAS-object_id = Administrator as object_id
FIELDALIAS-result = PermissionDescription as result

EVAL-change_type = case(Feature IN ("Administrators", "Sets", "Roles", "Account Mgmt"), "AAA")
EVAL-object_attrs = replace(Description, "\"", "\\\"")
EVAL-object_category = case(Feature == "Account Mgmt", "user", Feature IN ("Administrators", "Sets", "Roles"), Feature)
EVAL-status = "success"
EVAL-vendor_product = "CyberArk EPM"
EVAL-user_type = "admin"
EVAL-src_user_type = if(Role == "AccountAdmin", "admin", "user")
EVAL-action = case(like(Description, "Create Admin%") OR like(Description, "Create Role%") OR like(Description, "Create Set%"), "created", like(Description, "Delete Admin%") OR like(Description, "Delete Administrator%") OR like(Description, "Delete Sets%") OR like(Description, "Delete Role%"), "deleted",like(Description, "Edit Admin%") OR like(Description, "Edit Account%") OR like(Description, "Edit Set%") OR like(Description, "Edit Role%") OR like(Description, "Reset Password for Admin%") OR like(Description, "Save SAML integration%") OR like(Description, "Change Password%"), "modified",like(Description, "Bind Admin%") OR like(Description, "Save SAML integration%") OR like(Description, "Change Password for User%"), "started")
EVAL-command = coalesce(command, "web")
