<form version="1.1" script="vo_incident_summary.js" stylesheet="victorops.css" hideFooter="true" hideEdit="false" hideTitle="false">
  <label>Incident Summary</label>
  <search id="vo_search">
    <query>
      `victorops_incidents` | sort lastAlertTime desc | dedup incidentNumber | fields *
    </query>
    <earliest>$time_period.earliest$</earliest>
    <latest>$time_period.latest$</latest>
  </search>
  <fieldset submitButton="false">
    <input type="dropdown" token="org_field">
      <label>Organization</label>
      <choice value="*">All</choice>
      <default>*</default>
      <fieldForLabel>name</fieldForLabel>
      <fieldForValue>name</fieldForValue>
      <search>
        <query>`victorops_incidents` org != '' | eval name = org | dedup name | sort name  | table name</query>
        <earliest>0</earliest>
        <latest></latest>
      </search>
    </input>
    <input type="time" token="time_period">
      <label>Date Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="last_update" searchWhenChanged="true" depends="$justHideMe$">
      <label>last_update</label>
      <search>
        <query>`victorops_incidents` org="$org_field$" | head 1 | convert timeformat="%H:%M:%S on %m/%d/%Y" ctime(_time) AS last_update | table last_update</query>
      </search>
      <fieldForLabel>last_update</fieldForLabel>
      <fieldForValue>last_update</fieldForValue>
      <selectFirstChoice>true</selectFirstChoice>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Last Incident Received at $last_update$</title>
    </panel>
  </row>
  <row>
    <panel>
      <single>
        <title>Live Incidents</title>
        <search base="vo_search">
          <query>
search org="$org_field$" (currentPhase=UNACKED OR currentPhase=ACKED) 
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Resolved Incidents</title>
        <search base="vo_search">
          <query>
search org="$org_field$" currentPhase=RESOLVED  
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Incident Trend</title>
        <search base="vo_search">
          <query>search org="$org_field$" 
            | timechart count span=1h
            | streamstats sum(count)</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Live Incidents</title>
        <search base="vo_search">
          <query>
search org="$org_field$" currentPhase != "RESOLVED"
| eval transitions = mvzip('transitions{}.by', 'transitions{}.name') | eval transitions = if (transitions not null, transitions, "") | eval transitions = mvzip(transitions,'transitions{}.at') 
| fillnull value=" " transitions 
| mvexpand transitions | makemv transitions delim="," | eval transition_user=mvindex(transitions, 0) | eval transition_type=mvindex(transitions,1) | eval transition_time=mvindex(transitions,2)
| eval startTimeEpoch =strptime(startTime,"%Y-%m-%dT%H:%M:%SZ")  | eval transition_time_epoch =strptime(transition_time,"%Y-%m-%dT%H:%M:%SZ") | eval ack_duration = transition_time_epoch - startTimeEpoch
| rename org as Organization incidentNumber as Incident entityState as State entityDisplayName as Entity currentPhase as Phase alertCount as "Alert Count" startTime as "Start Time" lastAlertTime as "Last Alert Time" transition_user as "Acked By" ack_duration as "Time To Ack" transition_time as "Acked Time"
| table Organization, Incident, State, Entity, Phase, "Alert Count", "Start Time", "Last Alert Time", "Acked Time" "Time To Ack" "Acked By"</query>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Resolved Incidents</title>
        <search base="vo_search">
          <query>
| search org="$org_field$" currentPhase = "RESOLVED"
| eval start = strptime(startTime,"%Y-%m-%dT%H:%M:%SZ") 
| eval end = strptime(lastAlertTime,"%Y-%m-%dT%H:%M:%SZ") 
| eval duration = round((end - start) * 60)
| eval transitions = mvzip('transitions{}.name','transitions{}.by') 
| eval n = mvfind(transitions,"RESOLVED") 
| eval tmp = if (isnotnull(n), mvindex(transitions,n),'')
| eval resolvedBy = if (tmp == '', tmp, replace(tmp,"RESOLVED,",""))
| rename org as Organization incidentNumber as Incident entityState as State entityDisplayName as Entity currentPhase as Phase alertCount as "Alert Count" startTime as "Start Time" lastAlertTime as "Resolved Time" duration as "Time to Resolve" resolvedBy as "Resolved By"
| table Organization, Incident, Entity, "Alert Count", "Start Time", "Resolved Time", "Time to Resolve" "Resolved By"</query>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <html>
      <div id="createModal" class="modal fade" style="margin-top:100px;z-index:-9999;height:580px;" data-backdrop="static;">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="border-bottom:1px solid #999999;padding:15px;">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="top:15px;"><span aria-hidden="true">X</span></button>
              <h4 class="modal-title" id="fieldModalLabel">Create New Incident</h4>
            </div>
            <div id="createModalBody" class="modal-body" style="min-height:470px;padding-top:10px;">
              <div>
                <span style="font-weight:bold;">Monitor Type: Manual</span>
              </div>
              <!--
              <div>
                <span style="font-weight:bold">Created By:</span>  $env:user$
              </div>
              -->
              <div style="padding-top:15px;">
                Organization*:
                <div>
                  <select id="orgSelect" style="width:100%" placeholder="Select Organization">
                  </select>
                </div>
              </div>
              <div>
                Team / Policy*:
                <div>
                  <select id="teamSelect" style="width:100%" placeholder="Select Team/Policy">
                  </select>
                </div>
              </div>
              <div>
                User*:
                <div>
                  <select id="userSelect" style="width:100%" placeholder="Select User">
                  </select>
                </div>
              </div>
              <div>
                Acknowledge Behavior*:
                <div>
                  <select id="behaviorSelect" style="width:100%">
                    <option value="false">Stop paging after a single Acknowldge from any Escalation Policy or User</option>
                    <option value="true">Continue paging until each Escalation Policy or User above has Acknowledged</option>
                  </select>
                </div>
              </div>
              <div>
                Incident Description*:
                <div>
                  <input id="descriptionTI" type="text" style="width:100%" placeholder="Enter Incident Description"></input>
                </div>
              </div>
              <div>
                Incident Body*:
                <div>
                  <textarea id="incidentDetailTA" style="width:100%" placeholder="Enter Incident Details"></textarea>
                </div>
              </div>
              <div>
                Conference Bridge:
                <div>
                  <select id="bridgeSelect" style="width:100%" placeholder="Select Bridge">
                    <option value="">No Conference Bridge</option>
                    <!--<option value="78">Customer Impacting</option>-->
                    <!--<option value="22">DW Bridge</option>-->
                    <option value="-1">Enter Your Own Conference Bridge Information</option>
                  </select>
                </div>
              </div>
              <div id="enterBridgePanel" style="display:none;">
                <div>
                  <div style="display:inline-block;width:20%;text-align:right;">
                    URL:
                  </div>
                  <input id="urlTI" type="text" style="width:79%;"></input>
                </div>
                <div>
                  <div style="display:inline-block;width:20%;text-align:right;">
                    Phone Number:
                  </div>
                  <input id="phoneTI" type="text" style="width:79%;"></input>
                </div>
                <div>
                  <div style="display:inline-block;width:20%;text-align:right;">
                    Details:
                  </div>
                  <textarea id="notesTA" type="text" style="width:79%;"></textarea>
                </div>
              </div>
            </div>
            <div id="createModalFooter" class="modal-footer">
              <label id="dialogErrorMessage" style="float:left;color:#CC0000;"></label>
              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
              <button id="createDialogButton" type="button" class="btn btn-vo">Submit</button>
            </div>
          </div>
        </div>
      </div>
      <div id="incidentModal" class="modal fade" style="margin-top:100px;z-index:-9999;height:100px;" data-backdrop="static;">
        <div class="modal-dialog">
          <div class="modal-content">
            <div id="incidentModalBody" class="modal-body" style="margin-top:60px;text-align:center;font-size:16px;">
            </div>
            <div id="incidentModalFooter" class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Dismiss</button>
            </div>
          </div>
        </div>
      </div>
    </html>
  </row>
</form>
