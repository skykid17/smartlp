<form version="1.1" hideEdit="false" hideTitle="false">
  <label>Current Oncall</label>
  <fieldset submitButton="false">
    <input type="dropdown" token="org_field">
      <label>Organization</label>
      <choice value="*">All</choice>
      <default>*</default>
      <fieldForLabel>name</fieldForLabel>
      <fieldForValue>name</fieldForValue>
      <search>
        <query>`victorops_teams` org != '' | eval name = org | dedup name | sort name  | table name</query>
        <earliest>0</earliest>
        <latest></latest>
      </search>
    </input>
    <input type="dropdown" token="name_field">
      <label>Team Name</label>
      <choice value="*">All</choice>
      <default>*</default>
      <fieldForLabel>name</fieldForLabel>
      <fieldForValue>name</fieldForValue>
      <search>
        <query>`victorops_teams` info.name != '' org="$org_field$" | eval name = 'info.name' | dedup name | sort name | table name</query>
        <earliest>0</earliest>
        <latest></latest>
      </search>
    </input>
    <input type="dropdown" token="policy_field">
      <label>Policy</label>
      <choice value="*">All</choice>
      <default>*</default>
      <fieldForLabel>policies</fieldForLabel>
      <fieldForValue>policies</fieldForValue>
      <search>
        <query>`victorops_teams` org="$org_field$" type="team" info.name="$name_field$"
| eval policies = 'policies{}.name' | mvexpand policies | dedup policies | sort policies | table policies</query>
        <earliest>0</earliest>
        <latest></latest>
      </search>
    </input>
    <input type="dropdown" token="username_field" searchWhenChanged="true">
      <label>Username</label>
      <choice value="*">All</choice>
      <default>*</default>
      <fieldForLabel>users</fieldForLabel>
      <fieldForValue>users</fieldForValue>
      <search>
        <query>`victorops_teams` $policy_field$ org="$org_field$" info.name="$name_field$"
| eval users = 'members{}.username' | mvexpand users | dedup users | sort users | table users</query>
        <earliest>0</earliest>
        <latest></latest>
      </search>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Teams</title>
      <table>
        <title>Select row to view Team OnCall Schedule</title>
        <search>
          <query>`victorops_oncall` org="$org_field$" earliest=0
| dedup teamName
| search teamName = "$name_field$"
| eval policies = mvzip('policies{}.policyName', 'policies{}.oncallUsers{}') 
| mvexpand policies 
| makemv policies delim="," 
| eval policyName=mvindex(policies, 0) 
| eval oncallUsers=mvindex(policies, 1) 
| search policyName = "$policy_field$"
| search oncallUsers = "$username_field$"
| join oncallUsers [search `victorops_users` org="$org_field$" earliest=0 | dedup info.username | eval oncallUsers='info.username' | table oncallUsers info.email]
| sort teamName
| join type=left teamName, policyName [| retrieveRoutingKeysForOrg $org_field$]
| rename org as Organization teamName as "Team Name" policyName as "Policy Name" oncallUsers as "Oncall Users" info.email as "Oncall User Email" "routingKey" as "Routing Key"
| table Organization "Team Name" teamSlug  "Policy Name" "Oncall Users" "Oncall User Email" "Routing Key"
          </query>
          <earliest>0</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">row</option>
        <fields>["Organization", "Team Name","Policy Name","Oncall Users","Oncall User Email", "Routing Key"]</fields>
        <drilldown>
          <link target="_blank">/app/TA-splunk-add-on-for-victorops/vo_team_oncall_calendar?form.Slug=$row.Organization$~$row.teamSlug$</link>
        </drilldown>
      </table>
    </panel>
  </row>
</form>
