##
## SPDX-FileCopyrightText: 2020 Splunk, Inc. <sales@splunk.com>
## SPDX-License-Identifier: LicenseRef-Splunk-8-2021
##
##
[source::....bluecoat]
sourcetype = bluecoat:proxysg:access:file

[bluecoat]
rename=bluecoat:proxysg:access:syslog

[bluecoat:proxysg:access:syslog]
pulldown_type = true
category = Network & Security
description = Data from Blue Coat ProxySG in W3C ELFF format thru syslog
KV_MODE = none
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE=true
MAX_DAYS_AGO = 10951
TRUNCATE  = 64000

# Support transition to new type at index time
TRANSFORMS-bluecoatkv=set_sourcetype_bluecoat
TRANSFORMS-TrashHeaders = TrashHeaders

## Please uncomment below to extract fields from v5_3_3 logs
#REPORT-auto_kv_for_bluecoat_v5 = auto_kv_for_bluecoat_v5_3_3

# Please uncomment below to extract fields from 6.5.x field format
#REPORT-auto_kv_for_bluecoat_v6 = auto_kv_for_bluecoat_v6_5_x


# Please uncomment below to extract fields from 6.6.x field format
#REPORT-auto_kv_for_bluecoat_6.x = auto_kv_for_bluecoat_v6_6_x,auto_kv_for_bluecoat_v6_7_x,auto_kv_for_bluecoat_v7_3_x


# Supports Bluecoat 7.3.6.x,6.7.x field format
REPORT-auto_kv_for_bluecoat = auto_kv_for_bluecoat_v6_7_x,auto_kv_for_bluecoat_v7_3_x,http_referrer_domain
REPORT-vendor_categories = bluecoat_vendor_categories
REPORT-bluecoat_header = bluecoat_header

FIELDALIAS-action           = s_action as vendor_action
FIELDALIAS-dest_ip          = r_ip as dest_ip

EVAL-app = "Blue Coat ProxySG"
EVAL-dest = case(r_ip != "-", r_ip, cs_host != "-", cs_host)
EVAL-bytes = if(sc_bytes != "-" AND cs_bytes != "-", sc_bytes + cs_bytes, null)
EVAL-duration = if(time_taken != "-", time_taken, null)
EVAL-src = if(c_ip != "-", c_ip, null)
EVAL-user = if(cs_username != "-", cs_username, null)
EVAL-http_referrer = if(cs_Referer != "-", cs_Referer, null)
EVAL-status = if(sc_status != "-", sc_status, null)
EVAL-http_method = if(cs_method != "-", cs_method, null)
EVAL-http_content_type = if(rs_Content_Type != "-", rs_Content_Type, null)
EVAL-dest_host = if(cs_host != "-", cs_host, null)
EVAL-dest_port = if(cs_uri_port != "-", cs_uri_port, null)
EVAL-http_user_agent = if(cs_User_Agent != "-", cs_User_Agent, null)
EVAL-bytes_in = if(sc_bytes != "-", sc_bytes, null)
EVAL-bytes_out = if(cs_bytes != "-", cs_bytes, null)
EVAL-uri_path = if(cs_uri_path != "-", cs_uri_path, null)
EVAL-uri_query = if(cs_uri_query != "-", cs_uri_query, null)
EVAL-category = if(cs_categories != "-", cs_categories, null)
EVAL-dvc = if(s_ip != "-", s_ip, null)

EVAL-url = coalesce(cs_uri, if(isnull(cs_uri_scheme) OR (cs_uri_scheme=="-"), "", cs_uri_scheme+"://") + cs_host + cs_uri_path + if(isnull(cs_uri_query) OR (cs_uri_query == "-"), "", cs_uri_query))
EVAL-url_domain = if(cs_host != "-", cs_host, null)
EVAL-product = "ProxySG"
EVAL-vendor = "Blue Coat"
EVAL-vendor_product = "Blue Coat ProxySG"
# Eval action to blocked if sc_filter_result is DENIED
EVAL-action = case(sc_filter_result=="DENIED","blocked")
EVAL-http_user_agent_length = if(cs_User_Agent != "-", len(cs_User_Agent), null)

LOOKUP-vendor_traffic_action = bluecoat_proxy_action_lookup vendor_action OUTPUTNEW action, transport

[bluecoat:proxysg:access:file]
pulldown_type = true
category = Network & Security
description = Data from Blue Coat ProxySG in W3C ELFF format thru file monitoring

INDEXED_EXTRACTIONS = w3c
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE=true
MAX_DAYS_AGO = 10951

TRANSFORMS-TrashHeaders = TrashHeaders

REPORT-vendor_categories = bluecoat_vendor_categories
REPORT-bluecoat_header = bluecoat_header,http_referrer_domain

FIELDALIAS-duration         = time_taken as duration
FIELDALIAS-src              = c_ip as src
FIELDALIAS-user             = cs_username as user
FIELDALIAS-status           = sc_status as status
FIELDALIAS-action           = s_action as vendor_action
FIELDALIAS-http_method      = cs_method as http_method
FIELDALIAS-content_type     = rs_Content_Type as http_content_type
FIELDALIAS-dest_host        = cs_host as dest_host
FIELDALIAS-dest_port        = cs_uri_port as dest_port
FIELDALIAS-user_agent       = cs_User_Agent as http_user_agent
FIELDALIAS-dest_ip          = r_ip as dest_ip
FIELDALIAS-dvc              = s_ip as dvc
FIELDALIAS-bytes_in         = sc_bytes as bytes_in
FIELDALIAS-bytes_out        = cs_bytes as bytes_out
FIELDALIAS-uri_path         = cs_uri_path as uri_path
FIELDALIAS-uri_query        = cs_uri_query as uri_query
FIELDALIAS-category         = cs_categories as category
FIELDALIAS-http_referrer    = cs_Referer as http_referrer

EVAL-app = "Blue Coat ProxySG"
EVAL-dest = coalesce(dest_ip, dest_host)
EVAL-bytes = if(isnotnull(bytes_in) AND isnotnull(bytes_out), bytes_in + bytes_out, null)

EVAL-url = coalesce(cs_uri, if(isnull(cs_uri_scheme) OR (cs_uri_scheme=="-"), "", cs_uri_scheme+"://") + cs_host + cs_uri_path + if(isnull(cs_uri_query) OR (cs_uri_query == "-"), "", cs_uri_query))
EVAL-url_domain = if(cs_host != "-", cs_host, null)
EVAL-product = "ProxySG"
EVAL-vendor = "Blue Coat"
EVAL-vendor_product = "Blue Coat ProxySG"
EVAL-http_user_agent_length = len(cs_User_Agent)

# Eval action to blocked if sc_filter_result is DENIED
EVAL-action = case(sc_filter_result=="DENIED","blocked")
LOOKUP-vendor_traffic_action = bluecoat_proxy_action_lookup vendor_action OUTPUTNEW action, transport

[source::....bluecoatkv]
sourcetype = bluecoat:proxysg:access:kv


## Template used by Bluecoat in this type
## <134>1 $(date)T$(x-bluecoat-hour-utc):$(x-bluecoat-minute-utc):$(x-bluecoat-second-utc).000z $(x-bluecoat-appliance-name) bluecoat[0]: SPLV5.1 c-ip=$(c-ip) Content-Type=$(quot)$(rs(Content-Type))$(quot) cs-auth-group=$(cs-auth-group) cs-bytes=$(cs-bytes) cs-categories=$(quot)$(cs-categories)$(quot) cs-host=$(cs-host) cs-ip=$(cs-ip) cs-method=$(cs-method) cs-uri-extension=$(cs-uri-extension) cs-uri-path=$(cs-uri-path) cs-uri-port=$(cs-uri-port) cs-uri-query=$(quot)$(cs-uri-query)$(quot) cs-uri-scheme=$(cs-uri-scheme) cs-User-Agent=$(quot)$(cs(User-Agent))$(quot) cs-username=$(cs-username) dnslookup-time=$(dnslookup-time) duration=$(duration) rs-status=$(rs-status) rs-version=$(rs-version) rs_Content_Type=$(rs-Content-Type) s-action=$(s-action) s-ip=$(s-ip) service.name=$(service.name) service.group=$(service.group) s-supplier-ip=$(s-supplier-ip) s-supplier-name=$(s-supplier-name) sc-bytes=$(sc-bytes) sc-filter-result=$(sc-filter-result) sc-filter-result=$(sc-filter-result) sc-status=$(sc-status) time-taken=$(time-taken) x-bluecoat-appliance-name=$(x-bluecoat-appliance-name) x-bluecoat-appliance-primary-address=$(x-bluecoat-appliance-primary-address) x-bluecoat-application-name=$(x-bluecoat-application-name) x-bluecoat-application-operation=$(x-bluecoat-application-operation) x-bluecoat-proxy-primary-address=$(x-bluecoat-proxy-primary-address) x-bluecoat-transaction-uuid=$(x-bluecoat-transaction-uuid) x-exception-id=$(x-exception-id) x-virus-id=$(x-virus-id) c-url=$(quot)$(url)$(quot) cs-Referer=$(quot)$(cs(Referer))$(quot)
[bluecoat:proxysg:access:kv]
pulldown_type = true
category = Network & Security
description = Data from Blue Coat ProxySG in W3C KV format thru syslog
KV_MODE = auto
SHOULD_LINEMERGE = false
MAX_DAYS_AGO = 10951
EVENT_BREAKER_ENABLE = true
TRUNCATE  = 64000

TRANSFORMS-TrashHeaders = TrashHeaders
SEDCMD-empty=s/ [a-zA-z0-9\-]+\=(?:\"\-\"|-)//g

REPORT-bluecoat_header = bluecoat_header

FIELDALIAS-duration         = time_taken as duration
FIELDALIAS-src              = c_ip as src
FIELDALIAS-user             = cs_username as user
FIELDALIAS-http_referrer    = cs_Referer as http_referrer
FIELDALIAS-status           = sc_status as status
FIELDALIAS-action           = s_action as vendor_action
FIELDALIAS-http_method      = cs_method as http_method
FIELDALIAS-content_type     = rs_Content_Type as http_content_type
FIELDALIAS-dest_host        = cs_host as dest_host
FIELDALIAS-dest_port        = cs_uri_port as dest_port
FIELDALIAS-user_agent       = cs_User_Agent as http_user_agent
FIELDALIAS-dvc              = s_ip as dvc
FIELDALIAS-bytes_in         = sc_bytes as bytes_in
FIELDALIAS-bytes_out        = cs_bytes as bytes_out
FIELDALIAS-uri_path         = cs_uri_path as uri_path
FIELDALIAS-uri_query        = cs_uri_query as uri_query
FIELDALIAS-category         = cs_categories as category

EVAL-app = "Blue Coat ProxySG"
EVAL-vendor_categories = split(cs_categories,";")
EVAL-dest = coalesce(r_ip,cs_host)
EVAL-dest_ip = coalesce(r_ip, s_supplier_ip)
EVAL-bytes = if(isnotnull(bytes_in) AND isnotnull(bytes_out), bytes_in + bytes_out, null)
EVAL-url_domain = if(cs_host != "-", cs_host, null)
EVAL-url = coalesce(cs_uri, if(isnull(cs_uri_scheme) OR (cs_uri_scheme=="-"), "", cs_uri_scheme+"://") + cs_host + cs_uri_path + if(isnull(cs_uri_query) OR (cs_uri_query == "-"), "", cs_uri_query))
EVAL-product = "ProxySG"
EVAL-vendor = "Blue Coat"
EVAL-vendor_product = "Blue Coat ProxySG"
EVAL-http_user_agent_length = len(cs_User_Agent)
EVAL-http_referrer_domain = replace(cs_Referer,"^(?:[^:]+:\/\/)?(?!(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\S+:\/\/))([^:\/]+)(?:\S+)","\1")

LOOKUP-vendor_traffic_action = bluecoat_proxy_action_lookup vendor_action OUTPUT action, transport
