##
## SPDX-FileCopyrightText: 2024 Splunk, Inc.
## SPDX-License-Identifier: LicenseRef-Splunk-8-2021
##
##

[msscom:allperformance]
description = Collect all performance data from MS SCOM
interval = 600
mode = rising
index_time_mode = current
query = \
 /*\
  SPDX-FileCopyrightText: 2024 Splunk, Inc.\
  SPDX-License-Identifier: LicenseRef-Splunk-8-2021\
 */\
 SELECT TimeSampled                                             as timesampled,\
        pdav.TimeAdded                                          as scom_timestamp,\
        'get-scomallperfdata'                                   as scom_command,\
        pdav.TimeAdded                                          as timeadded,\
        LOWER(pdav.PerformanceDataId)                           as id,\
        pdav.PerformanceSourceInternalId                        as monitoringperformancedataid,\
        LOWER(MonitoringObjectId)                               as monitoringobjectid,\
        LOWER(RuleId)                                           as ruleid,\
        LOWER(RuleId)                                           as monitoringruleid,\
        InstanceName                                            as instancename,\
        ObjectName                                              as objectname,\
        CounterName                                             as countername,\
        ISNULL(LastSampledValue, '')                            as lastsampledvalue,\
        ScaleFactor                                             as scalefactor,\
        ScaleLegend                                             as scalelegend,\
        CASE WHEN HasSignature = 0 THEN 'False' ELSE 'True' END AS hassignature,\
        LearningRuleId                                          as learningmonitoringruleid,\
        LearningRuleId                                          as learningruleid,\
        ISNULL(LOWER(ClassId), '')                              as classid,\
        ISNULL(LOWER(ClassId), '')                              as monitoringclassid,\
        MonitoringObjectName                                    as monitoringobjectname,\
        MonitoringObjectDisplayName                             as monitoringobjectdisplayname,\
        MonitoringObjectPath                                    as monitoringobjectpath,\
        MonitoringObjectFullName                                as monitoringobjectfullname,\
        SampleValue                                             as samplevalue,\
        rv.Description                                          as ruledescription,\
        rv.Description                                          as monitoringruledescription,\
        rv.DisplayName                                          as ruledisplayname,\
        rv.DisplayName                                          as monitoringruledisplayname,\
        mgi.ManagementGroupName                                 as managementgroup,\
        LOWER(mgi.ManagementGroupId)                            as managementgroupid\
 FROM OperationsManager.dbo.PerformanceDataAllView pdav\
          INNER JOIN OperationsManager.dbo.PerformanceCounterSignatureView pcsv\
                     ON pdav.PerformanceSourceInternalId = pcsv.PerformanceSourceInternalId\
          INNER JOIN OperationsManager.dbo.RuleView rv ON pcsv.RuleId = rv.Id\
          CROSS JOIN (select ManagementGroupName, ManagementGroupId\
                      from OperationsManager.dbo.__MOMManagementGroupInfo__) mgi\
 WHERE rv.LanguageCode = 'ENU'\
   AND pdav.TimeAdded > '2022-08-17 13:00:00.553'\
 order by pdav.TimeAdded;
sourcetype = microsoft:scom:performance
rising_column_index = 2

[msscom:events]
description = Collect audit event data from MS SCOM
interval = 3600
mode = rising
index_time_mode = current
query = \
 /*\
  SPDX-FileCopyrightText: 2024 Splunk, Inc.\
  SPDX-License-Identifier: LicenseRef-Splunk-8-2021\
 */\
 SELECT rv.Description                      as monitoringruledescription,\
        ev.TimeAdded                        as "scom_timestamp",\
        ev.PublisherName                    as publishername,\
        LOWER(ev.CategoryId)                as categoryid,\
        ev.CategoryStringId                 as category,\
        ev.MonitoringObjectPath             as monitoringobjectpath,\
        ev.TimeAdded                        as timeadded,\
        rv.DisplayName                      as ruledisplayname,\
        LOWER(ev.ClassId)                   as monitoringclassid,\
        LOWER(rv.Id)                        as ruleid,\
        ev.MonitoringObjectFullName         as monitoringobjectfullname,\
        ev."User"                           as "user",\
        REPLACE(REPLACE(REPLACE(ev.EventData, '<', '&lt;'), '>', '&gt;'), '"',\
                '&apos;')                   as eventdata,\
        ev.LevelId                          as levelid,\
        ev.LevelStringId                    as level,\
        ev.EventParameters                  as parameters,\
        'event'                             as splunk_scom_group,\
        LOWER(ev.Id)                        as id,\
        LOWER(ev.OriginalId)                as originalid,\
        LOWER(ev.ClassId)                   as classid,\
        ev.MonitoringObjectDisplayName      as monitoringobjectdisplayname,\
        rv.DisplayName                      as monitoringruledisplayname,\
        'get-scomevent'                     as scom_command,\
        ev.Number                           as number,\
        LOWER(ev.MonitoringObjectId)        as monitoringobjectid,\
        rv.Description                      as ruledescription,\
        ev.TimeGenerated,\
        ev.Channel                          as channel,\
        ev.LoggingComputer                  as loggingcomputer,\
        LOWER(rv.Id)                        as monitoringruleid,\
        ISNULL(ev.MonitoringObjectName, '') as monitoringobjectname,\
        mgi.ManagementGroupName             as managementgroup,\
        mgi.ManagementGroupId               as managementgroupid,\
        LT5.LTValue                         AS description,\
        LT5.LTStringType\
 from OperationsManager.dbo.EventView ev\
          INNER JOIN OperationsManager.dbo.RuleView rv ON ev.RuleId = rv.Id\
          CROSS JOIN (select ManagementGroupName, ManagementGroupId\
                      from OperationsManager.dbo.__MOMManagementGroupInfo__) mgi\
          LEFT OUTER JOIN OperationsManager.dbo.LocalizedText AS LT5 WITH (NOLOCK)\
                          ON LT5.LTStringId = [ev].[EventNumberStringId] and LT5.LanguageCode = 'ENU'\
 where ev.TimeAdded > '2022-08-16 13:00:00.553'\
 order by ev.TimeAdded;
sourcetype = microsoft:scom:events
rising_column_index = 2

[msscom:alerts]
description = Collect alerts data from MS SCOM
interval = 3600
mode = rising
index_time_mode = current
query = \
 /*\
  SPDX-FileCopyrightText: 2024 Splunk, Inc.\
  SPDX-License-Identifier: LicenseRef-Splunk-8-2021\
 */\
 SELECT av.TimeAdded                                                       as scom_timestamp,\
        LOWER(av.Id)                                                       as id,\
        LOWER(av.MonitoringObjectId)                                       as monitoringobjectid,\
        LOWER(av.MonitoringClassId)                                        as monitoringclassid,\
        LOWER(av.MonitoringClassId)                                        as classid,\
        av.MonitoringObjectDisplayName                                     as monitoringobjectdisplayname,\
        av.MonitoringObjectName                                            as monitoringobjectname,\
        av.MonitoringObjectPath                                            as monitoringobjectpath,\
        av.MonitoringObjectFullName                                        as monitoringobjectfullname,\
        CASE IsMonitorAlert\
            WHEN 0 THEN 'False'\
            WHEN 1 THEN 'True'\
            END                                                            as ismonitoralert,\
        LOWER(av.ProblemId)                                                as problemid,\
        LOWER(av.MonitoringRuleId)                                         as monitoringruleid,\
        LOWER(av.MonitoringRuleId)                                         as ruleid,\
        CASE av.Severity\
            WHEN 0 THEN 'Information'\
            WHEN 1 THEN 'Warning'\
            WHEN 2 THEN 'Error'\
            END                                                            as severity,\
        CASE av.Priority\
            WHEN 0 THEN 'Low'\
            WHEN 1 THEN 'Normal'\
            WHEN 2 THEN 'High'\
            END                                                            as priority,\
        av.ResolutionState                                                 as resolutionstate,\
        av.Category                                                        as category,\
        av.Owner                                                           as owner,\
        av.ResolvedBy                                                      as resolvedby,\
        av.TimeRaised                                                      as timeraised,\
        av.TimeAdded                                                       as timeadded,\
        av.LastModified                                                    as lastmodified,\
        av.LastModifiedBy                                                  as lastmodifiedby,\
        av.TimeResolutionStateLastModified                                 as timeresolutionstatelastmodified,\
        av.CustomField1                                                    as customfield1,\
        av.CustomField2                                                    as customfield2,\
        av.CustomField3                                                    as customfield3,\
        av.CustomField4                                                    as customfield4,\
        av.CustomField5                                                    as customfield5,\
        av.CustomField6                                                    as customfield6,\
        av.CustomField7                                                    as customfield7,\
        av.CustomField8                                                    as customfield8,\
        av.CustomField9                                                    as customfield9,\
        av.CustomField10                                                   as customfield10,\
        REPLACE(\
            REPLACE(\
                REPLACE(av.Context, '<', '&lt;'),\
                '>', '&gt;'),\
            '"', '&apos;')                                                  as context,\
        av.LastModifiedByNonConnector                                      as lastmodifiedbynonconnector,\
        CASE AV.MonitoringObjectInMaintenanceMode\
            WHEN 0 THEN 'False'\
            WHEN 1 THEN 'True'\
            END                                                            as monitoringobjectinmaintenancemode,\
        av.MaintenanceModeLastModified                                     as maintenancemodelastmodified,\
        av.StateLastModified                                               as statelastmodified,\
        av.RepeatCount                                                     as repeatcount,\
        av.AlertStringName                                                 as "name",\
        av.TicketId                                                        as ticketid,\
        av.ConnectorId                                                     as connectorid,\
        av.SiteName                                                        as sitename,\
        av.TfsWorkItemId                                                   as tfsworkitemid,\
        av.TfsWorkItemOwner                                                as tfsworkitemowner,\
        'alert'                                                            as splunk_scom_group,\
        'alert'                                                            as type,\
        'get-scomalert'                                                    as scom_command,\
        av.MonitoringObjectPath                                            as principalname,\
        SUBSTRING(av.MonitoringObjectPath, 0,\
                  CHARINDEX('.', av.MonitoringObjectPath))                 as netbioscomputername,\
        SUBSTRING(av.MonitoringObjectPath, CHARINDEX('.', av.MonitoringObjectPath) + 1,\
                  LEN(MonitoringObjectPath))                               as netbiosdomainname,\
        OperationsManager.dbo.fn_GetAlertDescription(av.AlertStringDescription,\
                                                           av.AlertParams) as description,\
        CASE av.ConnectorStatus\
            WHEN 0 THEN 'NotMarkedForForwarding'\
            WHEN 1 THEN 'Pending'\
            WHEN 2 THEN 'SuccessfullyForwarded'\
            END                                                            AS connectorstatus,\
        CASE av.MonitoringObjectHealthState\
            WHEN 0 THEN 'Uninitialized'\
            WHEN 1 THEN 'Success'\
            WHEN 2 THEN 'Warning'\
            WHEN 3 THEN 'Error'\
            END                                                            AS monitoringobjecthealthstate,\
        mgi.ManagementGroupName                                            as managementgroup,\
        LOWER(mgi.ManagementGroupId)                                       as managementgroupid\
 from OperationsManager.dbo.AlertView as av\
          CROSS JOIN (select ManagementGroupName, ManagementGroupId\
                      from OperationsManager.dbo.__MOMManagementGroupInfo__) mgi\
 WHERE av.TimeAdded > '2022-08-16 13:00:00.553'\
 order by av.TimeAdded;
sourcetype = microsoft:scom:alert
rising_column_index = 1

[msscom:alertshistory]
description = Collect alerts history data from MS SCOM
interval = 3600
mode = rising
index_time_mode = current
query = \
 /*\
  SPDX-FileCopyrightText: 2024 Splunk, Inc.\
  SPDX-License-Identifier: LicenseRef-Splunk-8-2021\
 */\
 SELECT ah.Timeadded                             as scom_timestamp,\
        ah.Comments                              as comments,\
        ah.ConnectorId                           as connectorid,\
        REPLACE(REPLACE(REPLACE(ah.Context, '<', '&lt;'), '>', '&gt;'), '"',\
                '&apos;')                        as context,\
        ah.CustomField1                          as customfield1,\
        ah.CustomField2                          as customfield2,\
        ah.CustomField3                          as customfield3,\
        ah.CustomField4                          as customfield4,\
        ah.CustomField5                          as customfield5,\
        ah.CustomField6                          as customfield6,\
        ah.CustomField7                          as customfield7,\
        ah.CustomField8                          as customfield8,\
        ah.CustomField9                          as customfield9,\
        ah.CustomField10                         as customfield10,\
        LOWER(ah.AlertHistoryId)                 as id,\
        ah.ModifiedBy                            as modifiedby,\
        LOWER(ah.AlertId)                        as monitoringalertid,\
        ah.Owner                                 as owner,\
        ah.ResolutionState                       as resolutionstate,\
        'get-scomalert | get-scomalerthistory'   as scom_command,\
        ah.TimeAdded                             as timeadded,\
        'alert'                                  as splunk_scom_group,\
        ah.TfsWorkItemId                         as tfsworkitemid,\
        ah.TfsWorkItemOwner                      as tfsworkitemowner,\
        ah.TicketId                              as ticketid,\
        ah.TimeModified                          as timemodified,\
        ah.TimeModifiedOffset                    as timemodifiedoffset,\
        ah.TimeResolutionStateLastModified       as timeresolutionstatelastmodified,\
        ah.TimeResolutionStateLastModifiedOffset as timeresolutionstatelastmodifiedoffset,\
        mgi.ManagementGroupName                  as managementgroup,\
        LOWER(mgi.ManagementGroupId)             as managementgroupid\
 from OperationsManager.dbo.AlertHistory ah\
          CROSS JOIN (select ManagementGroupName, ManagementGroupId\
                      from OperationsManager.dbo.__MOMManagementGroupInfo__) mgi\
 where ah.TimeAdded > '2022-09-01 06:51:29.413'\
 order by ah.TimeAdded;
sourcetype = microsoft:scom:alert
rising_column_index = 1
