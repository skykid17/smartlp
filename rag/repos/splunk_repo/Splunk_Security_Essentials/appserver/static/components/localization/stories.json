[
   {
      "author": "David Dorsey, Splunk",
      "date": "2017-09-06",
      "description": "A common attack technique is to leverage user accounts to gain unauthorized access to the target's network. This Analytic Story minimizes opportunities for attack by helping you actively manage creation/use/dormancy/deletion--the lifecycle of system and application accounts.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search identifies endpoints that have caused a relatively high number of account lockouts in a short period.",
            "how_to_implement": "You must ingest your Windows security event logs in the `Change` datamodel under the nodename is `Account_Management`, for this search to execute successfully. Please consider updating the cron schedule and the count of lockouts you want to monitor, according to your environment. \\\n **Splunk>Phantom Playbook Integration**\\\nIf Splunk>Phantom is also configured in your environment, a Playbook called \"Excessive Account Lockouts Enrichment and Response\" can be configured to run when any results are found by this detection search. The Playbook executes the Contextual and Investigative searches in this Story, conducts additional information gathering on Windows endpoints, and takes a response action to shut down the affected endpoint. To use this integration, install the Phantom App for Splunk `https://splunkbase.splunk.com/app/3411/`, add the correct hostname to the \"Phantom Instance\" field in the Adaptive Response Actions when configuring this detection search, and set the corresponding Playbook to active. \\\n(Playbook Link:`https://my.phantom.us/4.1/playbook/excessive-account-lockouts-enrichment-and-response/`).\\\n",
            "id": "c026e3dd-7e18-4abb-8f41-929e836efe74",
            "known_false_positives": "It's possible that a widely used system, such as a kiosk, could cause a large number of account lockouts.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_excessive_account_lockouts_from_endpoint_filter"
               }
            ],
            "name": "Detect Excessive Account Lockouts From Endpoint",
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Change.All_Changes where nodename=All_Changes.Account_Management All_Changes.result=\"lockout\" by All_Changes.dest All_Changes.result |`drop_dm_object_name(\"All_Changes\")` |`drop_dm_object_name(\"Account_Management\")`| `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search count > 5 | `detect_excessive_account_lockouts_from_endpoint_filter`",
            "tags": {
               "analytics_story": [
                  "Account Monitoring and Controls"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [
                  "Tropic Trooper",
                  "FIN10",
                  "Stolen Pencil",
                  "APT32"
               ],
               "mitre_attack_id": [
                  "T1078.003"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Local Accounts"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search detects user accounts that have been locked out a relatively high number of times in a short period.",
            "how_to_implement": "ou must ingest your Windows security event logs in the `Change` datamodel under the nodename is `Account_Management`, for this search to execute successfully. Please consider updating the cron schedule and the count of lockouts you want to monitor, according to your environment.",
            "id": "95a7f9a5-6096-437e-a19e-86f42ac609bd",
            "known_false_positives": "It is possible that a legitimate user is experiencing an issue causing multiple account login failures leading to lockouts.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_excessive_user_account_lockouts_filter"
               }
            ],
            "name": "Detect Excessive User Account Lockouts",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Change.All_Changes where nodename=All_Changes.Account_Management All_Changes.result=\"lockout\" by All_Changes.user All_Changes.result |`drop_dm_object_name(\"All_Changes\")` |`drop_dm_object_name(\"Account_Management\")`| `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search count > 5 | `detect_excessive_user_account_lockouts_filter`",
            "tags": {
               "analytics_story": [
                  "Account Monitoring and Controls"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [
                  "Tropic Trooper",
                  "FIN10",
                  "Stolen Pencil",
                  "APT32"
               ],
               "mitre_attack_id": [
                  "T1078.003"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Local Accounts"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-12",
            "description": "This detection search will help profile user accounts in your environment by identifying newly created accounts that have been added to your network in the past week.",
            "how_to_implement": "To successfully implement this search, you need to be populating the Enterprise Security Identity_Management data model in the assets and identity framework.",
            "id": "475b9e27-17e4-46e2-b7e2-648221be3b89",
            "known_false_positives": "If the Identity_Management data model is not updated regularly, this search could give you false positive alerts. Please consider this and investigate appropriately.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "identify_new_user_accounts_filter"
               }
            ],
            "name": "Identify New User Accounts",
            "references": [],
            "search": "| from datamodel Identity_Management.All_Identities  | eval empStatus=case((now()-startDate)<604800, \"Accounts created in last week\") | search empStatus=\"Accounts created in last week\"| `security_content_ctime(endDate)` | `security_content_ctime(startDate)`| table identity empStatus endDate startDate | `identify_new_user_accounts_filter`",
            "tags": {
               "analytics_story": [
                  "Account Monitoring and Controls"
               ],
               "asset_type": "Domain Server",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "APT3",
                  "Threat Group-1314"
               ],
               "mitre_attack_id": [
                  "T1078.002"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Domain Accounts"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-06",
            "description": "This search detects accounts that were created and deleted in a short time period.",
            "how_to_implement": "This search requires you to have enabled your Group Management Audit Logs in your Local Windows Security Policy and be ingesting those logs.  More information on how to enable them can be found here: http://whatevernetworks.com/auditing-group-membership-changes-in-active-directory/",
            "id": "b25f6f62-0782-43c1-b403-083231ffd97d",
            "known_false_positives": "It is possible that an administrator created and deleted an account in a short time period.  Verifying activity with an administrator is advised.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "short_lived_windows_accounts_filter"
               }
            ],
            "name": "Short Lived Windows Accounts",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(All_Changes.result_id) as result_id count min(_time) as firstTime max(_time) as lastTime from datamodel=Change where All_Changes.result_id=4720 OR All_Changes.result_id=4726 by _time span=4h All_Changes.user All_Changes.dest | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(\"All_Changes\")` | search result_id = 4720 result_id=4726 | transaction user connected=false maxspan=240m | table firstTime lastTime count user dest result_id | `short_lived_windows_accounts_filter`",
            "tags": {
               "analytics_story": [
                  "Account Monitoring and Controls"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "APT41",
                  "Dragonfly 2.0",
                  "Leafminer",
                  "APT3"
               ],
               "mitre_attack_id": [
                  "T1136.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Local Account"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "8892a655-6205-55f7-abba-06460e38c8ae",
      "name": "Account Monitoring and Controls",
      "narrative": "Monitoring user accounts within your enterprise is a critical analytic function that helps ensure that credential and access policies/procedures are properly implemented and are being enforced. Proactive ad-hoc hunting, as well as routine monitoring, can ensure user or system accounts are not being abused by unauthorized individuals or processes. In the event of a network event or breach, user-authentication logs are a key resource in determining if or how an account might have been compromised or co-opted, leading to suspicious or malicious activity.",
      "references": [],
      "tags": {
         "analytics_story": "Account Monitoring and Controls",
         "category": [
            "Best Practices"
         ],
         "mitre_attack_groups": [
            "Stolen Pencil",
            "Leafminer",
            "APT32",
            "FIN10",
            "APT41",
            "Tropic Trooper",
            "Threat Group-1314",
            "TA505",
            "APT3",
            "Dragonfly 2.0",
            "APT39"
         ],
         "mitre_attack_id": [
            "T1136.001",
            "T1078.002",
            "T1078.003"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Local Accounts",
            "Local Account",
            "Domain Accounts"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2018-12-06",
      "description": "Detect and investigate activities--such as unusually long `Content-Type` length, suspicious java classes and web servers executing suspicious processes--consistent with attempts to exploit Apache Struts vulnerabilities.",
      "detections": [
         {
            "author": "Jose Hernandez, Splunk",
            "date": "2018-12-06",
            "description": "This search looks for suspicious Java classes that are often used to exploit remote command execution in common Java frameworks, such as Apache Struts.",
            "how_to_implement": "In order to properly run this search, Splunk needs to ingest data from your web-traffic appliances that serve or sit in the path of your Struts application servers. This can be accomplished by indexing data from a web proxy, or by using network traffic-analysis tools, such as Splunk Stream or Bro.",
            "id": "if1fea6da-3c86-4c1d-b255-fc3b2781a491",
            "known_false_positives": "There are no known false positives.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=stream:http",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "stream_http"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_java_classes_filter"
               }
            ],
            "name": "Suspicious Java Classes",
            "references": [],
            "search": "`stream_http` http_method=POST http_content_length>1 | regex form_data=\"(?i)java\\.lang\\.(?:runtime|processbuilder)\" | rename src_ip as src | stats count earliest(_time) as firstTime, latest(_time) as lastTime, values(url) as uri, values(status) as status, values(http_user_agent) as http_user_agent by src, dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `suspicious_java_classes_filter`",
            "tags": {
               "analytics_story": [
                  "Apache Struts Vulnerability"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.AE"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-10-13",
            "description": "This search looks for unusually long strings in the Content-Type http header that the client sends the server.",
            "how_to_implement": "This particular search leverages data extracted from Stream:HTTP. You must configure the http stream using the Splunk Stream App on your Splunk Stream deployment server to extract the cs_content_type field.",
            "id": "57a0a2bf-353f-40c1-84dc-29293f3c35b7",
            "known_false_positives": "Very few legitimate Content-Type fields will have a length greater than 100 characters.",
            "macros": [
               {
                  "definition": "sourcetype=stream:http",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "stream_http"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unusually_long_content_type_length_filter"
               }
            ],
            "name": "Unusually Long Content-Type Length",
            "references": [],
            "search": "`stream_http` | eval cs_content_type_length = len(cs_content_type) | where cs_content_type_length > 100 | table endtime src_ip dest_ip cs_content_type_length cs_content_type url | `unusually_long_content_type_length_filter`",
            "tags": {
               "analytics_story": [
                  "Apache Struts Vulnerability"
               ],
               "asset_type": "Web Server",
               "cis20": [
                  "CIS 3",
                  "CIS 4",
                  "CIS 18",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.RA",
                  "RS.MI",
                  "PR.PT",
                  "PR.IP",
                  "DE.AE",
                  "PR.MA",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2019-04-01",
            "description": "This search looks for suspicious processes on all systems labeled as web servers.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model. In addition, web servers will need to be identified in the Assets and Identity Framework of Enterprise Security.",
            "id": "ec3b7601-689a-4463-94e0-c9f45638efb9",
            "known_false_positives": "Some of these processes may be used legitimately on web servers during maintenance or other administrative tasks.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "web_servers_executing_suspicious_processes_filter"
               }
            ],
            "name": "Web Servers Executing Suspicious Processes",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.dest_category=\"web_server\" AND (Processes.process=\"*whoami*\" OR Processes.process=\"*ping*\" OR Processes.process=\"*iptables*\" OR Processes.process=\"*wget*\" OR Processes.process=\"*service*\" OR Processes.process=\"*curl*\") by Processes.process Processes.process_name, Processes.dest Processes.user| `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `web_servers_executing_suspicious_processes_filter`",
            "tags": {
               "analytics_story": [
                  "Apache Struts Vulnerability"
               ],
               "asset_type": "Web Server",
               "cis20": [
                  "CIS 3"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Sandworm Team",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "Inception",
                  "Kimsuky",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "Honeybee",
                  "APT19",
                  "APT37",
                  "APT32",
                  "Magic Hound",
                  "OilRig",
                  "APT3",
                  "Sowbug",
                  "Gamaredon Group",
                  "Patchwork",
                  "Stealth Falcon",
                  "Lazarus Group",
                  "admin@338",
                  "Turla",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1082"
               ],
               "mitre_attack_tactics": [
                  "Discovery"
               ],
               "mitre_attack_technique": [
                  "System Information Discovery"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "2dcfd6a2-e7d2-4873-b6ba-adaf819d2a1e",
      "name": "Apache Struts Vulnerability",
      "narrative": "In March of 2017, a remote code-execution vulnerability in the Jakarta Multipart parser in Apache Struts, a widely used open-source framework for creating Java web applications, was disclosed and assigned to CVE-2017-5638. About two months later, hackers exploited the flaw to carry out the world's <a href=https://www.usatoday.com/story/tech/2017/09/07/nations-biggest-hacks-and-data-breaches-millions/644311001/> 5th largest data breach</a>. The target, credit giant Equifax, <a href=https://money.cnn.com/2017/09/16/technology/equifax-breach-security-hole/index.html>told investigators</a> that it had become aware of the vulnerability two months before the attack. \\\nThe exploit involved manipulating the `Content-Type HTTP` header to execute commands embedded in the header.\\\nThis Analytic Story contains two different searches that help to identify activity that may be related to this issue. The first search looks for characteristics of the `Content-Type` header consistent with attempts to exploit the vulnerability. This should be a relatively pertinent indicator, as the `Content-Type` header is generally consistent and does not have a large degree of variation.\\\nThe second search looks for the execution of various commands typically entered on the command shell when an attacker first lands on a system. These commands are not generally executed on web servers during the course of day-to-day operation, but they may be used when the system is undergoing maintenance or troubleshooting.\\\nFirst, it is helpful is to understand how often the notable event is generated, as well as the commonalities in some of these events. This may help determine whether this is a common occurrence that is of a lesser concern or a rare event that may require more extensive investigation. It can also help to understand whether the issue is restricted to a single user or system or is broader in scope.\\\nhen looking at the target of the behavior illustrated by the event, you should note the sensitivity of the user and or/system to help determine the potential impact. It is also helpful to see what other events involving the target have occurred in the recent past. This can help tie different events together and give further situational awareness regarding the target.\\\nVarious types of information for external systems should be reviewed and (potentially) collected if the incident is, indeed, judged to be malicious. Information like this can be useful in generating your own threat intelligence to create alerts in the future.\\\nLooking at the country, responsible party, and fully qualified domain names associated with the external IP address--as well as the registration information associated with those domain names, if they are frequently visited by others--can help you answer the question of \"who,\" in regard to the external system. Answering that can help qualify the event and may serve useful for tracking. In addition, there are various sources that can provide some reputation information on the IP address or domain name, which can assist in determining if the event is malicious in nature. Finally, determining whether or not there are other events associated with the IP address may help connect some dots or show other events that should be brought into scope.\\\nGathering various data elements on the system of interest can sometimes help quickly determine that something suspicious may be happening. Some of these items include determining who else may have recently logged into the system, whether any unusual scheduled tasks exist, whether the system is communicating on suspicious ports, whether there are modifications to sensitive registry keys, and whether there are any known vulnerabilities on the system. This information can often highlight other activity commonly seen in attack scenarios or give more information about how the system may have been targeted.\\\nhen a specific service or application is targeted, it is often helpful to know the associated version to help determine whether or not it is vulnerable to a specific exploit.\\\nhen it is suspected there is an attack targeting a web server, it is helpful to look at some of the behavior of the web service to see if there is evidence that the service has been compromised. Some indications of this might be network connections to external resources, the web service spawning child processes that are not associated with typical behavior, and whether the service wrote any files that might be malicious in nature.\\\nIn the event that a suspicious file is found, we can review more information about it to help determine if it is, in fact, malicious. Identifying the file type, any processes that have the file open, what processes created and/or modified the file, and the number of systems that may have this file can help to determine if the file is malicious. Also, determining the file hash and checking it against reputation sources, such as VirusTotal, can sometimes quickly help determine whether it is malicious in nature.\\\nOften, a simple inspection of a suspect process name and path can tell you if the system has been compromised. For example, if `svchost.exe` is found running from a location other than `C:\\Windows\\System32`, it is likely something malicious designed to hide in plain sight when simply reviewing process names. Similarly, if the process itself seems legitimate, but the parent process is running from the temporary browser cache, there may be activity initiated via a compromised website the user visited.\\\nIt can also be very helpful to examine various behaviors of the process of interest or the parent of the process that is of interest. For example, if it turns out that the process of interest is malicious, it would be good to see if the parent to that process spawned other processes that might also be worth further scrutiny. If a process is suspect, reviewing the network connections made around the time of the event and/or if the process spawned any child processes could be helpful in determining whether it is malicious or executing a malicious script.",
      "references": [
         "https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/v3.2/dev/rules/REQUEST-944-APPLICATION-ATTACK-JAVA.conf"
      ],
      "tags": {
         "analytics_story": "Apache Struts Vulnerability",
         "category": [
            "Vulnerability"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "Sowbug",
            "Turla",
            "Inception",
            "Kimsuky",
            "admin@338",
            "OilRig",
            "APT32",
            "APT19",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Lazarus Group",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "Rocke",
            "Blue Mockingbird",
            "APT18",
            "Tropic Trooper",
            "Patchwork",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1082"
         ],
         "mitre_attack_tactics": [
            "Discovery"
         ],
         "mitre_attack_technique": [
            "System Information Discovery"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2017-09-13",
      "description": "Keep a careful inventory of every asset on your network to make it easier to detect rogue devices. Unauthorized/unmanaged devices could be an indication of malicious behavior that should be investigated further.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2017-09-13",
                  "description": "This search shows you every asset category you have and the assets that belong to those categories.",
                  "how_to_implement": "To successfully implement this search you must first leverage the Assets and Identity framework in Enterprise Security to populate your assets_by_str.csv file which should then be mapped to the Identity_Management data model. The Identity_Management data model will contain a list of known authorized company assets. Ensure that all inventoried systems are constantly vetted and updated.",
                  "id": "dcfd6b40-42f9-469d-a433-2e53f7489ff9",
                  "name": "Count of assets by category",
                  "search": "| from datamodel Identity_Management.All_Assets | stats count values(nt_host) by category | sort -count",
                  "tags": {
                     "analytics_story": [
                        "Asset Tracking"
                     ],
                     "detections": [
                        "Detect Unauthorized Assets by MAC address"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2017-09-13",
            "description": "By populating the organization's assets within the assets_by_str.csv, we will be able to detect unauthorized devices that are trying to connect with the organization's network by inspecting DHCP request packets, which are issued by devices when they attempt to obtain an IP address from the DHCP server. The MAC address associated with the source of the DHCP request is checked against the list of known devices, and reports on those that are not found.",
            "how_to_implement": "This search uses the Network_Sessions data model shipped with Enterprise Security. It leverages the Assets and Identity framework to populate the assets_by_str.csv file located in SA-IdentityManagement, which will contain a list of known authorized organizational assets including their MAC addresses. Ensure that all inventoried systems have their MAC address populated.",
            "id": "dcfd6b40-42f9-469d-a433-2e53f7489ff4",
            "known_false_positives": "This search might be prone to high false positives. Please consider this when conducting analysis or investigations. Authorized devices may be detected as unauthorized. If this is the case, verify the MAC address of the system responsible for the false positive and add it to the Assets and Identity framework with the proper information.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_unauthorized_assets_by_mac_address_filter"
               }
            ],
            "name": "Detect Unauthorized Assets by MAC address",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Sessions where nodename=All_Sessions.DHCP All_Sessions.signature=DHCPREQUEST by All_Sessions.src_ip All_Sessions.src_mac | dedup All_Sessions.src_mac| `drop_dm_object_name(\"Network_Sessions\")`|`drop_dm_object_name(\"All_Sessions\")` | search NOT [| inputlookup asset_lookup_by_str |rename mac as src_mac | fields + src_mac] | `detect_unauthorized_assets_by_mac_address_filter`",
            "tags": {
               "analytics_story": [
                  "Asset Tracking"
               ],
               "asset_type": "Infrastructure",
               "cis20": [
                  "CIS 1"
               ],
               "kill_chain_phases": [
                  "Reconnaissance",
                  "Delivery",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "91c676cf-0b23-438d-abee-f6335e1fce77",
      "name": "Asset Tracking",
      "narrative": "This Analytic Story is designed to help you develop a better understanding of what authorized and unauthorized devices are part of your enterprise. This story can help you better categorize and classify assets, providing critical business context and awareness of their assets during an incident. Information derived from this Analytic Story can be used to better inform and support other analytic stories. For successful detection, you will need to leverage the Assets and Identity Framework from Enterprise Security to populate your known assets.",
      "references": [
         "https://www.cisecurity.org/controls/inventory-of-authorized-and-unauthorized-devices/"
      ],
      "tags": {
         "analytics_story": "Asset Tracking",
         "category": [
            "Best Practices"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2018-06-04",
      "description": "Track when a user assumes an IAM role in another AWS account to obtain cross-account access to services and resources in that account. Accessing new roles could be an indication of malicious activity.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-06-04",
                  "description": "This search looks for **AssumeRole** events where the requesting account differs from the requested account, then writes these relationships to a lookup file.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Validate the user name entries in `previously_seen_aws_cross_account_activity.csv`, a lookup file created by this support search.",
                  "id": "1cc22b09-c867-416e-a511-cb36ac44aee2",
                  "name": "Previously Seen AWS Cross Account Activity",
                  "search": "`cloudtrail` eventName=AssumeRole | spath output=requestingAccountId path=userIdentity.accountId | spath output=requestedAccountId path=resources{}.accountId | search requestingAccountId=* | where requestingAccountId!=requestedAccountId | stats earliest(_time) as firstTime latest(_time) as lastTime by requestingAccountId, requestedAccountId | outputlookup previously_seen_aws_cross_account_activity | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Cross Account Activity"
                     ],
                     "detections": [
                        "AWS Cross Account Activity From Previously Unseen Account"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for AssumeRole events where an IAM role in a different account is requested for the first time.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the `Previously Seen AWS Cross Account Activity` support search only once to create the baseline of previously seen cross account activity. Thanks to Pablo Vega at Recurly for suggesting improvements to the search.",
            "id": "64fbbddf-fabf-4edf-80b3-0cc36ef37727",
            "known_false_positives": "Using multiple AWS accounts and roles is perfectly valid behavior. It's suspicious when an account requests privileges of an account it hasn't before. You should validate with the account owner that this is a legitimate request.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_cross_account_activity_from_previously_unseen_account_filter"
               }
            ],
            "name": "AWS Cross Account Activity From Previously Unseen Account",
            "references": [],
            "search": "`cloudtrail` eventName=AssumeRole | spath output=requestingAccountId path=userIdentity.accountId | spath output=requestedAccountId path=resources{}.accountId | search requestingAccountId=* | where requestingAccountId != requestedAccountId | inputlookup append=t previously_seen_aws_cross_account_activity | multireport [| stats min(eval(coalesce(firstTime, _time))) as firstTime max(eval(coalesce(lastTime, _time))) as lastTime by requestingAccountId, requestedAccountId | outputlookup previously_seen_aws_cross_account_activity | where fact=fiction] [| eventstats min(eval(coalesce(firstTime, _time))) as firstTime, max(eval(coalesce(lastTime, _time))) as lastTime by requestingAccountId, requestedAccountId | where firstTime >= relative_time(now(), \"-70m@m\") AND isnotnull(_time) | spath output=accessKeyId path=responseElements.credentials.accessKeyId | spath output=requestingARN path=resources{}.ARN | stats values(awsRegion) as awsRegion values(firstTime) as firstTime values(lastTime) as lastTime values(sharedEventID) as sharedEventID, values(requestingARN) as src_user, values(responseElements.assumedRoleUser.arn) as dest_user by _time, requestingAccountId, requestedAccountId, accessKeyId] | table _time, firstTime, lastTime, src_user, requestingAccountId, dest_user, requestedAccountId, awsRegion, accessKeyId, sharedEventID | `aws_cross_account_activity_from_previously_unseen_account_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cross Account Activity"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "PR.AC",
                  "PR.DS",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-27",
            "description": "This search provides detection of an user attaching itself to a different role trust policy. This can be used for lateral movement and escalation of privileges.",
            "how_to_implement": "You must install splunk AWS add-on and Splunk App for AWS. This search works with cloudwatch logs",
            "id": "88fc31dd-f331-448c-9856-d3d51dd5d3a1",
            "known_false_positives": "Attach to policy can create a lot of noise. This search can be adjusted to provide specific values to identify cases of abuse (i.e status=failure). The search can provide context for common users attaching themselves to higher privilege policies or even newly created policies.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_detect_attach_to_role_policy_filter"
               }
            ],
            "name": "aws detect attach to role policy",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` attach policy| spath requestParameters.policyArn | table sourceIPAddress user_access_key userIdentity.arn userIdentity.sessionContext.sessionIssuer.arn eventName errorCode errorMessage status action requestParameters.policyArn userIdentity.sessionContext.attributes.mfaAuthenticated userIdentity.sessionContext.attributes.creationDate  | `aws_detect_attach_to_role_policy_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cross Account Activity"
               ],
               "asset_type": "AWS Account",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-27",
            "description": "This search provides detection of accounts creating permanent keys. Permanent keys are not created by default and they are only needed for programmatic calls. Creation of Permanent key is an important event to monitor.",
            "how_to_implement": "You must install splunk AWS add on and Splunk App for AWS. This search works with cloudwatch logs",
            "id": "12d6d713-3cb4-4ffc-a064-1dca3d1cca01",
            "known_false_positives": "Not all permanent key creations are malicious. If there is a policy of rotating keys this search can be adjusted to provide better context.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_detect_permanent_key_creation_filter"
               }
            ],
            "name": "aws detect permanent key creation",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` AKIA | spath eventName | search eventName=CreateAccessKey \"userIdentity.type!=AssumedRole\" | table sourceIPAddress userName src_user userIdentity.type userAgent action status responseElements.accessKey.createDate responseElements.accessKey.status responseElements.accessKey.accessKeyId |`aws_detect_permanent_key_creation_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cross Account Activity"
               ],
               "asset_type": "AWS Account",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-27",
            "description": "This search provides detection of role creation by IAM users. Role creation is an event by itself if user is creating a new role with trust policies different than the available in AWS and it can be used for lateral movement and escalation of privileges.",
            "how_to_implement": "You must install splunk AWS add-on and Splunk App for AWS. This search works with cloudwatch logs",
            "id": "5f04081e-ddee-4353-afe4-504f288de9ad",
            "known_false_positives": "CreateRole is not very common in common users. This search can be adjusted to provide specific values to identify cases of abuse. In general AWS provides plenty of trust policies that fit most use cases.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_detect_role_creation_filter"
               }
            ],
            "name": "aws detect role creation",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` event_name=CreateRole action=created userIdentity.type=AssumedRole requestParameters.description=Allows | table sourceIPAddress userIdentity.principalId userIdentity.arn action event_name awsRegion http_user_agent mfa_auth msg requestParameters.roleName requestParameters.description responseElements.role.arn responseElements.role.createDate | `aws_detect_role_creation_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cross Account Activity"
               ],
               "asset_type": "AWS Account",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-27",
            "description": "This search provides detection of suspicious use of sts:AssumeRole. These tokens can be created on the go and used by attackers to move laterally and escalate privileges.",
            "how_to_implement": "You must install splunk AWS add on and Splunk App for AWS. This search works with cloudwatch logs",
            "id": "8e565314-b6a2-46d8-9f05-1a34a176a662",
            "known_false_positives": "Sts:AssumeRole can be very noisy as it is a standard mechanism to provide cross account and cross resources access. This search can be adjusted to provide specific values to identify cases of abuse.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_detect_sts_assume_role_abuse_filter"
               }
            ],
            "name": "aws detect sts assume role abuse",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` ASIA AssumeRole userIdentity.sessionContext.sessionIssuer.type=Role | table sourceIPAddress userIdentity.arn user_agent user_access_key status action requestParameters.roleName responseElements.role.roleName responseElements.role.createDate | `aws_detect_sts_assume_role_abuse_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cross Account Activity"
               ],
               "asset_type": "AWS Account",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-27",
            "description": "This search provides detection of suspicious use of sts:GetSessionToken. These tokens can be created on the go and used by attackers to move laterally and escalate privileges.",
            "how_to_implement": "You must install splunk AWS add-on and Splunk App for AWS. This search works with cloudwatch logs",
            "id": "85d7b35f-b8b5-4b01-916f-29b81e7a0551",
            "known_false_positives": "Sts:GetSessionToken can be very noisy as in certain environments numerous calls of this type can be executed. This search can be adjusted to provide specific values to identify cases of abuse. In specific environments the use of field requestParameters.serialNumber will need to be used.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_detect_sts_get_session_token_abuse_filter"
               }
            ],
            "name": "aws detect sts get session token abuse",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` ASIA  userIdentity.type=IAMUser| spath eventName | search eventName=GetSessionToken | table sourceIPAddress eventTime userIdentity.arn userName userAgent user_type status region | `aws_detect_sts_get_session_token_abuse_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cross Account Activity"
               ],
               "asset_type": "AWS Account",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "2f2f610a-d64d-48c2-b57c-967a2b49ab5a",
      "name": "AWS Cross Account Activity",
      "narrative": "Amazon Web Services (AWS) admins manage access to AWS resources and services across the enterprise using AWS's Identity and Access Management (IAM) functionality. IAM provides the ability to create and manage AWS users, groups, and roles-each with their own unique set of privileges and defined access to specific resources (such as EC2 instances, the AWS Management Console, API, or the command-line interface). Unlike conventional (human) users, IAM roles are assumable by anyone in the organization. They provide users with dynamically created temporary security credentials that expire within a set time period.\\\nHerein lies the rub. In between the time between when the temporary credentials are issued and when they expire is a period of opportunity, where a user could leverage the temporary credentials to wreak havoc-spin up or remove instances, create new users, elevate privileges, and other malicious activities-throughout the environment.\\\nThis Analytic Story includes searches that will help you monitor your AWS CloudTrail logs for evidence of suspicious cross-account activity.  For example, while accessing multiple AWS accounts and roles may be perfectly valid behavior, it may be suspicious when an account requests privileges of an account it has not accessed in the past. After identifying suspicious activities, you can use the provided investigative searches to help you probe more deeply.",
      "references": [
         "https://aws.amazon.com/blogs/security/aws-cloudtrail-now-tracks-cross-account-activity-to-its-origin/"
      ],
      "tags": {
         "analytics_story": "AWS Cross Account Activity",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "APT33"
         ],
         "mitre_attack_id": [
            "T1078.004"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Cloud Accounts"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2018-03-08",
      "description": "Monitor your AWS EC2 instances for activities related to cryptojacking/cryptomining. New instances that originate from previously unseen regions, users who launch abnormally high numbers of instances, or EC2 instances started by previously unseen users are just a few examples of potentially malicious behavior.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for CloudTrail events where a user successfully launches an abnormally high number of instances.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. The threshold value should be tuned to your environment.",
            "id": "2a9b80d3-6340-4345-b5ad-290bf5d0dac4",
            "known_false_positives": "Many service accounts configured within an AWS infrastructure are known to exhibit this behavior. Please adjust the threshold values and filter out service accounts from the output. Always verify if this search alerted on a human user.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "abnormally_high_aws_instances_launched_by_user_filter"
               }
            ],
            "name": "Abnormally High AWS Instances Launched by User",
            "references": [],
            "search": "`cloudtrail` eventName=RunInstances errorCode=success | bucket span=10m _time | stats count AS instances_launched by _time userName | eventstats avg(instances_launched) as total_launched_avg, stdev(instances_launched) as total_launched_stdev | eval threshold_value = 4 | eval isOutlier=if(instances_launched > total_launched_avg+(total_launched_stdev * threshold_value), 1, 0) | search isOutlier=1 AND _time >= relative_time(now(), \"-10m@m\") | eval num_standard_deviations_away = round(abs(instances_launched - total_launched_avg) / total_launched_stdev, 2) | table _time, userName, instances_launched, num_standard_deviations_away, total_launched_avg, total_launched_stdev | `abnormally_high_aws_instances_launched_by_user_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cryptomining",
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-01-08",
                  "description": "This search looks for CloudTrail events where an AWS instance is started and creates a baseline of most recent time (latest) and the first time (earliest) we've seen this region in our dataset grouped by the value awsRegion for the last 30 days",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd63",
                  "name": "Previously Seen AWS Regions",
                  "search": "`cloudtrail` StartInstances | stats earliest(_time) as earliest latest(_time) as latest by awsRegion | outputlookup previously_seen_aws_regions.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Cryptomining",
                        "Suspicious AWS EC2 Activities"
                     ],
                     "detections": [
                        "EC2 Instance Started In Previously Unseen Region"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-02-23",
            "description": "This search looks for CloudTrail events where an instance is started in a particular region in the last one hour and then compares it to a lookup file of previously seen regions where an instance was started",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the \"Previously seen AWS Regions\" support search only once to create of baseline of previously seen regions.",
            "id": "ada0f478-84a8-4641-a3f3-d82362d6fd75",
            "known_false_positives": "It's possible that a user has unknowingly started an instance in a new region. Please verify that this activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "ec2_instance_started_in_previously_unseen_region_filter"
               }
            ],
            "name": "EC2 Instance Started In Previously Unseen Region",
            "references": [],
            "search": "`cloudtrail` earliest=-1h StartInstances | stats earliest(_time) as earliest latest(_time) as latest by awsRegion | inputlookup append=t previously_seen_aws_regions.csv | stats min(earliest) as earliest max(latest) as latest by awsRegion | outputlookup previously_seen_aws_regions.csv | eval regionStatus=if(earliest >= relative_time(now(),\"-1d@d\"), \"Instance Started in a New Region\",\"Previously Seen Region\") | `security_content_ctime(earliest)` | `security_content_ctime(latest)` | where regionStatus=\"Instance Started in a New Region\" | `ec2_instance_started_in_previously_unseen_region_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cryptomining",
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-12",
                  "description": "This search builds a table of previously seen AMIs used to launch EC2 instances",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "bb1bd99d-1e93-45f1-9571-cfed42d372b9",
                  "name": "Previously Seen EC2 AMIs",
                  "search": "`cloudtrail` eventName=RunInstances errorCode=success | rename requestParameters.instancesSet.items{}.imageId as amiID | stats earliest(_time) as firstTime latest(_time) as lastTime by amiID | outputlookup previously_seen_ec2_amis.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Cryptomining"
                     ],
                     "detections": [
                        "EC2 Instance Started With Previously Unseen AMI"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-03-12",
            "description": "This search looks for EC2 instances being created with previously unseen AMIs.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously Seen EC2 AMIs\" support search once to create a history of previously seen AMIs.",
            "id": "347ec301-601b-48b9-81aa-9ddf9c829dd3",
            "known_false_positives": "After a new AMI is created, the first systems created with that AMI will cause this alert to fire.  Verify that the AMI being used was created by a legitimate user.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "ec2_instance_started_with_previously_unseen_ami_filter"
               }
            ],
            "name": "EC2 Instance Started With Previously Unseen AMI",
            "references": [],
            "search": "`cloudtrail` eventName=RunInstances [search `cloudtrail` eventName=RunInstances errorCode=success | stats earliest(_time) as firstTime latest(_time) as lastTime by requestParameters.instancesSet.items{}.imageId | rename requestParameters.instancesSet.items{}.imageId as amiID | inputlookup append=t previously_seen_ec2_amis.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by amiID | outputlookup previously_seen_ec2_amis.csv | eval newAMI=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)` | where newAMI=1 | rename amiID as requestParameters.instancesSet.items{}.imageId | table requestParameters.instancesSet.items{}.imageId] | rename requestParameters.instanceType as instanceType, responseElements.instancesSet.items{}.instanceId as dest, userIdentity.arn as arn, requestParameters.instancesSet.items{}.imageId as amiID | table firstTime, lastTime, arn, amiID, dest, instanceType | `ec2_instance_started_with_previously_unseen_ami_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cryptomining"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-08",
                  "description": "This search builds a table of previously seen EC2 instance types",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "b8f029f2-65a6-4d76-be98-dad1c9d59c45",
                  "name": "Previously Seen EC2 Instance Types",
                  "search": "`cloudtrail` eventName=RunInstances errorCode=success | rename requestParameters.instanceType as instanceType | fillnull value=\"m1.small\" instanceType | stats earliest(_time) as earliest latest(_time) as latest by instanceType | outputlookup previously_seen_ec2_instance_types.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Cryptomining"
                     ],
                     "detections": [
                        "EC2 Instance Started With Previously Unseen Instance Type"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-02-07",
            "description": "This search looks for EC2 instances being created with previously unseen instance types.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously Seen EC2 Instance Types\" support search once to create a history of previously seen instance types.",
            "id": "65541c80-03c7-4e05-83c8-1dcd57a2e1ad",
            "known_false_positives": "It is possible that an admin will create a new system using a new instance type never used before. Verify with the creator that they intended to create the system with the new instance type.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "ec2_instance_started_with_previously_unseen_instance_type_filter"
               }
            ],
            "name": "EC2 Instance Started With Previously Unseen Instance Type",
            "references": [],
            "search": "`cloudtrail` eventName=RunInstances [search `cloudtrail` eventName=RunInstances errorCode=success | fillnull value=\"m1.small\" requestParameters.instanceType | stats earliest(_time) as earliest latest(_time) as latest by requestParameters.instanceType | rename requestParameters.instanceType as instanceType | inputlookup append=t previously_seen_ec2_instance_types.csv | stats min(earliest) as earliest max(latest) as latest by instanceType | outputlookup previously_seen_ec2_instance_types.csv | eval newType=if(earliest >= relative_time(now(), \"-70m@m\"), 1, 0) | `security_content_ctime(earliest)` | `security_content_ctime(latest)` | where newType=1 | rename instanceType as requestParameters.instanceType | table requestParameters.instanceType] | spath output=user userIdentity.arn | rename requestParameters.instanceType as instanceType, responseElements.instancesSet.items{}.instanceId as dest | table _time, user, dest, instanceType | `ec2_instance_started_with_previously_unseen_instance_type_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cryptomining"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-15",
                  "description": "This search builds a table of previously seen ARNs that have launched a EC2 instance.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "6c767ac0-0906-4355-9a83-927f5ee7bdad",
                  "name": "Previously Seen EC2 Launches By User",
                  "search": "`cloudtrail` eventName=RunInstances errorCode=success | rename userIdentity.arn as arn | stats earliest(_time) as firstTime latest(_time) as lastTime by arn | outputlookup previously_seen_ec2_launches_by_user.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Cryptomining",
                        "Suspicious AWS EC2 Activities"
                     ],
                     "detections": [
                        "EC2 Instance Started With Previously Unseen User"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for EC2 instances being created by users who have not created them before.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously Seen EC2 Launches By User\" support search once to create a history of previously seen ARNs.",
            "id": "22773e84-bac0-4595-b086-20d3f735b4f1",
            "known_false_positives": "It's possible that a user will start to create EC2 instances when they haven't before for any number of reasons. Verify with the user that is launching instances that this is the intended behavior.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "ec2_instance_started_with_previously_unseen_user_filter"
               }
            ],
            "name": "EC2 Instance Started With Previously Unseen User",
            "references": [],
            "search": "`cloudtrail` eventName=RunInstances [search `cloudtrail` eventName=RunInstances errorCode=success | stats earliest(_time) as firstTime latest(_time) as lastTime by userIdentity.arn | rename userIdentity.arn as arn | inputlookup append=t previously_seen_ec2_launches_by_user.csv | stats min(firstTime) as firstTime, max(lastTime) as lastTime by arn | outputlookup previously_seen_ec2_launches_by_user.csv | eval newUser=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newUser=1 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename arn as userIdentity.arn | table userIdentity.arn] | rename requestParameters.instanceType as instanceType, responseElements.instancesSet.items{}.instanceId as dest, userIdentity.arn as user | table _time, user, dest, instanceType | `ec2_instance_started_with_previously_unseen_user_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cryptomining",
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "ced74200-8465-4bc3-bd2c-9a782eec6750",
      "name": "AWS Cryptomining",
      "narrative": "Cryptomining is an intentionally difficult, resource-intensive business. Its complexity was designed into the process to ensure that the number of blocks mined each day would remain steady. So, it's par for the course that ambitious, but unscrupulous, miners make amassing the computing power of large enterprises--a practice known as cryptojacking--a top priority. \\\nCryptojacking has attracted an increasing amount of media attention since its explosion in popularity in the fall of 2017. The attacks have moved from in-browser exploits and mobile phones to enterprise cloud services, such as Amazon Web Services (AWS). It's difficult to determine exactly how widespread the practice has become, since bad actors continually evolve their ability to escape detection, including employing unlisted endpoints, moderating their CPU usage, and hiding the mining pool's IP address behind a free CDN. \\\nhen malicious miners appropriate a cloud instance, often spinning up hundreds of new instances, the costs can become astronomical for the account holder. So, it is critically important to monitor your systems for suspicious activities that could indicate that your network has been infiltrated. \\\nThis Analytic Story is focused on detecting suspicious new instances in your EC2 environment to help prevent such a disaster. It contains detection searches that will detect when a previously unused instance type or AMI is used. It also contains support searches to build lookup files to ensure proper execution of the detection searches.",
      "references": [
         "https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf"
      ],
      "tags": {
         "analytics_story": "AWS Cryptomining",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "APT33",
            "no"
         ],
         "mitre_attack_id": [
            "T1535",
            "T1078.004"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Cloud Accounts",
            "Unused/Unsupported Cloud Regions"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2018-05-21",
      "description": "Monitor your AWS network infrastructure for bad configurations and malicious activity. Investigative searches help you probe deeper, when the facts warrant it.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-01-10",
            "description": "The search looks for CloudTrail events to detect if any network ACLs were created with all the ports open to a specified CIDR.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS, version 4.4.0 or later, and configure your CloudTrail inputs.",
            "id": "ada0f478-84a8-4641-a3f1-d82362d6bd75",
            "known_false_positives": "It's possible that an admin has created this ACL with all ports open for some legitimate purpose however, this should be scoped and not allowed in production environment.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_network_access_control_list_created_with_all_open_ports_filter"
               }
            ],
            "name": "AWS Network Access Control List Created with All Open Ports",
            "references": [],
            "search": "`cloudtrail` eventName=CreateNetworkAclEntry | mvexpand requestParameters | mvexpand responseElements | search requestParameters.portRange.from=1024 requestParameters.portRange.to=65535 requestParameters.ruleAction=allow | rename userIdentity.arn as arn | rename requestParameters.networkAclId as networkAclId | table _time aws_account_id src userName arn networkAclId requestParameters.* responseElements.* | `aws_network_access_control_list_created_with_all_open_ports_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Network ACL Activity"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 11"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-01-10",
            "description": "Enforcing network-access controls is one of the defensive mechanisms used by cloud administrators to restrict access to a cloud instance. After the attacker has gained control of the AWS console by compromising an admin account, they can delete a network ACL and gain access to the instance from anywhere. This search will query the CloudTrail logs to detect users deleting network ACLs.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs.",
            "id": "ada0f478-84a8-4641-a3f1-d82362d6fd75",
            "known_false_positives": "It's possible that a user has legitimately deleted a network ACL.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_network_access_control_list_deleted_filter"
               }
            ],
            "name": "AWS Network Access Control List Deleted",
            "references": [],
            "search": "`cloudtrail` eventName=DeleteNetworkAcl|rename userIdentity.arn as arn  | stats count min(_time) as firstTime max(_time) as lastTime values(errorMessage) values(errorCode) values(userAgent) values(userIdentity.*) by src userName arn eventName | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `aws_network_access_control_list_deleted_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Network ACL Activity"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 11"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-05-07",
                  "description": "This search establishes, on a per-hour basis, the average and the standard deviation of the number of outbound connections blocked in your VPC flow logs by each source IP address (IP address of your EC2 instances). Also recorded is the number of data points for each source IP. This table outputs to a lookup file to allow the detection search to operate quickly.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your `VPC flow logs.`.",
                  "id": "fc0edd96-ff2b-48b0-9f1f-63da3782fd63",
                  "name": "Baseline of blocked outbound traffic from AWS",
                  "search": "`cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16) | bucket _time span=1h | stats count as numberOfBlockedConnections by _time, src_ip | stats count(numberOfBlockedConnections) as numDataPoints, latest(numberOfBlockedConnections) as latestCount, avg(numberOfBlockedConnections) as avgBlockedConnections, stdev(numberOfBlockedConnections) as stdevBlockedConnections by src_ip | table src_ip, latestCount, numDataPoints, avgBlockedConnections, stdevBlockedConnections | outputlookup baseline_blocked_outbound_connections | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Network ACL Activity",
                        "Command and Control",
                        "Suspicious AWS Traffic"
                     ],
                     "detections": [
                        "Detect Spike in blocked Outbound Traffic from your AWS"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-05-07",
            "description": "This search will detect spike in blocked outbound network connections originating from within your AWS environment.  It will also update the cache file that factors in the latest data.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your VPC Flow logs. You can modify `dataPointThreshold` and `deviationThreshold` to better fit your environment. The `dataPointThreshold` variable is the number of data points required to meet the definition of \"spike.\" The `deviationThreshold` variable is the number of standard deviations away from the mean that the value must be to be considered a spike. This search works best when you run the \"Baseline of Blocked Outbound Connection\" support search once to create a history of previously seen blocked outbound connections.",
            "id": "ada0f278-84a8-46w1-a3f1-w32372d4bd53",
            "known_false_positives": "The false-positive rate may vary based on the values of`dataPointThreshold` and `deviationThreshold`. Additionally, false positives may result when AWS administrators roll out policies enforcing network blocks, causing sudden increases in the number of blocked outbound connections.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudwatchlogs:vpcflow",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudwatchlogs_vpcflow"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_spike_in_blocked_outbound_traffic_from_your_aws_filter"
               }
            ],
            "name": "Detect Spike in blocked Outbound Traffic from your AWS",
            "references": [],
            "search": "`cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  [search  `cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  | stats count as numberOfBlockedConnections by src_ip | inputlookup baseline_blocked_outbound_connections append=t | fields - latestCount | stats values(*) as * by src_ip | rename numberOfBlockedConnections as latestCount | eval newAvgBlockedConnections=avgBlockedConnections + (latestCount-avgBlockedConnections)/720 | eval newStdevBlockedConnections=sqrt(((pow(stdevBlockedConnections, 2)*719 + (latestCount-newAvgBlockedConnections)*(latestCount-avgBlockedConnections))/720)) | eval avgBlockedConnections=coalesce(newAvgBlockedConnections, avgBlockedConnections), stdevBlockedConnections=coalesce(newStdevBlockedConnections, stdevBlockedConnections), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) | table src_ip, latestCount, numDataPoints, avgBlockedConnections, stdevBlockedConnections | outputlookup baseline_blocked_outbound_connections | eval dataPointThreshold = 5, deviationThreshold = 3 | eval isSpike=if((latestCount > avgBlockedConnections+deviationThreshold*stdevBlockedConnections) AND numDataPoints > dataPointThreshold, 1, 0) | where isSpike=1 | table src_ip] | stats values(dest_ip) as \"Blocked Destination IPs\", values(interface_id) as \"resourceId\" count as numberOfBlockedConnections, dc(dest_ip) as uniqueDestConnections by src_ip | `detect_spike_in_blocked_outbound_traffic_from_your_aws_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Network ACL Activity",
                  "Suspicious AWS Traffic",
                  "Command and Control"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 11"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives",
                  "Command and Control"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.AE",
                  "DE.CM",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-05-21",
                  "description": "This search establishes, on a per-hour basis, the average and the standard deviation of the number of API calls that were related to network ACLs made by each user. Also recorded is the number of data points for each user. This table is then outputted to a lookup file to allow the detection search to operate quickly.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs. To add or remove API event names for network ACLs, edit the macro `network_acl_events`.",
                  "id": "fc0edd96-ff2b-4810-9f1f-63da3783fd63",
                  "name": "Baseline of Network ACL Activity by ARN",
                  "search": "`cloudtrail` `network_acl_events` | spath output=arn path=userIdentity.arn | bucket _time span=1h | stats count as apiCalls by _time, arn | stats count(apiCalls) as numDataPoints, latest(apiCalls) as latestCount, avg(apiCalls) as avgApiCalls, stdev(apiCalls) as stdevApiCalls by arn | table arn, latestCount, numDataPoints, avgApiCalls, stdevApiCalls | outputlookup network_acl_activity_baseline | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Network ACL Activity"
                     ],
                     "detections": [
                        "Detect Spike in Network ACL Activity"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-05-21",
            "description": "This search will detect users creating spikes in API activity related to network access-control lists (ACLs)in your AWS environment.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. You can modify `dataPointThreshold` and `deviationThreshold` to better fit your environment. The `dataPointThreshold` variable is the minimum number of data points required to have a statistically significant amount of data to determine. The `deviationThreshold` variable is the number of standard deviations away from the mean that the value must be to be considered a spike. This search works best when you run the \"Baseline of Network ACL Activity by ARN\" support search once to create a lookup file of previously seen Network ACL Activity. To add or remove API event names related to network ACLs, edit the macro `network_acl_events`.",
            "id": "ada0f478-84a8-4641-a1f1-e32372d4bd53",
            "known_false_positives": "The false-positive rate may vary based on the values of`dataPointThreshold` and `deviationThreshold`. Please modify this according the your environment.",
            "macros": [
               {
                  "definition": "(eventName = CreateNetworkAcl OR eventName = CreateNetworkAclEntry OR eventName = DeleteNetworkAcl OR eventName = DeleteNetworkAclEntry OR eventName = ReplaceNetworkAclEntry OR eventName = ReplaceNetworkAclAssociation)",
                  "description": "This is a list of AWS event names that are associated with Network ACLs",
                  "name": "network_acl_events"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_spike_in_network_acl_activity_filter"
               }
            ],
            "name": "Detect Spike in Network ACL Activity",
            "references": [],
            "search": "`cloudtrail` `network_acl_events` [search `cloudtrail` `network_acl_events` | spath output=arn path=userIdentity.arn | stats count as apiCalls by arn | inputlookup network_acl_activity_baseline append=t | fields - latestCount | stats values(*) as * by arn | rename apiCalls as latestCount | eval newAvgApiCalls=avgApiCalls + (latestCount-avgApiCalls)/720 | eval newStdevApiCalls=sqrt(((pow(stdevApiCalls, 2)*719 + (latestCount-newAvgApiCalls)*(latestCount-avgApiCalls))/720)) | eval avgApiCalls=coalesce(newAvgApiCalls, avgApiCalls), stdevApiCalls=coalesce(newStdevApiCalls, stdevApiCalls), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) | table arn, latestCount, numDataPoints, avgApiCalls, stdevApiCalls | outputlookup network_acl_activity_baseline | eval dataPointThreshold = 15, deviationThreshold = 3 | eval isSpike=if((latestCount > avgApiCalls+deviationThreshold*stdevApiCalls) AND numDataPoints > dataPointThreshold, 1, 0) | where isSpike=1 | rename arn as userIdentity.arn | table userIdentity.arn] | spath output=user userIdentity.arn | stats values(eventName) as eventNames, count as numberOfApiCalls, dc(eventName) as uniqueApisCalled by user | `detect_spike_in_network_acl_activity_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Network ACL Activity"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 12",
                  "CIS 11"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.DP",
                  "DE.CM",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "2e8948a5-5239-406b-b56b-6c50ff268af4",
      "name": "AWS Network ACL Activity",
      "narrative": "AWS CloudTrail is an AWS service that helps you enable governance, compliance, and operational/risk auditing of your AWS account. Actions taken by a user, role, or an AWS service are recorded as events in CloudTrail. It is crucial for a company to monitor events and actions taken in the AWS Management Console, AWS Command Line Interface, and AWS SDKs and APIs to ensure that your servers are not vulnerable to attacks. This analytic story contains detection searches that leverage CloudTrail logs from AWS to check for bad configurations and malicious activity in your AWS network access controls.",
      "references": [
         "https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_NACLs.html",
         "https://aws.amazon.com/blogs/security/how-to-help-prepare-for-ddos-attacks-by-reducing-your-attack-surface/"
      ],
      "tags": {
         "analytics_story": "AWS Network ACL Activity",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2018-03-16",
      "description": "Monitor your AWS provisioning activities for behaviors originating from unfamiliar or unusual locations. These behaviors may indicate that malicious activities are occurring somewhere within your network.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-16",
                  "description": "This search builds a table of the first and last times seen for every IP address (along with its physical location) previously associated with cloud-provisioning activity. This is broadly defined as any event that runs or creates something.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "ac88e6a0-4fba-4dfd-b7b9-8964df7d1aee",
                  "name": "Previously Seen AWS Provisioning Activity Sources",
                  "search": "`cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | stats earliest(_time) as firstTime, latest(_time) as lastTime by sourceIPAddress, City, Region, Country | outputlookup previously_seen_provisioning_activity_src.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Suspicious Provisioning Activities"
                     ],
                     "detections": [
                        "AWS Cloud Provisioning From Previously Unseen IP Address",
                        "AWS Cloud Provisioning From Previously Unseen City",
                        "AWS Cloud Provisioning From Previously Unseen Country",
                        "AWS Cloud Provisioning From Previously Unseen Region"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-03-16",
            "description": "This search looks for AWS provisioning activities from previously unseen cities.  Provisioning activities are defined broadly as any event that begins with \"Run\" or \"Create.\" ",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously Seen AWS Provisioning Activity Sources\" support search once to create a history of previously seen locations that have provisioned AWS resources.",
            "id": "344a1778-0b25-490c-adb1-de8beddf59cd",
            "known_false_positives": "This is a strictly behavioral search, so we define \"false positive\" slightly differently. Every time this fires, it will accurately reflect the first occurrence in the time period you're searching within, plus what is stored in the cache feature. But while there are really no \"false positives\" in a traditional sense, there is definitely lots of noise.\\\n This search will fire any time a new city is seen in the **GeoIP** database for any kind of provisioning activity. If you typically do all provisioning from tools inside of your city, there should be few false positives. If you are located in countries where the free version of **MaxMind GeoIP** that ships by default with Splunk has weak resolution (particularly small countries in less economically powerful regions), this may be much less valuable to you.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_cloud_provisioning_from_previously_unseen_city_filter"
               }
            ],
            "name": "AWS Cloud Provisioning From Previously Unseen City",
            "references": [],
            "search": "`cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | search City=* [search `cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | search City=* | stats earliest(_time) as firstTime, latest(_time) as lastTime by sourceIPAddress, City, Region, Country | inputlookup append=t previously_seen_provisioning_activity_src.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by sourceIPAddress, City, Region, Country | outputlookup previously_seen_provisioning_activity_src.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by City | eval newCity=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newCity=1 | table City] | spath output=user userIdentity.arn | rename sourceIPAddress as src_ip | table _time, user, src_ip, City, eventName, errorCode | `aws_cloud_provisioning_from_previously_unseen_city_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Suspicious Provisioning Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-16",
                  "description": "This search builds a table of the first and last times seen for every IP address (along with its physical location) previously associated with cloud-provisioning activity. This is broadly defined as any event that runs or creates something.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "ac88e6a0-4fba-4dfd-b7b9-8964df7d1aee",
                  "name": "Previously Seen AWS Provisioning Activity Sources",
                  "search": "`cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | stats earliest(_time) as firstTime, latest(_time) as lastTime by sourceIPAddress, City, Region, Country | outputlookup previously_seen_provisioning_activity_src.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Suspicious Provisioning Activities"
                     ],
                     "detections": [
                        "AWS Cloud Provisioning From Previously Unseen IP Address",
                        "AWS Cloud Provisioning From Previously Unseen City",
                        "AWS Cloud Provisioning From Previously Unseen Country",
                        "AWS Cloud Provisioning From Previously Unseen Region"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-03-16",
            "description": "This search looks for AWS provisioning activities from previously unseen countries. Provisioning activities are defined broadly as any event that begins with \"Run\" or \"Create.\" ",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously Seen AWS Provisioning Activity Sources\" support search once to create a history of previously seen locations that have provisioned AWS resources.",
            "id": "ceb8d3d8-06cb-49eb-beaf-829526e33ff0",
            "known_false_positives": "This is a strictly behavioral search, so we define \"false positive\" slightly differently. Every time this fires, it will accurately reflect the first occurrence in the time period you're searching over plus what is stored in the cache feature. But while there are really no \"false positives\" in a traditional sense, there is definitely lots of noise.\\\n This search will fire any time a new country is seen in the **GeoIP** database for any kind of provisioning activity. If you typically do all provisioning from tools inside of your country, there should be few false positives. If you are located in countries where the free version of **MaxMind GeoIP** that ships by default with Splunk has weak resolution (particularly small countries in less economically powerful regions), this may be much less valuable to you.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_cloud_provisioning_from_previously_unseen_country_filter"
               }
            ],
            "name": "AWS Cloud Provisioning From Previously Unseen Country",
            "references": [],
            "search": "`cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | search Country=* [search `cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | search Country=* | stats earliest(_time) as firstTime, latest(_time) as lastTime by sourceIPAddress, City, Region, Country | inputlookup append=t previously_seen_provisioning_activity_src.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by sourceIPAddress, City, Region, Country | outputlookup previously_seen_provisioning_activity_src.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by Country | eval newCountry=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newCountry=1 | table Country] | spath output=user userIdentity.arn | rename sourceIPAddress as src_ip | table _time, user, src_ip, Country, eventName, errorCode | `aws_cloud_provisioning_from_previously_unseen_country_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Suspicious Provisioning Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-16",
                  "description": "This search builds a table of the first and last times seen for every IP address (along with its physical location) previously associated with cloud-provisioning activity. This is broadly defined as any event that runs or creates something.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "ac88e6a0-4fba-4dfd-b7b9-8964df7d1aee",
                  "name": "Previously Seen AWS Provisioning Activity Sources",
                  "search": "`cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | stats earliest(_time) as firstTime, latest(_time) as lastTime by sourceIPAddress, City, Region, Country | outputlookup previously_seen_provisioning_activity_src.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Suspicious Provisioning Activities"
                     ],
                     "detections": [
                        "AWS Cloud Provisioning From Previously Unseen IP Address",
                        "AWS Cloud Provisioning From Previously Unseen City",
                        "AWS Cloud Provisioning From Previously Unseen Country",
                        "AWS Cloud Provisioning From Previously Unseen Region"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-03-16",
            "description": "This search looks for AWS provisioning activities from previously unseen IP addresses. Provisioning activities are defined broadly as any event that begins with \"Run\" or \"Create.\" ",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously Seen AWS Provisioning Activity Sources\" support search once to create a history of previously seen locations that have provisioned AWS resources.",
            "id": "42e15012-ac14-4801-94f4-f1acbe64880b",
            "known_false_positives": "This is a strictly behavioral search, so we define \"false positive\" slightly differently. Every time this fires, it will accurately reflect the first occurrence in the time period you're searching within, plus what is stored in the cache feature. But while there are really no \"false positives\" in a traditional sense, there is definitely lots of noise.\\\n This search will fire any time a new IP address is seen in the **GeoIP** database for any kind of provisioning activity. If you typically do all provisioning from tools inside of your country, there should be few false positives. If you are located in countries where the free version of **MaxMind GeoIP** that ships by default with Splunk has weak resolution (particularly small countries in less economically powerful regions), this may be much less valuable to you.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_cloud_provisioning_from_previously_unseen_ip_address_filter"
               }
            ],
            "name": "AWS Cloud Provisioning From Previously Unseen IP Address",
            "references": [],
            "search": "`cloudtrail` (eventName=Run* OR eventName=Create*) [search `cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | search Country=* | stats earliest(_time) as firstTime, latest(_time) as lastTime by sourceIPAddress, City, Region, Country | inputlookup append=t previously_seen_provisioning_activity_src.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by sourceIPAddress, City, Region, Country | outputlookup previously_seen_provisioning_activity_src.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by sourceIPAddress | eval newIP=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newIP=1 | table sourceIPAddress] | spath output=user userIdentity.arn | rename sourceIPAddress as src_ip | table _time, user, src_ip, eventName, errorCode | `aws_cloud_provisioning_from_previously_unseen_ip_address_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Suspicious Provisioning Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-16",
                  "description": "This search builds a table of the first and last times seen for every IP address (along with its physical location) previously associated with cloud-provisioning activity. This is broadly defined as any event that runs or creates something.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "ac88e6a0-4fba-4dfd-b7b9-8964df7d1aee",
                  "name": "Previously Seen AWS Provisioning Activity Sources",
                  "search": "`cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | stats earliest(_time) as firstTime, latest(_time) as lastTime by sourceIPAddress, City, Region, Country | outputlookup previously_seen_provisioning_activity_src.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Suspicious Provisioning Activities"
                     ],
                     "detections": [
                        "AWS Cloud Provisioning From Previously Unseen IP Address",
                        "AWS Cloud Provisioning From Previously Unseen City",
                        "AWS Cloud Provisioning From Previously Unseen Country",
                        "AWS Cloud Provisioning From Previously Unseen Region"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-03-16",
            "description": "This search looks for AWS provisioning activities from previously unseen regions. Region in this context is similar to a state in the United States. Provisioning activities are defined broadly as any event that begins with \"Run\" or \"Create.\"",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously Seen AWS Provisioning Activity Sources\" support search once to create a history of previously seen locations that have provisioned AWS resources.",
            "id": "7971d3df-da82-4648-a6e5-b5637bea5253",
            "known_false_positives": "This is a strictly behavioral search, so we define \"false positive\" slightly differently. Every time this fires, it will accurately reflect the first occurrence in the time period you're searching within, plus what is stored in the cache feature. But while there are really no \"false positives\" in a traditional sense, there is definitely lots of noise.\\\n This search will fire any time a new region is seen in the **GeoIP** database for any kind of provisioning activity. If you typically do all provisioning from tools inside of your region, there should be few false positives. If you are located in regions where the free version of **MaxMind GeoIP** that ships by default with Splunk has weak resolution (particularly small countries in less economically powerful regions), this may be much less valuable to you.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_cloud_provisioning_from_previously_unseen_region_filter"
               }
            ],
            "name": "AWS Cloud Provisioning From Previously Unseen Region",
            "references": [],
            "search": "`cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | search Region=* [search `cloudtrail` (eventName=Run* OR eventName=Create*) | iplocation sourceIPAddress | search Region=* | stats earliest(_time) as firstTime, latest(_time) as lastTime by sourceIPAddress, City, Region, Country | inputlookup append=t previously_seen_provisioning_activity_src.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by sourceIPAddress, City, Region, Country | outputlookup previously_seen_provisioning_activity_src.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by Region | eval newRegion=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newRegion=1 | table Region] | spath output=user userIdentity.arn | rename sourceIPAddress as src_ip | table _time, user, src_ip, Region, eventName, errorCode | `aws_cloud_provisioning_from_previously_unseen_region_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Suspicious Provisioning Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "3338b567-3804-4261-9889-cf0ca4753c7f",
      "name": "AWS Suspicious Provisioning Activities",
      "narrative": "Because most enterprise AWS activities originate from familiar geographic locations, monitoring for activity from unknown or unusual regions is an important security measure. This indicator can be especially useful in environments where it is impossible to whitelist specific IPs (because they vary).\\\nThis Analytic Story was designed to provide you with flexibility in the precision you employ in specifying legitimate geographic regions. It can be as specific as an IP address or a city, or as broad as a region (think state) or an entire country. By determining how precise you want your geographical locations to be and monitoring for new locations that haven't previously accessed your environment, you can detect adversaries as they begin to probe your environment. Since there are legitimate reasons for activities from unfamiliar locations, this is not a standalone indicator. Nevertheless, location can be a relevant piece of information that you may wish to investigate further.",
      "references": [
         "https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf"
      ],
      "tags": {
         "analytics_story": "AWS Suspicious Provisioning Activities",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "no"
         ],
         "mitre_attack_id": [
            "T1535"
         ],
         "mitre_attack_tactics": [
            "Defense Evasion"
         ],
         "mitre_attack_technique": [
            "Unused/Unsupported Cloud Regions"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2018-03-12",
      "description": "Detect and investigate dormant user accounts for your AWS environment that have become active again. Because inactive and ad-hoc accounts are common attack targets, it's critical to enable governance within your environment.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2018-05-17",
            "description": "This search looks for CloudTrail events where a user logged into the AWS account, is making API calls and has not enabled Multi Factor authentication. Multi factor authentication adds a layer of security by forcing the users to type a unique authentication code from an approved authentication device when they access AWS websites or services. AWS Best Practices recommend that you enable MFA for privileged IAM users.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Leverage the support search `Create a list of approved AWS service accounts`: run it once every 30 days to create a list of service accounts and validate them.\\\nThis search produces fields (`eventName`,`userIdentity.type`,`userIdentity.arn`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** AWS Event Name, **Field:** eventName\\\n1. \\\n1. **Label:** AWS User ARN, **Field:** userIdentity.arn\\\n1. \\\n1. **Label:** AWS User Type, **Field:** userIdentity.type\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "2a9b80d3-6340-4345-w5ad-212bf5d1dac4",
            "known_false_positives": "Many service accounts configured within an AWS infrastructure do not have multi factor authentication enabled. Please ignore the service accounts, if triggered and instead add them to the aws_service_accounts.csv file to fine tune the detection. It is also possible that the search detects users in your environment using Single Sign-On systems, since the MFA is not handled by AWS.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_api_activity_from_users_without_mfa_filter"
               }
            ],
            "name": "Detect API activity from users without MFA",
            "references": [],
            "search": "`cloudtrail` userIdentity.sessionContext.attributes.mfaAuthenticated=false | search NOT [| inputlookup aws_service_accounts | fields identity | rename identity as user]| stats  count min(_time) as firstTime max(_time) as lastTime values(eventName) as eventName by userIdentity.arn userIdentity.type user | `security_content_ctime(firstTime)`  | `security_content_ctime(lastTime)` | `detect_api_activity_from_users_without_mfa_filter`",
            "tags": {
               "analytics_story": [
                  "AWS User Monitoring"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.DP",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-12-03",
                  "description": "This search looks for successful API activity in CloudTrail within the last 30 days, filters out known users from the identity table, and outputs values of users into `aws_service_accounts.csv` lookup file.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the service account entires in `aws_service_accounts.csv`, which is a lookup file created as a result of running this support search. Please remove the entries of service accounts that are not legitimate.",
                  "id": "fc0edc95-ff2b-48b1-5f6f-63ga3789fd43",
                  "name": "Create a list of approved AWS service accounts",
                  "search": "`cloudtrail` errorCode=success | rename userName as identity | search NOT [inputlookup identity_lookup_expanded | fields identity] | stats count by identity | table identity | outputlookup aws_service_accounts | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS User Monitoring"
                     ],
                     "detections": [
                        "Detect AWS API Activities From Unapproved Accounts"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for successful CloudTrail activity by user accounts that are not listed in the identity table or `aws_service_accounts.csv`. It returns event names and count, as well as the first and last time a specific user or service is detected, grouped by users.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. You must also populate the `identity_lookup_expanded` lookup shipped with the Asset and Identity framework to be able to look up users in your identity table in Enterprise Security (ES). Leverage the support search called \"Create a list of approved AWS service accounts\": run it once every 30 days to create and validate a list of service accounts.\\\nThis search produces fields (`eventName`,`firstTime`,`lastTime`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** AWS Event Name, **Field:** eventName\\\n1. \\\n1. **Label:** First Time, **Field:** firstTime\\\n1. \\\n1. **Label:** Last Time, **Field:** lastTime\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "ada0f478-84a8-4641-a3f1-d82362d4bd55",
            "known_false_positives": "It's likely that you'll find activity detected by users/service accounts that are not listed in the `identity_lookup_expanded` or ` aws_service_accounts.csv` file. If the user is a legitimate service account, update the `aws_service_accounts.csv` table with that entry.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_aws_api_activities_from_unapproved_accounts_filter"
               }
            ],
            "name": "Detect AWS API Activities From Unapproved Accounts",
            "references": [],
            "search": "`cloudtrail` errorCode=success | rename userName as identity | search NOT [| inputlookup identity_lookup_expanded | fields identity] | search NOT [| inputlookup aws_service_accounts | fields identity] | rename identity as user | stats count min(_time) as firstTime max(_time) as lastTime values(eventName) as eventName by user | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `detect_aws_api_activities_from_unapproved_accounts_filter`",
            "tags": {
               "analytics_story": [
                  "AWS User Monitoring"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.CM",
                  "PR.AC",
                  "ID.AM"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-04-16",
                  "description": "This search looks for successful API calls made by different user roles, then creates a baseline of the earliest and latest times we have encountered this user role. It also returns the name of the API call in our dataset--grouped by user role and name of the API call--that occurred within the last 30 days. In this support search, we are only looking for events where the user identity is Assumed Role.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user role entries in `previously_seen_api_calls_from_user_roles.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "fc0edc95-fq2c-48b0-9f6f-63da3289fd03",
                  "name": "Previously seen API call per user roles in CloudTrail",
                  "search": "`cloudtrail` eventType=AwsApiCall errorCode=success userIdentity.type=AssumedRole | stats earliest(_time) as earliest latest(_time) as latest by userName eventName | outputlookup previously_seen_api_calls_from_user_roles | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS User Monitoring"
                     ],
                     "detections": [
                        "Detect new API calls from user roles"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-04-16",
            "description": "This search detects new API calls that have either never been seen before or that have not been seen in the previous hour, where the identity type is `AssumedRole`.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously seen API call per user roles in CloudTrail\" support search once to create a history of previously seen user roles.",
            "id": "22773e84-bac0-4595-b086-20d3f335b4f1",
            "known_false_positives": "It is possible that there are legitimate user roles making new or infrequently used API calls in your infrastructure, causing the search to trigger.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_new_api_calls_from_user_roles_filter"
               }
            ],
            "name": "Detect new API calls from user roles",
            "references": [],
            "search": "`cloudtrail` eventType=AwsApiCall errorCode=success userIdentity.type=AssumedRole [search `cloudtrail` eventType=AwsApiCall errorCode=success  userIdentity.type=AssumedRole | stats earliest(_time) as earliest latest(_time) as latest by userName eventName |  inputlookup append=t previously_seen_api_calls_from_user_roles | stats min(earliest) as earliest, max(latest) as latest by userName eventName | outputlookup previously_seen_api_calls_from_user_roles| eval newApiCallfromUserRole=if(earliest>=relative_time(now(), \"-70m@m\"), 1, 0) | where newApiCallfromUserRole=1 | `security_content_ctime(earliest)` | `security_content_ctime(latest)` | table eventName userName]  |rename userName as user| stats values(eventName) earliest(_time) as earliest latest(_time) as latest by user | `security_content_ctime(earliest)` | `security_content_ctime(latest)` | `detect_new_api_calls_from_user_roles_filter`",
            "tags": {
               "analytics_story": [
                  "AWS User Monitoring"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-04-09",
                  "description": "This search establishes, on a per-hour basis, the average and the standard deviation of the number of API calls made by each user. Also recorded is the number of data points for each user. This table is then outputted to a lookup file to allow the detection search to operate quickly.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "fc0edc96-ff2b-48b0-9f6f-63da3783fd63",
                  "name": "Baseline of API Calls per User ARN",
                  "search": "`cloudtrail` eventType=AwsApiCall | spath output=arn path=userIdentity.arn | bucket _time span=1h | stats count as apiCalls by _time, arn | stats count(apiCalls) as numDataPoints, latest(apiCalls) as latestCount, avg(apiCalls) as avgApiCalls, stdev(apiCalls) as stdevApiCalls by arn | table arn, latestCount, numDataPoints, avgApiCalls, stdevApiCalls | outputlookup api_call_by_user_baseline | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS User Monitoring"
                     ],
                     "detections": [
                        "Detect Spike in AWS API Activity"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search will detect users creating spikes of API activity in your AWS environment.  It will also update the cache file that factors in the latest data.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. You can modify `dataPointThreshold` and `deviationThreshold` to better fit your environment. The `dataPointThreshold` variable is the minimum number of data points required to have a statistically significant amount of data to determine. The `deviationThreshold` variable is the number of standard deviations away from the mean that the value must be to be considered a spike.\\\nThis search produces fields (`eventName`,`numberOfApiCalls`,`uniqueApisCalled`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** AWS Event Name, **Field:** eventName\\\n1. \\\n1. **Label:** Number of API Calls, **Field:** numberOfApiCalls\\\n1. \\\n1. **Label:** Unique API Calls, **Field:** uniqueApisCalled\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "ada0f478-84a8-4641-a3f1-d32362d4bd55",
            "known_false_positives": "",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_spike_in_aws_api_activity_filter"
               }
            ],
            "name": "Detect Spike in AWS API Activity",
            "references": [],
            "search": "`cloudtrail` eventType=AwsApiCall [search `cloudtrail` eventType=AwsApiCall | spath output=arn path=userIdentity.arn | stats count as apiCalls by arn | inputlookup api_call_by_user_baseline append=t | fields - latestCount | stats values(*) as * by arn | rename apiCalls as latestCount | eval newAvgApiCalls=avgApiCalls + (latestCount-avgApiCalls)/720 | eval newStdevApiCalls=sqrt(((pow(stdevApiCalls, 2)*719 + (latestCount-newAvgApiCalls)*(latestCount-avgApiCalls))/720)) | eval avgApiCalls=coalesce(newAvgApiCalls, avgApiCalls), stdevApiCalls=coalesce(newStdevApiCalls, stdevApiCalls), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) | table arn, latestCount, numDataPoints, avgApiCalls, stdevApiCalls | outputlookup api_call_by_user_baseline | eval dataPointThreshold = 15, deviationThreshold = 3 | eval isSpike=if((latestCount > avgApiCalls+deviationThreshold*stdevApiCalls) AND numDataPoints > dataPointThreshold, 1, 0) | where isSpike=1 | rename arn as userIdentity.arn | table userIdentity.arn] | spath output=user userIdentity.arn | stats values(eventName) as eventName, count as numberOfApiCalls, dc(eventName) as uniqueApisCalled by user | `detect_spike_in_aws_api_activity_filter`",
            "tags": {
               "analytics_story": [
                  "AWS User Monitoring"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.CM",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-04-17",
                  "description": "This search establishes, on a per-hour basis, the average and the standard deviation for the number of API calls related to security groups made by each user. Also recorded is the number of data points for each user. This table is then outputted to a lookup file to allow the detection search to operate quickly.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs. To add or remove API event names for security groups, edit the macro `security_group_api_calls`.",
                  "id": "fc0edd96-ff2b-48b0-9f1f-63da3783fd63",
                  "name": "Baseline of Security Group Activity by ARN",
                  "search": "`cloudtrail` `security_group_api_calls` | spath output=arn path=userIdentity.arn | bucket _time span=1h | stats count as apiCalls by _time, arn | stats count(apiCalls) as numDataPoints, latest(apiCalls) as latestCount, avg(apiCalls) as avgApiCalls, stdev(apiCalls) as stdevApiCalls by arn | table arn, latestCount, numDataPoints, avgApiCalls, stdevApiCalls | outputlookup security_group_activity_baseline | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS User Monitoring"
                     ],
                     "detections": [
                        "Detect Spike in Security Group Activity"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-04-18",
            "description": "This search will detect users creating spikes in API activity related to security groups in your AWS environment.  It will also update the cache file that factors in the latest data.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. You can modify `dataPointThreshold` and `deviationThreshold` to better fit your environment. The `dataPointThreshold` variable is the minimum number of data points required to have a statistically significant amount of data to determine. The `deviationThreshold` variable is the number of standard deviations away from the mean that the value must be to be considered a spike.This search works best when you run the \"Baseline of Security Group Activity by ARN\" support search once to create a history of previously seen Security Group Activity. To add or remove API event names for security groups, edit the macro `security_group_api_calls`.",
            "id": "ada0f478-84a8-4641-a3f1-e32372d4bd53",
            "known_false_positives": "Based on the values of`dataPointThreshold` and `deviationThreshold`, the false positive rate may vary. Please modify this according the your environment.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "(eventName=AuthorizeSecurityGroupIngress OR eventName=CreateSecurityGroup OR eventName=DeleteSecurityGroup OR eventName=DescribeClusterSecurityGroups OR eventName=DescribeDBSecurityGroups OR eventName=DescribeSecurityGroupReferences OR eventName=DescribeSecurityGroups OR eventName=DescribeStaleSecurityGroups OR eventName=RevokeSecurityGroupIngress OR eventName=UpdateSecurityGroupRuleDescriptionsIngress)",
                  "description": "This macro is a list of AWS event names associated with security groups",
                  "name": "security_group_api_calls"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_spike_in_security_group_activity_filter"
               }
            ],
            "name": "Detect Spike in Security Group Activity",
            "references": [],
            "search": "`cloudtrail` `security_group_api_calls` [search `cloudtrail` `security_group_api_calls` | spath output=arn path=userIdentity.arn | stats count as apiCalls by arn | inputlookup security_group_activity_baseline append=t | fields - latestCount | stats values(*) as * by arn | rename apiCalls as latestCount | eval newAvgApiCalls=avgApiCalls + (latestCount-avgApiCalls)/720 | eval newStdevApiCalls=sqrt(((pow(stdevApiCalls, 2)*719 + (latestCount-newAvgApiCalls)*(latestCount-avgApiCalls))/720)) | eval avgApiCalls=coalesce(newAvgApiCalls, avgApiCalls), stdevApiCalls=coalesce(newStdevApiCalls, stdevApiCalls), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) | table arn, latestCount, numDataPoints, avgApiCalls, stdevApiCalls | outputlookup security_group_activity_baseline | eval dataPointThreshold = 15, deviationThreshold = 3 | eval isSpike=if((latestCount > avgApiCalls+deviationThreshold*stdevApiCalls) AND numDataPoints > dataPointThreshold, 1, 0) | where isSpike=1 | rename arn as userIdentity.arn | table userIdentity.arn] | spath output=user userIdentity.arn | stats values(eventName) as eventNames, count as numberOfApiCalls, dc(eventName) as uniqueApisCalled by user | `detect_spike_in_security_group_activity_filter`",
            "tags": {
               "analytics_story": [
                  "AWS User Monitoring"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.CM",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "2e8948a5-5239-406b-b56b-6c50f1269af3",
      "name": "AWS User Monitoring",
      "narrative": "It seems obvious that it is critical to monitor and control the users who have access to your cloud infrastructure. Nevertheless, it's all too common for enterprises to lose track of ad-hoc accounts, leaving their servers vulnerable to attack. In fact, this was the very oversight that led to Tesla's cryptojacking attack in February, 2018.\\\nIn addition to compromising the security of your data, when bad actors leverage your compute resources, it can incur monumental costs, since you will be billed for any new EC2 instances and increased bandwidth usage. \\\nFortunately, you can leverage Amazon Web Services (AWS) CloudTrail--a tool that helps you enable governance, compliance, and risk auditing of your AWS account--to give you increased visibility into your user and resource activity by recording AWS Management Console actions and API calls. You can identify which users and accounts called AWS, the source IP address from which the calls were made, and when the calls occurred.\\\nThe detection searches in this Analytic Story are designed to help you uncover AWS API activities from users not listed in the identity table, as well as similar activities from disabled accounts.",
      "references": [
         "https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf",
         "https://redlock.io/blog/cryptojacking-tesla"
      ],
      "tags": {
         "analytics_story": "AWS User Monitoring",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "APT33"
         ],
         "mitre_attack_id": [
            "T1078.004"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Cloud Accounts"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2017-12-19",
      "description": "Detect and investigate activity that may indicate that an adversary is using faux domains to mislead users into interacting with malicious infrastructure. Monitor DNS, email, and web traffic for permutations of your brand name.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-10-08",
                  "description": "This search creates permutations of your existing domains, removes the valid domain names and stores them in a specified lookup file so they can be checked for in the associated detection searches.",
                  "how_to_implement": "To successfully implement this search you need to update the file called domains.csv in the DA-ESS-SOC/lookup directory. Or `cim_corporate_email_domains.csv` and `cim_corporate_web_domains.csv` from **Splunk\\_SA\\_CIM**.",
                  "id": "19f7d2ec-6028-4d01-bcdb-bda9a034c17f",
                  "name": "DNSTwist Domain Names",
                  "search": "| dnstwist domainlist=domains.csv | `remove_valid_domains` | eval domain_abuse=\"true\" | table domain, domain_abuse | outputlookup brandMonitoring_lookup | stats count",
                  "tags": {
                     "analytics_story": [
                        "Brand Monitoring",
                        "Suspicious Emails"
                     ],
                     "detections": [
                        "Monitor Email For Brand Abuse",
                        "Monitor DNS For Brand Abuse",
                        "Monitor Web Traffic For Brand Abuse"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2017-09-23",
            "description": "This search looks for DNS requests for faux domains similar to the domains that you want to have monitored for abuse.",
            "how_to_implement": "You need to ingest data from your DNS logs. Specifically you must ingest the domain that is being queried and the IP of the host originating the request. Ideally, you should also be ingesting the answer to the query and the query type. This approach allows you to also create your own localized passive DNS capability which can aid you in future investigations. You also need to have run the search \"ESCU - DNSTwist Domain Names\", which creates the permutations of the domain that will be checked for.",
            "id": "24dd17b1-e2fb-4c31-878c-d4f746595bfa",
            "known_false_positives": "None at this time",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "lookup update=true brandMonitoring_lookup domain as query OUTPUT domain_abuse | search domain_abuse=true",
                  "description": "This macro limits the output to only domains that are in the brand monitoring lookup file",
                  "name": "brand_abuse_dns"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "monitor_dns_for_brand_abuse_filter"
               }
            ],
            "name": "Monitor DNS For Brand Abuse",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(DNS.answer) as IPs min(_time) as firstTime from datamodel=Network_Resolution by DNS.src, DNS.query | `drop_dm_object_name(\"DNS\")` | `security_content_ctime(firstTime)`| `brand_abuse_dns` | `monitor_dns_for_brand_abuse_filter`",
            "tags": {
               "analytics_story": [
                  "Brand Monitoring"
               ],
               "asset_type": "Endpoint",
               "kill_chain_phases": [
                  "Delivery",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-10-08",
                  "description": "This search creates permutations of your existing domains, removes the valid domain names and stores them in a specified lookup file so they can be checked for in the associated detection searches.",
                  "how_to_implement": "To successfully implement this search you need to update the file called domains.csv in the DA-ESS-SOC/lookup directory. Or `cim_corporate_email_domains.csv` and `cim_corporate_web_domains.csv` from **Splunk\\_SA\\_CIM**.",
                  "id": "19f7d2ec-6028-4d01-bcdb-bda9a034c17f",
                  "name": "DNSTwist Domain Names",
                  "search": "| dnstwist domainlist=domains.csv | `remove_valid_domains` | eval domain_abuse=\"true\" | table domain, domain_abuse | outputlookup brandMonitoring_lookup | stats count",
                  "tags": {
                     "analytics_story": [
                        "Brand Monitoring",
                        "Suspicious Emails"
                     ],
                     "detections": [
                        "Monitor Email For Brand Abuse",
                        "Monitor DNS For Brand Abuse",
                        "Monitor Web Traffic For Brand Abuse"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2018-01-05",
            "description": "This search looks for emails claiming to be sent from a domain similar to one that you want to have monitored for abuse.",
            "how_to_implement": "You need to ingest email header data. Specifically the sender's address (src_user) must be populated.  You also need to have run the search \"ESCU - DNSTwist Domain Names\", which creates the permutations of the domain that will be checked for.",
            "id": "b2ea1f38-3a3e-4b8a-9cf1-82760d86a6b8",
            "known_false_positives": "None at this time",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "monitor_email_for_brand_abuse_filter"
               }
            ],
            "name": "Monitor Email For Brand Abuse",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(All_Email.recipient) as recipients, min(_time) as firstTime, max(_time) as lastTime from datamodel=Email by All_Email.src_user, All_Email.message_id | `drop_dm_object_name(\"All_Email\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | eval temp=split(src_user, \"@\") | eval email_domain=mvindex(temp, 1) | lookup update=true brandMonitoring_lookup domain as email_domain OUTPUT domain_abuse | search domain_abuse=true | table message_id, src_user, email_domain, recipients, firstTime, lastTime | `monitor_email_for_brand_abuse_filter`",
            "tags": {
               "analytics_story": [
                  "Brand Monitoring",
                  "Suspicious Emails"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-10-08",
                  "description": "This search creates permutations of your existing domains, removes the valid domain names and stores them in a specified lookup file so they can be checked for in the associated detection searches.",
                  "how_to_implement": "To successfully implement this search you need to update the file called domains.csv in the DA-ESS-SOC/lookup directory. Or `cim_corporate_email_domains.csv` and `cim_corporate_web_domains.csv` from **Splunk\\_SA\\_CIM**.",
                  "id": "19f7d2ec-6028-4d01-bcdb-bda9a034c17f",
                  "name": "DNSTwist Domain Names",
                  "search": "| dnstwist domainlist=domains.csv | `remove_valid_domains` | eval domain_abuse=\"true\" | table domain, domain_abuse | outputlookup brandMonitoring_lookup | stats count",
                  "tags": {
                     "analytics_story": [
                        "Brand Monitoring",
                        "Suspicious Emails"
                     ],
                     "detections": [
                        "Monitor Email For Brand Abuse",
                        "Monitor DNS For Brand Abuse",
                        "Monitor Web Traffic For Brand Abuse"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2017-09-23",
            "description": "This search looks for Web requests to faux domains similar to the one that you want to have monitored for abuse.",
            "how_to_implement": "You need to ingest data from your web traffic. This can be accomplished by indexing data from a web proxy, or using a network traffic analysis tool, such as Bro or Splunk Stream. You also need to have run the search \"ESCU - DNSTwist Domain Names\", which creates the permutations of the domain that will be checked for.",
            "id": "134da869-e264-4a8f-8d7e-fcd0ec88f301",
            "known_false_positives": "None at this time",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "lookup update=true brandMonitoring_lookup domain as urls OUTPUT domain_abuse | search domain_abuse=true",
                  "description": "This macro limits the output to only domains that are in the brand monitoring lookup file",
                  "name": "brand_abuse_web"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "monitor_web_traffic_for_brand_abuse_filter"
               }
            ],
            "name": "Monitor Web Traffic For Brand Abuse",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Web.url) as urls min(_time) as firstTime from datamodel=Web by Web.src | `drop_dm_object_name(\"Web\")` | `security_content_ctime(firstTime)` | `brand_abuse_web` | `monitor_web_traffic_for_brand_abuse_filter`",
            "tags": {
               "analytics_story": [
                  "Brand Monitoring"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "91c676cf-0b23-438d-abee-f6335e1fce78",
      "name": "Brand Monitoring",
      "narrative": "While you can educate your users and customers about the risks and threats posed by typosquatting, phishing, and corporate espionage, human error is a persistent fact of life. Of course, your adversaries are all too aware of this reality and will happily leverage it for nefarious purposes whenever possible&#51;phishing with lookalike addresses, embedding faux command-and-control domains in malware, and hosting malicious content on domains that closely mimic your corporate servers. This is where brand monitoring comes in.\\\nYou can use our adaptation of `DNSTwist`, together with the support searches in this Analytic Story, to generate permutations of specified brands and external domains. Splunk can monitor email, DNS requests, and web traffic for these permutations and provide you with early warnings and situational awareness--powerful elements of an effective defense.\\\nNotable events will include IP addresses, URLs, and user data. Drilling down can provide you with even more actionable intelligence, including likely geographic information, contextual searches to help you scope the problem, and investigative searches.",
      "references": [
         "https://www.zerofox.com/blog/what-is-digital-risk-monitoring/",
         "https://securingtomorrow.mcafee.com/consumer/family-safety/what-is-typosquatting/",
         "https://blog.malwarebytes.com/cybercrime/2016/06/explained-typosquatting/"
      ],
      "tags": {
         "analytics_story": "Brand Monitoring",
         "category": [
            "Abuse"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2019-10-02",
      "description": "Monitor your cloud compute instances for activities related to cryptojacking/cryptomining. New instances that originate from previously unseen regions, users who launch abnormally high numbers of instances, or compute instances started by previously unseen users are just a few examples of potentially malicious behavior.",
      "detections": [
         {
            "author": "Jason Brewer, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2019-11-14",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model for how many RunInstances users do in the environment. By default, the search uses the last 90 days of data to build the model. The model created by this search is then used in the corresponding detection search, which identifies subsequent outliers in the number of RunInstances performed by a user in a small time window.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs.\\\nIn addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. Depending on the number of users in your environment, you may also need to adjust the value for max_inputs in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data.\\\nMore information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "fa5634df-fb05-4b4b-aba0-6115138bb1ba",
                  "name": "Baseline of Excessive AWS Instances Launched by User - MLTK",
                  "search": "`cloudtrail` eventName=RunInstances errorCode=success `ec2_excessive_runinstances_mltk_input_filter` | bucket span=10m _time | stats count as instances_launched by _time src_user | fit DensityFunction instances_launched threshold=0.0005 into ec2_excessive_runinstances_v1",
                  "tags": {
                     "analytics_story": [
                        "Cloud Cryptomining",
                        "Suspicious AWS EC2 Activities"
                     ],
                     "detections": [
                        "Abnormally High AWS Instances Launched by User - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for CloudTrail events where a user successfully launches an abnormally high number of instances.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. The threshold value should be tuned to your environment.",
            "id": "dec41ad5-d579-42cb-b4c6-f5dbb778bbe5",
            "known_false_positives": "Many service accounts configured within an AWS infrastructure are known to exhibit this behavior. Please adjust the threshold values and filter out service accounts from the output. Always verify if this search alerted on a human user.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "abnormally_high_aws_instances_launched_by_user___mltk_filter"
               }
            ],
            "name": "Abnormally High AWS Instances Launched by User - MLTK",
            "references": [],
            "search": "`cloudtrail` eventName=RunInstances errorCode=success `abnormally_high_aws_instances_launched_by_user___mltk_filter` | bucket span=10m _time  | stats count as instances_launched by _time src_user  | apply ec2_excessive_runinstances_v1  | rename \"IsOutlier(instances_launched)\" as isOutlier  | where isOutlier=1",
            "tags": {
               "analytics_story": [
                  "Cloud Cryptomining",
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-15",
                  "description": "This search builds a table of previously seen users that have launched a cloud compute instance.",
                  "how_to_implement": "You must be ingesting the approrpiate cloud infrastructure logs and have the Security Research cloud data model installed.",
                  "id": "9fa1c205-4e08-4681-bb1b-d0943e734b85",
                  "name": "Previously Seen Cloud Compute Creations By User",
                  "search": "| tstats earliest(_time) as firstTime, latest(_time) as lastTime from datamodel=Cloud_Infrastructure.Compute where Compute.action=run `previously_seen_cloud_compute_creations_by_user_input_filter` by Compute.src_user | `drop_dm_object_name(\"Compute\")` | outputlookup previously_seen_cloud_compute_creations_by_user | stats count",
                  "tags": {
                     "analytics_story": [
                        "Cloud Cryptomining"
                     ],
                     "detections": [
                        "Cloud Compute Instance Created By Previously Unseen User"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for cloud compute instances created by users who have not created them before.",
            "how_to_implement": "You must be ingesting the appropriate cloud-infrastructure logs and have the Security Research cloud data model (https://github.com/splunk/cloud-datamodel-security-research/) installed. Run the \"Previously Seen Cloud Compute Creations By User\" support search to create of baseline of previously seen users.",
            "id": "76988f6a-3935-48f6-a9e5-6fca8b3ed843",
            "known_false_positives": "It's possible that a user will start to create compute instances for the first time, for any number of reasons. Verify with the user launching instances that this is the intended behavior.",
            "macros": [
               {
                  "definition": "-70m@m",
                  "description": "Use this macro to determine how far into the past the window should be to determine if the user is new or not",
                  "name": "previously_seen_cloud_compute_creations_by_user_search_window_begin_offset"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "cloud_compute_instance_created_by_previously_unseen_user_filter"
               }
            ],
            "name": "Cloud Compute Instance Created By Previously Unseen User",
            "references": [],
            "search": "| tstats `security_content_summariesonly` earliest(_time) as firstTime, latest(_time) as lastTime values(Compute.dest) as dest from datamodel=Cloud_Infrastructure.Compute where Compute.action=run by Compute.src_user | `drop_dm_object_name(\"Compute\")` | inputlookup append=t previously_seen_cloud_compute_creations_by_user  | stats min(firstTime) as firstTime max(lastTime) as lastTime, values(dest) as dest by src_user | multireport [| table src_user, firstTime, lastTime | outputlookup previously_seen_cloud_compute_creations_by_user | where fact=fiction][| eval new_user=if(firstTime >= relative_time(now(), `previously_seen_cloud_compute_creations_by_user_search_window_begin_offset`), 1, 0) | where new_user=1 | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)`] | table src_user, dest, firstTime, lastTime | `cloud_compute_instance_created_by_previously_unseen_user_filter`",
            "tags": {
               "analytics_story": [
                  "Cloud Cryptomining"
               ],
               "asset_type": "Cloud Compute Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-12",
                  "description": "This search builds a table of previously seen images used to launch cloud compute instances",
                  "how_to_implement": "You must be ingesting the approrpiate cloud infrastructure logs and have the Security Research cloud data model installed.",
                  "id": "3782ad10-5ce2-46e2-b9c4-1de9ecd3aecc",
                  "name": "Previously Seen Cloud Compute Images",
                  "search": "| tstats earliest(_time) as firstTime, latest(_time) as lastTime from datamodel=Cloud_Infrastructure.Compute where Compute.action=run `previously_seen_cloud_compute_image_input_filter` by Compute.image_id | `drop_dm_object_name(\"Compute\")` | outputlookup previously_seen_cloud_compute_images | stats count",
                  "tags": {
                     "analytics_story": [
                        "Cloud Cryptomining"
                     ],
                     "detections": [
                        "Cloud Compute Instance Created With Previously Unseen Image"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-10-12",
            "description": "This search looks for cloud compute instances being created with previously unseen image IDs.",
            "how_to_implement": "You must be ingesting the appropriate cloud-infrastructure logs and have the Security Research cloud data model (https://github.com/splunk/cloud-datamodel-security-research/) installed. Run the \"Previously Seen Cloud Compute Images\" support search to create a baseline of previously seen images.",
            "id": "bc24922d-987c-4645-b288-f8c73ec194c4",
            "known_false_positives": "After a new image is created, the first systems created with that image will cause this alert to fire.  Verify that the image being used was created by a legitimate user.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "-70m@m",
                  "description": "Use this macro to determine how far into the past the window should be to determine if the image is new or not",
                  "name": "previously_seen_cloud_compute_image_search_window_begin_offset"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "cloud_compute_instance_created_with_previously_unseen_image_filter"
               }
            ],
            "name": "Cloud Compute Instance Created With Previously Unseen Image",
            "references": [],
            "search": "| tstats earliest(_time) as firstTime, latest(_time) as lastTime values(Compute.dest) as dest from datamodel=Cloud_Infrastructure.Compute where Compute.action=run `cloud_compute_instance_created_with_previously_unseen_image_filter` by Compute.image_id, Compute.src_user | `drop_dm_object_name(\"Compute\")` | inputlookup append=t previously_seen_cloud_compute_images | stats min(firstTime) as firstTime max(lastTime) as lastTime, values(dest) as dest by image_id, src_user | multireport [| table image_id, firstTime, lastTime | outputlookup previously_seen_cloud_compute_images | where fact=fiction][| eval new_image=if(firstTime >= relative_time(now(), `previously_seen_cloud_compute_image_search_window_begin_offset`), 1, 0) | where new_image=1 | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)`] | table image_id, dest, src_user, firstTime, lastTime",
            "tags": {
               "analytics_story": [
                  "Cloud Cryptomining"
               ],
               "asset_type": "Cloud Compute Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2019-10-03",
                  "description": "This search builds a table of previously seen cloud compute instance types",
                  "how_to_implement": "You must be ingesting the approrpiate cloud infrastructure logs and have the Security Research cloud data model installed.",
                  "id": "0ef13d46-164e-4cf5-816e-b3c0df170d00",
                  "name": "Previously Seen Cloud Compute Instance Types",
                  "search": "| tstats earliest(_time) as firstTime, latest(_time) as lastTime from datamodel=Cloud_Infrastructure.Compute where Compute.action=run `previously_seen_cloud_compute_instance_types_input_filter` by Compute.instance_type | `drop_dm_object_name(\"Compute\")` | outputlookup previously_seen_cloud_compute_instance_types | stats count",
                  "tags": {
                     "analytics_story": [
                        "Cloud Cryptomining"
                     ],
                     "detections": [
                        "Cloud Compute Instance Created With Previously Unseen Instance Type"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-03-12",
            "description": "Find EC2 instances being created with previously unseen instance types.",
            "how_to_implement": "You must be ingesting the appropriate cloud-infrastructure logs and have the Security Research cloud data model (https://github.com/splunk/cloud-datamodel-security-research/) installed. Run the \" Previously Seen Cloud Compute Instance Types\" support search to create a baseline of previously seen regions.",
            "id": "c6ddbf53-9715-49f3-bb4c-fb2e8a309cda",
            "known_false_positives": "It is possible that an admin will create a new system using a new instance type that has never been used before. Verify with the creator that they intended to create the system with the new instance type.",
            "macros": [
               {
                  "definition": "-70m@m",
                  "description": "Use this macro to determine how far into the past the window should be to determine if the instance type is new or not",
                  "name": "previously_seen_cloud_compute_instance_types_search_window_begin_offset"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "cloud_compute_instance_created_with_previously_unseen_instance_type_filter"
               }
            ],
            "name": "Cloud Compute Instance Created With Previously Unseen Instance Type",
            "references": [],
            "search": "| tstats earliest(_time) as firstTime, latest(_time) as lastTime values(Compute.dest) as dest from datamodel=Cloud_Infrastructure.Compute where Compute.event_name=RunInstances `cloud_compute_instance_created_with_previously_unseen_instance_type_filter` by Compute.instance_type, Compute.src_user | `drop_dm_object_name(\"Compute\")` | inputlookup append=t previously_seen_cloud_compute_instance_types | stats min(firstTime) as firstTime max(lastTime) as lastTime, values(dest) as dest by instance_type, src_user | multireport [| table instance_type, firstTime, lastTime | outputlookup previously_seen_cloud_compute_instance_types | where fact=fiction][| eval new_type=if(firstTime >= relative_time(now(), `previously_seen_cloud_compute_instance_types_search_window_begin_offset`), 1, 0) | where new_type=1 | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)`] | table instance_type, dest, src_user, firstTime, lastTime",
            "tags": {
               "analytics_story": [
                  "Cloud Cryptomining"
               ],
               "asset_type": "Cloud Compute Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2019-10-02",
                  "description": "This search looks for cloud compute events where a compute instance is started and creates a baseline of most recent time, `lastTime` and the first time `firstTime` we've seen this region in our dataset grouped by the region for the last 30 days",
                  "how_to_implement": "You must be ingesting the approrpiate cloud infrastructure logs and have the Security Research cloud data model installed.",
                  "id": "b5e232db-dec6-4db8-aaa1-dd5474521e40",
                  "name": "Previously Seen Cloud Regions",
                  "search": "| tstats earliest(_time) as firstTime, latest(_time) as lastTime from datamodel=Cloud_Infrastructure.Compute where Compute.action=start `previously_seen_cloud_regions_input_filter` by Compute.region | `drop_dm_object_name(\"Compute\")` | outputlookup previously_seen_cloud_regions | stats count",
                  "tags": {
                     "analytics_story": [
                        "Cloud Cryptomining"
                     ],
                     "detections": [
                        "Cloud Compute Instance Started In Previously Unused Region"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2019-10-02",
            "description": "This search looks at cloud-infrastructure events where an instance is created in any region within the last hour and then compares it to a lookup file of previously seen regions where instances have been created.",
            "how_to_implement": "You must be ingesting the appropriate cloud-infrastructure logs and have the Security Research cloud data model (https://github.com/splunk/cloud-datamodel-security-research/) installed. Run the \\\"Previously Seen Cloud Compute Instance Types\\\" support search to create a baseline of previously seen regions.",
            "id": "fa4089e2-50e3-40f7-8469-d2cc1564ca59",
            "known_false_positives": "It's possible that a user has unknowingly started an instance in a new region. Please verify that this activity is legitimate.",
            "macros": [
               {
                  "definition": "-70m@m",
                  "description": "Use this macro to determine how far into the past the window should be to determine if the region is new or not",
                  "name": "previously_seen_cloud_regions_search_window_begin_offset"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "cloud_compute_instance_started_in_previously_unused_region_filter"
               }
            ],
            "name": "Cloud Compute Instance Started In Previously Unused Region",
            "references": [],
            "search": "| tstats earliest(_time) as firstTime, latest(_time) as lastTime values(Compute.dest) as dest from datamodel=Cloud_Infrastructure.Compute where Compute.event_name=RunInstances `cloud_compute_instance_started_in_previously_unused_region_filter` by Compute.region, Compute.src_user | `drop_dm_object_name(\"Compute\")` | inputlookup append=t previously_seen_cloud_regions | stats min(firstTime) as firstTime max(lastTime) as lastTime, values(dest) as dest by region, src_user | multireport [| table region, firstTime, lastTime | outputlookup previously_seen_cloud_regions | where fact=fiction][| eval new_region=if(firstTime >= relative_time(now(), `previously_seen_cloud_regions_search_window_begin_offset`), 1, 0) | where new_region=1 | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)`] | table region, dest, src_user, firstTime, lastTime",
            "tags": {
               "analytics_story": [
                  "Cloud Cryptomining"
               ],
               "asset_type": "Cloud Compute Instance",
               "cis20": [
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "3b96d13c-fdc7-45dd-b3ad-c132b31cdd2a",
      "name": "Cloud Cryptomining",
      "narrative": "Cryptomining is an intentionally difficult, resource-intensive business. Its complexity was designed into the process to ensure that the number of blocks mined each day would remain steady. So, it's par for the course that ambitious, but unscrupulous, miners make amassing the computing power of large enterprises--a practice known as cryptojacking--a top priority. \\\nCryptojacking has attracted an increasing amount of media attention since its explosion in popularity in the fall of 2017. The attacks have moved from in-browser exploits and mobile phones to enterprise cloud services, such as Amazon Web Services (AWS), Google Cloud Platform (GCP), and Azure. It's difficult to determine exactly how widespread the practice has become, since bad actors continually evolve their ability to escape detection, including employing unlisted endpoints, moderating their CPU usage, and hiding the mining pool's IP address behind a free CDN. \\\nWhen malicious miners appropriate a cloud instance, often spinning up hundreds of new instances, the costs can become astronomical for the account holder. So it is critically important to monitor your systems for suspicious activities that could indicate that your network has been infiltrated. \\\nThis Analytic Story is focused on detecting suspicious new instances in your cloud environment to help prevent cryptominers from gaining a foothold. It contains detection searches that will detect when a previously unused instance type or AMI is used. It also contains support searches to build lookup files to ensure proper execution of the detection searches.",
      "references": [
         "https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf"
      ],
      "tags": {
         "analytics_story": "Cloud Cryptomining",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "APT33",
            "no"
         ],
         "mitre_attack_id": [
            "T1535",
            "T1078.004"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Cloud Accounts",
            "Unused/Unsupported Cloud Regions"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Jose Hernandez, Splunk",
      "date": "2019-01-09",
      "description": "Leverage searches that allow you to detect and investigate unusual activities that relate to the ColdRoot Remote Access Trojan that affects MacOS. An example of some of these activities are changing sensative binaries in the MacOS sub-system, detecting process names and executables associated with the RAT, detecting when a keyboard tab is installed on a MacOS machine and more.",
      "detections": [
         {
            "author": "Rico Valdez, Splunk",
            "date": "2019-01-29",
            "description": "This search looks for ColdRoot events from the osx-attacks osquery pack.",
            "how_to_implement": "In order to properly run this search, Splunk needs to ingest data from your osquery deployed agents with the [osx-attacks.conf](https://github.com/facebook/osquery/blob/experimental/packs/osx-attacks.conf#L599) pack enabled. Also the [TA-OSquery](https://github.com/d1vious/TA-osquery) must be deployed across your indexers and universal forwarders in order to have the osquery data populate the Alerts data model",
            "id": "a6fffe5e-05c3-4c04-badc-887607fbb8dc",
            "known_false_positives": "There are no known false positives.",
            "macros": [
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "osquery_pack___coldroot_detection_filter"
               }
            ],
            "name": "Osquery pack - ColdRoot detection",
            "references": [],
            "search": "| from datamodel Alerts.Alerts | search app=osquery:results (name=pack_osx-attacks_OSX_ColdRoot_RAT_Launchd OR name=pack_osx-attacks_OSX_ColdRoot_RAT_Files) | rename columns.path as path | bucket _time span=30s | stats count(path) by _time, host, user, path | `osquery_pack___coldroot_detection_filter`",
            "tags": {
               "analytics_story": [
                  "ColdRoot MacOS RAT"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 4",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Command and Control"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.DP",
                  "DE.CM",
                  "PR.PT"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Jose Hernandez, Splunk",
            "date": "2019-01-25",
            "description": "This search looks for processes in an MacOS system that is tapping keyboard events in MacOS, and essentially monitoring all keystrokes made by a user. This is a common technique used by RATs to log keystrokes from a victim, although it can also be used by legitimate processes like Siri to react on human input",
            "how_to_implement": "In order to properly run this search, Splunk needs to ingest data from your osquery deployed agents with the [osx-attacks.conf](https://github.com/facebook/osquery/blob/experimental/packs/osx-attacks.conf#L599) pack enabled. Also the [TA-OSquery](https://github.com/d1vious/TA-osquery) must be deployed across your indexers and universal forwarders in order to have the osquery data populate the Alerts data model.",
            "id": "2a371608-331d-4034-ae2c-21dda8f1d0ec",
            "known_false_positives": "There might be some false positives as keyboard event taps are used by processes like Siri and Zoom video chat, for some good examples of processes to exclude please see [this](https://github.com/facebook/osquery/pull/5345#issuecomment-454639161) comment.",
            "macros": [
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "processes_tapping_keyboard_events_filter"
               }
            ],
            "name": "Processes Tapping Keyboard Events",
            "references": [],
            "search": "| from datamodel Alerts.Alerts | search app=osquery:results name=pack_osx-attacks_Keyboard_Event_Taps | rename columns.cmdline as cmd, columns.name as process_name, columns.pid as process_id| dedup host,process_name | table host,process_name, cmd, process_id | `processes_tapping_keyboard_events_filter`",
            "tags": {
               "analytics_story": [
                  "ColdRoot MacOS RAT"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 4",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.DP"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "bd91a2bc-d20b-4f44-a982-1bea98e86390",
      "name": "ColdRoot MacOS RAT",
      "narrative": "Conventional wisdom holds that Apple's MacOS operating system is significantly less vulnerable to attack than Windows machines. While that point is debatable, it is true that attacks against MacOS systems are much less common. However, this fact does not mean that Macs are impervious to breaches. To the contrary, research has shown that that Mac malware is increasing at an alarming rate. According to AV-test, in 2018, there were 86,865 new MacOS malware variants, up from 27,338 the year before&#151;a 31% increase. In contrast, the independent research firm found that new Windows malware had increased from 65.17M to 76.86M during that same period, less than half the rate of growth. The bottom line is that while the numbers look a lot smaller than Windows, it's definitely time to take Mac security more seriously.\\\nThis Analytic Story addresses the ColdRoot remote access trojan (RAT), which was uploaded to Github in 2016, but was still escaping detection by the first quarter of 2018, when a new, more feature-rich variant was discovered masquerading as an Apple audio driver. Among other capabilities, the Pascal-based ColdRoot can heist passwords from users' keychains and remotely control infected machines without detection. In the initial report of his findings, Patrick Wardle, Chief Research Officer for Digita Security, explained that the new ColdRoot RAT could start and kill processes on the breached system, spawn new remote-desktop sessions, take screen captures and assemble them into a live stream of the victim's desktop, and more.\\\nSearches in this Analytic Story leverage the capabilities of OSquery to address ColdRoot detection from several different angles, such as looking for the existence of associated files and processes, and monitoring for signs of an installed keylogger.",
      "references": [
         "https://www.intego.com/mac-security-blog/osxcoldroot-and-the-rat-invasion/",
         "https://objective-see.com/blog/blog_0x2A.html",
         "https://www.bleepingcomputer.com/news/security/coldroot-rat-still-undetectable-despite-being-uploaded-on-github-two-years-ago/"
      ],
      "tags": {
         "analytics_story": "ColdRoot MacOS RAT",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2020-02-03",
      "description": "Monitor for and investigate activities--such as suspicious writes to the Windows Recycling Bin or email servers sending high amounts of traffic to specific hosts, for example--that may indicate that an adversary is harvesting and exfiltrating sensitive data. ",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "The search looks at the change-analysis data model and detects email files created outside the normal Outlook directory.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records the file-system activity from your hosts to populate the Endpoint.Filesystem data model node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or by other endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report file-system reads and writes.",
            "id": "ee18ed37-0802-4268-9435-b3b91aaa18xx",
            "known_false_positives": "Administrators and users sometimes prefer backing up their email data by moving the email files into a different folder. These attempts will be detected by the search.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "email_files_written_outside_of_the_outlook_directory_filter"
               }
            ],
            "name": "Email files written outside of the Outlook directory",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Filesystem.file_path) as file_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem where (Filesystem.file_name=*.pst OR Filesystem.file_name=*.ost) Filesystem.file_path != \"C:\\\\Users\\\\*\\\\My Documents\\\\Outlook Files\\\\*\"  Filesystem.file_path!=\"C:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Outlook*\" by Filesystem.action Filesystem.process_id Filesystem.file_name Filesystem.dest | `drop_dm_object_name(\"Filesystem\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`| `email_files_written_outside_of_the_outlook_directory_filter` ",
            "tags": {
               "analytics_story": [
                  "Collection and Staging"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Magic Hound",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1114.001"
               ],
               "mitre_attack_tactics": [
                  "Collection"
               ],
               "mitre_attack_technique": [
                  "Local Email Collection"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for an increase of data transfers from your email server to your clients. This could be indicative of a malicious actor collecting data using your email server.",
            "how_to_implement": "This search requires you to be ingesting your network traffic and populating the Network_Traffic data model.  Your email servers must be categorized as \"email_server\" for the search to work, as well. You may need to adjust the deviation_threshold and minimum_data_samples values based on the network traffic in your environment. The \"deviation_threshold\" field is a multiplying factor to control how much variation you're willing to tolerate. The \"minimum_data_samples\" field is the minimum number of connections of data samples required for the statistic to be valid.",
            "id": "7f5fb3e1-4209-4914-90db-0ec21b556378",
            "known_false_positives": "The false-positive rate will vary based on how you set the deviation_threshold and data_samples values. Our recommendation is to adjust these values based on your network traffic to and from your email servers.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "email_servers_sending_high_volume_traffic_to_hosts_filter"
               }
            ],
            "name": "Email servers sending high volume traffic to hosts",
            "references": [],
            "search": "| tstats `security_content_summariesonly` sum(All_Traffic.bytes_out) as bytes_out from datamodel=Network_Traffic where All_Traffic.src_category=email_server by All_Traffic.dest_ip _time span=1d | `drop_dm_object_name(\"All_Traffic\")` | eventstats avg(bytes_out) as avg_bytes_out stdev(bytes_out) as stdev_bytes_out | eventstats count as num_data_samples avg(eval(if(_time < relative_time(now(), \"@d\"), bytes_out, null))) as per_source_avg_bytes_out stdev(eval(if(_time < relative_time(now(), \"@d\"), bytes_out, null))) as per_source_stdev_bytes_out by dest_ip | eval minimum_data_samples = 4, deviation_threshold = 3 | where num_data_samples >= minimum_data_samples AND bytes_out > (avg_bytes_out + (deviation_threshold * stdev_bytes_out)) AND bytes_out > (per_source_avg_bytes_out + (deviation_threshold * per_source_stdev_bytes_out)) AND _time >= relative_time(now(), \"@d\") | eval num_standard_deviations_away_from_server_average = round(abs(bytes_out - avg_bytes_out) / stdev_bytes_out, 2), num_standard_deviations_away_from_client_average = round(abs(bytes_out - per_source_avg_bytes_out) / per_source_stdev_bytes_out, 2) | table dest_ip, _time, bytes_out, avg_bytes_out, per_source_avg_bytes_out, num_standard_deviations_away_from_server_average, num_standard_deviations_away_from_client_average | `email_servers_sending_high_volume_traffic_to_hosts_filter`",
            "tags": {
               "analytics_story": [
                  "Collection and Staging"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT1",
                  "FIN4",
                  "APT28",
                  "Dragonfly 2.0",
                  "Ke3chang",
                  "Leafminer"
               ],
               "mitre_attack_id": [
                  "T1114.002"
               ],
               "mitre_attack_tactics": [
                  "Collection"
               ],
               "mitre_attack_technique": [
                  "Remote Email Collection"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for an increase of data transfers from your email server to your clients. This could be indicative of a malicious actor collecting data using your email server.",
            "how_to_implement": "This search requires you to be ingesting your network traffic and populating the Network_Traffic data model.  Your email servers must be categorized as \"email_server\" for the search to work, as well. You may need to adjust the deviation_threshold and minimum_data_samples values based on the network traffic in your environment. The \"deviation_threshold\" field is a multiplying factor to control how much variation you're willing to tolerate. The \"minimum_data_samples\" field is the minimum number of connections of data samples required for the statistic to be valid.",
            "id": "7f5fb3e1-4209-4914-90db-0ec21b556368",
            "known_false_positives": "The false-positive rate will vary based on how you set the deviation_threshold and data_samples values. Our recommendation is to adjust these values based on your network traffic to and from your email servers.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "hosts_receiving_high_volume_of_network_traffic_from_email_server_filter"
               }
            ],
            "name": "Hosts receiving high volume of network traffic from email server",
            "references": [],
            "search": "| tstats `security_content_summariesonly` sum(All_Traffic.bytes_in) as bytes_in from datamodel=Network_Traffic where All_Traffic.dest_category=email_server by All_Traffic.src_ip _time span=1d | `drop_dm_object_name(\"All_Traffic\")` | eventstats avg(bytes_in) as avg_bytes_in stdev(bytes_in) as stdev_bytes_in | eventstats count as num_data_samples avg(eval(if(_time < relative_time(now(), \"@d\"), bytes_in, null))) as per_source_avg_bytes_in stdev(eval(if(_time < relative_time(now(), \"@d\"), bytes_in, null))) as per_source_stdev_bytes_in by src_ip | eval minimum_data_samples = 4, deviation_threshold = 3 | where num_data_samples >= minimum_data_samples AND bytes_in > (avg_bytes_in + (deviation_threshold * stdev_bytes_in)) AND bytes_in > (per_source_avg_bytes_in + (deviation_threshold * per_source_stdev_bytes_in)) AND _time >= relative_time(now(), \"@d\") | eval num_standard_deviations_away_from_server_average = round(abs(bytes_in - avg_bytes_in) / stdev_bytes_in, 2), num_standard_deviations_away_from_client_average = round(abs(bytes_in - per_source_avg_bytes_in) / per_source_stdev_bytes_in, 2) | table src_ip, _time, bytes_in, avg_bytes_in, per_source_avg_bytes_in, num_standard_deviations_away_from_server_average, num_standard_deviations_away_from_client_average | `hosts_receiving_high_volume_of_network_traffic_from_email_server_filter`",
            "tags": {
               "analytics_story": [
                  "Collection and Staging"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT1",
                  "FIN4",
                  "APT28",
                  "Dragonfly 2.0",
                  "Ke3chang",
                  "Leafminer"
               ],
               "mitre_attack_id": [
                  "T1114.002"
               ],
               "mitre_attack_tactics": [
                  "Collection"
               ],
               "mitre_attack_technique": [
                  "Remote Email Collection"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-22",
            "description": "This search detects writes to the 'System Volume Information' folder by something other than the System process.",
            "how_to_implement": "You need to be ingesting logs with both the process name and command-line from your endpoints. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
            "id": "cd6297cd-2bdd-4aa1-84aa-5d2f84228fac",
            "known_false_positives": "It is possible that other utilities or system processes may legitimately write to this folder. Investigate and modify the search to include exceptions as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "sysmon"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_writes_to_system_volume_information_filter"
               }
            ],
            "name": "Suspicious writes to System Volume Information",
            "references": [],
            "search": "(`sysmon` OR tag=process) EventCode=11 process_id!=4 file_path=*System\\ Volume\\ Information* | stats count min(_time) as firstTime max(_time) as lastTime by dest, Image, file_path | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `suspicious_writes_to_system_volume_information_filter`",
            "tags": {
               "analytics_story": [
                  "Collection and Staging"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 8"
               ],
               "mitre_attack_groups": [
                  "Windshift",
                  "APT32",
                  "BRONZE BUTLER",
                  "menuPass",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1036"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Masquerading"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-22",
            "description": "This search detects writes to the recycle bin by a process other than explorer.exe.",
            "how_to_implement": "To successfully implement this search you need to be ingesting information on filesystem and process logs responsible for the changes from your endpoints into the `Endpoint` datamodel in the `Processes` and `Filesystem` nodes.",
            "id": "b5541828-8ffd-4070-9d95-b3da4de924cb",
            "known_false_positives": "Because the Recycle Bin is a hidden folder in modern versions of Windows, it would be unusual for a process other than explorer.exe to write to it. Incidents should be investigated as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_writes_to_windows_recycle_bin_filter"
               }
            ],
            "name": "Suspicious writes to windows Recycle Bin",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.file_path) as file_path values(Filesystem.file_name) as file_name FROM datamodel=Endpoint.Filesystem where Filesystem.file_path = \"*$Recycle.Bin*\" by Filesystem.process_id Filesystem.dest | `drop_dm_object_name(\"Filesystem\")`| search [| tstats `security_content_summariesonly` values(Processes.user) as user values(Processes.process_name) as process_name values(Processes.parent_process_name) as parent_process_name FROM datamodel=Endpoint.Processes where Processes.process_name != \"explorer.exe\" by Processes.process_id Processes.dest| `drop_dm_object_name(\"Processes\")` | table process_id dest] | `suspicious_writes_to_windows_recycle_bin_filter`",
            "tags": {
               "analytics_story": [
                  "Collection and Staging"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 8"
               ],
               "mitre_attack_groups": [
                  "Windshift",
                  "APT32",
                  "BRONZE BUTLER",
                  "menuPass",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1036"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Masquerading"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "8e03c61e-13c4-4dcd-bfbe-5ce5a8dc031a",
      "name": "Collection and Staging",
      "narrative": "A common adversary goal is to identify and exfiltrate data of value from a target organization. This data may include email conversations and addresses, confidential company information, links to network design/infrastructure, important dates, and so on.\\\n Attacks are composed of three activities: identification, collection, and staging data for exfiltration. Identification typically involves scanning systems and observing user activity. Collection can involve the transfer of large amounts of data from various repositories. Staging/preparation includes moving data to a central location and compressing (and optionally encoding and/or encrypting) it. All of these activities provide opportunities for defenders to identify their presence. \\\nUse the searches to detect and monitor suspicious behavior related to these activities.",
      "references": [
         "https://attack.mitre.org/wiki/Collection",
         "https://attack.mitre.org/wiki/Technique/T1074"
      ],
      "tags": {
         "analytics_story": "Collection and Staging",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Ke3chang",
            "Leafminer",
            "Magic Hound",
            "APT1",
            "APT32",
            "APT28",
            "BRONZE BUTLER",
            "FIN4",
            "menuPass",
            "Windshift",
            "Dragonfly 2.0"
         ],
         "mitre_attack_id": [
            "T1114.002",
            "T1114.001",
            "T1036"
         ],
         "mitre_attack_tactics": [
            "Defense Evasion",
            "Collection"
         ],
         "mitre_attack_technique": [
            "Remote Email Collection",
            "Local Email Collection",
            "Masquerading"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2018-06-01",
      "description": "Detect and investigate tactics, techniques, and procedures leveraged by attackers to establish and operate command and control channels. Implants installed by attackers on compromised endpoints use these channels to receive instructions and send data back to the malicious operators.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search allows you to identify the endpoints that have connected to more than five DNS servers and made DNS Queries over the time frame of the search.",
            "how_to_implement": "This search requires that DNS data is being ingested and populating the `Network_Resolution` data model. This data can come from DNS logs or from solutions that parse network traffic for this data, such as Splunk Stream or Bro.\\\nThis search produces fields (`dest_count`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** Distinct DNS Connections, **Field:** dest_count\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "74ec6f18-604b-4202-a567-86b2066be3ce",
            "known_false_positives": "It's possible that an enterprise has more than five DNS servers that are configured in a round-robin rotation. Please customize the search, as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "clients_connecting_to_multiple_dns_servers_filter"
               }
            ],
            "name": "Clients Connecting to Multiple DNS Servers",
            "search": "| tstats `security_content_summariesonly` count, values(DNS.dest) AS dest dc(DNS.dest) as dest_count from datamodel=Network_Resolution where DNS.message_type=QUERY by DNS.src | `drop_dm_object_name(\"Network_Resolution\")` |where dest_count > 5 | `clients_connecting_to_multiple_dns_servers_filter` ",
            "tags": {
               "analytics_story": [
                  "DNS Hijacking",
                  "Command and Control",
                  "Suspicious DNS Traffic",
                  "Host Redirection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT32",
                  "APT33",
                  "Thrip",
                  "FIN8",
                  "OilRig",
                  "Lazarus Group"
               ],
               "mitre_attack_id": [
                  "T1048.003"
               ],
               "mitre_attack_tactics": [
                  "Exfiltration"
               ],
               "mitre_attack_technique": [
                  "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-01-16",
            "description": "Malicious actors often abuse legitimate Dynamic DNS services to host malicious payloads or interactive command and control nodes. Attackers will automate domain resolution changes by routing dynamic domains to countless IP addresses to circumvent firewall blocks, blacklists as well as frustrate a network defenders analytic and investigative processes. This search will look for DNS queries made from within your infrastructure to suspicious dynamic domains.",
            "how_to_implement": "First, you'll need to ingest data from your DNS operations. This can be done by ingesting logs from your server or data, collected passively by Splunk Stream or a similar solution. Specifically, data that contains the domain that is being queried and the IP of the host originating the request must be populating the `Network_Resolution` data model. This search also leverages a lookup file, `dynamic_dns_providers_default.csv`, which contains a non-exhaustive list of Dynamic DNS providers. Please consider updating the local lookup periodically by adding new domains to the list of `dynamic_dns_providers_local.csv`.\\\nThis search produces fields (query, answer, isDynDNS) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable event. To see the additional metadata, add the following fields, if not already present, to Incident Review. Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** DNS Query, **Field:** query\\\n1. \\\n1. **Label:** DNS Answer, **Field:** answer\\\n1. \\\n1. **Label:** IsDynamicDNS, **Field:** isDynDNS\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "c77162d3-f93c-45cc-80c8-22f6v5464g9f",
            "known_false_positives": "Some users and applications may leverage Dynamic DNS to reach out to some domains on the Internet since dynamic DNS by itself is not malicious, however this activity must be verified.",
            "macros": [
               {
                  "definition": "lookup update=true dynamic_dns_providers_default dynamic_dns_domains as query OUTPUTNEW isDynDNS_default | lookup update=true dynamic_dns_providers_local dynamic_dns_domains as query OUTPUTNEW isDynDNS_local| eval isDynDNS = coalesce(isDynDNS_default, isDynDNS_local)|fields - isDynDNS_default, isDynDNS_local| search isDynDNS=True",
                  "description": "This macro limits the output of the query field to dynamic dns domains. It looks up the domains in a file provided by Splunk and one intended to be updated by the end user.",
                  "name": "dynamic_dns_providers"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_hosts_connecting_to_dynamic_domain_providers_filter"
               }
            ],
            "name": "Detect hosts connecting to dynamic domain providers",
            "search": "| tstats `security_content_summariesonly` count values(DNS.answer) as answer min(_time) as firstTime from datamodel=Network_Resolution by DNS.src, DNS.query | `drop_dm_object_name(\"DNS\")` | `security_content_ctime(firstTime)` | `dynamic_dns_providers` | `detect_hosts_connecting_to_dynamic_domain_providers_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection",
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "DNS Hijacking",
                  "Suspicious DNS Traffic",
                  "Dynamic DNS",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.DS",
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2018-06-01",
            "description": "This search looks for outbound ICMP packets with a packet size larger than 1,000 bytes. Various threat actors have been known to use ICMP as a command and control channel for their attack infrastructure. Large ICMP packets from an endpoint to a remote host may be indicative of this activity.",
            "how_to_implement": "In order to run this search effectively, we highly recommend that you leverage the Assets and Identity framework. It is important that you have a good understanding of how your network segments are designed and that you are able to distinguish internal from external address space. Add a category named `internal` to the CIDRs that host the company's assets in the `assets_by_cidr.csv` lookup file, which is located in `$SPLUNK_HOME/etc/apps/SA-IdentityManagement/lookups/`. More information on updating this lookup can be found here: https://docs.splunk.com/Documentation/ES/5.0.0/Admin/Addassetandidentitydata. This search also requires you to be ingesting your network traffic and populating the Network_Traffic data model",
            "id": "e9c102de-4d43-42a7-b1c8-8062ea297419",
            "known_false_positives": "ICMP packets are used in a variety of ways to help troubleshoot networking issues and ensure the proper flow of traffic. As such, it is possible that a large ICMP packet could be perfectly legitimate. If large ICMP packets are associated with command and control traffic, there will typically be a large number of these packets observed over time. If the search is providing a large number of false positives, you can modify the search to adjust the byte threshold or whitelist specific IP addresses, as necessary.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_large_outbound_icmp_packets_filter"
               }
            ],
            "name": "Detect Large Outbound ICMP Packets",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count earliest(_time) as firstTime latest(_time) as lastTime values(All_Traffic.action) values(All_Traffic.bytes) from datamodel=Network_Traffic where All_Traffic.action !=blocked All_Traffic.dest_category !=internal (All_Traffic.protocol=icmp OR All_Traffic.transport=icmp) All_Traffic.bytes > 1000 by All_Traffic.src_ip All_Traffic.dest_ip | `drop_dm_object_name(\"All_Traffic\")` | search ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16) | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)` | `detect_large_outbound_icmp_packets_filter`",
            "tags": {
               "analytics_story": [
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT29",
                  "PLATINUM",
                  "APT3"
               ],
               "mitre_attack_id": [
                  "T1095"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "Non-Application Layer Protocol"
               ],
               "nist": [
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search is used to detect attempts to use DNS tunneling, by calculating the length of responses to DNS TXT queries. Endpoints using DNS as a method of transmission for data exfiltration, command and control, or evasion of security controls can often be detected by noting unusually large volumes of DNS traffic.",
            "how_to_implement": "To successfully implement this search you need to ingest data from your DNS logs, or monitor DNS traffic using Stream, Bro or something similar. Specifically, this query requires that the DNS data model is populated with information regarding the DNS record type that is being returned as well as the data in the answer section of the protocol.",
            "id": "05437c07-62f5-452e-afdc-04dd44815bb9",
            "known_false_positives": "It's possible that legitimate TXT record responses can be long enough to trigger this search. You can modify the packet threshold for this search to help mitigate false positives.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_long_dns_txt_record_response_filter"
               }
            ],
            "name": "Detect Long DNS TXT Record Response",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Resolution where DNS.message_type=response AND DNS.record_type=TXT by DNS.src DNS.dest DNS.answer DNS.record_type |  `drop_dm_object_name(\"DNS\")` | eval anslen=len(answer) | search anslen>100 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename src as \"Source IP\", dest as \"Destination IP\", answer as \"DNS Answer\" anslen as \"Answer Length\" record_type as \"DNS Record Type\" firstTime as \"First Time\" lastTime as \"Last Time\" count as Count | table \"Source IP\" \"Destination IP\" \"DNS Answer\" \"DNS Record Type\"  \"Answer Length\" Count \"First Time\" \"Last Time\" | `detect_long_dns_txt_record_response_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.DS",
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-05-07",
                  "description": "This search establishes, on a per-hour basis, the average and the standard deviation of the number of outbound connections blocked in your VPC flow logs by each source IP address (IP address of your EC2 instances). Also recorded is the number of data points for each source IP. This table outputs to a lookup file to allow the detection search to operate quickly.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your `VPC flow logs.`.",
                  "id": "fc0edd96-ff2b-48b0-9f1f-63da3782fd63",
                  "name": "Baseline of blocked outbound traffic from AWS",
                  "search": "`cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16) | bucket _time span=1h | stats count as numberOfBlockedConnections by _time, src_ip | stats count(numberOfBlockedConnections) as numDataPoints, latest(numberOfBlockedConnections) as latestCount, avg(numberOfBlockedConnections) as avgBlockedConnections, stdev(numberOfBlockedConnections) as stdevBlockedConnections by src_ip | table src_ip, latestCount, numDataPoints, avgBlockedConnections, stdevBlockedConnections | outputlookup baseline_blocked_outbound_connections | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Network ACL Activity",
                        "Command and Control",
                        "Suspicious AWS Traffic"
                     ],
                     "detections": [
                        "Detect Spike in blocked Outbound Traffic from your AWS"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-05-07",
            "description": "This search will detect spike in blocked outbound network connections originating from within your AWS environment.  It will also update the cache file that factors in the latest data.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your VPC Flow logs. You can modify `dataPointThreshold` and `deviationThreshold` to better fit your environment. The `dataPointThreshold` variable is the number of data points required to meet the definition of \"spike.\" The `deviationThreshold` variable is the number of standard deviations away from the mean that the value must be to be considered a spike. This search works best when you run the \"Baseline of Blocked Outbound Connection\" support search once to create a history of previously seen blocked outbound connections.",
            "id": "ada0f278-84a8-46w1-a3f1-w32372d4bd53",
            "known_false_positives": "The false-positive rate may vary based on the values of`dataPointThreshold` and `deviationThreshold`. Additionally, false positives may result when AWS administrators roll out policies enforcing network blocks, causing sudden increases in the number of blocked outbound connections.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudwatchlogs:vpcflow",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudwatchlogs_vpcflow"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_spike_in_blocked_outbound_traffic_from_your_aws_filter"
               }
            ],
            "name": "Detect Spike in blocked Outbound Traffic from your AWS",
            "references": [],
            "search": "`cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  [search  `cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  | stats count as numberOfBlockedConnections by src_ip | inputlookup baseline_blocked_outbound_connections append=t | fields - latestCount | stats values(*) as * by src_ip | rename numberOfBlockedConnections as latestCount | eval newAvgBlockedConnections=avgBlockedConnections + (latestCount-avgBlockedConnections)/720 | eval newStdevBlockedConnections=sqrt(((pow(stdevBlockedConnections, 2)*719 + (latestCount-newAvgBlockedConnections)*(latestCount-avgBlockedConnections))/720)) | eval avgBlockedConnections=coalesce(newAvgBlockedConnections, avgBlockedConnections), stdevBlockedConnections=coalesce(newStdevBlockedConnections, stdevBlockedConnections), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) | table src_ip, latestCount, numDataPoints, avgBlockedConnections, stdevBlockedConnections | outputlookup baseline_blocked_outbound_connections | eval dataPointThreshold = 5, deviationThreshold = 3 | eval isSpike=if((latestCount > avgBlockedConnections+deviationThreshold*stdevBlockedConnections) AND numDataPoints > dataPointThreshold, 1, 0) | where isSpike=1 | table src_ip] | stats values(dest_ip) as \"Blocked Destination IPs\", values(interface_id) as \"resourceId\" count as numberOfBlockedConnections, dc(dest_ip) as uniqueDestConnections by src_ip | `detect_spike_in_blocked_outbound_traffic_from_your_aws_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Network ACL Activity",
                  "Suspicious AWS Traffic",
                  "Command and Control"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 11"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives",
                  "Command and Control"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.AE",
                  "DE.CM",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-18",
            "description": "This search is used to detect DNS tunneling, by calculating the sum of the length of DNS queries and DNS answers. The search also filters out potential false positives by filtering out queries made to internal systems and the queries originating from internal DNS, Web, and Email servers. Endpoints using DNS as a method of transmission for data exfiltration, command and control, or evasion of security controls can often be detected by noting an unusually large volume of DNS traffic.",
            "how_to_implement": "To successfully implement this search, we must ensure that DNS data is being ingested and mapped to the appropriate fields in the Network_Resolution data model. Fields like src_category are automatically provided by the Assets and Identity Framework shipped with Splunk Enterprise Security. You will need to ensure you are using the Assets and Identity Framework and populating the src_category field. You will also need to enable the `cim_corporate_web_domain_search()` macro which will essentially filter out the DNS queries made to the corporate web domains to reduce alert fatigue.",
            "id": "104658f4-afdc-499f-9719-17a43f9826f4",
            "known_false_positives": "It's possible that normal DNS traffic will exhibit this behavior. If an alert is generated, please investigate and validate as appropriate. The threshold can also be modified to better suit your environment.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detection_of_dns_tunnels_filter"
               }
            ],
            "name": "Detection of DNS Tunnels",
            "references": [],
            "search": "| tstats `security_content_summariesonly` dc(\"DNS.query\") as count  from datamodel=Network_Resolution  where nodename=DNS \"DNS.message_type\"=\"QUERY\" NOT (`cim_corporate_web_domain_search(\"DNS.query\")`) NOT \"DNS.query\"=\"*.in-addr.arpa\" NOT (\"DNS.src_category\"=\"svc_infra_dns\" OR \"DNS.src_category\"=\"svc_infra_webproxy\" OR \"DNS.src_category\"=\"svc_infra_email*\"   ) by \"DNS.src\",\"DNS.query\" | rename \"DNS.src\" as src  \"DNS.query\" as message | eval length=len(message) | stats sum(length) as length by src | append [ tstats `security_content_summariesonly` dc(\"DNS.answer\") as count  from datamodel=Network_Resolution  where nodename=DNS \"DNS.message_type\"=\"QUERY\" NOT (`cim_corporate_web_domain_search(\"DNS.query\")`) NOT \"DNS.query\"=\"*.in-addr.arpa\" NOT (\"DNS.src_category\"=\"svc_infra_dns\" OR \"DNS.src_category\"=\"svc_infra_webproxy\" OR \"DNS.src_category\"=\"svc_infra_email*\"   ) by \"DNS.src\",\"DNS.answer\" | rename \"DNS.src\" as src  \"DNS.answer\" as message | eval message=if(message==\"unknown\",\"\", message) | eval length=len(message) | stats sum(length) as length by src ] | stats sum(length) as length by src | where length > 10000 | `detection_of_dns_tunnels_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection",
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the length of the DNS queries for each DNS record type observed in the environment. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search, which uses it to identify outliers in the length of the DNS query.",
                  "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "c914844c-0ff5-4efc-8d44-c063443129ba",
                  "name": "Baseline of DNS Query Length - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution by DNS.query DNS.record_type | search DNS.record_type=* | `drop_dm_object_name(\"DNS\")` | eval query_length = len(query) | fit DensityFunction query_length by record_type into dns_query_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "Command and Control",
                        "Hidden Cobra Malware",
                        "Suspicious DNS Traffic"
                     ],
                     "detections": [
                        "DNS Query Length Outliers - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-01-22",
            "description": "This search allows you to identify DNS requests that are unusually large for the record type being requested in your environment.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, the Machine Learning Toolkit (MLTK) version 4.2 or greater must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of DNS Query Length - MLTK\" must be executed before this detection search, because it builds a machine-learning (ML) model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.\\\nThis search produces fields (`query`,`query_length`,`count`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** DNS Query, **Field:** query\\\n1. \\\n1. **Label:** DNS Query Length, **Field:** query_length\\\n1. \\\n1. **Label:** Number of events, **Field:** count\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "85fbcfe8-9718-4911-adf6-7000d077a3a9",
            "known_false_positives": "If you are seeing more results than desired, you may consider reducing the value for threshold in the search. You should also periodically re-run the support search to re-build the ML model on the latest data.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_length_outliers___mltk_filter"
               }
            ],
            "name": "DNS Query Length Outliers - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as start_time max(_time) as end_time values(DNS.src) as src values(DNS.dest) as dest from datamodel=Network_Resolution by DNS.query DNS.record_type | search DNS.record_type=* |  `drop_dm_object_name(DNS)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | eval query_length = len(query) | apply dns_query_pdfmodel threshold=0.01 | rename \"IsOutlier(query_length)\" as isOutlier | search isOutlier > 0 | sort -query_length | table start_time end_time query record_type count src dest query_length | `dns_query_length_outliers___mltk_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search allows you to identify DNS requests and compute the standard deviation on the length of the names being resolved, then filter on two times the standard deviation to show you those queries that are unusually large for your environment.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model.",
            "id": "1a67f15a-f4ff-4170-84e9-08cf6f75d6f5",
            "known_false_positives": "It's possible there can be long domain names that are legitimate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_length_with_high_standard_deviation_filter"
               }
            ],
            "name": "DNS Query Length With High Standard Deviation",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution by DNS.query DNS.record_type |  `drop_dm_object_name(\"DNS\")` | eval query_length = len(query) | table query query_length record_type count | eventstats stdev(query_length) AS stdev avg(query_length) AS avg p50(query_length) AS p50| where query_length>(avg+stdev*2) | eval z_score=(query_length-avg)/stdev | `dns_query_length_with_high_standard_deviation_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search will detect DNS requests resolved by unauthorized DNS servers. Legitimate DNS servers should be identified in the Enterprise Security Assets and Identity Framework.",
            "how_to_implement": "To successfully implement this search you will need to ensure that DNS data is populating the Network_Resolution data model. It also requires that your DNS servers are identified correctly in the Assets and Identity table of Enterprise Security.",
            "id": "1a67f15a-f4ff-4170-84e9-08cf6f75d6f6",
            "known_false_positives": "Legitimate DNS activity can be detected in this search. Investigate, verify and update the list of authorized DNS servers as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_requests_resolved_by_unauthorized_dns_servers_filter"
               }
            ],
            "name": "DNS Query Requests Resolved by Unauthorized DNS Servers",
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution where DNS.dest_category != dns_server AND DNS.src_category != dns_server by DNS.src DNS.dest | `drop_dm_object_name(\"DNS\")` | `dns_query_requests_resolved_by_unauthorized_dns_servers_filter` ",
            "tags": {
               "analytics_story": [
                  "DNS Hijacking",
                  "Command and Control",
                  "Suspicious DNS Traffic",
                  "Host Redirection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 1",
                  "CIS 3",
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS",
                  "PR.IP",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search identifies DNS query failures by counting the number of DNS responses that do not indicate success, and trigger on more than 50 occurrences.",
            "how_to_implement": "To successfully implement this search you must ensure that DNS data is populating the Network_Resolution data model.",
            "id": "104658f4-afdc-499e-9719-17243f9826f1",
            "known_false_positives": "It is possible legitimate traffic can trigger this rule. Please investigate as appropriate. The threshold for generating an event can also be customized to better suit your environment.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "excessive_dns_failures_filter"
               }
            ],
            "name": "Excessive DNS Failures",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(\"DNS.query\") as queries from datamodel=Network_Resolution where nodename=DNS \"DNS.reply_code\"!=\"No Error\" \"DNS.reply_code\"!=\"NoError\" DNS.reply_code!=\"unknown\" NOT \"DNS.query\"=\"*.arpa\" \"DNS.query\"=\"*.*\" by \"DNS.src\",\"DNS.query\"| `drop_dm_object_name(\"DNS\")`| lookup cim_corporate_web_domain_lookup domain as query OUTPUT domain| where isnull(domain)| lookup update=true alexa_lookup_by_str domain as query OUTPUT rank| where isnull(rank)| stats sum(count) as count mode(queries) as queries by src| `get_asset(src)`| where count>50 | `excessive_dns_failures_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for network traffic defined by port and transport layer protocol in the Enterprise Security lookup table \"lookup_interesting_ports\", that is marked as prohibited, and has an associated 'allow' action in the Network_Traffic data model. This could be indicative of a misconfigured network device.",
            "how_to_implement": "In order to properly run this search, Splunk needs to ingest data from firewalls or other network control devices that mediate the traffic allowed into an environment. This is necessary so that the search can identify an 'action' taken on the traffic of interest. The search requires the Network_Traffic data model be populated.",
            "id": "ce5a0962-849f-4720-a678-753fe6674479",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "prohibited_network_traffic_allowed_filter"
               }
            ],
            "name": "Prohibited Network Traffic Allowed",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.action = allowed by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action | lookup update=true interesting_ports_lookup dest_port as All_Traffic.dest_port OUTPUT app is_prohibited note transport | search is_prohibited=true | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `prohibited_network_traffic_allowed_filter`",
            "tags": {
               "analytics_story": [
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "Ransomware",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Delivery",
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1048"
               ],
               "mitre_attack_tactics": [
                  "Exfiltration"
               ],
               "mitre_attack_technique": [
                  "Exfiltration Over Alternative Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for network traffic on common ports where a higher layer protocol does not match the port that is being used. For example, this search should identify cases where protocols other than HTTP are running on TCP port 80. This can be used by attackers to circumvent firewall restrictions, or as an attempt to hide malicious communications over ports and protocols that are typically allowed and not well inspected.",
            "how_to_implement": "Running this search properly requires a technology that can inspect network traffic and identify common protocols. Technologies such as Bro and Palo Alto Networks firewalls are two examples that will identify protocols via inspection, and not just assume a specific protocol based on the transport protocol and ports.",
            "id": "54dc1265-2f74-4b6d-b30d-49eb506a31b3",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "protocol_or_port_mismatch_filter"
               }
            ],
            "name": "Protocol or Port Mismatch",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where (All_Traffic.app=dns NOT All_Traffic.dest_port=53) OR ((All_Traffic.app=web-browsing OR All_Traffic.app=http) NOT (All_Traffic.dest_port=80 OR All_Traffic.dest_port=8080 OR All_Traffic.dest_port=8000)) OR (All_Traffic.app=ssl NOT (All_Traffic.dest_port=443 OR All_Traffic.dest_port=8443)) OR (All_Traffic.app=smtp NOT All_Traffic.dest_port=25) by All_Traffic.src_ip, All_Traffic.dest_ip, All_Traffic.app, All_Traffic.dest_port |`security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `protocol_or_port_mismatch_filter`",
            "tags": {
               "analytics_story": [
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT32",
                  "APT33",
                  "Thrip",
                  "FIN8",
                  "OilRig",
                  "Lazarus Group"
               ],
               "mitre_attack_id": [
                  "T1048.003"
               ],
               "mitre_attack_tactics": [
                  "Exfiltration"
               ],
               "mitre_attack_technique": [
                  "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for network traffic identified as The Onion Router (TOR), a benign anonymity network which can be abused for a variety of nefarious purposes.",
            "how_to_implement": "In order to properly run this search, Splunk needs to ingest data from firewalls or other network control devices that mediate the traffic allowed into an environment. This is necessary so that the search can identify an 'action' taken on the traffic of interest. The search requires the Network_Traffic data model be populated.",
            "id": "ea688274-9c06-4473-b951-e4cb7a5d7a45",
            "known_false_positives": "None at this time",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "tor_traffic_filter"
               }
            ],
            "name": "TOR Traffic",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.app=tor AND All_Traffic.action=allowed by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `tor_traffic_filter`",
            "tags": {
               "analytics_story": [
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "Ransomware",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "TA505",
                  "Rocke",
                  "APT39",
                  "Tropic Trooper",
                  "MuddyWater",
                  "Wizard Spider",
                  "Inception",
                  "APT41",
                  "SilverTerrier",
                  "Machete",
                  "APT28",
                  "WIRTE",
                  "APT33",
                  "FIN4",
                  "Night Dragon",
                  "APT18",
                  "APT38",
                  "Cobalt Group",
                  "APT19",
                  "Threat Group-3390",
                  "Rancor",
                  "Orangeworm",
                  "APT37",
                  "Ke3chang",
                  "Dark Caracal",
                  "Turla",
                  "Lazarus Group",
                  "BRONZE BUTLER",
                  "APT32",
                  "OilRig",
                  "Magic Hound",
                  "Gamaredon Group",
                  "Stealth Falcon"
               ],
               "mitre_attack_id": [
                  "T1071.001"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "Web Protocols"
               ],
               "nist": [
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "943773c6-c4de-4f38-89a8-0b92f98804d8",
      "name": "Command and Control",
      "narrative": "Threat actors typically architect and implement an infrastructure to use in various ways during the course of their attack campaigns. In some cases, they leverage this infrastructure for scanning and performing reconnaissance activities. In others, they may use this infrastructure to launch actual attacks. One of the most important functions of this infrastructure is to establish servers that will communicate with implants on compromised endpoints. These servers establish a command and control channel that is used to proxy data between the compromised endpoint and the attacker. These channels relay commands from the attacker to the compromised endpoint and the output of those commands back to the attacker.\\\nBecause this communication is so critical for an adversary, they often use techniques designed to hide the true nature of the communications. There are many different techniques used to establish and communicate over these channels. This Analytic Story provides searches that look for a variety of the techniques used for these channels, as well as indications that these channels are active, by examining logs associated with border control devices and network-access control lists.",
      "references": [
         "https://attack.mitre.org/wiki/Command_and_Control",
         "https://searchsecurity.techtarget.com/feature/Command-and-control-servers-The-puppet-masters-that-govern-malware"
      ],
      "tags": {
         "analytics_story": "Command and Control",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "SilverTerrier",
            "Sandworm Team",
            "Gamaredon Group",
            "APT29",
            "Cobalt Group",
            "APT41",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "BRONZE BUTLER",
            "Thrip",
            "OilRig",
            "APT32",
            "Machete",
            "Dark Caracal",
            "PLATINUM",
            "FIN4",
            "Orangeworm",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "no",
            "Night Dragon",
            "MuddyWater",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "APT3",
            "APT39",
            "APT38",
            "APT33",
            "APT18",
            "Rocke",
            "APT28",
            "Tropic Trooper",
            "TA505",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1048.003",
            "T1095",
            "T1071.001",
            "T1071.004",
            "T1048"
         ],
         "mitre_attack_tactics": [
            "Exfiltration",
            "Command And Control"
         ],
         "mitre_attack_technique": [
            "DNS",
            "Non-Application Layer Protocol",
            "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol",
            "Exfiltration Over Alternative Protocol",
            "Web Protocols"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Splunk Research Team, Splunk",
      "date": "2019-04-29",
      "description": "Detect DNS and web requests to fake websites generated by the EvilGinx2 toolkit. These websites are designed to fool unwitting users who have clicked on a malicious link in a phishing email. ",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for DNS requests for phishing domains that are leveraging EvilGinx tools to mimic websites.",
            "how_to_implement": "You need to ingest data from your DNS logs in the Network_Resolution datamodel. Specifically you must ingest the domain that is being queried and the IP of the host originating the request. Ideally, you should also be ingesting the answer to the query and the query type. This approach allows you to also create your own localized passive DNS capability which can aid you in future investigations. You will have to add legitimate domain names to the `legit_domains.csv` file shipped with the app. \\\n **Splunk>Phantom Playbook Integration**\\\nIf Splunk>Phantom is also configured in your environment, a Playbook called `Lets Encrypt Domain Investigate` can be configured to run when any results are found by this detection search. To use this integration, install the Phantom App for Splunk `https://splunkbase.splunk.com/app/3411/`, add the correct hostname to the \"Phantom Instance\" field in the Adaptive Response Actions when configuring this detection search, and set the corresponding Playbook to active. \\\n(Playbook link:`https://my.phantom.us/4.2/playbook/lets-encrypt-domain-investigate/`).\\\n",
            "id": "24dd17b1-e2fb-4c31-878c-d4f226595bfa",
            "known_false_positives": "If a known good domain is not listed in the legit_domains.csv file, then the search could give you false postives. Please update that lookup file to filter out DNS requests to legitimate domains.",
            "macros": [
               {
                  "definition": "(query=www* AND query = m* AND query=static*)",
                  "description": "This limits the query fields to domains that are associated with evilginx masquerading as FaceBook",
                  "name": "evilginx_phishlets_facebook"
               },
               {
                  "definition": "(query=accounts* AND query=ssl* AND query=www*)",
                  "description": "This limits the query fields to domains that are associated with evilginx masquerading as Google",
                  "name": "evilginx_phishlets_google"
               },
               {
                  "definition": "(query=api* AND query = github*)",
                  "description": "This limits the query fields to domains that are associated with evilginx masquerading as GitHub",
                  "name": "evilginx_phishlets_github"
               },
               {
                  "definition": "(query=www* AND query=aws* AND query=console.aws* AND query=signin.aws* AND api-northeast-1.console.aws* AND query=fls-na* AND query=images-na*)",
                  "description": "This limits the query fields to domains that are associated with evilginx masquerading as an AWS console",
                  "name": "evilginx_phishlets_aws"
               },
               {
                  "definition": "(query=outlook* AND query=login* AND query=account*)",
                  "description": "This limits the query fields to domains that are associated with evilginx masquerading as Outlook",
                  "name": "evilginx_phishlets_outlook"
               },
               {
                  "definition": "(query=login* AND query=www*)",
                  "description": "This limits the query fields to domains that are associated with evilginx masquerading as Office 365",
                  "name": "evilginx_phishlets_0365"
               },
               {
                  "definition": "(query=fls-na* AND query = www* AND query=images*)",
                  "description": "This limits the query fields to domains that are associated with evilginx masquerading as Amazon",
                  "name": "evilginx_phishlets_amazon"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_dns_requests_to_phishing_sites_leveraging_evilginx2_filter"
               }
            ],
            "name": "Detect DNS requests to Phishing Sites leveraging EvilGinx2",
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(DNS.answer) as answer from datamodel=Network_Resolution.DNS by DNS.dest DNS.src DNS.query host | `drop_dm_object_name(DNS)`| rex field=query \".*?(?<domain>[^./:]+\\.(\\S{2,3}|\\S{2,3}.\\S{2,3}))$\" | stats count values(query) as query by domain dest src answer| search `evilginx_phishlets_amazon` OR `evilginx_phishlets_facebook` OR `evilginx_phishlets_github` OR `evilginx_phishlets_0365` OR `evilginx_phishlets_outlook` OR `evilginx_phishlets_aws` OR `evilginx_phishlets_google` | search NOT [ inputlookup legit_domains.csv | fields domain]| join domain type=outer [| tstats count `security_content_summariesonly` values(Web.url) as url from datamodel=Web.Web by Web.dest Web.site | rename \"Web.*\" as * | rex field=site \".*?(?<domain>[^./:]+\\.(\\S{2,3}|\\S{2,3}.\\S{2,3}))$\" | table dest domain url] | table count src dest query answer domain url | `detect_dns_requests_to_phishing_sites_leveraging_evilginx2_filter`",
            "tags": {
               "analytics_story": [
                  "Common Phishing Frameworks"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 7"
               ],
               "kill_chain_phases": [
                  "Delivery",
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "Magic Hound",
                  "Windshift",
                  "FIN6",
                  "OilRig",
                  "Dark Caracal"
               ],
               "mitre_attack_id": [
                  "T1566.003"
               ],
               "mitre_attack_tactics": [
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Spearphishing via Service"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS",
                  "PR.IP",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "9a64ab44-9214-4639-8163-7eaa2621bd61",
      "name": "Common Phishing Frameworks",
      "narrative": "As most people know, these emails use fraudulent domains, [email scraping](https://www.cyberscoop.com/emotet-trojan-phishing-scraping-templates-cofense-geodo/), familiar contact names inserted as senders, and other tactics to lure targets into clicking a malicious link, opening an attachment with a [nefarious payload](https://www.cyberscoop.com/emotet-trojan-phishing-scraping-templates-cofense-geodo/), or entering sensitive personal information that perpetrators may intercept. This attack technique requires a relatively low level of skill and allows adversaries to easily cast a wide net. Because phishing is a technique that relies on human psychology, you will never be able to eliminate this vulnerability 100%. But you can use automated detection to significantly reduce the risks.\\\nThis Analytic Story focuses on detecting signs of MiTM attacks enabled by [EvilGinx2](https://github.com/kgretzky/evilginx2), a toolkit that sets up a transparent proxy between the targeted site and the user. In this way, the attacker is able to intercept credentials and two-factor identification tokens. It employs a proxy template to allow a registered domain to impersonate targeted sites, such as Linkedin, Amazon, Okta, Github, Twitter, Instagram, Reddit, Office 365, and others. It can even register SSL certificates and camouflage them via a URL shortener, making them difficult to detect. Searches in this story look for signs of MiTM attacks enabled by EvilGinx2.",
      "references": [
         "https://github.com/kgretzky/evilginx2",
         "https://attack.mitre.org/techniques/T1192/",
         "https://breakdev.org/evilginx-advanced-phishing-with-two-factor-authentication-bypass/"
      ],
      "tags": {
         "analytics_story": "Common Phishing Frameworks",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "OilRig",
            "Magic Hound",
            "FIN6",
            "Dark Caracal",
            "Windshift"
         ],
         "mitre_attack_id": [
            "T1566.003"
         ],
         "mitre_attack_tactics": [
            "Initial Access"
         ],
         "mitre_attack_technique": [
            "Spearphishing via Service"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rod Soto, Rico Valdez, Splunk",
      "date": "2020-02-20",
      "description": "Use the searches in this story to monitor your Kubernetes registry repositories for upload, and deployment of potentially vulnerable, backdoor, or implanted containers. These searches provide information on source users, destination path, container names and repository names. The searches provide context to address Mitre T1525 which refers to container implantation upload to a company's repository either in Amazon Elastic Container Registry, Google Container Registry and Azure Container Registry.",
      "detections": [
         {
            "author": "Rod Soto, Rico Valdez, Splunk",
            "date": "2020-02-20",
            "description": "This search show information on uploaded containers including source user, account, action, bucket name event name, http user agent, message and destination path.",
            "how_to_implement": "You must install the GCP App for Splunk (version 2.0.0 or later), then configure stackdriver and set a subpub subscription to be imported to Splunk. You must also install Cloud Infrastructure data model. Please also customize the `container_implant_gcp_detection_filter` macro to filter out the false positives.",
            "id": "4f00ca88-e766-4605-ac65-ae51c9fd185b",
            "known_false_positives": "Uploading container is a normal behavior from developers or users with access to container registry. GCP GCR registers container upload as a Storage event, this search must be considered under the context of CONTAINER upload creation which automatically generates a bucket entry for destination path.",
            "macros": [
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "gcp_gcr_container_uploaded_filter"
               }
            ],
            "name": "GCP GCR container uploaded",
            "references": [],
            "search": "|tstats count min(_time) as firstTime max(_time) as lastTime  FROM datamodel=Cloud_Infrastructure.Storage where Storage.event_name=storage.objects.create by Storage.src_user Storage.account Storage.action Storage.bucket_name Storage.event_name Storage.http_user_agent Storage.msg Storage.object_path | `drop_dm_object_name(\"Storage\")`  | `gcp_gcr_container_uploaded_filter` ",
            "tags": {
               "analytics_story": [
                  "Container Implantation Monitoring and Investigation"
               ],
               "asset_type": "GCP GCR Container",
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1525"
               ],
               "mitre_attack_tactics": [
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Implant Container Image"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Rico Valdez, Splunk",
            "date": "2020-02-20",
            "description": "This searches show information on uploaded containers including source user, image id, source IP user type, http user agent, region, first time, last time of operation (PutImage). These searches are based on Cloud Infrastructure Data Model.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. You must also install Cloud Infrastructure data model. Please also customize the `container_implant_aws_detection_filter` macro to filter out the false positives.",
            "id": "f0f70b40-f7ad-489d-9905-23d149da8099",
            "known_false_positives": "Uploading container is a normal behavior from developers or users with access to container registry.",
            "macros": [
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "new_container_uploaded_to_aws_ecr_filter"
               }
            ],
            "name": "New container uploaded to AWS ECR",
            "references": [],
            "search": "| tstats count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Cloud_Infrastructure.Compute where Compute.user_type!=\"AssumeRole\" AND Compute.http_user_agent=\"AWS Internal\" AND Compute.event_name=\"PutImage\" by Compute.image_id Compute.src_user Compute.src Compute.region Compute.msg Compute.user_type | `drop_dm_object_name(\"Compute\")` | `new_container_uploaded_to_aws_ecr_filter` ",
            "tags": {
               "analytics_story": [
                  "Container Implantation Monitoring and Investigation"
               ],
               "asset_type": "AWS ECR container",
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1525"
               ],
               "mitre_attack_tactics": [
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Implant Container Image"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "aa0e28b1-0521-4b6f-9d2a-7b87e34af246",
      "name": "Container Implantation Monitoring and Investigation",
      "narrative": "Container Registrys provide a way for organizations to keep customized images of their development and infrastructure environment in private. However if these repositories are misconfigured or priviledge users credentials are compromise, attackers can potentially upload implanted containers which can be deployed across the organization. These searches allow operator to monitor who, when and what was uploaded to container registry.",
      "references": [
         "https://github.com/splunk/cloud-datamodel-security-research"
      ],
      "tags": {
         "analytics_story": "Container Implantation Monitoring and Investigation",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "no"
         ],
         "mitre_attack_id": [
            "T1525"
         ],
         "mitre_attack_tactics": [
            "Persistence"
         ],
         "mitre_attack_technique": [
            "Implant Container Image"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2020-02-04",
      "description": "Uncover activity consistent with credential dumping, a technique wherein attackers compromise systems and attempt to obtain and exfiltrate passwords. The threat actors use these pilfered credentials to further escalate privileges and spread throughout a target environment. The included searches in this Analytic Story are designed to identify attempts to credential dumping.",
      "detections": [
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-06",
            "description": "Detect memory dumping of the LSASS process.",
            "how_to_implement": "This search requires Sysmon Logs and a Sysmon configuration, which includes EventCode 10 for lsass.exe. This search uses an input macro named `sysmon`. We strongly recommend that you specify your environment-specific configurations (index, source, sourcetype, etc.) for Windows Sysmon logs. Replace the macro definition with configurations for your Splunk environment. The search also uses a post-filter macro designed to filter out known false positives.",
            "id": "fb4c31b0-13e8-4155-8aa5-24de4b8d6717",
            "known_false_positives": "Administrators can create memory dumps for debugging purposes, but memory dumps of the LSASS process would be unusual.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "sysmon"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "access_lsass_memory_for_dump_creation_filter"
               }
            ],
            "name": "Access LSASS Memory for Dump Creation",
            "references": [
               "https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf"
            ],
            "search": "`sysmon` EventCode=10 TargetImage=*lsass.exe CallTrace=*dbgcore.dll* OR CallTrace=*dbghelp.dll* | stats count min(_time) as firstTime max(_time) as lastTime by Computer, TargetImage, TargetProcessId, SourceImage, SourceProcessId | rename Computer as dest | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `access_lsass_memory_for_dump_creation_filter` ",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 6",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Whitefly",
                  "Blue Mockingbird",
                  "Silence",
                  "Threat Group-3390",
                  "Leviathan",
                  "APT41",
                  "Soft Cell",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Stolen Pencil",
                  "APT32",
                  "Lazarus Group",
                  "Leafminer",
                  "Magic Hound",
                  "MuddyWater",
                  "PLATINUM",
                  "FIN8",
                  "BRONZE BUTLER",
                  "OilRig",
                  "FIN6",
                  "APT3",
                  "APT28",
                  "APT1",
                  "Ke3chang",
                  "Cleaver"
               ],
               "mitre_attack_id": [
                  "T1003.001"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "LSASS Memory"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2020-07-21",
            "description": "Monitor for changes of the ExecutionPolicy in the registry to the values \"unrestricted\" or \"bypass,\" which allows the execution of malicious scripts.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Registry node. You must also be ingesting logs with the fields registry_path, registry_key_name, and registry_value_name from your endpoints.",
            "id": "c2590137-0b08-4985-9ec5-6ae23d92f63d",
            "known_false_positives": "Administrators may attempt to change the default execution policy on a system for a variety of reasons. However, setting the policy to \"unrestricted\" or \"bypass\" as this search is designed to identify, would be unusual. Hits should be reviewed and investigated as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "attempt_to_set_default_powershell_execution_policy_to_unrestricted_or_bypass_filter"
               }
            ],
            "name": "Attempt To Set Default PowerShell Execution Policy To Unrestricted or Bypass",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=*Software\\\\Microsoft\\\\Powershell\\\\1\\\\ShellIds\\\\Microsoft.PowerShell* Registry.registry_key_name=ExecutionPolicy (Registry.registry_value_name=Unrestricted OR Registry.registry_value_name=Bypass) by Registry.registry_path Registry.registry_key_name Registry.registry_value_name Registry.dest | `drop_dm_object_name(Registry)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `attempt_to_set_default_powershell_execution_policy_to_unrestricted_or_bypass_filter` ",
            "tags": {
               "analytics_story": [
                  "Malicious PowerShell",
                  "Credential Dumping"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1059.001"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-02",
            "description": "Monitor for execution of reg.exe with parameters specifying an export of keys that contain hashed credentials that attackers may try to crack offline.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints, to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "14038953-e5f2-4daf-acff-5452062baf03",
            "known_false_positives": "None identified.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "attempted_credential_dump_from_registry_via_reg_exe_filter"
               }
            ],
            "name": "Attempted Credential Dump From Registry via Reg exe",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=reg.exe OR Processes.process_name=cmd.exe) Processes.process=*save* (Processes.process=*HKEY_LOCAL_MACHINE\\\\Security* OR Processes.process=*HKEY_LOCAL_MACHINE\\\\SAM* OR Processes.process=*HKEY_LOCAL_MACHINE\\\\System* OR Processes.process=*HKLM\\\\Security* OR Processes.process=*HKLM\\\\System* OR Processes.process=*HKLM\\\\SAM*) by Processes.user Processes.process_name Processes.process Processes.dest | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `attempted_credential_dump_from_registry_via_reg_exe_filter` ",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Threat Group-3390",
                  "Ke3chang",
                  "Soft Cell",
                  "Night Dragon",
                  "Dragonfly 2.0",
                  "menuPass"
               ],
               "mitre_attack_id": [
                  "T1003.002"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "Security Account Manager"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-06",
            "description": "Detect remote thread creation into LSASS consistent with credential dumping.",
            "how_to_implement": "This search needs Sysmon Logs with a Sysmon configuration, which includes EventCode 8 with lsass.exe. This search uses an input macro named `sysmon`. We strongly recommend that you specify your environment-specific configurations (index, source, sourcetype, etc.) for Windows Sysmon logs. Replace the macro definition with configurations for your Splunk environment. The search also uses a post-filter macro designed to filter out known false positives.",
            "id": "67d4dbef-9564-4699-8da8-03a151529edc",
            "known_false_positives": "Other tools can access LSASS for legitimate reasons and generate an event. In these cases, tweaking the search may help eliminate noise.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "sysmon"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "create_remote_thread_into_lsass_filter"
               }
            ],
            "name": "Create Remote Thread into LSASS",
            "references": [
               "https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf"
            ],
            "search": "`sysmon` EventID=8 TargetImage=*lsass.exe | stats count min(_time) as firstTime max(_time) as lastTime by Computer, EventCode, TargetImage, TargetProcessId | rename Computer as dest | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `create_remote_thread_into_lsass_filter`",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 8",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Whitefly",
                  "Blue Mockingbird",
                  "Silence",
                  "Threat Group-3390",
                  "Leviathan",
                  "APT41",
                  "Soft Cell",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Stolen Pencil",
                  "APT32",
                  "Lazarus Group",
                  "Leafminer",
                  "Magic Hound",
                  "MuddyWater",
                  "PLATINUM",
                  "FIN8",
                  "BRONZE BUTLER",
                  "OilRig",
                  "FIN6",
                  "APT3",
                  "APT28",
                  "APT1",
                  "Ke3chang",
                  "Cleaver"
               ],
               "mitre_attack_id": [
                  "T1003.001"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "LSASS Memory"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-10",
            "description": "Monitor for signs that Ntdsutil, Vssadmin, or Wmic has been used to create a shadow copy.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints, to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "eb120f5f-b879-4a63-97c1-93352b5df844",
            "known_false_positives": "Legtimate administrator usage of Ntdsutil, Vssadmin, or Wmic will create false positives.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "creation_of_shadow_copy_filter"
               }
            ],
            "name": "Creation of Shadow Copy",
            "references": [
               "https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf"
            ],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=ntdsutil.exe Processes.process=*ntds* Processes.process=*create*) OR (Processes.process_name=vssadmin.exe Processes.process=*create* Processes.process=*shadow*) OR (Processes.process_name=wmic.exe Processes.process=*shadowcopy* Processes.process=*create*) by Processes.dest Processes.user Processes.process_name Processes.process  Processes.parent_process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `creation_of_shadow_copy_filter`",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "FIN6",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1003.003"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "NTDS"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-10",
            "description": "This search detects the use of wmic and Powershell to create a shadow copy.",
            "id": "2ed8b538-d284-449a-be1d-82ad1dbd186b",
            "known_false_positives": "Legtimate administrator usage of wmic to create a shadow copy.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "creation_of_shadow_copy_with_wmic_and_powershell_filter"
               }
            ],
            "name": "Creation of Shadow Copy with wmic and powershell",
            "references": [
               "https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf"
            ],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=wmic* OR Processes.process_name=powershell* Processes.process=*shadowcopy* Processes.process=*create* by Processes.user Processes.process_name Processes.process Processes.dest | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `creation_of_shadow_copy_with_wmic_and_powershell_filter`",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "FIN6",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1003.003"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "NTDS"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-10",
            "description": "This search detects credential dumping using copy command from a shadow copy.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "d8c406fe-23d2-45f3-a983-1abe7b83ff3b",
            "known_false_positives": "unknown",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "credential_dumping_via_copy_command_from_shadow_copy_filter"
               }
            ],
            "name": "Credential Dumping via Copy Command from Shadow Copy",
            "references": [
               "https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf"
            ],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe (Processes.process=*\\\\system32\\\\config\\\\sam* OR Processes.process=*\\\\system32\\\\config\\\\security* OR Processes.process=*\\\\system32\\\\config\\\\system* OR Processes.process=*\\\\windows\\\\ntds\\\\ntds.dit*) by Processes.dest Processes.user Processes.process_name Processes.process  Processes.parent_process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `credential_dumping_via_copy_command_from_shadow_copy_filter` ",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "FIN6",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1003.003"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "NTDS"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-10",
            "description": "This search detects the creation of a symlink to a shadow copy.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c5eac648-fae0-4263-91a6-773df1f4c903",
            "known_false_positives": "unknown",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "credential_dumping_via_symlink_to_shadow_copy_filter"
               }
            ],
            "name": "Credential Dumping via Symlink to Shadow Copy",
            "references": [
               "https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf"
            ],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe Processes.process=*mklink* Processes.process=*HarddiskVolumeShadowCopy* by Processes.dest Processes.user Processes.process_name Processes.process  Processes.parent_process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `credential_dumping_via_symlink_to_shadow_copy_filter` ",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "FIN6",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1003.003"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "NTDS"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-03",
            "description": "This search looks for reading lsass memory consistent with credential dumping.",
            "how_to_implement": "This search needs Sysmon Logs and a sysmon configuration, which includes EventCode 10 with lsass.exe. This search uses an input macro named `sysmon`. We strongly recommend that you specify your environment-specific configurations (index, source, sourcetype, etc.) for Windows Sysmon logs. Replace the macro definition with configurations for your Splunk environment. The search also uses a post-filter macro designed to filter out known false positives.",
            "id": "2c365e57-4414-4540-8dc0-73ab10729996",
            "known_false_positives": "The activity may be legitimate. Other tools can access lsass for legitimate reasons, and it's possible this event could be generated in those cases. In these cases, false positives should be fairly obvious and you may need to tweak the search to eliminate noise.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "sysmon"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_credential_dumping_through_lsass_access_filter"
               }
            ],
            "name": "Detect Credential Dumping through LSASS access",
            "references": [],
            "search": "`sysmon` EventCode=10 TargetImage=*lsass.exe (GrantedAccess=0x1010 OR GrantedAccess=0x1410) | stats count min(_time) as firstTime max(_time) as lastTime by Computer, SourceImage, SourceProcessId, TargetImage, TargetProcessId, EventCode, GrantedAccess | rename Computer as dest | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `detect_credential_dumping_through_lsass_access_filter` ",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Whitefly",
                  "Blue Mockingbird",
                  "Silence",
                  "Threat Group-3390",
                  "Leviathan",
                  "APT41",
                  "Soft Cell",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Stolen Pencil",
                  "APT32",
                  "Lazarus Group",
                  "Leafminer",
                  "Magic Hound",
                  "MuddyWater",
                  "PLATINUM",
                  "FIN8",
                  "BRONZE BUTLER",
                  "OilRig",
                  "FIN6",
                  "APT3",
                  "APT28",
                  "APT1",
                  "Ke3chang",
                  "Cleaver"
               ],
               "mitre_attack_id": [
                  "T1003.001"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "LSASS Memory"
               ],
               "nist": [
                  "PR.IP",
                  "PR.AC",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-03",
            "description": "This search looks for reading loaded Images unique to credential dumping with Mimikatz.",
            "how_to_implement": "This search needs Sysmon Logs and a sysmon configuration, which includes EventCode 7 with powershell.exe. This search uses an input macro named `sysmon`. We strongly recommend that you specify your environment-specific configurations (index, source, sourcetype, etc.) for Windows Sysmon logs. Replace the macro definition with configurations for your Splunk environment. The search also uses a post-filter macro designed to filter out known false positives.",
            "id": "29e307ba-40af-4ab2-91b2-3c6b392bbba0",
            "known_false_positives": "Other tools can import the same DLLs. These tools should be part of a whtelist.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "sysmon"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_mimikatz_using_loaded_images_filter"
               }
            ],
            "name": "Detect Mimikatz Using Loaded Images",
            "references": [
               "https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for.html"
            ],
            "search": "`sysmon` EventCode=7 | stats values(ImageLoaded) as ImageLoaded values(ProcessId) as ProcessId by Computer, Image | search ImageLoaded=*WinSCard.dll ImageLoaded=*cryptdll.dll ImageLoaded=*hid.dll ImageLoaded=*samlib.dll ImageLoaded=*vaultcli.dll | rename Computer as dest | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `detect_mimikatz_using_loaded_images_filter`",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 6",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Whitefly",
                  "Blue Mockingbird",
                  "Silence",
                  "Threat Group-3390",
                  "Leviathan",
                  "APT41",
                  "Soft Cell",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Stolen Pencil",
                  "APT32",
                  "Lazarus Group",
                  "Leafminer",
                  "Magic Hound",
                  "MuddyWater",
                  "PLATINUM",
                  "FIN8",
                  "BRONZE BUTLER",
                  "OilRig",
                  "FIN6",
                  "APT3",
                  "APT28",
                  "APT1",
                  "Ke3chang",
                  "Cleaver"
               ],
               "mitre_attack_id": [
                  "T1003.001"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "LSASS Memory"
               ],
               "nist": [
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2020-02-21",
            "description": "Detect the usage of comsvcs.dll for dumping the lsass process.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints, to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "8943b567-f14d-4ee8-a0bb-2121d4ce3184",
            "known_false_positives": "None identified.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dump_lsass_via_comsvcs_dll_filter"
               }
            ],
            "name": "Dump LSASS via comsvcs DLL",
            "references": [
               "https://modexp.wordpress.com/2019/08/30/minidumpwritedump-via-com-services-dll/",
               "https://twitter.com/SBousseaden/status/1167417096374050817"
            ],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=rundll32.exe Processes.process=*comsvcs.dll* Processes.process=*MiniDump* by Processes.user Processes.process_name Processes.process Processes.dest | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `dump_lsass_via_comsvcs_dll_filter`",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Whitefly",
                  "Blue Mockingbird",
                  "Silence",
                  "Threat Group-3390",
                  "Leviathan",
                  "APT41",
                  "Soft Cell",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Stolen Pencil",
                  "APT32",
                  "Lazarus Group",
                  "Leafminer",
                  "Magic Hound",
                  "MuddyWater",
                  "PLATINUM",
                  "FIN8",
                  "BRONZE BUTLER",
                  "OilRig",
                  "FIN6",
                  "APT3",
                  "APT28",
                  "APT1",
                  "Ke3chang",
                  "Cleaver"
               ],
               "mitre_attack_id": [
                  "T1003.001"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "LSASS Memory"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2019-12-06",
            "description": "This search detects loading of unsigned images by LSASS.",
            "how_to_implement": "This search needs Sysmon Logs with a sysmon configuration, which includes EventCode 7 with lsass.exe. This search uses an input macro named `sysmon`. We strongly recommend that you specify your environment-specific configurations (index, source, sourcetype, etc.) for Windows Sysmon logs. Replace the macro definition with configurations for your Splunk environment. The search also uses a post-filter macro designed to filter out known false positives.",
            "id": "56ef054c-76ef-45f9-af4a-a634695dcd65",
            "known_false_positives": "Other tools could load images into LSASS for legitimate reason. But enterprise tools should always use signed DLLs.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "sysmon"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unsigned_image_loaded_by_lsass_filter"
               }
            ],
            "name": "Unsigned Image Loaded by LSASS",
            "references": [
               "https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf"
            ],
            "search": "`sysmon` EventID=7 Image=*lsass.exe Signed=false | stats count min(_time) as firstTime max(_time) as lastTime by Computer, Image, ImageLoaded, Signed, SHA1 | rename Computer as dest | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `unsigned_image_loaded_by_lsass_filter` ",
            "tags": {
               "analytics_story": [
                  "Credential Dumping"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 8",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Whitefly",
                  "Blue Mockingbird",
                  "Silence",
                  "Threat Group-3390",
                  "Leviathan",
                  "APT41",
                  "Soft Cell",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Stolen Pencil",
                  "APT32",
                  "Lazarus Group",
                  "Leafminer",
                  "Magic Hound",
                  "MuddyWater",
                  "PLATINUM",
                  "FIN8",
                  "BRONZE BUTLER",
                  "OilRig",
                  "FIN6",
                  "APT3",
                  "APT28",
                  "APT1",
                  "Ke3chang",
                  "Cleaver"
               ],
               "mitre_attack_id": [
                  "T1003.001"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "LSASS Memory"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "854d78bf-d0e2-4f4e-b05c-640905f86d7a",
      "name": "Credential Dumping",
      "narrative": "Credential dumping&#151;gathering credentials from a target system, often hashed or encrypted&#151;is a common attack technique. Even though the credentials may not be in plain text, an attacker can still exfiltrate the data and set to cracking it offline, on their own systems. The threat actors target a variety of sources to extract them, including the Security Accounts Manager (SAM), Local Security Authority (LSA), NTDS from Domain Controllers, or the Group Policy Preference (GPP) files.\\\nOnce attackers obtain valid credentials, they use them to move throughout a target network with ease, discovering new systems and identifying assets of interest. Credentials obtained in this manner typically include those of privileged users, which may provide access to more sensitive information and system operations.\\\nThe detection searches in this Analytic Story monitor access to the Local Security Authority Subsystem Service (LSASS) process, the usage of shadowcopies for credential dumping and some other techniques for credential dumping.",
      "references": [
         "https://attack.mitre.org/wiki/Technique/T1003",
         "https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for.html"
      ],
      "tags": {
         "analytics_story": "Credential Dumping",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Sandworm Team",
            "Whitefly",
            "TEMP.Veles",
            "APT1",
            "Cobalt Group",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "Kimsuky",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Thrip",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "APT32",
            "FIN10",
            "PLATINUM",
            "FIN7",
            "APT19",
            "Ke3chang",
            "TA459",
            "Leafminer",
            "Magic Hound",
            "Night Dragon",
            "MuddyWater",
            "Threat Group-3390",
            "Lazarus Group",
            "APT3",
            "Frankenstein",
            "APT39",
            "Silence",
            "Stolen Pencil",
            "Gallmaker",
            "Dragonfly 2.0",
            "APT33",
            "Blue Mockingbird",
            "FIN6",
            "APT28",
            "Deep Panda",
            "Soft Cell",
            "DarkVishnya",
            "DarkHydrus",
            "Patchwork",
            "Cleaver",
            "Poseidon Group",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1059.001",
            "T1003.001",
            "T1003.003",
            "T1003.002"
         ],
         "mitre_attack_tactics": [
            "Credential Access",
            "Execution"
         ],
         "mitre_attack_technique": [
            "LSASS Memory",
            "NTDS",
            "PowerShell",
            "Security Account Manager"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 3
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2017-09-14",
      "description": "Fortify your data-protection arsenal--while continuing to ensure data confidentiality and integrity--with searches that monitor for and help you investigate possible signs of data exfiltration.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-01-16",
            "description": "Malicious actors often abuse legitimate Dynamic DNS services to host malicious payloads or interactive command and control nodes. Attackers will automate domain resolution changes by routing dynamic domains to countless IP addresses to circumvent firewall blocks, blacklists as well as frustrate a network defenders analytic and investigative processes. This search will look for DNS queries made from within your infrastructure to suspicious dynamic domains.",
            "how_to_implement": "First, you'll need to ingest data from your DNS operations. This can be done by ingesting logs from your server or data, collected passively by Splunk Stream or a similar solution. Specifically, data that contains the domain that is being queried and the IP of the host originating the request must be populating the `Network_Resolution` data model. This search also leverages a lookup file, `dynamic_dns_providers_default.csv`, which contains a non-exhaustive list of Dynamic DNS providers. Please consider updating the local lookup periodically by adding new domains to the list of `dynamic_dns_providers_local.csv`.\\\nThis search produces fields (query, answer, isDynDNS) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable event. To see the additional metadata, add the following fields, if not already present, to Incident Review. Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** DNS Query, **Field:** query\\\n1. \\\n1. **Label:** DNS Answer, **Field:** answer\\\n1. \\\n1. **Label:** IsDynamicDNS, **Field:** isDynDNS\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "c77162d3-f93c-45cc-80c8-22f6v5464g9f",
            "known_false_positives": "Some users and applications may leverage Dynamic DNS to reach out to some domains on the Internet since dynamic DNS by itself is not malicious, however this activity must be verified.",
            "macros": [
               {
                  "definition": "lookup update=true dynamic_dns_providers_default dynamic_dns_domains as query OUTPUTNEW isDynDNS_default | lookup update=true dynamic_dns_providers_local dynamic_dns_domains as query OUTPUTNEW isDynDNS_local| eval isDynDNS = coalesce(isDynDNS_default, isDynDNS_local)|fields - isDynDNS_default, isDynDNS_local| search isDynDNS=True",
                  "description": "This macro limits the output of the query field to dynamic dns domains. It looks up the domains in a file provided by Splunk and one intended to be updated by the end user.",
                  "name": "dynamic_dns_providers"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_hosts_connecting_to_dynamic_domain_providers_filter"
               }
            ],
            "name": "Detect hosts connecting to dynamic domain providers",
            "search": "| tstats `security_content_summariesonly` count values(DNS.answer) as answer min(_time) as firstTime from datamodel=Network_Resolution by DNS.src, DNS.query | `drop_dm_object_name(\"DNS\")` | `security_content_ctime(firstTime)` | `dynamic_dns_providers` | `detect_hosts_connecting_to_dynamic_domain_providers_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection",
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "DNS Hijacking",
                  "Suspicious DNS Traffic",
                  "Dynamic DNS",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.DS",
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-11-27",
            "description": "The search is used to detect hosts that generate Windows Event ID 4663 for successful attempts to write to or read from a removable storage and Event ID 4656 for failures, which occurs when a USB drive is plugged in. In this scenario we are querying the Change_Analysis data model to look for Windows Event ID 4656 or 4663 where the priority of the affected host is marked as high in the ES Assets and Identity Framework.",
            "how_to_implement": "To successfully implement this search, you must ingest Windows Security Event logs and track event code 4663 and 4656. Ensure that the field from the event logs is being mapped to the result_id field in the Change_Analysis data model. To minimize the alert volume, this search leverages the Assets and Identity framework to filter out events from those assets not marked high priority in the Enterprise Security Assets and Identity Framework.",
            "id": "104658f4-afdc-499f-9719-17a43f9826f5",
            "known_false_positives": "Legitimate USB activity will also be detected. Please verify and investigate as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_usb_device_insertion_filter"
               }
            ],
            "name": "Detect USB device insertion",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count earliest(_time) AS earliest latest(_time) AS latest from datamodel=Change_Analysis where (nodename = All_Changes) All_Changes.result=\"Removable Storage device\" (All_Changes.result_id=4663 OR All_Changes.result_id=4656) (All_Changes.src_priority=high) by All_Changes.dest | `drop_dm_object_name(\"All_Changes\")`| `security_content_ctime(earliest)`| `security_content_ctime(latest)`  | `detect_usb_device_insertion_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "PR.DS"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-18",
            "description": "This search is used to detect DNS tunneling, by calculating the sum of the length of DNS queries and DNS answers. The search also filters out potential false positives by filtering out queries made to internal systems and the queries originating from internal DNS, Web, and Email servers. Endpoints using DNS as a method of transmission for data exfiltration, command and control, or evasion of security controls can often be detected by noting an unusually large volume of DNS traffic.",
            "how_to_implement": "To successfully implement this search, we must ensure that DNS data is being ingested and mapped to the appropriate fields in the Network_Resolution data model. Fields like src_category are automatically provided by the Assets and Identity Framework shipped with Splunk Enterprise Security. You will need to ensure you are using the Assets and Identity Framework and populating the src_category field. You will also need to enable the `cim_corporate_web_domain_search()` macro which will essentially filter out the DNS queries made to the corporate web domains to reduce alert fatigue.",
            "id": "104658f4-afdc-499f-9719-17a43f9826f4",
            "known_false_positives": "It's possible that normal DNS traffic will exhibit this behavior. If an alert is generated, please investigate and validate as appropriate. The threshold can also be modified to better suit your environment.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detection_of_dns_tunnels_filter"
               }
            ],
            "name": "Detection of DNS Tunnels",
            "references": [],
            "search": "| tstats `security_content_summariesonly` dc(\"DNS.query\") as count  from datamodel=Network_Resolution  where nodename=DNS \"DNS.message_type\"=\"QUERY\" NOT (`cim_corporate_web_domain_search(\"DNS.query\")`) NOT \"DNS.query\"=\"*.in-addr.arpa\" NOT (\"DNS.src_category\"=\"svc_infra_dns\" OR \"DNS.src_category\"=\"svc_infra_webproxy\" OR \"DNS.src_category\"=\"svc_infra_email*\"   ) by \"DNS.src\",\"DNS.query\" | rename \"DNS.src\" as src  \"DNS.query\" as message | eval length=len(message) | stats sum(length) as length by src | append [ tstats `security_content_summariesonly` dc(\"DNS.answer\") as count  from datamodel=Network_Resolution  where nodename=DNS \"DNS.message_type\"=\"QUERY\" NOT (`cim_corporate_web_domain_search(\"DNS.query\")`) NOT \"DNS.query\"=\"*.in-addr.arpa\" NOT (\"DNS.src_category\"=\"svc_infra_dns\" OR \"DNS.src_category\"=\"svc_infra_webproxy\" OR \"DNS.src_category\"=\"svc_infra_email*\"   ) by \"DNS.src\",\"DNS.answer\" | rename \"DNS.src\" as src  \"DNS.answer\" as message | eval message=if(message==\"unknown\",\"\", message) | eval length=len(message) | stats sum(length) as length by src ] | stats sum(length) as length by src | where length > 10000 | `detection_of_dns_tunnels_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection",
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "91c676cf-0b23-438d-abee-f6335e1fce33",
      "name": "Data Protection",
      "narrative": "Attackers can leverage a variety of resources to compromise or exfiltrate enterprise data. Common exfiltration techniques include remote-access channels via low-risk, high-payoff active-collections operations and close-access operations using insiders and removable media. While this Analytic Story is not a comprehensive listing of all the methods by which attackers can exfiltrate data, it provides a useful starting point.",
      "references": [
         "https://www.cisecurity.org/controls/data-protection/",
         "https://www.sans.org/reading-room/whitepapers/dns/splunk-detect-dns-tunneling-37022",
         "https://umbrella.cisco.com/blog/2013/04/15/on-the-trail-of-malicious-dynamic-dns-domains/"
      ],
      "tags": {
         "analytics_story": "Data Protection",
         "category": [
            "Abuse"
         ],
         "mitre_attack_groups": [
            "Ke3chang",
            "Cobalt Group",
            "OilRig",
            "APT18",
            "APT41",
            "Tropic Trooper",
            "FIN7",
            "APT39"
         ],
         "mitre_attack_id": [
            "T1071.004"
         ],
         "mitre_attack_tactics": [
            "Command And Control"
         ],
         "mitre_attack_technique": [
            "DNS"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2020-01-22",
      "description": "Monitor for suspicious activities associated with DHS Technical Alert US-CERT TA18-074A. Some of the activities that adversaries used in these compromises included spearfishing attacks, malware, watering-hole domains, many and more.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for the creation of local administrator accounts using net.exe.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "b89919ed-fe5f-492c-b139-151bb162040e",
            "known_false_positives": "Administrators often leverage net.exe to create admin accounts.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "create_local_admin_accounts_using_net_exe_filter"
               }
            ],
            "name": "Create local admin accounts using net exe",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.user) as user values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=net.exe OR Processes.process_name=net1.exe) AND (Processes.process=*localgroup* OR Processes.process=*/add* OR Processes.process=*user*) by Processes.process Processes.process_name Processes.dest | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` |`create_local_admin_accounts_using_net_exe_filter` ",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "APT41",
                  "Dragonfly 2.0",
                  "Leafminer",
                  "APT3"
               ],
               "mitre_attack_id": [
                  "T1136.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Local Account"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-08",
            "description": "This search looks for newly created accounts that have been elevated to local administrators.",
            "id": "b25f6f62-0712-43c1-b203-083231ffd97d",
            "known_false_positives": "The activity may be legitimate. For this reason, it's best to verify the account with an administrator and ask whether there was a valid service request for the account creation. If your local administrator group name is not \"Administrators\", this search may generate an excessive number of false positives",
            "macros": [
               {
                  "definition": "eventtype=wineventlog_security",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wineventlog_security"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_new_local_admin_account_filter"
               }
            ],
            "name": "Detect New Local Admin account",
            "references": [],
            "search": "`wineventlog_security` EventID=4720 OR (EventID=4732 Group_Name=Administrators) | transaction MemberSid connected=false maxspan=180m | rename MemberSid as user | stats count min(_time) as firstTime max(_time) as lastTime by user dest | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `detect_new_local_admin_account_filter`",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Windows",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives",
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "APT41",
                  "Dragonfly 2.0",
                  "Leafminer",
                  "APT3"
               ],
               "mitre_attack_id": [
                  "T1136.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Local Account"
               ],
               "nist": [
                  "PR.AC",
                  "DE.CM"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for outbound SMB connections made by hosts within your network to the Internet. SMB traffic is used for Windows file-sharing activity. One of the techniques often used by attackers involves retrieving the credential hash using an SMB request made to a compromised server controlled by the threat actor.",
            "how_to_implement": "In order to run this search effectively, we highly recommend that you leverage the Assets and Identity framework. It is important that you have good understanding of how your network segments are designed, and be able to distinguish internal from external address space. Add a category named `internal` to the CIDRs that host the company's assets in `assets_by_cidr.csv` lookup file, which is located in `$SPLUNK_HOME/etc/apps/SA-IdentityManagement/lookups/`. More information on updating this lookup can be found here: https://docs.splunk.com/Documentation/ES/5.0.0/Admin/Addassetandidentitydata. This search also requires you to be ingesting your network traffic and populating the Network_Traffic data model",
            "id": "7f5fb3e1-4209-414-90db-0ec21b936378",
            "known_false_positives": "It is likely that the outbound Server Message Block (SMB) traffic is legitimate, if the company's internal networks are not well-defined in the Assets and Identity Framework. Categorize the internal CIDR blocks as `internal` in the lookup file to avoid creating notable events for traffic destined to those CIDR blocks. Any other network connection that is going out to the Internet should be investigated and blocked. Best practices suggest preventing external communications of all SMB versions and related protocols at the network boundary.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_outbound_smb_traffic_filter"
               }
            ],
            "name": "Detect Outbound SMB Traffic",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count earliest(_time) as earliest latest(_time) as latest values(All_Traffic.action) from datamodel=Network_Traffic where All_Traffic.action !=blocked All_Traffic.dest_category !=internal (All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb) by All_Traffic.src_ip All_Traffic.dest_ip | `drop_dm_object_name(\"All_Traffic\")` | search ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16) | `security_content_ctime(earliest)`| `security_content_ctime(latest)` | `detect_outbound_smb_traffic_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives",
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT41",
                  "SilverTerrier",
                  "Machete",
                  "Honeybee"
               ],
               "mitre_attack_id": [
                  "T1071.002"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "File Transfer Protocols"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2019-02-26",
            "description": "This search looks for events where `PsExec.exe` is run with the `accepteula` flag in the command line. PsExec is a built-in Windows utility that enables you to execute processes on other systems. It is fully interactive for console applications. This tool is widely used for launching interactive command prompts on remote systems. Threat actors leverage this extensively for executing code on compromised systems. If an attacker is running PsExec for the first time, they will be prompted to accept the end-user license agreement (EULA), which can be passed as the argument `accepteula` within the command line.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "b89919ed-fe5f-492c-b139-151xb162040e",
            "known_false_positives": "Administrators can leverage PsExec for accessing remote systems and might pass `accepteula` as an argument if they are running this tool for the first time. However, it is not likely that you'd see multiple occurrences of this event on a machine",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_psexec_with_accepteula_flag_filter"
               }
            ],
            "name": "Detect PsExec With accepteula Flag",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = PsExec.exe Processes.process = \"*accepteula*\" by Processes.process_name Processes.dest  Processes.parent_process_name | `drop_dm_object_name(Processes)`| `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `detect_psexec_with_accepteula_flag_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1",
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1059.003",
                  "T1059.001"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Command Shell",
                  "PowerShell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2019-03-01",
                  "description": "This search looks for command-line arguments where `cmd.exe /c` is used to execute a program, then creates a baseline of the earliest and latest times we have encountered this command-line argument in our dataset within the last 30 days.",
                  "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd23",
                  "name": "Previously seen command line arguments",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe AND Processes.process=\"* /c *\" by Processes.process | `drop_dm_object_name(Processes)`",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Orangeworm Attack Group",
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Processes launching netsh",
                        "First time seen command line argument"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for command-line arguments that use a `/c` parameter to execute a command that has not previously been seen.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model. Please make sure you run the support search \"Previously seen command line arguments,\"&#151;which creates a lookup file called `previously_seen_cmd_line_arguments.csv`&#151;a historical baseline of all command-line arguments. You must also validate this list. For the search to do accurate calculation, ensure the search scheduling is the same value as the `relative_time` evaluation function.",
            "id": "9be56c82-b1cc-4318-87eb-q138afaaqa39",
            "known_false_positives": "Legitimate programs can also use command-line arguments to execute. Please verify the command-line arguments to check what command/program is being executed. We recommend customizing the `first_time_seen_cmd_line_filter` macro to exclude legitimate parent_process_name",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "first_time_seen_command_line_argument_filter"
               }
            ],
            "name": "First time seen command line argument",
            "references": [],
            "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process Processes.process_name Processes.parent_process_name Processes.dest| `drop_dm_object_name(Processes)`| `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search [| tstats `security_content_summariesonly` earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process | `drop_dm_object_name(Processes)` | inputlookup append=t previously_seen_cmd_line_arguments | stats min(firstTime) as firstTime, max(lastTime) as lastTime by process | outputlookup previously_seen_cmd_line_arguments | eval newCmdLineArgument=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newCmdLineArgument=1 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table process] | `first_time_seen_command_line_argument_filter` ",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A",
                  "Suspicious Command-Line Executions",
                  "Orangeworm Attack Group",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Hidden Cobra Malware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda",
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.001",
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell",
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for PowerShell processes started with parameters used to bypass the local execution policy for scripts. These parameters are often observed in attacks leveraging PowerShell scripts as they override the default PowerShell execution policy.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "9be56c82-b1cc-4318-87eb-d138afaaca39",
            "known_false_positives": "There may be legitimate reasons to bypass the PowerShell execution policy. The PowerShell script being run with this parameter should be validated to ensure that it is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "malicious_powershell_process___execution_policy_bypass_filter"
               }
            ],
            "name": "Malicious PowerShell Process - Execution Policy Bypass",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process_id) as process_id, values(Processes.parent_process_id) as parent_process_id values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=powershell.exe AND (Processes.process=\"* -ex*\" OR Processes.process=\"* bypass *\") by Processes.process_id, Processes.user, Processes.dest | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `malicious_powershell_process___execution_policy_bypass_filter`",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 7",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1059.001"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Josef Kuepker, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the number of SMB connections observed each hour for every day of week. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search to identify outliers in the number of SMB connections for that hour and day of the week.",
                  "how_to_implement": "You must be ingesting network traffic and populating the Network_Traffic data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. To improve your results, you may consider adding \"src\" to the by clause, which will build the model for each unique source in your enviornment. However, if you have a large number of hosts in your environment, this search may be very resource intensive. In this case, you may need to raise the value of max_inputs and/or max_groups in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "df98763b-0b08-4281-8ef9-08db7ac572a9",
                  "name": "Baseline of SMB Traffic - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=10m, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(\"All_Traffic\")` | fit DensityFunction count by \"HourOfDay,DayOfWeek\" into smb_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Ransomware"
                     ],
                     "detections": [
                        "Processes launching netsh",
                        "SMB Traffic Spike - MLTK"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2019-03-01",
                  "description": "This search looks for command-line arguments where `cmd.exe /c` is used to execute a program, then creates a baseline of the earliest and latest times we have encountered this command-line argument in our dataset within the last 30 days.",
                  "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd23",
                  "name": "Previously seen command line arguments",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe AND Processes.process=\"* /c *\" by Processes.process | `drop_dm_object_name(Processes)`",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Orangeworm Attack Group",
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Processes launching netsh",
                        "First time seen command line argument"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2020-07-10",
            "description": "This search looks for processes launching netsh.exe. Netsh is a command-line scripting utility that allows you to, either locally or remotely, display or modify the network configuration of a computer that is currently running. Netsh can be used as a persistence proxy technique to execute a helper DLL when netsh.exe is executed. In this search, we are looking for processes spawned by netsh.exe and executing commands via the command line.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model",
            "id": "b89919ed-fe5f-492c-b139-95dbb162040e",
            "known_false_positives": "Some VPN applications are known to launch netsh.exe. Outside of these instances, it is unusual for an executable to launch netsh.exe and run commands.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "processes_launching_netsh_filter"
               }
            ],
            "name": "Processes launching netsh",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) AS Processes.process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=netsh.exe by Processes.parent_process_name Processes.parent_process Processes.process_name Processes.user Processes.dest |`drop_dm_object_name(\"Processes\")` |`security_content_ctime(firstTime)` |`security_content_ctime(lastTime)` |`processes_launching_netsh_filter`",
            "tags": {
               "analytics_story": [
                  "Netsh Abuse",
                  "Disabling Security Tools",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Lazarus Group",
                  "Kimsuky",
                  "Dragonfly 2.0",
                  "Carbanak"
               ],
               "mitre_attack_id": [
                  "T1562.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Disable or Modify System Firewall"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The search looks for modifications to registry keys that can be used to launch an application or service at system startup.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "f5f6af30-7aa7-4295-bfe9-07fe87c01a4b",
            "known_false_positives": "There are many legitimate applications that must execute on system startup and will use these registry keys to accomplish that task.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_used_for_persistence_filter"
               }
            ],
            "name": "Registry Keys Used For Persistence",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*currentversion\\\\run* OR Registry.registry_path=*currentVersion\\\\Windows\\\\Appinit_Dlls* OR Registry.registry_path=CurrentVersion\\\\Winlogon\\\\Shell* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\Userinit* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\VmApplet* OR Registry.registry_path=*currentversion\\\\policies\\\\explorer\\\\run* OR Registry.registry_path=*currentversion\\\\runservices* OR Registry.registry_path=*\\\\CurrentControlSet\\\\Control\\\\Lsa\\\\* OR Registry.registry_path=\"*Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options*\" OR Registry.registry_path=HKLM\\\\SOFTWARE\\\\Microsoft\\\\Netsh\\\\*) by Registry.dest , Registry.status, Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `registry_keys_used_for_persistence_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Suspicious MSHTA Activity",
                  "DHS Report TA18-074A",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware",
                  "Windows Persistence Techniques",
                  "Emotet Malware  DHS Report TA18-201A "
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for arguments to sc.exe indicating the creation or modification of a Windows service.",
            "id": "f0c693d8-2a89-4ce7-80b4-98fea4c3ea6d",
            "known_false_positives": "Using sc.exe to manipulate Windows services is uncommon. However, there may be legitimate instances of this behavior. It is important to validate and investigate as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "sc_exe_manipulating_windows_services_filter"
               }
            ],
            "name": "Sc exe Manipulating Windows Services",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = sc.exe (Processes.process=\"* create *\" OR Processes.process=\"* config *\") by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `sc_exe_manipulating_windows_services_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Service Abuse",
                  "DHS Report TA18-074A",
                  "Orangeworm Attack Group",
                  "Windows Persistence Techniques",
                  "Disabling Security Tools"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "DarkVishnya",
                  "Wizard Spider",
                  "APT32",
                  "APT41",
                  "Kimsuky",
                  "Tropic Trooper",
                  "Cobalt Group",
                  "Ke3chang",
                  "Honeybee",
                  "FIN7",
                  "Threat Group-3390",
                  "APT19",
                  "APT3",
                  "Lazarus Group",
                  "Carbanak"
               ],
               "mitre_attack_id": [
                  "T1543.003"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Windows Service"
               ],
               "nist": [
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "PR.AT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for flags passed to schtasks.exe on the command-line that indicate a task name associated with the Dragonfly threat actor was created or deleted.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "d5af132c-7c17-439c-9d31-13d55340f36c",
            "known_false_positives": "No known false positives",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "scheduled_task_name_used_by_dragonfly_threat_actors_filter"
               }
            ],
            "name": "Scheduled Task Name Used by Dragonfly Threat Actors",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=schtasks.exe  by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | search (process=*delete* OR process=*create*) process=*reset* | `scheduled_task_name_used_by_dragonfly_threat_actors_filter` ",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "MuddyWater",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT-C-36",
                  "BRONZE BUTLER",
                  "APT41",
                  "Machete",
                  "Soft Cell",
                  "Silence",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Dragonfly 2.0",
                  "Patchwork",
                  "OilRig",
                  "Rancor",
                  "Cobalt Group",
                  "FIN8",
                  "menuPass",
                  "FIN10",
                  "APT32",
                  "FIN7",
                  "Stealth Falcon",
                  "FIN6",
                  "APT3",
                  "APT29"
               ],
               "mitre_attack_id": [
                  "T1053.005"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Scheduled Task"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2019-04-01",
            "description": "This search looks for process names that consist only of a single letter.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "a4214f0b-e01c-41bc-8cc4-d2b71e3056b4",
            "known_false_positives": "Single-letter executables are not always malicious. Investigate this activity with your normal incident-response process.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "single_letter_process_on_endpoint_filter"
               }
            ],
            "name": "Single Letter Process On Endpoint",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.dest, Processes.user, Processes.process, Processes.process_name | `drop_dm_object_name(Processes)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | eval process_name_length = len(process_name), endExe = if(substr(process_name, -4) == \".exe\", 1, 0) | search process_name_length=5 AND endExe=1 | table count, firstTime, lastTime, dest, user, process, process_name | `single_letter_process_on_endpoint_filter`",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for spikes in the number of Server Message Block (SMB) traffic connections.",
            "how_to_implement": "This search requires you to be ingesting your network traffic logs and populating the `Network_Traffic` data model.",
            "id": "7f5fb3e1-4209-4914-90db-0ec21b936378",
            "known_false_positives": "A file server may experience high-demand loads that could cause this analytic to trigger.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "smb_traffic_spike_filter"
               }
            ],
            "name": "SMB Traffic Spike",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src | `drop_dm_object_name(\"All_Traffic\")` | eventstats max(_time) as maxtime | stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, \"-70m@m\"), count, null))) as count avg(eval(if(_time<relative_time(maxtime, \"-70m@m\"), count, null))) as avg stdev(eval(if(_time<relative_time(maxtime, \"-70m@m\"), count, null))) as stdev by src | eval upperBound=(avg+stdev*2), isOutlier=if(count > upperBound AND num_data_samples >=50, 1, 0) | where isOutlier=1 | table src count | `smb_traffic_spike_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Hidden Cobra Malware",
                  "Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT32",
                  "Orangeworm",
                  "FIN8",
                  "APT3",
                  "Lazarus Group",
                  "Threat Group-1314",
                  "Turla",
                  "Deep Panda",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1021.002"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "SMB/Windows Admin Shares"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the number of SMB connections observed each hour for every day of week. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search to identify outliers in the number of SMB connections for that hour and day of the week.",
                  "how_to_implement": "You must be ingesting network traffic and populating the Network_Traffic data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. To improve your results, you may consider adding \"src\" to the by clause, which will build the model for each unique source in your enviornment. However, if you have a large number of hosts in your environment, this search may be very resource intensive. In this case, you may need to raise the value of max_inputs and/or max_groups in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "df98763b-0b08-4281-8ef9-08db7ac572a9",
                  "name": "Baseline of SMB Traffic - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=10m, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(\"All_Traffic\")` | fit DensityFunction count by \"HourOfDay,DayOfWeek\" into smb_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Ransomware"
                     ],
                     "detections": [
                        "Processes launching netsh",
                        "SMB Traffic Spike - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-22",
            "description": "This search uses the Machine Learning Toolkit (MLTK) to identify spikes in the number of Server Message Block (SMB) connections.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, the Machine Learning Toolkit (MLTK) version 4.2 or greater must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of SMB Traffic - MLTK\" must be executed before this detection search, because it builds a machine-learning (ML) model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.\\\nThis search produces a field (Number of events,count) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. This field contributes additional context to the notable. To see the additional metadata, add the following field, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry): \\\n1. **Label:** Number of events, **Field:** count\\\nDetailed documentation on how to create a new field within Incident Review is found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "d25773ba-9ad8-48d1-858e-07ad0bbeb828",
            "known_false_positives": "If you are seeing more results than desired, you may consider reducing the value of the threshold in the search. You should also periodically re-run the support search to re-build the ML model on the latest data. Please update the `smb_traffic_spike_mltk_filter` macro to filter out false positive results",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "smb_traffic_spike___mltk_filter"
               }
            ],
            "name": "SMB Traffic Spike - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(All_Traffic.dest_ip) as dest values(All_Traffic.dest_port) as port from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(All_Traffic)` | apply smb_pdfmodel threshold=0.001 | rename \"IsOutlier(count)\" as isOutlier | search isOutlier > 0 | sort -count | table _time src dest port count | `smb_traffic_spike___mltk_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Hidden Cobra Malware",
                  "Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT32",
                  "Orangeworm",
                  "FIN8",
                  "APT3",
                  "Lazarus Group",
                  "Threat Group-1314",
                  "Turla",
                  "Deep Panda",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1021.002"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "SMB/Windows Admin Shares"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for reg.exe being launched from a command prompt not started by the user. When a user launches cmd.exe, the parent process is usually explorer.exe. This search filters out those instances.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "a6b3ab4e-dd77-4213-95fa-fc94701995e0",
            "known_false_positives": "It's possible for system administrators to write scripts that exhibit this behavior. If this is the case, the search will need to be modified to filter them out.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_reg_exe_process_filter"
               }
            ],
            "name": "Suspicious Reg exe Process",
            "references": [
               "https://car.mitre.org/wiki/CAR-2013-03-001"
            ],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.parent_process_name != explorer.exe Processes.process_name =cmd.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest Processes.process_id Processes.parent_process_id | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search [| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.parent_process_name=cmd.exe Processes.process_name= reg.exe by Processes.parent_process_id Processes.dest Processes.process_name | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename parent_process_id as process_id |dedup process_id| table process_id dest] | `suspicious_reg_exe_process_filter` ",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Disabling Security Tools",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "Turla",
                  "APT32",
                  "APT38",
                  "Dragonfly 2.0",
                  "APT19",
                  "Threat Group-3390",
                  "Honeybee",
                  "Patchwork",
                  "Gorgon Group",
                  "FIN8"
               ],
               "mitre_attack_id": [
                  "T1112"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Modify Registry"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "0c016e5c-88be-4e2c-8c6c-c2b55b4fb4ef",
      "name": "DHS Report TA18-074A",
      "narrative": "The frequency of nation-state cyber attacks has increased significantly over the last decade. Employing numerous tactics and techniques, these attacks continue to escalate in complexity. \\\nThere is a wide range of motivations for these state-sponsored hacks, including stealing valuable corporate, military, or diplomatic data&#1151;all of which could confer advantages in various arenas. They may also target critical infrastructure. \\\nOne joint Technical Alert (TA) issued by the Department of Homeland and the FBI in mid-March of 2018 attributed some cyber activity targeting utility infrastructure to operatives sponsored by the Russian government. The hackers executed spearfishing attacks, installed malware, employed watering-hole domains, and more. While they caused no physical damage, the attacks provoked fears that a nation-state could turn off water, redirect power, or compromise a nuclear power plant.\\\nSuspicious activities--spikes in SMB traffic, processes that launch netsh (to modify the network configuration), suspicious registry modifications, and many more--may all be events you may wish to investigate further. While the use of these technique may be an indication that a nation-state actor is attempting to compromise your environment, it is important to note that these techniques are often employed by other groups, as well.",
      "references": [
         "https://www.us-cert.gov/ncas/alerts/TA18-074A"
      ],
      "tags": {
         "analytics_story": "DHS Report TA18-074A",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "SilverTerrier",
            "Gamaredon Group",
            "Sowbug",
            "TEMP.Veles",
            "Cobalt Group",
            "APT1",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "APT-C-36",
            "Kimsuky",
            "Putter Panda",
            "admin@338",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Thrip",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "APT32",
            "Machete",
            "FIN10",
            "Dark Caracal",
            "Suckfly",
            "Orangeworm",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "TA459",
            "Leafminer",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Carbanak",
            "Darkhotel",
            "Frankenstein",
            "APT39",
            "Silence",
            "Dragonfly 2.0",
            "APT38",
            "Gallmaker",
            "APT33",
            "Blue Mockingbird",
            "APT18",
            "APT28",
            "FIN6",
            "Soft Cell",
            "Deep Panda",
            "Rocke",
            "Tropic Trooper",
            "Patchwork",
            "Threat Group-1314",
            "DarkVishnya",
            "DarkHydrus",
            "Poseidon Group",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1059.001",
            "T1562.004",
            "T1053.005",
            "T1543.003",
            "T1021.002",
            "T1136.001",
            "T1071.002",
            "T1112",
            "T1547.001",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Command And Control",
            "Defense Evasion",
            "Lateral Movement",
            "Execution",
            "Persistence",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "SMB/Windows Admin Shares",
            "Registry Run Keys / Startup Folder",
            "Modify Registry",
            "Local Account",
            "File Transfer Protocols",
            "Windows Command Shell",
            "PowerShell",
            "Windows Service",
            "Scheduled Task",
            "Disable or Modify System Firewall"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2020-02-04",
      "description": "Looks for activities and techniques associated with the disabling of security tools on a Windows system, such as suspicious `reg.exe` processes, processes launching netsh, and many others.",
      "detections": [
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "Attempt to add a certificate to the untrusted certificate store",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "6bc5243e-ef36-45dc-9b12-f4a6be131159",
            "known_false_positives": "There may be legitimate reasons for administrators to add a certificate to the untrusted certificate store. In such cases, this will typically be done on a large number of systems.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "attempt_to_add_certificate_to_untrusted_store_filter"
               }
            ],
            "name": "Attempt To Add Certificate To Untrusted Store",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=certutil.exe (Processes.process=*-addstore* AND Processes.process=*disallowed* ) by Processes.parent_process Processes.process_name Processes.user | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` |`security_content_ctime(lastTime)` | `attempt_to_add_certificate_to_untrusted_store_filter`",
            "tags": {
               "analytics_story": [
                  "Disabling Security Tools"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1553.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Install Root Certificate"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for attempts to stop security-related services on the endpoint.",
            "how_to_implement": "You must be ingesting data that records the file-system activity from your hosts to populate the Endpoint file-system data-model node. If you are using Sysmon, you will need a Splunk Universal Forwarder on each endpoint from which you want to collect data. The search is shipped with a lookup file, `security_services.csv`, that can be edited to update the list of services to monitor. This lookup file can be edited directly where it lives in `$SPLUNK_HOME/etc/apps/DA-ESS-ContentUpdate/lookups`, or via the Splunk console. You should add the names of services an attacker might use on the command line and surround with asterisks (*****), so that they work properly when searching the command line. The file should be updated with the names of any services you would like to monitor for attempts to stop the service.,",
            "id": "c8e349c6-b97c-486e-8949-bd7bcd1f3910",
            "known_false_positives": "None identified. Attempts to disable security-related services should be identified and understood.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "attempt_to_stop_security_service_filter"
               }
            ],
            "name": "Attempt To Stop Security Service",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = net.exe OR  Processes.process_name = sc.exe) Processes.process=\"* stop *\" by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` |lookup security_services_lookup service as process OUTPUTNEW category, description | search category=security | `attempt_to_stop_security_service_filter`",
            "tags": {
               "analytics_story": [
                  "Disabling Security Tools"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "BRONZE BUTLER",
                  "Rocke",
                  "Kimsuky",
                  "Turla",
                  "Night Dragon",
                  "Gorgon Group",
                  "Lazarus Group",
                  "Putter Panda"
               ],
               "mitre_attack_id": [
                  "T1562.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Disable or Modify Tools"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Josef Kuepker, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the number of SMB connections observed each hour for every day of week. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search to identify outliers in the number of SMB connections for that hour and day of the week.",
                  "how_to_implement": "You must be ingesting network traffic and populating the Network_Traffic data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. To improve your results, you may consider adding \"src\" to the by clause, which will build the model for each unique source in your enviornment. However, if you have a large number of hosts in your environment, this search may be very resource intensive. In this case, you may need to raise the value of max_inputs and/or max_groups in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "df98763b-0b08-4281-8ef9-08db7ac572a9",
                  "name": "Baseline of SMB Traffic - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=10m, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(\"All_Traffic\")` | fit DensityFunction count by \"HourOfDay,DayOfWeek\" into smb_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Ransomware"
                     ],
                     "detections": [
                        "Processes launching netsh",
                        "SMB Traffic Spike - MLTK"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2019-03-01",
                  "description": "This search looks for command-line arguments where `cmd.exe /c` is used to execute a program, then creates a baseline of the earliest and latest times we have encountered this command-line argument in our dataset within the last 30 days.",
                  "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd23",
                  "name": "Previously seen command line arguments",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe AND Processes.process=\"* /c *\" by Processes.process | `drop_dm_object_name(Processes)`",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Orangeworm Attack Group",
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Processes launching netsh",
                        "First time seen command line argument"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2020-07-10",
            "description": "This search looks for processes launching netsh.exe. Netsh is a command-line scripting utility that allows you to, either locally or remotely, display or modify the network configuration of a computer that is currently running. Netsh can be used as a persistence proxy technique to execute a helper DLL when netsh.exe is executed. In this search, we are looking for processes spawned by netsh.exe and executing commands via the command line.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model",
            "id": "b89919ed-fe5f-492c-b139-95dbb162040e",
            "known_false_positives": "Some VPN applications are known to launch netsh.exe. Outside of these instances, it is unusual for an executable to launch netsh.exe and run commands.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "processes_launching_netsh_filter"
               }
            ],
            "name": "Processes launching netsh",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) AS Processes.process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=netsh.exe by Processes.parent_process_name Processes.parent_process Processes.process_name Processes.user Processes.dest |`drop_dm_object_name(\"Processes\")` |`security_content_ctime(firstTime)` |`security_content_ctime(lastTime)` |`processes_launching_netsh_filter`",
            "tags": {
               "analytics_story": [
                  "Netsh Abuse",
                  "Disabling Security Tools",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Lazarus Group",
                  "Kimsuky",
                  "Dragonfly 2.0",
                  "Carbanak"
               ],
               "mitre_attack_id": [
                  "T1562.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Disable or Modify System Firewall"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for arguments to sc.exe indicating the creation or modification of a Windows service.",
            "id": "f0c693d8-2a89-4ce7-80b4-98fea4c3ea6d",
            "known_false_positives": "Using sc.exe to manipulate Windows services is uncommon. However, there may be legitimate instances of this behavior. It is important to validate and investigate as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "sc_exe_manipulating_windows_services_filter"
               }
            ],
            "name": "Sc exe Manipulating Windows Services",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = sc.exe (Processes.process=\"* create *\" OR Processes.process=\"* config *\") by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `sc_exe_manipulating_windows_services_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Service Abuse",
                  "DHS Report TA18-074A",
                  "Orangeworm Attack Group",
                  "Windows Persistence Techniques",
                  "Disabling Security Tools"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "DarkVishnya",
                  "Wizard Spider",
                  "APT32",
                  "APT41",
                  "Kimsuky",
                  "Tropic Trooper",
                  "Cobalt Group",
                  "Ke3chang",
                  "Honeybee",
                  "FIN7",
                  "Threat Group-3390",
                  "APT19",
                  "APT3",
                  "Lazarus Group",
                  "Carbanak"
               ],
               "mitre_attack_id": [
                  "T1543.003"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Windows Service"
               ],
               "nist": [
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "PR.AT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for reg.exe being launched from a command prompt not started by the user. When a user launches cmd.exe, the parent process is usually explorer.exe. This search filters out those instances.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "a6b3ab4e-dd77-4213-95fa-fc94701995e0",
            "known_false_positives": "It's possible for system administrators to write scripts that exhibit this behavior. If this is the case, the search will need to be modified to filter them out.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_reg_exe_process_filter"
               }
            ],
            "name": "Suspicious Reg exe Process",
            "references": [
               "https://car.mitre.org/wiki/CAR-2013-03-001"
            ],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.parent_process_name != explorer.exe Processes.process_name =cmd.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest Processes.process_id Processes.parent_process_id | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search [| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.parent_process_name=cmd.exe Processes.process_name= reg.exe by Processes.parent_process_id Processes.dest Processes.process_name | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename parent_process_id as process_id |dedup process_id| table process_id dest] | `suspicious_reg_exe_process_filter` ",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Disabling Security Tools",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "Turla",
                  "APT32",
                  "APT38",
                  "Dragonfly 2.0",
                  "APT19",
                  "Threat Group-3390",
                  "Honeybee",
                  "Patchwork",
                  "Gorgon Group",
                  "FIN8"
               ],
               "mitre_attack_id": [
                  "T1112"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Modify Registry"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-22",
            "description": "Attackers often disable security tools to avoid detection. This search looks for the usage of process `fltMC.exe` to unload a Sysmon Driver that will stop sysmon from collecting the data.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model. This search is also shipped with `unload_sysmon_filter_driver_filter` macro, update this macro to filter out false positives.",
            "id": "c77162d3-f93c-45cc-80c8-22f665664g9f",
            "known_false_positives": "",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unload_sysmon_filter_driver_filter"
               }
            ],
            "name": "Unload Sysmon Filter Driver",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=fltMC.exe AND Processes.process=*unload* AND Processes.process=*SysmonDrv*  by Processes.process_name Processes.process_id Processes.parent_process_name Processes.process Processes.dest Processes.user | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)` |`unload_sysmon_filter_driver_filter`| table firstTime lastTime dest user count process_name process_id parent_process_name process",
            "tags": {
               "analytics_story": [
                  "Disabling Security Tools"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "BRONZE BUTLER",
                  "Rocke",
                  "Kimsuky",
                  "Turla",
                  "Night Dragon",
                  "Gorgon Group",
                  "Lazarus Group",
                  "Putter Panda"
               ],
               "mitre_attack_id": [
                  "T1562.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Disable or Modify Tools"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "fcc27099-46a0-46b0-a271-5c7dab56b6f1",
      "name": "Disabling Security Tools",
      "narrative": "Attackers employ a variety of tactics in order to avoid detection and operate without barriers. This often involves modifying the configuration of security tools to get around them or explicitly disabling them to prevent them from running. This Analytic Story includes searches that look for activity consistent with attackers attempting to disable various security mechanisms. Such activity may involve monitoring for suspicious registry activity, as this is where much of the configuration for Windows and various other programs reside, or explicitly attempting to shut down security-related services. Other times, attackers attempt various tricks to prevent specific programs from running, such as adding the certificates with which the security tools are signed to a blacklist (which would prevent them from running).",
      "references": [
         "https://attack.mitre.org/wiki/Technique/T1089",
         "https://blog.malwarebytes.com/cybercrime/2015/11/vonteera-adware-uses-certificates-to-disable-anti-malware/",
         "https://www.operationblockbuster.com/wp-content/uploads/2016/02/Operation-Blockbuster-Tools-Report.pdf"
      ],
      "tags": {
         "analytics_story": "Disabling Security Tools",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Cobalt Group",
            "APT41",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Putter Panda",
            "Kimsuky",
            "Gorgon Group",
            "BRONZE BUTLER",
            "APT32",
            "FIN7",
            "APT19",
            "Ke3chang",
            "no",
            "Night Dragon",
            "Honeybee",
            "Threat Group-3390",
            "Lazarus Group",
            "APT3",
            "Carbanak",
            "Dragonfly 2.0",
            "Silence",
            "APT38",
            "Rocke",
            "Blue Mockingbird",
            "DarkVishnya",
            "Tropic Trooper",
            "Patchwork"
         ],
         "mitre_attack_id": [
            "T1562.004",
            "T1543.003",
            "T1553.004",
            "T1112",
            "T1562.001"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Install Root Certificate",
            "Disable or Modify Tools",
            "Modify Registry",
            "Windows Service",
            "Disable or Modify System Firewall"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2016-09-13",
      "description": "DNS poses a serious threat as a Denial of Service (DOS) amplifier, if it responds to `ANY` queries. This Analytic Story can help you detect attackers who may be abusing your company's DNS infrastructure to launch amplification attacks, causing Denial of Service to other victims.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-20",
            "description": "The search is used to identify attempts to use your DNS Infrastructure for DDoS purposes via a DNS amplification attack leveraging ANY queries.",
            "how_to_implement": "To successfully implement this search you must ensure that DNS data is populating the Network_Resolution data model.",
            "id": "8fa891f7-a533-4b3c-af85-5aa2e7c1f1eb",
            "known_false_positives": "Legitimate ANY requests may trigger this search, however it is unusual to see a large volume of them under typical circumstances. You may modify the threshold in the search to better suit your environment.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "large_volume_of_dns_any_queries_filter"
               }
            ],
            "name": "Large Volume of DNS ANY Queries",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution where nodename=DNS \"DNS.message_type\"=\"QUERY\" \"DNS.record_type\"=\"ANY\" by \"DNS.dest\" | `drop_dm_object_name(\"DNS\")` | where count>200 | `large_volume_of_dns_any_queries_filter`",
            "tags": {
               "analytics_story": [
                  "DNS Amplification Attacks"
               ],
               "asset_type": "DNS Servers",
               "cis20": [
                  "CIS 11",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1498.002"
               ],
               "mitre_attack_tactics": [
                  "Impact"
               ],
               "mitre_attack_technique": [
                  "Reflection Amplification"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "e8afd39e-3294-11e6-b39d-a45e60c6700",
      "name": "DNS Amplification Attacks",
      "narrative": "The Domain Name System (DNS) is the protocol used to map domain names to IP addresses. It has been proven to work very well for its intended function. However if DNS is misconfigured, servers can be abused by attackers to levy amplification or redirection attacks against victims. Because DNS responses to `ANY` queries are so much larger than the queries themselves--and can be made with a UDP packet, which does not require a handshake--attackers can spoof the source address of the packet and cause much more data to be sent to the victim than if they sent the traffic themselves. The `ANY` requests are will be larger than normal DNS server requests, due to the fact that the server provides significant details, such as MX records and associated IP addresses. A large volume of this traffic can result in a DOS on the victim's machine. This misconfiguration leads to two possible victims, the first being the DNS servers participating in an attack and the other being the hosts that are the targets of the DOS attack.\\\nThe search in this story can help you to detect if attackers are abusing your company's DNS infrastructure to launch DNS amplification attacks causing Denial of Service to other victims.",
      "references": [
         "https://www.us-cert.gov/ncas/alerts/TA13-088A",
         "https://www.imperva.com/learn/application-security/dns-amplification/"
      ],
      "tags": {
         "analytics_story": "DNS Amplification Attacks",
         "category": [
            "Abuse"
         ],
         "mitre_attack_groups": [
            "no"
         ],
         "mitre_attack_id": [
            "T1498.002"
         ],
         "mitre_attack_tactics": [
            "Impact"
         ],
         "mitre_attack_technique": [
            "Reflection Amplification"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2020-02-04",
      "description": "Secure your environment against DNS hijacks with searches that help you detect and investigate unauthorized changes to DNS records.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search allows you to identify the endpoints that have connected to more than five DNS servers and made DNS Queries over the time frame of the search.",
            "how_to_implement": "This search requires that DNS data is being ingested and populating the `Network_Resolution` data model. This data can come from DNS logs or from solutions that parse network traffic for this data, such as Splunk Stream or Bro.\\\nThis search produces fields (`dest_count`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** Distinct DNS Connections, **Field:** dest_count\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "74ec6f18-604b-4202-a567-86b2066be3ce",
            "known_false_positives": "It's possible that an enterprise has more than five DNS servers that are configured in a round-robin rotation. Please customize the search, as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "clients_connecting_to_multiple_dns_servers_filter"
               }
            ],
            "name": "Clients Connecting to Multiple DNS Servers",
            "search": "| tstats `security_content_summariesonly` count, values(DNS.dest) AS dest dc(DNS.dest) as dest_count from datamodel=Network_Resolution where DNS.message_type=QUERY by DNS.src | `drop_dm_object_name(\"Network_Resolution\")` |where dest_count > 5 | `clients_connecting_to_multiple_dns_servers_filter` ",
            "tags": {
               "analytics_story": [
                  "DNS Hijacking",
                  "Command and Control",
                  "Suspicious DNS Traffic",
                  "Host Redirection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT32",
                  "APT33",
                  "Thrip",
                  "FIN8",
                  "OilRig",
                  "Lazarus Group"
               ],
               "mitre_attack_id": [
                  "T1048.003"
               ],
               "mitre_attack_tactics": [
                  "Exfiltration"
               ],
               "mitre_attack_technique": [
                  "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-01-16",
            "description": "Malicious actors often abuse legitimate Dynamic DNS services to host malicious payloads or interactive command and control nodes. Attackers will automate domain resolution changes by routing dynamic domains to countless IP addresses to circumvent firewall blocks, blacklists as well as frustrate a network defenders analytic and investigative processes. This search will look for DNS queries made from within your infrastructure to suspicious dynamic domains.",
            "how_to_implement": "First, you'll need to ingest data from your DNS operations. This can be done by ingesting logs from your server or data, collected passively by Splunk Stream or a similar solution. Specifically, data that contains the domain that is being queried and the IP of the host originating the request must be populating the `Network_Resolution` data model. This search also leverages a lookup file, `dynamic_dns_providers_default.csv`, which contains a non-exhaustive list of Dynamic DNS providers. Please consider updating the local lookup periodically by adding new domains to the list of `dynamic_dns_providers_local.csv`.\\\nThis search produces fields (query, answer, isDynDNS) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable event. To see the additional metadata, add the following fields, if not already present, to Incident Review. Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** DNS Query, **Field:** query\\\n1. \\\n1. **Label:** DNS Answer, **Field:** answer\\\n1. \\\n1. **Label:** IsDynamicDNS, **Field:** isDynDNS\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "c77162d3-f93c-45cc-80c8-22f6v5464g9f",
            "known_false_positives": "Some users and applications may leverage Dynamic DNS to reach out to some domains on the Internet since dynamic DNS by itself is not malicious, however this activity must be verified.",
            "macros": [
               {
                  "definition": "lookup update=true dynamic_dns_providers_default dynamic_dns_domains as query OUTPUTNEW isDynDNS_default | lookup update=true dynamic_dns_providers_local dynamic_dns_domains as query OUTPUTNEW isDynDNS_local| eval isDynDNS = coalesce(isDynDNS_default, isDynDNS_local)|fields - isDynDNS_default, isDynDNS_local| search isDynDNS=True",
                  "description": "This macro limits the output of the query field to dynamic dns domains. It looks up the domains in a file provided by Splunk and one intended to be updated by the end user.",
                  "name": "dynamic_dns_providers"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_hosts_connecting_to_dynamic_domain_providers_filter"
               }
            ],
            "name": "Detect hosts connecting to dynamic domain providers",
            "search": "| tstats `security_content_summariesonly` count values(DNS.answer) as answer min(_time) as firstTime from datamodel=Network_Resolution by DNS.src, DNS.query | `drop_dm_object_name(\"DNS\")` | `security_content_ctime(firstTime)` | `dynamic_dns_providers` | `detect_hosts_connecting_to_dynamic_domain_providers_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection",
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "DNS Hijacking",
                  "Suspicious DNS Traffic",
                  "Dynamic DNS",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.DS",
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search will detect DNS requests resolved by unauthorized DNS servers. Legitimate DNS servers should be identified in the Enterprise Security Assets and Identity Framework.",
            "how_to_implement": "To successfully implement this search you will need to ensure that DNS data is populating the Network_Resolution data model. It also requires that your DNS servers are identified correctly in the Assets and Identity table of Enterprise Security.",
            "id": "1a67f15a-f4ff-4170-84e9-08cf6f75d6f6",
            "known_false_positives": "Legitimate DNS activity can be detected in this search. Investigate, verify and update the list of authorized DNS servers as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_requests_resolved_by_unauthorized_dns_servers_filter"
               }
            ],
            "name": "DNS Query Requests Resolved by Unauthorized DNS Servers",
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution where DNS.dest_category != dns_server AND DNS.src_category != dns_server by DNS.src DNS.dest | `drop_dm_object_name(\"DNS\")` | `dns_query_requests_resolved_by_unauthorized_dns_servers_filter` ",
            "tags": {
               "analytics_story": [
                  "DNS Hijacking",
                  "Command and Control",
                  "Suspicious DNS Traffic",
                  "Host Redirection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 1",
                  "CIS 3",
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS",
                  "PR.IP",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Jose Hernandez, Splunk",
            "baselines": [
               {
                  "author": "Jose Hernandez, Splunk",
                  "date": "2019-02-14",
                  "description": "The search takes corporate and common cloud provider domains configured under `cim_corporate_email_domains.csv`, `cim_corporate_web_domains.csv`, and `cloud_domains.csv` finds their responses across the last 30 days from data in the `Network_Resolution ` datamodel, then stores the output under the `discovered_dns_records.csv` lookup",
                  "how_to_implement": "To successfully implement this search, you must be ingesting DNS logs, and populating the Network_Resolution data model. Also make sure that the cim_corporate_web_domains and cim_corporate_email_domains lookups are populated with the domains owned by your corporation",
                  "id": "c096f721-8842-42ce-bfc7-74bd8c72b7c3",
                  "name": "Discover DNS records",
                  "search": "| inputlookup cim_corporate_email_domains.csv | inputlookup append=T cim_corporate_web_domains.csv | inputlookup append=T cim_cloud_domains.csv | eval domain = trim(replace(domain, \"\\*\", \"\")) | join domain [|tstats `security_content_summariesonly` count values(DNS.record_type) as type, values(DNS.answer) as answer from datamodel=Network_Resolution where DNS.message_type=RESPONSE DNS.answer!=\"unknown\" DNS.answer!=\"\" by DNS.query | rename DNS.query as query | where query!=\"unknown\" | rex field=query \"(?<domain>\\w+\\.\\w+?)(?:$|/)\"] | makemv delim=\" \" answer |  makemv delim=\" \" type | sort -count | table count,domain,type,query,answer | outputlookup createinapp=true discovered_dns_records.csv",
                  "tags": {
                     "analytics_story": [
                        "DNS Hijacking"
                     ],
                     "detections": [
                        "DNS record changed"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "The search takes the DNS records and their answers results of the discovered_dns_records lookup and finds if any records have changed by searching DNS response from the Network_Resolution datamodel across the last day.",
            "how_to_implement": "To successfully implement this search you will need to ensure that DNS data is populating the `Network_Resolution` data model. It also requires that the `discover_dns_record` lookup table be populated by the included support search \"Discover DNS record\". \\\n **Splunk>Phantom Playbook Integration**\\\nIf Splunk>Phantom is also configured in your environment, a Playbook called \"DNS Hijack Enrichment\" can be configured to run when any results are found by this detection search. The playbook takes in the DNS record changed and uses Geoip, whois, Censys and PassiveTotal to detect if DNS issuers changed. To use this integration, install the Phantom App for Splunk `https://splunkbase.splunk.com/app/3411/`, add the correct hostname to the \"Phantom Instance\" field in the Adaptive Response Actions when configuring this detection search, and set the corresponding Playbook to active. \\\n(Playbook Link:`https://my.phantom.us/4.2/playbook/dns-hijack-enrichment/`).\\\n",
            "id": "44d3a43e-dcd5-49f7-8356-5209bb369065",
            "known_false_positives": "Legitimate DNS changes can be detected in this search. Investigate, verify and update the list of provided current answers for the domains in question as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_record_changed_filter"
               }
            ],
            "name": "DNS record changed",
            "search": "| inputlookup discovered_dns_records.csv | rename answer as discovered_answer | join domain[|tstats `security_content_summariesonly` count values(DNS.record_type) as type, values(DNS.answer) as current_answer values(DNS.src) as src from datamodel=Network_Resolution where DNS.message_type=RESPONSE DNS.answer!=\"unknown\" DNS.answer!=\"\" by DNS.query | rename DNS.query as query | where query!=\"unknown\" | rex field=query \"(?<domain>\\w+\\.\\w+?)(?:$|/)\"] | makemv delim=\" \" answer |  makemv delim=\" \" type | sort -count | table count,src,domain,type,query,current_answer,discovered_answer | makemv current_answer  | mvexpand current_answer | makemv discovered_answer | eval n=mvfind(discovered_answer, current_answer) | where isnull(n) | `dns_record_changed_filter`",
            "tags": {
               "analytics_story": [
                  "DNS Hijacking"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 1",
                  "CIS 3",
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS",
                  "PR.IP",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "8169f17b-ef68-4b59-aa28-586907301221",
      "name": "DNS Hijacking",
      "narrative": "Dubbed the Achilles heel of the Internet (see https://www.f5.com/labs/articles/threat-intelligence/dns-is-still-the-achilles-heel-of-the-internet-25613), DNS plays a critical role in routing web traffic but is notoriously vulnerable to attack. One reason is its distributed nature. It relies on unstructured connections between millions of clients and servers over inherently insecure protocols.\\\nThe gravity and extent of the importance of securing DNS from attacks is undeniable. The fallout of compromised DNS can be disastrous. Not only can hackers bring down an entire business, they can intercept confidential information, emails, and login credentials, as well. \\\nOn January 22, 2019, the US Department of Homeland Security 2019's Cybersecurity and Infrastructure Security Agency (CISA) raised awareness of some high-profile DNS hijacking attacks against infrastructure, both in the United States and abroad. It issued Emergency Directive 19-01 (see https://cyber.dhs.gov/ed/19-01/), which summarized the activity and required government agencies to take the following four actions, all within 10 days: \\\n1. For all .gov or other agency-managed domains, audit public DNS records on all authoritative and secondary DNS servers, verify that they resolve to the intended location or report them to CISA.\\\n1. Update the passwords for all accounts on systems that can make changes to each agency 2019's DNS records.\\\n1. Implement multi-factor authentication (MFA) for all accounts on systems that can make changes to each agency's 2019 DNS records or, if impossible, provide CISA with the names of systems, the reasons why MFA cannot be enabled within the required timeline, and an ETA for when it can be enabled.\\\n1. CISA will begin regular delivery of newly added certificates to Certificate Transparency (CT) logs for agency domains via the Cyber Hygiene service. Upon receipt, agencies must immediately begin monitoring CT log data for certificates issued that they did not request. If an agency confirms that a certificate was unauthorized, it must report the certificate to the issuing certificate authority and to CISA. Of course, it makes sense to put equivalent actions in place within your environment, as well. \\\nIn DNS hijacking, the attacker assumes control over an account or makes use of a DNS service exploit to make changes to DNS records. Once they gain access, attackers can substitute their own MX records, name-server records, and addresses, redirecting emails and traffic through their infrastructure, where they can read, copy, or modify information seen. They can also generate valid encryption certificates to help them avoid browser-certificate checks. In one notable attack on the Internet service provider, GoDaddy, the hackers altered Sender Policy Framework (SPF) records a relatively minor change that did not inflict excessive damage but allowed for more effective spam campaigns.\\\nThe searches in this Analytic Story help you detect and investigate activities that may indicate that DNS hijacking has taken place within your environment.",
      "references": [
         "https://www.fireeye.com/blog/threat-research/2017/09/apt33-insights-into-iranian-cyber-espionage.html",
         "https://umbrella.cisco.com/blog/2013/04/15/on-the-trail-of-malicious-dynamic-dns-domains/",
         "http://www.noip.com/blog/2014/07/11/dynamic-dns-can-use-2/",
         "https://www.splunk.com/blog/2015/08/04/detecting-dynamic-dns-domains-in-splunk.html"
      ],
      "tags": {
         "analytics_story": "DNS Hijacking",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Thrip",
            "Ke3chang",
            "OilRig",
            "Cobalt Group",
            "APT32",
            "APT33",
            "APT18",
            "APT41",
            "FIN8",
            "Tropic Trooper",
            "FIN7",
            "Lazarus Group",
            "APT39"
         ],
         "mitre_attack_id": [
            "T1071.004",
            "T1048.003"
         ],
         "mitre_attack_tactics": [
            "Exfiltration",
            "Command And Control"
         ],
         "mitre_attack_technique": [
            "DNS",
            "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2018-09-06",
      "description": "Detect and investigate hosts in your environment that may be communicating with dynamic domain providers. Attackers may leverage these services to help them avoid firewall blocks and blacklists.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-01-16",
            "description": "Malicious actors often abuse legitimate Dynamic DNS services to host malicious payloads or interactive command and control nodes. Attackers will automate domain resolution changes by routing dynamic domains to countless IP addresses to circumvent firewall blocks, blacklists as well as frustrate a network defenders analytic and investigative processes. This search will look for DNS queries made from within your infrastructure to suspicious dynamic domains.",
            "how_to_implement": "First, you'll need to ingest data from your DNS operations. This can be done by ingesting logs from your server or data, collected passively by Splunk Stream or a similar solution. Specifically, data that contains the domain that is being queried and the IP of the host originating the request must be populating the `Network_Resolution` data model. This search also leverages a lookup file, `dynamic_dns_providers_default.csv`, which contains a non-exhaustive list of Dynamic DNS providers. Please consider updating the local lookup periodically by adding new domains to the list of `dynamic_dns_providers_local.csv`.\\\nThis search produces fields (query, answer, isDynDNS) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable event. To see the additional metadata, add the following fields, if not already present, to Incident Review. Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** DNS Query, **Field:** query\\\n1. \\\n1. **Label:** DNS Answer, **Field:** answer\\\n1. \\\n1. **Label:** IsDynamicDNS, **Field:** isDynDNS\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "c77162d3-f93c-45cc-80c8-22f6v5464g9f",
            "known_false_positives": "Some users and applications may leverage Dynamic DNS to reach out to some domains on the Internet since dynamic DNS by itself is not malicious, however this activity must be verified.",
            "macros": [
               {
                  "definition": "lookup update=true dynamic_dns_providers_default dynamic_dns_domains as query OUTPUTNEW isDynDNS_default | lookup update=true dynamic_dns_providers_local dynamic_dns_domains as query OUTPUTNEW isDynDNS_local| eval isDynDNS = coalesce(isDynDNS_default, isDynDNS_local)|fields - isDynDNS_default, isDynDNS_local| search isDynDNS=True",
                  "description": "This macro limits the output of the query field to dynamic dns domains. It looks up the domains in a file provided by Splunk and one intended to be updated by the end user.",
                  "name": "dynamic_dns_providers"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_hosts_connecting_to_dynamic_domain_providers_filter"
               }
            ],
            "name": "Detect hosts connecting to dynamic domain providers",
            "search": "| tstats `security_content_summariesonly` count values(DNS.answer) as answer min(_time) as firstTime from datamodel=Network_Resolution by DNS.src, DNS.query | `drop_dm_object_name(\"DNS\")` | `security_content_ctime(firstTime)` | `dynamic_dns_providers` | `detect_hosts_connecting_to_dynamic_domain_providers_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection",
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "DNS Hijacking",
                  "Suspicious DNS Traffic",
                  "Dynamic DNS",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.DS",
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for web connections to dynamic DNS providers.",
            "how_to_implement": "This search requires you to be ingesting web-traffic logs. You can obtain these logs from indexing data from a web proxy or by using a network-traffic-analysis tool, such as Bro or Splunk Stream. The web data model must contain the URL being requested, the IP address of the host initiating the request, and the destination IP. This search also leverages a lookup file, `dynamic_dns_providers_default.csv`, which contains a non-exhaustive list of dynamic DNS providers. Consider periodically updating this local lookup file with new domains.\\\nThis search produces fields (`isDynDNS`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** IsDynamicDNS, **Field:** isDynDNS\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "134da869-e264-4a8f-8d7e-fcd01c18f301",
            "known_false_positives": "It is possible that list of dynamic DNS providers is outdated and/or that the URL being requested is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "lookup update=true dynamic_dns_providers_default dynamic_dns_domains as url OUTPUTNEW isDynDNS_default | lookup update=true dynamic_dns_providers_local dynamic_dns_domains as url OUTPUTNEW isDynDNS_local| eval isDynDNS = coalesce(isDynDNS_default, isDynDNS_local)|fields - isDynDNS_default, isDynDNS_local| search isDynDNS=True",
                  "description": "This is a description",
                  "name": "dynamic_dns_web_traffic"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_web_traffic_to_dynamic_domain_providers_filter"
               }
            ],
            "name": "Detect web traffic to dynamic domain providers",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Web.url) as url min(_time) as firstTime from datamodel=Web where Web.status=200 by Web.src Web.dest Web.status | `drop_dm_object_name(\"Web\")` | `security_content_ctime(firstTime)` | `dynamic_dns_web_traffic` | `detect_web_traffic_to_dynamic_domain_providers_filter`",
            "tags": {
               "analytics_story": [
                  "Dynamic DNS"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "TA505",
                  "Rocke",
                  "APT39",
                  "Tropic Trooper",
                  "MuddyWater",
                  "Wizard Spider",
                  "Inception",
                  "APT41",
                  "SilverTerrier",
                  "Machete",
                  "APT28",
                  "WIRTE",
                  "APT33",
                  "FIN4",
                  "Night Dragon",
                  "APT18",
                  "APT38",
                  "Cobalt Group",
                  "APT19",
                  "Threat Group-3390",
                  "Rancor",
                  "Orangeworm",
                  "APT37",
                  "Ke3chang",
                  "Dark Caracal",
                  "Turla",
                  "Lazarus Group",
                  "BRONZE BUTLER",
                  "APT32",
                  "OilRig",
                  "Magic Hound",
                  "Gamaredon Group",
                  "Stealth Falcon"
               ],
               "mitre_attack_id": [
                  "T1071.001"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "Web Protocols"
               ],
               "nist": [
                  "PR.IP",
                  "DE.DP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "8169f17b-ef68-4b59-aae8-586907301221",
      "name": "Dynamic DNS",
      "narrative": "Dynamic DNS services (DDNS) are legitimate low-cost or free services that allow users to rapidly update domain resolutions to IP infrastructure. While their usage can be benign, malicious actors can abuse DDNS to host harmful payloads or interactive-command-and-control infrastructure. These attackers will manually update or automate domain resolution changes by routing dynamic domains to IP addresses that circumvent firewall blocks and blacklists and frustrate a network defender's analytic and investigative processes. These searches will look for DNS queries made from within your infrastructure to suspicious dynamic domains and then investigate more deeply, when appropriate. While this list of top-level dynamic domains is not exhaustive, it can be dynamically updated as new suspicious dynamic domains are identified.",
      "references": [
         "https://www.fireeye.com/blog/threat-research/2017/09/apt33-insights-into-iranian-cyber-espionage.html",
         "https://umbrella.cisco.com/blog/2013/04/15/on-the-trail-of-malicious-dynamic-dns-domains/",
         "http://www.noip.com/blog/2014/07/11/dynamic-dns-can-use-2/",
         "https://www.splunk.com/blog/2015/08/04/detecting-dynamic-dns-domains-in-splunk.html"
      ],
      "tags": {
         "analytics_story": "Dynamic DNS",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "SilverTerrier",
            "Sandworm Team",
            "Gamaredon Group",
            "Cobalt Group",
            "APT41",
            "Wizard Spider",
            "Turla",
            "Inception",
            "BRONZE BUTLER",
            "OilRig",
            "APT32",
            "Machete",
            "Dark Caracal",
            "FIN4",
            "Orangeworm",
            "APT19",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "Night Dragon",
            "MuddyWater",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "APT38",
            "APT39",
            "APT33",
            "Rocke",
            "APT18",
            "APT28",
            "Tropic Trooper",
            "TA505",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1071.001"
         ],
         "mitre_attack_tactics": [
            "Command And Control"
         ],
         "mitre_attack_technique": [
            "Web Protocols"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2020-01-27",
      "description": "Detect rarely used executables, specific registry paths that may confer malware survivability and persistence, instances where cmd.exe is used to launch script interpreters, and other indicators that the Emotet financial malware has compromised your environment.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-03-16",
            "description": "This search will return a table of rare processes, the names of the systems running them, and the users who initiated each process.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts and populating the endpoint data model with the resultant dataset. The macro `filter_rare_process_whitelist` searches two lookup files to whitelist your processes.  These consist of `rare_process_whitelist_default.csv` and `rare_process_whitelist_local.csv`. To add your own processes to the whitelist, add them to `rare_process_whitelist_local.csv`. If you wish to remove an entry from the default lookup file, you will have to modify the macro itself to set the whitelist value for that process to false. You can modify the limit parameter and search scheduling to better suit your environment.",
            "id": "44fddcb2-8d3b-454c-874e-7c6de5a4f7ac",
            "known_false_positives": "Some legitimate processes may be only rarely executed in your environment. As these are identified, update `rare_process_whitelist_local.csv` to filter them out of your search results.",
            "macros": [
               {
                  "definition": "lookup update=true lookup_rare_process_whitelist_default process as process OUTPUTNEW whitelist | where whitelist=\"false\" | lookup update=true lookup_rare_process_whitelist_local process as process OUTPUT whitelist | where whitelist=\"false\"",
                  "description": "This macro is intended to whitelist processes that have been definied as rare",
                  "name": "filter_rare_process_whitelist"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_rare_executables_filter"
               }
            ],
            "name": "Detect Rare Executables",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.dest) as dest values(Processes.user) as user min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.process_name  | rename Processes.process_name as process | rex field=user \"(?<user_domain>.*)\\\\\\\\(?<user_name>.*)\" | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| search [| tstats count from datamodel=Endpoint.Processes by Processes.process_name | rare Processes.process_name limit=30 | rename Processes.process_name as process| `filter_rare_process_whitelist`| table process ] | `detect_rare_executables_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Unusual Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM",
                  "PR.PT",
                  "PR.DS",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for the execution of the cscript.exe or wscript.exe processes, with a parent of cmd.exe. The search will return the count, the first and last time this execution was seen on a machine, the user, and the destination of the machine",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model in the processes node. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
            "id": "b89919ed-fe5f-492c-b139-95dbb162039e",
            "known_false_positives": "Some legitimate applications may exhibit this behavior.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_use_of_cmd_exe_to_launch_script_interpreters_filter"
               }
            ],
            "name": "Detect Use of cmd exe to Launch Script Interpreters",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=\"cmd.exe\" (Processes.process_name=cscript.exe OR Processes.process_name =wscript.exe) by Processes.parent_process Processes.process_name Processes.user Processes.dest | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)` | `detect_use_of_cmd_exe_to_launch_script_interpreters_filter`",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Suspicious Command-Line Executions"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for specific command-line arguments that may indicate the execution of tools made by Nirsoft, which are legitimate, but may be abused by attackers.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "1297fb80-f42a-4q4a-9c8b-78c061417cf6",
            "known_false_positives": "While legitimate, these NirSoft tools are prone to abuse. You should verfiy that the tool was used for a legitimate purpose.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detection_of_tools_built_by_nirsoft_filter"
               }
            ],
            "name": "Detection of tools built by NirSoft",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process=\"* /stext *\" OR Processes.process=\"* /scomma *\" ) by Processes.parent_process Processes.process_name Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` |`security_content_ctime(lastTime)` | `detection_of_tools_built_by_nirsoft_filter`",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A "
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Silence",
                  "APT32",
                  "Threat Group-1314"
               ],
               "mitre_attack_id": [
                  "T1072"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Software Deployment Tools"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2017-09-19",
            "description": "Attackers often use spaces as a means to obfuscate an attachment's file extension. This search looks for messages with email attachments that have many spaces within the file names.",
            "how_to_implement": "You need to ingest data from emails. Specifically, the sender's address and the file names of any attachments must be mapped to the Email data model. The threshold ratio is set to 10%, but this value can be configured to suit each environment. \\\n **Splunk Phantom Playbook Integration**\\\nIf Splunk Phantom is also configured in your environment, a playbook called \"Suspicious Email Attachment Investigate and Delete\" can be configured to run when any results are found by this detection search. To use this integration, install the Phantom App for Splunk `https://splunkbase.splunk.com/app/3411/` and add the correct hostname to the \"Phantom Instance\" field in the Adaptive Response Actions when configuring this detection search. The notable event will be sent to Phantom and the playbook will gather further information about the file attachment and its network behaviors. If Phantom finds malicious behavior and an analyst approves of the results, the email will be deleted from the user's inbox.",
            "id": "56e877a6-1455-4479-ada6-0550dc1e22f8",
            "known_false_positives": "None at this time",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "email_attachments_with_lots_of_spaces_filter"
               }
            ],
            "name": "Email Attachments With Lots Of Spaces",
            "search": "| tstats `security_content_summariesonly` count values(All_Email.recipient) as recipient_address min(_time) as firstTime max(_time) as lastTime from datamodel=Email where All_Email.file_name=\"*\" by All_Email.src_user, All_Email.file_name All_Email.message_id | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Email\")` | eval space_ratio = (mvcount(split(file_name,\" \"))-1)/len(file_name) | search space_ratio >= 0.1 |  rex field=recipient_address \"(?<recipient_user>.*)@\" | `email_attachments_with_lots_of_spaces_filter`",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Suspicious Emails"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2017-09-15",
                  "description": "This search takes the existing interesting process table from ES, filters out any existing additions added by ESCU and then updates the table with processes identified by ESCU that should be prohibited on your endpoints.",
                  "how_to_implement": "This search should be run on each new install of ESCU.",
                  "id": "251930a5-1451-4428-bb13-eed5775be0ce",
                  "name": "Add Prohibited Processes to Enterprise Security",
                  "search": "| inputlookup interesting_processes_lookup | search note!=ESCU* | inputlookup append=T prohibitedProcesses_lookup | fillnull value=* dest dest_pci_domain | fillnull value=false is_required is_secure | fillnull value=true is_prohibited | outputlookup interesting_processes_lookup | stats count",
                  "tags": {
                     "analytics_story": [
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Monitor for Unauthorized Software",
                        "SamSam Ransomware"
                     ],
                     "detections": [
                        "Prohibited Software On Endpoint"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2019-10-11",
            "description": "This search looks for applications on the endpoint that you have marked as prohibited.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model in the processes node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is usually generated via logs that report process tracking in your Windows audit settings. In addition, you must also have only the `process_name` (not the entire process path) marked as \"prohibited\" in the Enterprise Security `interesting processes` table. To include the process names marked as \"prohibited\", which is included with ES Content Updates, run the included search <code>Add Prohibited Processes to Enterprise Security</code>.",
            "id": "a51bfe1a-94f0-48cc-b4e4-b6ae50145893",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "definition": "lookup interesting_processes_lookup app as process_name OUTPUT is_prohibited | search is_prohibited=True",
                  "description": "This macro limits the output to process_names that have been marked as prohibited",
                  "name": "prohibited_softwares"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "prohibited_software_on_endpoint_filter"
               }
            ],
            "name": "Prohibited Software On Endpoint",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.dest Processes.user Processes.process_name | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `prohibited_softwares` | `prohibited_software_on_endpoint_filter`",
            "tags": {
               "analytics_story": [
                  "Monitor for Unauthorized Software",
                  "Emotet Malware  DHS Report TA18-201A ",
                  "SamSam Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The search looks for modifications to registry keys that can be used to launch an application or service at system startup.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "f5f6af30-7aa7-4295-bfe9-07fe87c01a4b",
            "known_false_positives": "There are many legitimate applications that must execute on system startup and will use these registry keys to accomplish that task.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_used_for_persistence_filter"
               }
            ],
            "name": "Registry Keys Used For Persistence",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*currentversion\\\\run* OR Registry.registry_path=*currentVersion\\\\Windows\\\\Appinit_Dlls* OR Registry.registry_path=CurrentVersion\\\\Winlogon\\\\Shell* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\Userinit* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\VmApplet* OR Registry.registry_path=*currentversion\\\\policies\\\\explorer\\\\run* OR Registry.registry_path=*currentversion\\\\runservices* OR Registry.registry_path=*\\\\CurrentControlSet\\\\Control\\\\Lsa\\\\* OR Registry.registry_path=\"*Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options*\" OR Registry.registry_path=HKLM\\\\SOFTWARE\\\\Microsoft\\\\Netsh\\\\*) by Registry.dest , Registry.status, Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `registry_keys_used_for_persistence_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Suspicious MSHTA Activity",
                  "DHS Report TA18-074A",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware",
                  "Windows Persistence Techniques",
                  "Emotet Malware  DHS Report TA18-201A "
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for spikes in the number of Server Message Block (SMB) traffic connections.",
            "how_to_implement": "This search requires you to be ingesting your network traffic logs and populating the `Network_Traffic` data model.",
            "id": "7f5fb3e1-4209-4914-90db-0ec21b936378",
            "known_false_positives": "A file server may experience high-demand loads that could cause this analytic to trigger.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "smb_traffic_spike_filter"
               }
            ],
            "name": "SMB Traffic Spike",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src | `drop_dm_object_name(\"All_Traffic\")` | eventstats max(_time) as maxtime | stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, \"-70m@m\"), count, null))) as count avg(eval(if(_time<relative_time(maxtime, \"-70m@m\"), count, null))) as avg stdev(eval(if(_time<relative_time(maxtime, \"-70m@m\"), count, null))) as stdev by src | eval upperBound=(avg+stdev*2), isOutlier=if(count > upperBound AND num_data_samples >=50, 1, 0) | where isOutlier=1 | table src count | `smb_traffic_spike_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Hidden Cobra Malware",
                  "Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT32",
                  "Orangeworm",
                  "FIN8",
                  "APT3",
                  "Lazarus Group",
                  "Threat Group-1314",
                  "Turla",
                  "Deep Panda",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1021.002"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "SMB/Windows Admin Shares"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the number of SMB connections observed each hour for every day of week. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search to identify outliers in the number of SMB connections for that hour and day of the week.",
                  "how_to_implement": "You must be ingesting network traffic and populating the Network_Traffic data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. To improve your results, you may consider adding \"src\" to the by clause, which will build the model for each unique source in your enviornment. However, if you have a large number of hosts in your environment, this search may be very resource intensive. In this case, you may need to raise the value of max_inputs and/or max_groups in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "df98763b-0b08-4281-8ef9-08db7ac572a9",
                  "name": "Baseline of SMB Traffic - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=10m, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(\"All_Traffic\")` | fit DensityFunction count by \"HourOfDay,DayOfWeek\" into smb_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Ransomware"
                     ],
                     "detections": [
                        "Processes launching netsh",
                        "SMB Traffic Spike - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-22",
            "description": "This search uses the Machine Learning Toolkit (MLTK) to identify spikes in the number of Server Message Block (SMB) connections.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, the Machine Learning Toolkit (MLTK) version 4.2 or greater must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of SMB Traffic - MLTK\" must be executed before this detection search, because it builds a machine-learning (ML) model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.\\\nThis search produces a field (Number of events,count) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. This field contributes additional context to the notable. To see the additional metadata, add the following field, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry): \\\n1. **Label:** Number of events, **Field:** count\\\nDetailed documentation on how to create a new field within Incident Review is found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "d25773ba-9ad8-48d1-858e-07ad0bbeb828",
            "known_false_positives": "If you are seeing more results than desired, you may consider reducing the value of the threshold in the search. You should also periodically re-run the support search to re-build the ML model on the latest data. Please update the `smb_traffic_spike_mltk_filter` macro to filter out false positive results",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "smb_traffic_spike___mltk_filter"
               }
            ],
            "name": "SMB Traffic Spike - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(All_Traffic.dest_ip) as dest values(All_Traffic.dest_port) as port from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(All_Traffic)` | apply smb_pdfmodel threshold=0.001 | rename \"IsOutlier(count)\" as isOutlier | search isOutlier > 0 | sort -count | table _time src dest port count | `smb_traffic_spike___mltk_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Hidden Cobra Malware",
                  "Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT32",
                  "Orangeworm",
                  "FIN8",
                  "APT3",
                  "Lazarus Group",
                  "Threat Group-1314",
                  "Turla",
                  "Deep Panda",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1021.002"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "SMB/Windows Admin Shares"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for emails that have attachments with suspicious file extensions.",
            "how_to_implement": "You need to ingest data from emails. Specifically, the sender's address and the file names of any attachments must be mapped to the Email data model. \\\n **Splunk Phantom Playbook Integration**\\\nIf Splunk Phantom is also configured in your environment, a Playbook called \"Suspicious Email Attachment Investigate and Delete\" can be configured to run when any results are found by this detection search. To use this integration, install the Phantom App for Splunk `https://splunkbase.splunk.com/app/3411/`, and add the correct hostname to the \"Phantom Instance\" field in the Adaptive Response Actions when configuring this detection search. The notable event will be sent to Phantom and the playbook will gather further information about the file attachment and its network behaviors. If Phantom finds malicious behavior and an analyst approves of the results, the email will be deleted from the user's inbox.",
            "id": "473bd65f-06ca-4dfe-a2b8-ba04ab4a0084",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "definition": "lookup update=true is_suspicious_file_extension_lookup file_name OUTPUT suspicious | search suspicious=true",
                  "description": "This macro limits the output to email attachments that have suspicious extensions",
                  "name": "suspicious_email_attachments"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_email_attachment_extensions_filter"
               }
            ],
            "name": "Suspicious Email Attachment Extensions",
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Email where All_Email.file_name=\"*\" by All_Email.src_user, All_Email.file_name All_Email.message_id | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Email\")` | `suspicious_email_attachments` | `suspicious_email_attachment_extensions_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Suspicious Emails"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 7",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [
                  "Magic Hound",
                  "Windshift",
                  "APT33",
                  "Sandworm Team",
                  "Naikon",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Mofang",
                  "Wizard Spider",
                  "RTM",
                  "Frankenstein",
                  "Inception",
                  "BlackTech",
                  "APT-C-36",
                  "APT41",
                  "Machete",
                  "admin@338",
                  "Kimsuky",
                  "APT12",
                  "TA505",
                  "Silence",
                  "The White Company",
                  "APT39",
                  "FIN4",
                  "Darkhotel",
                  "Gallmaker",
                  "Tropic Trooper",
                  "Turla",
                  "Gorgon Group",
                  "Rancor",
                  "DarkHydrus",
                  "Cobalt Group",
                  "FIN7",
                  "OilRig",
                  "Lazarus Group",
                  "APT19",
                  "Dragonfly 2.0",
                  "BRONZE BUTLER",
                  "APT32",
                  "FIN8",
                  "MuddyWater",
                  "APT28",
                  "TA459",
                  "Leviathan",
                  "Patchwork",
                  "PLATINUM",
                  "Elderwood",
                  "APT29",
                  "APT37",
                  "menuPass"
               ],
               "mitre_attack_id": [
                  "T1566.001"
               ],
               "mitre_attack_tactics": [
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Spearphishing Attachment"
               ],
               "nist": [
                  "DE.AE",
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "bb9f5ed2-916e-4364-bb6d-91c310efcf52",
      "name": "Emotet Malware  DHS Report TA18-201A ",
      "narrative": "The trojan downloader known as Emotet first surfaced in 2014, when it was discovered targeting the banking industry to steal credentials. However, according to a joint technical alert (TA) issued by three government agencies (https://www.us-cert.gov/ncas/alerts/TA18-201A), Emotet has evolved far beyond those beginnings to become what a ThreatPost article called a threat-delivery service(see https://threatpost.com/emotet-malware-evolves-beyond-banking-to-threat-delivery-service/134342/).  For example, in early 2018, Emotet was found to be using its loader function to spread the Quakbot and Ransomware variants. \\\nAccording to the TA, the the malware continues to be among the most costly and destructive malware affecting the private and public sectors. Researchers have linked it to the threat group Mealybug, which has also been on the security communitys radar since 2014.\\\nThe searches in this Analytic Story will help you find executables that are rarely used in your environment, specific registry paths that malware often uses to ensure survivability and persistence, instances where cmd.exe is used to launch script interpreters, and other indicators that Emotet or other malware has compromised your environment. ",
      "references": [
         "https://www.us-cert.gov/ncas/alerts/TA18-201A",
         "https://www.first.org/resources/papers/conf2017/Advanced-Incident-Detection-and-Threat-Hunting-using-Sysmon-and-Splunk.pdf",
         "https://www.vkremez.com/2017/05/emotet-banking-trojan-malware-analysis.html"
      ],
      "tags": {
         "analytics_story": "Emotet Malware  DHS Report TA18-201A ",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "Sowbug",
            "Cobalt Group",
            "APT1",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "APT-C-36",
            "Kimsuky",
            "Putter Panda",
            "admin@338",
            "Naikon",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Molerats",
            "OilRig",
            "Elderwood",
            "APT32",
            "Suckfly",
            "FIN10",
            "Dark Caracal",
            "Machete",
            "BlackTech",
            "PLATINUM",
            "Orangeworm",
            "FIN4",
            "FIN7",
            "APT19",
            "APT12",
            "APT37",
            "Windshift",
            "Ke3chang",
            "TA459",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Mofang",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "APT38",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "Gallmaker",
            "APT33",
            "Blue Mockingbird",
            "APT18",
            "APT28",
            "Rocke",
            "Soft Cell",
            "FIN6",
            "Deep Panda",
            "Tropic Trooper",
            "Patchwork",
            "Threat Group-1314",
            "DarkHydrus",
            "TA505",
            "menuPass",
            "The White Company"
         ],
         "mitre_attack_id": [
            "T1021.002",
            "T1566.001",
            "T1547.001",
            "T1072",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Lateral Movement",
            "Execution",
            "Persistence",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Spearphishing Attachment",
            "SMB/Windows Admin Shares",
            "Software Deployment Tools",
            "Registry Run Keys / Startup Folder",
            "Windows Command Shell"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Shannon Davis, Splunk",
      "date": "2020-08-02",
      "description": "Uncover activity consistent with CVE-2020-5902. Discovered by Positive Technologies researchers, this vulnerability affects F5 BIG-IP, BIG-IQ. and Traffix SDC devices (vulnerable versions in F5 support link below). This vulnerability allows unauthenticated users, along with authenticated users, who have access to the configuration utility to execute system commands, create/delete files, disable services, and/or execute Java code.  This vulnerability can result in full system compromise.",
      "detections": [
         {
            "author": "Shannon Davis, Splunk",
            "date": "2020-08-02",
            "description": "This search detects remote code exploit attempts on F5 BIG-IP, BIG-IQ, and Traffix SDC devices",
            "how_to_implement": "To consistently detect exploit attempts on F5 devices using the vulnerabilities contained within CVE-2020-5902 it is recommended to ingest logs via syslog.  As many BIG-IP devices will have SSL enabled on their management interfaces, detections via wire data may not pick anything up unless you are decrypting SSL traffic in order to inspect it.  I am using a regex string from a Cloudflare mitigation technique to try and always catch the offending string (..;), along with the other exploit of using (hsqldb;).",
            "id": "810e4dbc-d46e-11ea-87d0-0242ac130003",
            "known_false_positives": "unknown",
            "macros": [
               {
                  "definition": "index=netops sourcetype=\"f5:bigip:rogue\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "f5_bigip_rogue"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_f5_tmui_rce_cve_2020_5902_filter"
               }
            ],
            "name": "Detect F5 TMUI RCE CVE-2020-5902",
            "references": [
               "https://www.ptsecurity.com/ww-en/about/news/f5-fixes-critical-vulnerability-discovered-by-positive-technologies-in-big-ip-application-delivery-controller/",
               "https://support.f5.com/csp/article/K52145254",
               "https://blog.cloudflare.com/cve-2020-5902-helping-to-protect-against-the-f5-tmui-rce-vulnerability/"
            ],
            "search": "`f5_bigip_rogue` | regex _raw=\"(hsqldb;|.*\\\\.\\\\.;.*)\" | search `detect_f5_tmui_rce_cve_2020_5902_filter`",
            "tags": {
               "analytics_story": [
                  "F5 TMUI RCE CVE-2020-5902"
               ],
               "asset_type": "Network",
               "cis20": [
                  "CIS 8",
                  "CIS 11"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Rocke",
                  "APT39",
                  "BlackTech",
                  "APT41",
                  "Soft Cell",
                  "Night Dragon",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1190"
               ],
               "mitre_attack_tactics": [
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Exploit Public-Facing Application"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "7678c968-d46e-11ea-87d0-0242ac130003",
      "name": "F5 TMUI RCE CVE-2020-5902",
      "narrative": "A client is able to perform a remote code execution on an exposed and vulnerable system. The detection search in this Analytic Story uses syslog to detect the malicious behavior. Syslog is going to be the best detection method, as any systems using SSL to protect their management console will make detection via wire data difficult.  The searches included used Splunk Connect For Syslog (https://splunkbase.splunk.com/app/4740/), and used a custom destination port to help define the data as F5 data (covered in https://splunk-connect-for-syslog.readthedocs.io/en/master/sources/F5/)",
      "references": [
         "https://www.ptsecurity.com/ww-en/about/news/f5-fixes-critical-vulnerability-discovered-by-positive-technologies-in-big-ip-application-delivery-controller/",
         "https://support.f5.com/csp/article/K52145254",
         "https://blog.cloudflare.com/cve-2020-5902-helping-to-protect-against-the-f5-tmui-rce-vulnerability/"
      ],
      "tags": {
         "analytics_story": "F5 TMUI RCE CVE-2020-5902",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Axiom",
            "Blue Mockingbird",
            "BlackTech",
            "APT41",
            "Rocke",
            "Soft Cell",
            "Night Dragon",
            "APT39"
         ],
         "mitre_attack_id": [
            "T1190"
         ],
         "mitre_attack_tactics": [
            "Initial Access"
         ],
         "mitre_attack_technique": [
            "Exploit Public-Facing Application"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2020-01-22",
      "description": "Monitor for and investigate activities, including the creation or deletion of hidden shares and file writes, that may be evidence of infiltration by North Korean government-sponsored cybercriminals. Details of this activity were reported in DHS Report TA-18-149A.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for the creation or deletion of hidden shares using net.exe.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "qw9919ed-fe5f-492c-b139-151bb162140e",
            "known_false_positives": "Administrators often leverage net.exe to create or delete network shares. You should verify that the activity was intentional and is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "create_or_delete_windows_shares_using_net_exe_filter"
               }
            ],
            "name": "Create or delete windows shares using net exe",
            "references": [
               "https://attack.mitre.org/techniques/T1077/",
               "https://attack.mitre.org/techniques/T1126/"
            ],
            "search": "| tstats `security_content_summariesonly` count values(Processes.user) as user values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processs.process_name=net.exe OR Processes.process_name=net1.exe) by Processes.process Processes.process_name Processes.dest | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | search process=*share* | `create_or_delete_windows_shares_using_net_exe_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for outbound SMB connections made by hosts within your network to the Internet. SMB traffic is used for Windows file-sharing activity. One of the techniques often used by attackers involves retrieving the credential hash using an SMB request made to a compromised server controlled by the threat actor.",
            "how_to_implement": "In order to run this search effectively, we highly recommend that you leverage the Assets and Identity framework. It is important that you have good understanding of how your network segments are designed, and be able to distinguish internal from external address space. Add a category named `internal` to the CIDRs that host the company's assets in `assets_by_cidr.csv` lookup file, which is located in `$SPLUNK_HOME/etc/apps/SA-IdentityManagement/lookups/`. More information on updating this lookup can be found here: https://docs.splunk.com/Documentation/ES/5.0.0/Admin/Addassetandidentitydata. This search also requires you to be ingesting your network traffic and populating the Network_Traffic data model",
            "id": "7f5fb3e1-4209-414-90db-0ec21b936378",
            "known_false_positives": "It is likely that the outbound Server Message Block (SMB) traffic is legitimate, if the company's internal networks are not well-defined in the Assets and Identity Framework. Categorize the internal CIDR blocks as `internal` in the lookup file to avoid creating notable events for traffic destined to those CIDR blocks. Any other network connection that is going out to the Internet should be investigated and blocked. Best practices suggest preventing external communications of all SMB versions and related protocols at the network boundary.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_outbound_smb_traffic_filter"
               }
            ],
            "name": "Detect Outbound SMB Traffic",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count earliest(_time) as earliest latest(_time) as latest values(All_Traffic.action) from datamodel=Network_Traffic where All_Traffic.action !=blocked All_Traffic.dest_category !=internal (All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb) by All_Traffic.src_ip All_Traffic.dest_ip | `drop_dm_object_name(\"All_Traffic\")` | search ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16) | `security_content_ctime(earliest)`| `security_content_ctime(latest)` | `detect_outbound_smb_traffic_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives",
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT41",
                  "SilverTerrier",
                  "Machete",
                  "Honeybee"
               ],
               "mitre_attack_id": [
                  "T1071.002"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "File Transfer Protocols"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the length of the DNS queries for each DNS record type observed in the environment. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search, which uses it to identify outliers in the length of the DNS query.",
                  "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "c914844c-0ff5-4efc-8d44-c063443129ba",
                  "name": "Baseline of DNS Query Length - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution by DNS.query DNS.record_type | search DNS.record_type=* | `drop_dm_object_name(\"DNS\")` | eval query_length = len(query) | fit DensityFunction query_length by record_type into dns_query_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "Command and Control",
                        "Hidden Cobra Malware",
                        "Suspicious DNS Traffic"
                     ],
                     "detections": [
                        "DNS Query Length Outliers - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-01-22",
            "description": "This search allows you to identify DNS requests that are unusually large for the record type being requested in your environment.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, the Machine Learning Toolkit (MLTK) version 4.2 or greater must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of DNS Query Length - MLTK\" must be executed before this detection search, because it builds a machine-learning (ML) model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.\\\nThis search produces fields (`query`,`query_length`,`count`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** DNS Query, **Field:** query\\\n1. \\\n1. **Label:** DNS Query Length, **Field:** query_length\\\n1. \\\n1. **Label:** Number of events, **Field:** count\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "85fbcfe8-9718-4911-adf6-7000d077a3a9",
            "known_false_positives": "If you are seeing more results than desired, you may consider reducing the value for threshold in the search. You should also periodically re-run the support search to re-build the ML model on the latest data.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_length_outliers___mltk_filter"
               }
            ],
            "name": "DNS Query Length Outliers - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as start_time max(_time) as end_time values(DNS.src) as src values(DNS.dest) as dest from datamodel=Network_Resolution by DNS.query DNS.record_type | search DNS.record_type=* |  `drop_dm_object_name(DNS)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | eval query_length = len(query) | apply dns_query_pdfmodel threshold=0.01 | rename \"IsOutlier(query_length)\" as isOutlier | search isOutlier > 0 | sort -query_length | table start_time end_time query record_type count src dest query_length | `dns_query_length_outliers___mltk_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search allows you to identify DNS requests and compute the standard deviation on the length of the names being resolved, then filter on two times the standard deviation to show you those queries that are unusually large for your environment.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model.",
            "id": "1a67f15a-f4ff-4170-84e9-08cf6f75d6f5",
            "known_false_positives": "It's possible there can be long domain names that are legitimate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_length_with_high_standard_deviation_filter"
               }
            ],
            "name": "DNS Query Length With High Standard Deviation",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution by DNS.query DNS.record_type |  `drop_dm_object_name(\"DNS\")` | eval query_length = len(query) | table query query_length record_type count | eventstats stdev(query_length) AS stdev avg(query_length) AS avg p50(query_length) AS p50| where query_length>(avg+stdev*2) | eval z_score=(query_length-avg)/stdev | `dns_query_length_with_high_standard_deviation_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2019-03-01",
                  "description": "This search looks for command-line arguments where `cmd.exe /c` is used to execute a program, then creates a baseline of the earliest and latest times we have encountered this command-line argument in our dataset within the last 30 days.",
                  "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd23",
                  "name": "Previously seen command line arguments",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe AND Processes.process=\"* /c *\" by Processes.process | `drop_dm_object_name(Processes)`",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Orangeworm Attack Group",
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Processes launching netsh",
                        "First time seen command line argument"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for command-line arguments that use a `/c` parameter to execute a command that has not previously been seen.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model. Please make sure you run the support search \"Previously seen command line arguments,\"&#151;which creates a lookup file called `previously_seen_cmd_line_arguments.csv`&#151;a historical baseline of all command-line arguments. You must also validate this list. For the search to do accurate calculation, ensure the search scheduling is the same value as the `relative_time` evaluation function.",
            "id": "9be56c82-b1cc-4318-87eb-q138afaaqa39",
            "known_false_positives": "Legitimate programs can also use command-line arguments to execute. Please verify the command-line arguments to check what command/program is being executed. We recommend customizing the `first_time_seen_cmd_line_filter` macro to exclude legitimate parent_process_name",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "first_time_seen_command_line_argument_filter"
               }
            ],
            "name": "First time seen command line argument",
            "references": [],
            "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process Processes.process_name Processes.parent_process_name Processes.dest| `drop_dm_object_name(Processes)`| `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search [| tstats `security_content_summariesonly` earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process | `drop_dm_object_name(Processes)` | inputlookup append=t previously_seen_cmd_line_arguments | stats min(firstTime) as firstTime, max(lastTime) as lastTime by process | outputlookup previously_seen_cmd_line_arguments | eval newCmdLineArgument=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newCmdLineArgument=1 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table process] | `first_time_seen_command_line_argument_filter` ",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A",
                  "Suspicious Command-Line Executions",
                  "Orangeworm Attack Group",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Hidden Cobra Malware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda",
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.001",
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell",
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-07",
            "description": "This search looks for network traffic on TCP/3389, the default port used by remote desktop. While remote desktop traffic is not uncommon on a network, it is usually associated with known hosts. This search allows for whitelisting both source and destination hosts to remove them from the output of the search so you can focus on the uncommon uses of remote desktop on your network.",
            "how_to_implement": "To successfully implement this search you need to identify systems that commonly originate remote desktop traffic and that commonly receive remote desktop traffic. You can use the included support search \"Identify Systems Creating Remote Desktop Traffic\" to identify systems that originate the traffic and the search \"Identify Systems Receiving Remote Desktop Traffic\" to identify systems that receive a lot of remote desktop traffic. After identifying these systems, you will need to add the \"common_rdp_source\" or \"common_rdp_destination\" category to that system depending on the usage, using the Enterprise Security Assets and Identities framework.  This can be done by adding an entry in the assets.csv file located in SA-IdentityManagement/lookups.",
            "id": "272b8407-842d-4b3d-bead-a704584003d3",
            "known_false_positives": "Remote Desktop may be used legitimately by users on the network.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_desktop_network_traffic_filter"
               }
            ],
            "name": "Remote Desktop Network Traffic",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.dest_port=3389 AND All_Traffic.dest_category!=common_rdp_destination AND All_Traffic.src_category!=common_rdp_source by All_Traffic.src All_Traffic.dest All_Traffic.dest_port | `drop_dm_object_name(\"All_Traffic\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `remote_desktop_network_traffic_filter` ",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "Hidden Cobra Malware",
                  "Lateral Movement"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 9",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "TEMP.Veles",
                  "Leviathan",
                  "APT39",
                  "Stolen Pencil",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "FIN8",
                  "APT3",
                  "OilRig",
                  "menuPass",
                  "FIN10",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "APT1",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1021.001"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Remote Desktop Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for the remote desktop process mstsc.exe running on systems upon which it doesn't typically run. This is accomplished by filtering out all systems that are noted in the `common_rdp_source category` in the Assets and Identity framework.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model in the processes node. The search requires you to identify systems that do not commonly use remote desktop. You can use the included support search \"Identify Systems Using Remote Desktop\" to identify these systems. After identifying them, you will need to add the \"common_rdp_source\" category to that system using the Enterprise Security Assets and Identities framework. This can be done by adding an entry in the assets.csv file located in `SA-IdentityManagement/lookups`.",
            "id": "f5939373-8054-40ad-8c64-cec478a22a4a",
            "known_false_positives": "Remote Desktop may be used legitimately by users on the network.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_desktop_process_running_on_system_filter"
               }
            ],
            "name": "Remote Desktop Process Running On System",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=*mstsc.exe AND Processes.dest_category!=common_rdp_source by Processes.dest Processes.user Processes.process | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `remote_desktop_process_running_on_system_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "Lateral Movement"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 9",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "TEMP.Veles",
                  "Leviathan",
                  "APT39",
                  "Stolen Pencil",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "FIN8",
                  "APT3",
                  "OilRig",
                  "menuPass",
                  "FIN10",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "APT1",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1021.001"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Remote Desktop Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for spikes in the number of Server Message Block (SMB) traffic connections.",
            "how_to_implement": "This search requires you to be ingesting your network traffic logs and populating the `Network_Traffic` data model.",
            "id": "7f5fb3e1-4209-4914-90db-0ec21b936378",
            "known_false_positives": "A file server may experience high-demand loads that could cause this analytic to trigger.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "smb_traffic_spike_filter"
               }
            ],
            "name": "SMB Traffic Spike",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src | `drop_dm_object_name(\"All_Traffic\")` | eventstats max(_time) as maxtime | stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, \"-70m@m\"), count, null))) as count avg(eval(if(_time<relative_time(maxtime, \"-70m@m\"), count, null))) as avg stdev(eval(if(_time<relative_time(maxtime, \"-70m@m\"), count, null))) as stdev by src | eval upperBound=(avg+stdev*2), isOutlier=if(count > upperBound AND num_data_samples >=50, 1, 0) | where isOutlier=1 | table src count | `smb_traffic_spike_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Hidden Cobra Malware",
                  "Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT32",
                  "Orangeworm",
                  "FIN8",
                  "APT3",
                  "Lazarus Group",
                  "Threat Group-1314",
                  "Turla",
                  "Deep Panda",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1021.002"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "SMB/Windows Admin Shares"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the number of SMB connections observed each hour for every day of week. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search to identify outliers in the number of SMB connections for that hour and day of the week.",
                  "how_to_implement": "You must be ingesting network traffic and populating the Network_Traffic data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. To improve your results, you may consider adding \"src\" to the by clause, which will build the model for each unique source in your enviornment. However, if you have a large number of hosts in your environment, this search may be very resource intensive. In this case, you may need to raise the value of max_inputs and/or max_groups in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "df98763b-0b08-4281-8ef9-08db7ac572a9",
                  "name": "Baseline of SMB Traffic - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=10m, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(\"All_Traffic\")` | fit DensityFunction count by \"HourOfDay,DayOfWeek\" into smb_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Ransomware"
                     ],
                     "detections": [
                        "Processes launching netsh",
                        "SMB Traffic Spike - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-22",
            "description": "This search uses the Machine Learning Toolkit (MLTK) to identify spikes in the number of Server Message Block (SMB) connections.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, the Machine Learning Toolkit (MLTK) version 4.2 or greater must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of SMB Traffic - MLTK\" must be executed before this detection search, because it builds a machine-learning (ML) model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.\\\nThis search produces a field (Number of events,count) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. This field contributes additional context to the notable. To see the additional metadata, add the following field, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry): \\\n1. **Label:** Number of events, **Field:** count\\\nDetailed documentation on how to create a new field within Incident Review is found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "d25773ba-9ad8-48d1-858e-07ad0bbeb828",
            "known_false_positives": "If you are seeing more results than desired, you may consider reducing the value of the threshold in the search. You should also periodically re-run the support search to re-build the ML model on the latest data. Please update the `smb_traffic_spike_mltk_filter` macro to filter out false positive results",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "smb_traffic_spike___mltk_filter"
               }
            ],
            "name": "SMB Traffic Spike - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(All_Traffic.dest_ip) as dest values(All_Traffic.dest_port) as port from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(All_Traffic)` | apply smb_pdfmodel threshold=0.001 | rename \"IsOutlier(count)\" as isOutlier | search isOutlier > 0 | sort -count | table _time src dest port count | `smb_traffic_spike___mltk_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Hidden Cobra Malware",
                  "Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT32",
                  "Orangeworm",
                  "FIN8",
                  "APT3",
                  "Lazarus Group",
                  "Threat Group-1314",
                  "Turla",
                  "Deep Panda",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1021.002"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "SMB/Windows Admin Shares"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2019-04-25",
            "description": "The search looks for files created with names that have been linked to malicious activity.",
            "how_to_implement": "You must be ingesting data that records the filesystem activity from your hosts to populate the Endpoint file-system data model node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or via other endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report file system reads and writes. In addition, this search leverages an included lookup file that contains the names of the files to watch for, as well as a note to communicate why that file name is being monitored. This lookup file can be edited to add or remove file the file names you want to monitor.",
            "id": "57f76b8a-32f0-42ed-b358-d9fa3ca7bac8",
            "known_false_positives": "It's possible for a legitimate file to be created with the same name as one noted in the lookup file. Filenames listed in the lookup file should be unique enough that collisions are rare. Looking at the location of the file and the process responsible for the activity can help determine whether or not the activity is legitimate.",
            "macros": [
               {
                  "definition": "lookup suspicious_writes_lookup file as file_name OUTPUT note as \"Reference\" | search \"Reference\" != False",
                  "description": "This macro limites the output to file names that have been marked as suspicious",
                  "name": "suspicious_writes"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_file_write_filter"
               }
            ],
            "name": "Suspicious File Write",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Filesystem.action) as action values(Filesystem.file_path) as file_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem by Filesystem.file_name Filesystem.dest | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Filesystem)` | `suspicious_writes` | `suspicious_file_write_filter`",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "baf7580b-d4b4-4774-8173-7d198e9da335",
      "name": "Hidden Cobra Malware",
      "narrative": "North Korea's government-sponsored \"cyber army\" has been slowly building momentum and gaining sophistication over the last 15 years or so. As a result, the group's activity, which the US government refers to as \"Hidden Cobra,\" has surreptitiously crept onto the collective radar as a preeminent global threat.\\\nThese state-sponsored actors are thought to be responsible for everything from a hack on a South Korean nuclear plant to an attack on Sony in anticipation of its release of the movie \"The Interview\" at the end of 2014. They're also notorious for cyberespionage. In recent years, the group seems to be focused on financial crimes, such as cryptojacking.\\\nIn June of 2018, The Department of Homeland Security, together with the FBI and other U.S. government partners, issued Technical Alert (TA-18-149A) to advise the public about two variants of North Korean malware. One variant, dubbed \"Joanap,\" is a multi-stage peer-to-peer botnet that allows North Korean state actors to exfiltrate data, download and execute secondary payloads, and initialize proxy communications. The other variant, \"Brambul,\" is a Windows32 SMB worm that is dropped into a victim network. When executed, the malware attempts to spread laterally within a victim's local subnet, connecting via the SMB protocol and initiating brute-force password attacks. It reports details to the Hidden Cobra actors via email, so they can use the information for secondary remote operations.\\\nAmong other searches in this Analytic Story is a detection search that looks for the creation or deletion of hidden shares, such as, \"adnim$,\" which the Hidden Cobra malware creates on the target system. Another looks for the creation of three malicious files associated with the malware. You can also use a search in this story to investigate activity that indicates that malware is sending email back to the attackers.",
      "references": [
         "https://www.us-cert.gov/HIDDEN-COBRA-North-Korean-Malicious-Cyber-Activity",
         "https://www.operationblockbuster.com/wp-content/uploads/2016/02/Operation-Blockbuster-Destructive-Malware-Report.pdf"
      ],
      "tags": {
         "analytics_story": "Hidden Cobra Malware",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "SilverTerrier",
            "Sowbug",
            "TEMP.Veles",
            "Cobalt Group",
            "APT1",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "Kimsuky",
            "admin@338",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Thrip",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "APT32",
            "Suckfly",
            "FIN10",
            "Dark Caracal",
            "Machete",
            "Orangeworm",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "TA459",
            "Magic Hound",
            "Axiom",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "APT38",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "Gallmaker",
            "Stolen Pencil",
            "APT33",
            "Blue Mockingbird",
            "APT18",
            "APT28",
            "FIN6",
            "Soft Cell",
            "Deep Panda",
            "Tropic Trooper",
            "Patchwork",
            "Threat Group-1314",
            "DarkVishnya",
            "DarkHydrus",
            "Poseidon Group",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1059.001",
            "T1021.001",
            "T1021.002",
            "T1071.002",
            "T1071.004",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Command And Control",
            "Lateral Movement"
         ],
         "mitre_attack_technique": [
            "DNS",
            "SMB/Windows Admin Shares",
            "File Transfer Protocols",
            "Windows Command Shell",
            "PowerShell",
            "Remote Desktop Protocol"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2017-09-14",
      "description": "Detect evidence of tactics used to redirect traffic from a host to a destination other than the one intended--potentially one that is part of an adversary's attack infrastructure. An example is redirecting communications regarding patches and updates or misleading users into visiting a malicious website.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search allows you to identify the endpoints that have connected to more than five DNS servers and made DNS Queries over the time frame of the search.",
            "how_to_implement": "This search requires that DNS data is being ingested and populating the `Network_Resolution` data model. This data can come from DNS logs or from solutions that parse network traffic for this data, such as Splunk Stream or Bro.\\\nThis search produces fields (`dest_count`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** Distinct DNS Connections, **Field:** dest_count\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "74ec6f18-604b-4202-a567-86b2066be3ce",
            "known_false_positives": "It's possible that an enterprise has more than five DNS servers that are configured in a round-robin rotation. Please customize the search, as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "clients_connecting_to_multiple_dns_servers_filter"
               }
            ],
            "name": "Clients Connecting to Multiple DNS Servers",
            "search": "| tstats `security_content_summariesonly` count, values(DNS.dest) AS dest dc(DNS.dest) as dest_count from datamodel=Network_Resolution where DNS.message_type=QUERY by DNS.src | `drop_dm_object_name(\"Network_Resolution\")` |where dest_count > 5 | `clients_connecting_to_multiple_dns_servers_filter` ",
            "tags": {
               "analytics_story": [
                  "DNS Hijacking",
                  "Command and Control",
                  "Suspicious DNS Traffic",
                  "Host Redirection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT32",
                  "APT33",
                  "Thrip",
                  "FIN8",
                  "OilRig",
                  "Lazarus Group"
               ],
               "mitre_attack_id": [
                  "T1048.003"
               ],
               "mitre_attack_tactics": [
                  "Exfiltration"
               ],
               "mitre_attack_technique": [
                  "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search will detect DNS requests resolved by unauthorized DNS servers. Legitimate DNS servers should be identified in the Enterprise Security Assets and Identity Framework.",
            "how_to_implement": "To successfully implement this search you will need to ensure that DNS data is populating the Network_Resolution data model. It also requires that your DNS servers are identified correctly in the Assets and Identity table of Enterprise Security.",
            "id": "1a67f15a-f4ff-4170-84e9-08cf6f75d6f6",
            "known_false_positives": "Legitimate DNS activity can be detected in this search. Investigate, verify and update the list of authorized DNS servers as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_requests_resolved_by_unauthorized_dns_servers_filter"
               }
            ],
            "name": "DNS Query Requests Resolved by Unauthorized DNS Servers",
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution where DNS.dest_category != dns_server AND DNS.src_category != dns_server by DNS.src DNS.dest | `drop_dm_object_name(\"DNS\")` | `dns_query_requests_resolved_by_unauthorized_dns_servers_filter` ",
            "tags": {
               "analytics_story": [
                  "DNS Hijacking",
                  "Command and Control",
                  "Suspicious DNS Traffic",
                  "Host Redirection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 1",
                  "CIS 3",
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS",
                  "PR.IP",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2018-11-02",
            "description": "The search looks for modifications to the hosts file on all Windows endpoints across your environment.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records the file-system activity from your hosts to populate the Endpoint.Filesystem data model node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or by other endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report file-system reads and writes.",
            "id": "06a6fc63-a72d-41dc-8736-7e3dd9612116",
            "known_false_positives": "There may be legitimate reasons for system administrators to add entries to this file.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "windows_hosts_file_modification_filter"
               }
            ],
            "name": "Windows hosts file modification",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem  by Filesystem.file_name Filesystem.file_path Filesystem.dest | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | search Filesystem.file_name=hosts AND Filesystem.file_path=*Windows\\\\System32\\\\* | `drop_dm_object_name(Filesystem)` | `windows_hosts_file_modification_filter`",
            "tags": {
               "analytics_story": [
                  "Host Redirection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "2e8948a5-5239-406b-b56b-6c50fe268af4",
      "name": "Host Redirection",
      "narrative": "Attackers will often attempt to manipulate client communications for nefarious purposes. In some cases, an attacker may endeavor to modify a local host file to redirect communications with resources (such as antivirus or system-update services) to prevent clients from receiving patches or updates. In other cases, an attacker might use this tactic to have the client connect to a site that looks like the intended site, but instead installs malware or collects information from the victim. Additionally, an attacker may redirect a victim in order to execute a MITM attack and observe communications.",
      "references": [
         "https://blog.malwarebytes.com/cybercrime/2016/09/hosts-file-hijacks/"
      ],
      "tags": {
         "analytics_story": "Host Redirection",
         "category": [
            "Abuse"
         ],
         "mitre_attack_groups": [
            "Thrip",
            "Ke3chang",
            "OilRig",
            "Cobalt Group",
            "APT32",
            "APT33",
            "APT18",
            "APT41",
            "FIN8",
            "Tropic Trooper",
            "FIN7",
            "Lazarus Group",
            "APT39"
         ],
         "mitre_attack_id": [
            "T1071.004",
            "T1048.003"
         ],
         "mitre_attack_tactics": [
            "Exfiltration",
            "Command And Control"
         ],
         "mitre_attack_technique": [
            "DNS",
            "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2017-09-14",
      "description": "In March of 2016, adversaries were seen using JexBoss--an open-source utility used for testing and exploiting JBoss application servers. These searches help detect evidence of these attacks, such as network connections to external resources or web services spawning atypical child processes, among others.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-23",
            "description": "This search looks for specific GET or HEAD requests to web servers that are indicative of reconnaissance attempts to identify vulnerable JBoss servers. JexBoss is described as the exploit tool of choice for this malicious activity.",
            "how_to_implement": "You must be ingesting data from the web server or network traffic that contains web specific information, and populating the Web data model.",
            "id": "104658f4-afdc-499e-9719-17243f982681",
            "known_false_positives": "It's possible for legitimate HTTP requests to be made to URLs containing the suspicious paths.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_attackers_scanning_for_vulnerable_jboss_servers_filter"
               }
            ],
            "name": "Detect attackers scanning for vulnerable JBoss servers",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where (Web.http_method=\"GET\" OR Web.http_method=\"HEAD\") AND (Web.url=\"*/web-console/ServerInfo.jsp*\" OR Web.url=\"*web-console*\" OR Web.url=\"*jmx-console*\" OR Web.url = \"*invoker*\") by Web.http_method, Web.url, Web.src, Web.dest | `drop_dm_object_name(\"Web\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `detect_attackers_scanning_for_vulnerable_jboss_servers_filter`",
            "tags": {
               "analytics_story": [
                  "JBoss Vulnerability",
                  "SamSam Ransomware"
               ],
               "asset_type": "Web Server",
               "kill_chain_phases": [
                  "Reconnaissance"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Sandworm Team",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "Inception",
                  "Kimsuky",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "Honeybee",
                  "APT19",
                  "APT37",
                  "APT32",
                  "Magic Hound",
                  "OilRig",
                  "APT3",
                  "Sowbug",
                  "Gamaredon Group",
                  "Patchwork",
                  "Stealth Falcon",
                  "Lazarus Group",
                  "admin@338",
                  "Turla",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1082"
               ],
               "mitre_attack_tactics": [
                  "Discovery"
               ],
               "mitre_attack_technique": [
                  "System Information Discovery"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-23",
            "description": "This search is used to detect malicious HTTP requests crafted to exploit jmx-console in JBoss servers. The malicious requests have a long URL length, as the payload is embedded in the URL.",
            "how_to_implement": "You must ingest data from the web server or capture network data that contains web specific information with solutions such as Bro or Splunk Stream, and populating the Web data model",
            "id": "c8bff7a4-11ea-4416-a27d-c5bca472913d",
            "known_false_positives": "No known false positives for this detection.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_malicious_requests_to_exploit_jboss_servers_filter"
               }
            ],
            "name": "Detect malicious requests to exploit JBoss servers",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where (Web.http_method=\"GET\" OR Web.http_method=\"HEAD\") by Web.http_method, Web.url,Web.url_length Web.src, Web.dest | search Web.url=\"*jmx-console/HtmlAdaptor?action=invokeOpByName&name=jboss.admin*import*\" AND Web.url_length > 200 | `drop_dm_object_name(\"Web\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table src, dest_ip, http_method, url, firstTime, lastTime | `detect_malicious_requests_to_exploit_jboss_servers_filter`",
            "tags": {
               "analytics_story": [
                  "JBoss Vulnerability",
                  "SamSam Ransomware"
               ],
               "asset_type": "Web Server",
               "cis20": [
                  "CIS 12",
                  "CIS 4",
                  "CIS 18"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.RA",
                  "PR.PT",
                  "PR.IP",
                  "DE.AE",
                  "PR.MA",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "1f5294cb-b85f-4c2d-9c58-ffcf248f52bd",
      "name": "JBoss Vulnerability",
      "narrative": "This Analytic Story looks for probing and exploitation attempts targeting JBoss application servers. While the vulnerabilities associated with this story are rather dated, they were leveraged in a spring 2016 campaign in connection with the Samsam ransomware variant. Incidents involving this ransomware are unique, in that they begin with attacks against vulnerable services, rather than the phishing or drive-by attacks more common with ransomware. In this case, vulnerable JBoss applications appear to be the target of choice.\\\nIt is helpful to understand how often a notable event generated by this story occurs, as well as the commonalities between some of these events, both of which may provide clues about whether this is a common occurrence of minimal concern or a rare event that may require more extensive investigation. It may also help to understand whether the issue is restricted to a single user/system or whether it is broader in scope.\\\nhen looking at the target of the behavior uncovered by the event, you should note the sensitivity of the user and or/system to help determine the potential impact. It is also helpful to identify other recent events involving the target. This can help tie different events together and give further situational awareness regarding the target host.\\\nVarious types of information for external systems should be reviewed and, potentially, collected if the incident is, indeed, judged to be malicious. This data may be useful for generating your own threat intelligence, so you can create future alerts.\\\nThe following factors may assist you in determining whether the event is malicious: \\\n1. Country of origin\\\n1. Responsible party\\\n1. Fully qualified domain names associated with the external IP address\\\n1. Registration of fully qualified domain names associated with external IP address Determining whether it is a dynamic domain frequently visited by others and/or how third parties categorize it can also help you qualify and understand the event and possible motivation for the attack. In addition, there are various sources that may provide reputation information on the IP address or domain name, which can assist you in determining whether the event is malicious in nature. Finally, determining whether there are other events associated with the IP address may help connect data points or expose other historic events that might be brought back into scope.\\\nGathering various data on the system of interest can sometimes help quickly determine whether something suspicious is happening. Some of these items include determining who else may have logged into the system recently, whether any unusual scheduled tasks exist, whether the system is communicating on suspicious ports, whether there are modifications to sensitive registry keys, and/or whether there are any known vulnerabilities on the system. This information can often highlight other activity commonly seen in attack scenarios or give more information about how the system may have been targeted.\\\nhen a specific service or application is targeted, it is often helpful to know the associated version, to help determine whether it is vulnerable to a specific exploit.\\\nIf you suspect an attack targeting a web server, it is helpful to look at some of the behavior of the web service to see if there is evidence that the service has been compromised. Some indications of this might be network connections to external resources, the web service spawning child processes that are not associated with typical behavior, and whether the service wrote any files that might be malicious in nature.\\\nIf a suspicious file is found, we can review more information about it to help determine if it is, in fact, malicious. Identifying the file type, any processes that opened the file, the processes that may have created and/or modified the file, and how many other systems potentially have this file can you determine whether the file is malicious. Also, determining the file hash and checking it against reputation sources, such as VirusTotal, can sometimes help you quickly determine if it is malicious in nature.\\\nOften, a simple inspection of a suspect process name and path can tell you if the system has been compromised. For example, if svchost.exe is found running from a location other than `C:\\Windows\\System32`, it is likely something malicious designed to hide in plain sight when simply reviewing process names. \\\nIt can also be helpful to examine various behaviors of and the parent of the process of interest. For example, if it turns out the process of interest is malicious, it would be good to see whether the parent process spawned other processes that might also warrant further scrutiny. If a process is suspect, a review of the network connections made around the time of the event and noting whether the process has spawned any child processes could be helpful in determining whether it is malicious or executing a malicious script.",
      "references": [
         "http://www.deependresearch.org/2016/04/jboss-exploits-view-from-victim.html"
      ],
      "tags": {
         "analytics_story": "JBoss Vulnerability",
         "category": [
            "Vulnerability"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "Sowbug",
            "Turla",
            "Inception",
            "Kimsuky",
            "admin@338",
            "OilRig",
            "APT32",
            "APT19",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Lazarus Group",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "Rocke",
            "Blue Mockingbird",
            "APT18",
            "Tropic Trooper",
            "Patchwork",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1082"
         ],
         "mitre_attack_tactics": [
            "Discovery"
         ],
         "mitre_attack_technique": [
            "System Information Discovery"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rod Soto, Splunk",
      "date": "2020-04-15",
      "description": "This story addresses detection against Kubernetes cluster fingerprint scan and attack by providing information on items such as source ip, user agent, cluster names.",
      "detections": [
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-04-15",
            "description": "This search provides information of unauthenticated requests via user agent, and authentication data against Kubernetes cluster in AWS",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudWatch EKS Logs inputs.",
            "id": "294c4686-63dd-4fe6-93a2-ca807626704a",
            "known_false_positives": "Not all unauthenticated requests are malicious, but frequency, UA and source IPs will provide context.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "amazon_eks_kubernetes_cluster_scan_detection_filter"
               }
            ],
            "name": "Amazon EKS Kubernetes cluster scan detection",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` \"user.username\"=\"system:anonymous\" userAgent!=\"AWS Security Scanner\" | rename sourceIPs{} as src_ip | stats count min(_time) as firstTime max(_time) as lastTime values(responseStatus.reason) values(source) as cluster_name values(responseStatus.code) values(userAgent) as http_user_agent values(verb) values(requestURI) by src_ip user.username user.groups{} | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` |`amazon_eks_kubernetes_cluster_scan_detection_filter` ",
            "tags": {
               "analytics_story": [
                  "Kubernetes Scanning Activity"
               ],
               "asset_type": "Amazon EKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Reconnaissance"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1526"
               ],
               "mitre_attack_tactics": [
                  "Discovery"
               ],
               "mitre_attack_technique": [
                  "Cloud Service Discovery"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-04-15",
            "description": "This search provides detection information on unauthenticated requests against Kubernetes' Pods API",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on forAWS (version 4.4.0 or later), then configure your AWS CloudWatch EKS Logs.Please also customize the `kubernetes_pods_aws_scan_fingerprint_detection` macro to filter out the false positives.",
            "id": "dbfca1dd-b8e5-4ba4-be0e-e565e5d62002",
            "known_false_positives": "Not all unauthenticated requests are malicious, but frequency, UA and source IPs and direct request to API provide context.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "amazon_eks_kubernetes_pod_scan_detection_filter"
               }
            ],
            "name": "Amazon EKS Kubernetes Pod scan detection",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` \"user.username\"=\"system:anonymous\" verb=list objectRef.resource=pods requestURI=\"/api/v1/pods\" | rename source as cluster_name sourceIPs{} as src_ip | stats count min(_time) as firstTime max(_time) as lastTime values(responseStatus.reason) values(responseStatus.code) values(userAgent) values(verb) values(requestURI) by src_ip cluster_name user.username user.groups{} | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `amazon_eks_kubernetes_pod_scan_detection_filter` ",
            "tags": {
               "analytics_story": [
                  "Kubernetes Scanning Activity"
               ],
               "asset_type": "Amazon EKS Kubernetes cluster Pod",
               "kill_chain_phases": [
                  "Reconnaissance"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1526"
               ],
               "mitre_attack_tactics": [
                  "Discovery"
               ],
               "mitre_attack_technique": [
                  "Cloud Service Discovery"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-17",
            "description": "This search provides information of unauthenticated requests via user agent, and authentication data against Kubernetes cluster's pods",
            "how_to_implement": "You must install the GCP App for Splunk (version 2.0.0 or later), then configure stackdriver and set a Pub/Sub subscription to be imported to Splunk.",
            "id": "19b53215-4a16-405b-8087-9e6acf619842",
            "known_false_positives": "Not all unauthenticated requests are malicious, but frequency, User Agent, source IPs and pods  will provide context.",
            "macros": [
               {
                  "definition": "sourcetype=\"google:gcp:pubsub:message\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "google_gcp_pubsub_message"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "gcp_kubernetes_cluster_pod_scan_detection_filter"
               }
            ],
            "name": "GCP Kubernetes cluster pod scan detection",
            "references": [],
            "search": "`google_gcp_pubsub_message` category=kube-audit |spath input=properties.log |search responseStatus.code=401 |table sourceIPs{} userAgent verb requestURI responseStatus.reason properties.pod | `gcp_kubernetes_cluster_pod_scan_detection_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Scanning Activity"
               ],
               "asset_type": "GCP Kubernetes cluster",
               "kill_chain_phases": [
                  "Reconnaissance"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1526"
               ],
               "mitre_attack_tactics": [
                  "Discovery"
               ],
               "mitre_attack_technique": [
                  "Cloud Service Discovery"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-04-15",
            "description": "This search provides information of unauthenticated requests via user agent, and authentication data against Kubernetes cluster",
            "how_to_implement": "You must install the GCP App for Splunk (version 2.0.0 or later), then configure stackdriver and set a Pub/Sub subscription to be imported to Splunk. You must also install Cloud Infrastructure data model.Customize the macro kubernetes_gcp_scan_fingerprint_attack_detection to filter out FPs.",
            "id": "db5957ec-0144-4c56-b512-9dccbe7a2d26",
            "known_false_positives": "Not all unauthenticated requests are malicious, but frequency, User Agent and source IPs will provide context.",
            "macros": [
               {
                  "definition": "sourcetype=\"google:gcp:pubsub:message\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "google_gcp_pubsub_message"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "gcp_kubernetes_cluster_scan_detection_filter"
               }
            ],
            "name": "GCP Kubernetes cluster scan detection",
            "references": [],
            "search": "`google_gcp_pubsub_message` data.protoPayload.requestMetadata.callerIp!=127.0.0.1 data.protoPayload.requestMetadata.callerIp!=::1 \"data.labels.authorization.k8s.io/decision\"=forbid \"data.protoPayload.status.message\"=PERMISSION_DENIED data.protoPayload.authenticationInfo.principalEmail=\"system:anonymous\" | rename data.protoPayload.requestMetadata.callerIp as src_ip | stats count min(_time) as firstTime max(_time) as lastTime values(data.protoPayload.methodName) as method_name values(data.protoPayload.resourceName) as resource_name values(data.protoPayload.requestMetadata.callerSuppliedUserAgent) as http_user_agent by src_ip data.resource.labels.cluster_name | rename data.resource.labels.cluster_name as cluster_name| `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)`  | `gcp_kubernetes_cluster_scan_detection_filter` ",
            "tags": {
               "analytics_story": [
                  "Kubernetes Scanning Activity"
               ],
               "asset_type": "GCP Kubernetes cluster",
               "kill_chain_phases": [
                  "Reconnaissance"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1526"
               ],
               "mitre_attack_tactics": [
                  "Discovery"
               ],
               "mitre_attack_technique": [
                  "Cloud Service Discovery"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-05-20",
            "description": "This search provides information of unauthenticated requests via source IP user agent, request URI and response status data against Kubernetes cluster pod in Azure",
            "how_to_implement": "You must install the Add-on for Microsoft Cloud Services and Configure Kube-Audit data diagnostics",
            "id": "86aad3e0-732f-4f66-bbbc-70df448e461d",
            "known_false_positives": "Not all unauthenticated requests are malicious, but source IPs, userAgent, verb, request URI and response status will provide context.",
            "macros": [
               {
                  "definition": "sourcetype=mscs:storage:blob:json",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype) for Kubernetes data from Azure. Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "kubernetes_azure"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_azure_pod_scan_fingerprint_filter"
               }
            ],
            "name": "Kubernetes Azure pod scan fingerprint",
            "references": [],
            "search": "`kubernetes_azure` category=kube-audit | spath input=properties.log | search responseStatus.code=401 | table  sourceIPs{} userAgent verb requestURI responseStatus.reason properties.pod |`kubernetes_azure_pod_scan_fingerprint_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Scanning Activity"
               ],
               "asset_type": "Azure AKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Reconnaissance"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-05-19",
            "description": "This search provides information of unauthenticated requests via source IP user agent, request URI and response status data against Kubernetes cluster in Azure",
            "how_to_implement": "You must install the Add-on for Microsoft Cloud Services and Configure Kube-Audit data diagnostics",
            "id": "c5e5bd5c-1013-4841-8b23-e7b3253c840a",
            "known_false_positives": "Not all unauthenticated requests are malicious, but source IPs, userAgent, verb, request URI and response status will provide context.",
            "macros": [
               {
                  "definition": "sourcetype=mscs:storage:blob:json",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype) for Kubernetes data from Azure. Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "kubernetes_azure"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_azure_scan_fingerprint_filter"
               }
            ],
            "name": "Kubernetes Azure scan fingerprint",
            "references": [],
            "search": "`kubernetes_azure` category=kube-audit | spath input=properties.log | search responseStatus.code=401 | table  sourceIPs{} userAgent verb requestURI responseStatus.reason |`kubernetes_azure_scan_fingerprint_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Scanning Activity"
               ],
               "asset_type": "Azure AKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Reconnaissance"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1526"
               ],
               "mitre_attack_tactics": [
                  "Discovery"
               ],
               "mitre_attack_technique": [
                  "Cloud Service Discovery"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "a9ef59cf-e981-4e66-9eef-bb049f695c09",
      "name": "Kubernetes Scanning Activity",
      "narrative": "Kubernetes is the most used container orchestration platform, this orchestration platform contains sensitve information and management priviledges of production workloads, microservices and applications. These searches allow operator to detect suspicious unauthenticated requests from the internet to kubernetes cluster.",
      "references": [
         "https://github.com/splunk/cloud-datamodel-security-research"
      ],
      "tags": {
         "analytics_story": "Kubernetes Scanning Activity",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "no"
         ],
         "mitre_attack_id": [
            "T1526"
         ],
         "mitre_attack_tactics": [
            "Discovery"
         ],
         "mitre_attack_technique": [
            "Cloud Service Discovery"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rod Soto, Splunk",
      "date": "2020-05-20",
      "description": "This story addresses detection and response of accounts acccesing Kubernetes cluster sensitive objects such as configmaps or secrets providing information on items such as user user, group. object, namespace and authorization reason.",
      "detections": [
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-06-23",
            "description": "This search provides information on Kubernetes accounts accessing sensitve objects such as configmaps or secrets",
            "how_to_implement": "You must install splunk AWS add on and Splunk App for AWS. This search works with cloudwatch logs.",
            "id": "7f227943-2196-4d4d-8d6a-ac8cb308e61c",
            "known_false_positives": "Sensitive object access is not necessarily malicious but user and object context can provide guidance for detection.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "aws_eks_kubernetes_cluster_sensitive_object_access_filter"
               }
            ],
            "name": "AWS EKS Kubernetes cluster sensitive object access",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` objectRef.resource=secrets OR configmaps sourceIPs{}!=::1 sourceIPs{}!=127.0.0.1  |table sourceIPs{} user.username user.groups{} objectRef.resource objectRef.namespace objectRef.name annotations.authorization.k8s.io/reason |dedup user.username user.groups{} |`aws_eks_kubernetes_cluster_sensitive_object_access_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Object Access Activity"
               ],
               "asset_type": "AWS EKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-06-23",
            "description": "This search provides information on Kubernetes service accounts with failure or forbidden access status, this search can be extended by using top or rare operators to find trends or rarities in failure status, user agents, source IPs and request URI",
            "how_to_implement": "You must install splunk AWS add on and Splunk App for AWS. This search works with cloudwatch logs.",
            "id": "a6959c57-fa8f-4277-bb86-7c32fba579d5",
            "known_false_positives": "This search can give false positives as there might be inherent issues with authentications and permissions at cluster.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_aws_detect_service_accounts_forbidden_failure_access_filter"
               }
            ],
            "name": "Kubernetes AWS detect service accounts forbidden failure access",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` user.groups{}=system:serviceaccounts responseStatus.status = Failure | table sourceIPs{} src_user userAgent verb responseStatus.status requestURI | `kubernetes_aws_detect_service_accounts_forbidden_failure_access_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Object Access Activity"
               ],
               "asset_type": "AWS EKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-06-23",
            "description": "This search provides information on anonymous Kubectl calls with IP, verb namespace and object access context",
            "how_to_implement": "You must install splunk AWS add on and Splunk App for AWS. This search works with cloudwatch logs.",
            "id": "042a3d32-8318-4763-9679-09db2644a8f2",
            "known_false_positives": "Kubectl calls are not malicious by nature. However source IP, verb and Object can reveal potential malicious activity, specially anonymous suspicious IPs and sensitive objects such as configmaps or secrets",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_aws_detect_suspicious_kubectl_calls_filter"
               }
            ],
            "name": "Kubernetes AWS detect suspicious kubectl calls",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` userAgent=kubectl* sourceIPs{}!=127.0.0.1 sourceIPs{}!=::1 src_user=system:anonymous  | table  src_ip src_user verb userAgent requestURI  | stats  count by src_ip src_user verb userAgent requestURI |`kubernetes_aws_detect_suspicious_kubectl_calls_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Object Access Activity"
               ],
               "asset_type": "AWS EKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-05-20",
            "description": "This search provides information on Kubernetes accounts accessing sensitve objects such as configmpas or secrets",
            "how_to_implement": "You must install the Add-on for Microsoft Cloud Services and Configure Kube-Audit data diagnostics",
            "id": "1bba382b-07fd-4ffa-b390-8002739b76e8",
            "known_false_positives": "Sensitive object access is not necessarily malicious but user and object context can provide guidance for detection.",
            "macros": [
               {
                  "definition": "sourcetype=mscs:storage:blob:json",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype) for Kubernetes data from Azure. Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "kubernetes_azure"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_azure_detect_sensitive_object_access_filter"
               }
            ],
            "name": "Kubernetes Azure detect sensitive object access",
            "references": [],
            "search": "`kubernetes_azure` category=kube-audit | spath input=properties.log| search objectRef.resource=secrets OR configmaps user.username=system.anonymous OR annotations.authorization.k8s.io/decision=allow  |table user.username user.groups{} objectRef.resource objectRef.namespace objectRef.name annotations.authorization.k8s.io/reason |dedup user.username user.groups{} |`kubernetes_azure_detect_sensitive_object_access_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Object Access Activity"
               ],
               "asset_type": "Azure AKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-05-20",
            "description": "This search provides information on Kubernetes service accounts with failure or forbidden access status",
            "how_to_implement": "You must install the Add-on for Microsoft Cloud Services and Configure Kube-Audit data diagnostics",
            "id": "019690d7-420f-4da0-b320-f27b09961514",
            "known_false_positives": "This search can give false positives as there might be inherent issues with authentications and permissions at cluster.",
            "macros": [
               {
                  "definition": "sourcetype=mscs:storage:blob:json",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype) for Kubernetes data from Azure. Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "kubernetes_azure"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_azure_detect_service_accounts_forbidden_failure_access_filter"
               }
            ],
            "name": "Kubernetes Azure detect service accounts forbidden failure access",
            "references": [],
            "search": "`kubernetes_azure` category=kube-audit | spath input=properties.log | search user.groups{}=system:serviceaccounts*  responseStatus.reason=Forbidden | table  sourceIPs{} user.username userAgent verb responseStatus.reason responseStatus.status properties.pod objectRef.namespace  |`kubernetes_azure_detect_service_accounts_forbidden_failure_access_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Object Access Activity"
               ],
               "asset_type": "Azure AKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-05-26",
            "description": "This search provides information on rare Kubectl calls with IP, verb namespace and object access context",
            "how_to_implement": "You must install the Add-on for Microsoft Cloud Services and Configure Kube-Audit data diagnostics",
            "id": "4b6d1ba8-0000-4cec-87e6-6cbbd71651b5",
            "known_false_positives": "Kubectl calls are not malicious by nature. However source IP, verb and Object can reveal potential malicious activity, specially suspicious IPs and sensitive objects such as configmaps or secrets",
            "macros": [
               {
                  "definition": "sourcetype=mscs:storage:blob:json",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype) for Kubernetes data from Azure. Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "kubernetes_azure"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_azure_detect_suspicious_kubectl_calls_filter"
               }
            ],
            "name": "Kubernetes Azure detect suspicious kubectl calls",
            "references": [],
            "search": "`kubernetes_azure` category=kube-audit | spath input=properties.log | spath input=responseObject.metadata.annotations.kubectl.kubernetes.io/last-applied-configuration | search userAgent=kubectl* sourceIPs{}!=127.0.0.1 sourceIPs{}!=::1 | table sourceIPs{} verb userAgent user.groups{} objectRef.resource objectRef.namespace requestURI | rare sourceIPs{} verb userAgent user.groups{} objectRef.resource objectRef.namespace requestURI|`kubernetes_azure_detect_suspicious_kubectl_calls_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Object Access Activity"
               ],
               "asset_type": "Azure AKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-11",
            "description": "This search provides information on Kubernetes accounts accessing sensitve objects such as configmaps or secrets",
            "how_to_implement": "You must install splunk add on for GCP . This search works with pubsub messaging service logs.",
            "id": "bdb6d596-86a0-4aba-8369-418ae8b9963a",
            "known_false_positives": "Sensitive object access is not necessarily malicious but user and object context can provide guidance for detection.",
            "macros": [
               {
                  "definition": "sourcetype=\"google:gcp:pubsub:message\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "google_gcp_pubsub_message"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_gcp_detect_sensitive_object_access_filter"
               }
            ],
            "name": "Kubernetes GCP detect sensitive object access",
            "references": [],
            "search": "`google_gcp_pubsub_message` data.protoPayload.authorizationInfo{}.resource=configmaps OR secrets  | table data.protoPayload.requestMetadata.callerIp src_user data.resource.labels.cluster_name data.protoPayload.request.metadata.namespace data.labels.authorization.k8s.io/decision | dedup data.protoPayload.requestMetadata.callerIp src_user data.resource.labels.cluster_name |`kubernetes_gcp_detect_sensitive_object_access_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Object Access Activity"
               ],
               "asset_type": "GCP GKE Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-06-23",
            "description": "This search provides information on Kubernetes service accounts with failure or forbidden access status, this search can be extended by using top or rare operators to find trends or rarities in failure status, user agents, source IPs and request URI",
            "how_to_implement": "You must install splunk add on for GCP. This search works with pubsub messaging service logs.",
            "id": "7094808d-432a-48e7-bb3c-77e96c894f3b",
            "known_false_positives": "This search can give false positives as there might be inherent issues with authentications and permissions at cluster.",
            "macros": [
               {
                  "definition": "sourcetype=\"google:gcp:pubsub:message\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "google_gcp_pubsub_message"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_gcp_detect_service_accounts_forbidden_failure_access_filter"
               }
            ],
            "name": "Kubernetes GCP detect service accounts forbidden failure access",
            "references": [],
            "search": "`google_gcp_pubsub_message` system:serviceaccounts data.protoPayload.response.status.allowed!=* | table src_ip src_user http_user_agent data.protoPayload.response.spec.resourceAttributes.namespace data.resource.labels.cluster_name data.protoPayload.response.spec.resourceAttributes.verb  data.protoPayload.request.status.allowed data.protoPayload.response.status.reason data.labels.authorization.k8s.io/decision | dedup src_ip src_user | `kubernetes_gcp_detect_service_accounts_forbidden_failure_access_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Object Access Activity"
               ],
               "asset_type": "GCP GKE Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-11",
            "description": "This search provides information on anonymous Kubectl calls with IP, verb namespace and object access context",
            "how_to_implement": "You must install splunk add on for GCP. This search works with pubsub messaging logs.",
            "id": "a5bed417-070a-41f2-a1e4-82b6aa281557",
            "known_false_positives": "Kubectl calls are not malicious by nature. However source IP, source user, user agent, object path, and authorization context can reveal potential malicious activity, specially anonymous suspicious IPs and sensitive objects such as configmaps or secrets",
            "macros": [
               {
                  "definition": "sourcetype=\"google:gcp:pubsub:message\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "google_gcp_pubsub_message"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_gcp_detect_suspicious_kubectl_calls_filter"
               }
            ],
            "name": "Kubernetes GCP detect suspicious kubectl calls",
            "references": [],
            "search": "`google_gcp_pubsub_message` data.protoPayload.requestMetadata.callerSuppliedUserAgent=kubectl* src_user=system:unsecured OR src_user=system:anonymous | table src_ip src_user data.protoPayload.requestMetadata.callerSuppliedUserAgent data.protoPayload.authorizationInfo{}.granted object_path |dedup src_ip src_user |`kubernetes_gcp_detect_suspicious_kubectl_calls_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Object Access Activity"
               ],
               "asset_type": "GCP GKE Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "2574e6d9-7254-4751-8925-0447deeec8ea",
      "name": "Kubernetes Sensitive Object Access Activity",
      "narrative": "Kubernetes is the most used container orchestration platform, this orchestration platform contains sensitive objects within its architecture, specifically configmaps and secrets, if accessed by an attacker can lead to further compromise. These searches allow operator to detect suspicious requests against Kubernetes sensitive objects.",
      "references": [
         "https://www.splunk.com/en_us/blog/security/approaching-kubernetes-security-detecting-kubernetes-scan-with-splunk.html"
      ],
      "tags": {
         "analytics_story": "Kubernetes Sensitive Object Access Activity",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rod Soto, Splunk",
      "date": "2020-05-20",
      "description": "This story addresses detection and response around Sensitive Role usage within a Kubernetes clusters against cluster resources and namespaces.",
      "detections": [
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-06-23",
            "description": "This search provides information on Kubernetes service accounts,accessing pods by IP address, verb and decision",
            "how_to_implement": "You must install splunk AWS add on and Splunk App for AWS. This search works with cloudwatch logs",
            "id": "5b30b25d-7d32-42d8-95ca-64dfcd9076e6",
            "known_false_positives": "Not all service accounts interactions are malicious. Analyst must consider IP, verb and decision context when trying to detect maliciousness.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_aws_detect_most_active_service_accounts_by_pod_filter"
               }
            ],
            "name": "Kubernetes AWS detect most active service accounts by pod",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` user.groups{}=system:serviceaccounts  objectRef.resource=pods | table  sourceIPs{} user.username userAgent verb annotations.authorization.k8s.io/decision  | top  sourceIPs{} user.username verb annotations.authorization.k8s.io/decision |`kubernetes_aws_detect_most_active_service_accounts_by_pod_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Role Activity"
               ],
               "asset_type": "AWS EKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-06-23",
            "description": "This search provides information on Kubernetes RBAC authorizations by accounts, this search can be modified by adding top to see both extremes of RBAC by accounts occurrences",
            "how_to_implement": "You must install splunk AWS add on and Splunk App for AWS. This search works with cloudwatch logs",
            "id": "de7264ed-3ed9-4fef-bb01-6eefc87cefe8",
            "known_false_positives": "Not all RBAC Authorications are malicious. RBAC authorizations can uncover malicious activity specially if sensitive Roles have been granted.",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_aws_detect_rbac_authorization_by_account_filter"
               }
            ],
            "name": "Kubernetes AWS detect RBAC authorization by account",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` annotations.authorization.k8s.io/reason=* | table sourceIPs{} user.username userAgent annotations.authorization.k8s.io/reason | stats count by user.username annotations.authorization.k8s.io/reason | rare user.username annotations.authorization.k8s.io/reason |`kubernetes_aws_detect_rbac_authorization_by_account_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Role Activity"
               ],
               "asset_type": "AWS EKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-06-23",
            "description": "This search provides information on Kubernetes accounts accessing sensitve objects such as configmpas or secrets",
            "how_to_implement": "You must install splunk AWS add on and Splunk App for AWS. This search works with cloudwatch logs.",
            "id": "b6013a7b-85e0-4a45-b051-10b252d69569",
            "known_false_positives": "Sensitive role resource access is necessary for cluster operation, however source IP, namespace and user group may indicate possible malicious use. ",
            "macros": [
               {
                  "definition": "sourcetype=\"aws:cloudwatchlogs:eks\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_cloudwatchlogs_eks"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_aws_detect_sensitive_role_access_filter"
               }
            ],
            "name": "Kubernetes AWS detect sensitive role access",
            "references": [],
            "search": "`aws_cloudwatchlogs_eks` objectRef.resource=clusterroles OR clusterrolebindings sourceIPs{}!=::1 sourceIPs{}!=127.0.0.1  | table sourceIPs{} user.username user.groups{} objectRef.namespace requestURI annotations.authorization.k8s.io/reason | dedup user.username user.groups{} |`kubernetes_aws_detect_sensitive_role_access_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Role Activity"
               ],
               "asset_type": "AWS EKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-05-26",
            "description": "This search provides information on Kubernetes service accounts,accessing pods and namespaces by IP address and verb",
            "how_to_implement": "You must install the Add-on for Microsoft Cloud Services and Configure Kube-Audit data diagnostics",
            "id": "55a2264a-b7f0-45e5-addd-1e5ab3415c72",
            "known_false_positives": "Not all service accounts interactions are malicious. Analyst must consider IP and verb context when trying to detect maliciousness.",
            "macros": [
               {
                  "definition": "sourcetype=mscs:storage:blob:json",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype) for Kubernetes data from Azure. Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "kubernetes_azure"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_azure_detect_most_active_service_accounts_by_pod_namespace_filter"
               }
            ],
            "name": "Kubernetes Azure detect most active service accounts by pod namespace",
            "references": [],
            "search": "`kubernetes_azure` category=kube-audit | spath input=properties.log | search user.groups{}=system:serviceaccounts* OR user.username=system.anonymous OR annotations.authorization.k8s.io/decision=allow  | table  sourceIPs{} user.username userAgent verb responseStatus.reason responseStatus.status properties.pod objectRef.namespace | top sourceIPs{} user.username verb responseStatus.status properties.pod objectRef.namespace |`kubernetes_azure_detect_most_active_service_accounts_by_pod_namespace_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Role Activity"
               ],
               "asset_type": "Azure AKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-05-26",
            "description": "This search provides information on Kubernetes RBAC authorizations by accounts, this search can be modified by adding rare or top to see both extremes of RBAC by accounts occurrences",
            "how_to_implement": "You must install the Add-on for Microsoft Cloud Services and Configure Kube-Audit data diagnostics",
            "id": "47af7d20-0607-4079-97d7-7a29af58b54e",
            "known_false_positives": "Not all RBAC Authorications are malicious. RBAC authorizations can uncover malicious activity specially if sensitive Roles have been granted.",
            "macros": [
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_azure_detect_rbac_authorization_by_account_filter"
               }
            ],
            "name": "Kubernetes Azure detect RBAC authorization by account",
            "references": [],
            "search": "sourcetype:mscs:storage:blob:json category=kube-audit | spath input=properties.log | search annotations.authorization.k8s.io/reason=* | table sourceIPs{} user.username userAgent annotations.authorization.k8s.io/reason |stats count by user.username annotations.authorization.k8s.io/reason | rare user.username annotations.authorization.k8s.io/reason |`kubernetes_azure_detect_rbac_authorization_by_account_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Role Activity"
               ],
               "asset_type": "Azure AKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-05-20",
            "description": "This search provides information on Kubernetes accounts accessing sensitve objects such as configmpas or secrets",
            "how_to_implement": "You must install the Add-on for Microsoft Cloud Services and Configure Kube-Audit data diagnostics",
            "id": "f27349e5-1641-4f6a-9e68-30402be0ad4c",
            "known_false_positives": "Sensitive role resource access is necessary for cluster operation, however source IP, namespace and user group may indicate possible malicious use. ",
            "macros": [
               {
                  "definition": "sourcetype=mscs:storage:blob:json",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype) for Kubernetes data from Azure. Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "kubernetes_azure"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_azure_detect_sensitive_role_access_filter"
               }
            ],
            "name": "Kubernetes Azure detect sensitive role access",
            "references": [],
            "search": "`kubernetes_azure` category=kube-audit | spath input=properties.log| search objectRef.resource=clusterroles OR clusterrolebindings | table sourceIPs{} user.username user.groups{} objectRef.namespace requestURI annotations.authorization.k8s.io/reason | dedup user.username user.groups{} |`kubernetes_azure_detect_sensitive_role_access_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Role Activity"
               ],
               "asset_type": "Azure AKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-11",
            "description": "This search provides information on Kubernetes RBAC authorizations by accounts, this search can be modified by adding top to see both extremes of RBAC by accounts occurrences",
            "how_to_implement": "You must install splunk AWS add on for GCP. This search works with pubsub messaging service logs",
            "id": "99487de3-7192-4b41-939d-fbe9acfb1340",
            "known_false_positives": "Not all RBAC Authorications are malicious. RBAC authorizations can uncover malicious activity specially if sensitive Roles have been granted.",
            "macros": [
               {
                  "definition": "sourcetype=\"google:gcp:pubsub:message\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "google_gcp_pubsub_message"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_gcp_detect_rbac_authorizations_by_account_filter"
               }
            ],
            "name": "Kubernetes GCP detect RBAC authorizations by account",
            "references": [],
            "search": "`google_gcp_pubsub_message` data.labels.authorization.k8s.io/reason=ClusterRoleBinding OR Clusterrole  | table src_ip src_user data.labels.authorization.k8s.io/decision data.labels.authorization.k8s.io/reason | rare src_user data.labels.authorization.k8s.io/reason |`kubernetes_gcp_detect_rbac_authorizations_by_account_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Role Activity"
               ],
               "asset_type": "GCP GKE Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-10",
            "description": "This search provides information on Kubernetes service accounts,accessing pods by IP address, verb and decision",
            "how_to_implement": "You must install splunk GCP add on. This search works with pubsub messaging service logs",
            "id": "7f5c2779-88a0-4824-9caa-0f606c8f260f",
            "known_false_positives": "Not all service accounts interactions are malicious. Analyst must consider IP, verb and decision context when trying to detect maliciousness.",
            "macros": [
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_gcp_detect_most_active_service_accounts_by_pod_filter"
               }
            ],
            "name": "Kubernetes GCP detect most active service accounts by pod",
            "references": [],
            "search": "`google_gcp_pubsub_message  data.protoPayload.request.spec.group{}=system:serviceaccounts | table src_ip src_user http_user_agent data.protoPayload.request.spec.nonResourceAttributes.verb data.labels.authorization.k8s.io/decision data.protoPayload.response.spec.resourceAttributes.resource | top src_ip src_user http_user_agent data.labels.authorization.k8s.io/decision data.protoPayload.response.spec.resourceAttributes.resource |`kubernetes_gcp_detect_most_active_service_accounts_by_pod_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Role Activity"
               ],
               "asset_type": "GCP GKE Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rod Soto, Splunk",
            "date": "2020-07-11",
            "description": "This search provides information on Kubernetes accounts accessing sensitve objects such as configmpas or secrets",
            "how_to_implement": "You must install splunk add on for GCP. This search works with pubsub messaging servicelogs.",
            "id": "a46923f6-36b9-4806-a681-31f314907c30",
            "known_false_positives": "Sensitive role resource access is necessary for cluster operation, however source IP, user agent, decision and reason may indicate possible malicious use. ",
            "macros": [
               {
                  "definition": "sourcetype=\"google:gcp:pubsub:message\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "google_gcp_pubsub_message"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kubernetes_gcp_detect_sensitive_role_access_filter"
               }
            ],
            "name": "Kubernetes GCP detect sensitive role access",
            "references": [],
            "search": "`google_gcp_pubsub_message` data.labels.authorization.k8s.io/reason=ClusterRoleBinding OR Clusterrole dest=apis/rbac.authorization.k8s.io/v1 src_ip!=::1  | table src_ip src_user http_user_agent data.labels.authorization.k8s.io/decision data.labels.authorization.k8s.io/reason | dedup src_ip src_user |`kubernetes_gcp_detect_sensitive_role_access_filter`",
            "tags": {
               "analytics_story": [
                  "Kubernetes Sensitive Role Activity"
               ],
               "asset_type": "GCP GKE EKS Kubernetes cluster",
               "kill_chain_phases": [
                  "Lateral Movement"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "2574e6d9-7254-4751-8925-0447deeec8ew",
      "name": "Kubernetes Sensitive Role Activity",
      "narrative": "Kubernetes is the most used container orchestration platform, this orchestration platform contains sensitive roles within its architecture, specifically configmaps and secrets, if accessed by an attacker can lead to further compromise. These searches allow operator to detect suspicious requests against Kubernetes role activities",
      "references": [
         "https://www.splunk.com/en_us/blog/security/approaching-kubernetes-security-detecting-kubernetes-scan-with-splunk.html"
      ],
      "tags": {
         "analytics_story": "Kubernetes Sensitive Role Activity",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2020-02-04",
      "description": "Detect and investigate tactics, techniques, and procedures around how attackers move laterally within the enterprise. Because lateral movement can expose the adversary to detection, it should be an important focus for security analysts.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for specific authentication events from the Windows Security Event logs to detect potential attempts at using the Pass-the-Hash technique.",
            "how_to_implement": "To successfully implement this search, you must ingest your Windows Security Event logs and leverage the latest TA for Windows.",
            "id": "f5939373-8054-40ad-8c64-cec478a22a4b",
            "known_false_positives": "Legitimate logon activity by authorized NTLM systems may be detected by this search. Please investigate as appropriate.",
            "macros": [
               {
                  "definition": "eventtype=wineventlog_security",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wineventlog_security"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_activity_related_to_pass_the_hash_attacks_filter"
               }
            ],
            "name": "Detect Activity Related to Pass the Hash Attacks",
            "references": [],
            "search": "`wineventlog_security` EventCode=4624 (Logon_Type=3 LogonProcessName=NtLmSsp WorkstationName=WORKSTATION NOT AccountName=\"ANONYMOUS LOGON\") OR (EventCode=4624 Logon_Type=9 LogonProcessName=seclogo) | stats count min(_time) as firstTime max(_time) as lastTime by EventCode, Logon_Type, WorkstationName, user, dest | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `detect_activity_related_to_pass_the_hash_attacks_filter` ",
            "tags": {
               "analytics_story": [
                  "Lateral Movement"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Soft Cell",
                  "APT32",
                  "Night Dragon",
                  "APT28",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1550.002"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Pass the Hash"
               ],
               "nist": [
                  "PR.PT",
                  "PR.AT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Jose Hernandez, Splunk",
            "date": "2020-07-21",
            "description": "This search detects a potential kerberoasting attack via service principal name requests",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, and include the windows security event logs that contain kerberos",
            "id": "5cc67381-44fa-4111-8a37-7a230943f027",
            "known_false_positives": "Older systems that support kerberos RC4 by default NetApp may generate false positives",
            "macros": [
               {
                  "definition": "eventtype=wineventlog_security",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wineventlog_security"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "kerberoasting_spn_request_with_rc4_encryption_filter"
               }
            ],
            "name": "Kerberoasting spn request with RC4 encryption",
            "references": [
               "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1208/T1208.md",
               "https://www.trimarcsecurity.com/post/trimarcresearch-detecting-kerberoasting-activity"
            ],
            "search": "`wineventlog_security` EventID=4769 TicketOptions=0x40810000 TicketEncryptionType=0x17 | stats count min(_time) as firstTime max(_time) as lastTime values(ServiceName) values(TargetUserName) values(user)  by TargetDomainName | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `kerberoasting_spn_request_with_rc4_encryption_filter`",
            "tags": {
               "analytics_story": [
                  "Lateral Movement"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1558.003"
               ],
               "mitre_attack_tactics": [
                  "Credential Access"
               ],
               "mitre_attack_technique": [
                  "Kerberoasting"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-07",
            "description": "This search looks for network traffic on TCP/3389, the default port used by remote desktop. While remote desktop traffic is not uncommon on a network, it is usually associated with known hosts. This search allows for whitelisting both source and destination hosts to remove them from the output of the search so you can focus on the uncommon uses of remote desktop on your network.",
            "how_to_implement": "To successfully implement this search you need to identify systems that commonly originate remote desktop traffic and that commonly receive remote desktop traffic. You can use the included support search \"Identify Systems Creating Remote Desktop Traffic\" to identify systems that originate the traffic and the search \"Identify Systems Receiving Remote Desktop Traffic\" to identify systems that receive a lot of remote desktop traffic. After identifying these systems, you will need to add the \"common_rdp_source\" or \"common_rdp_destination\" category to that system depending on the usage, using the Enterprise Security Assets and Identities framework.  This can be done by adding an entry in the assets.csv file located in SA-IdentityManagement/lookups.",
            "id": "272b8407-842d-4b3d-bead-a704584003d3",
            "known_false_positives": "Remote Desktop may be used legitimately by users on the network.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_desktop_network_traffic_filter"
               }
            ],
            "name": "Remote Desktop Network Traffic",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.dest_port=3389 AND All_Traffic.dest_category!=common_rdp_destination AND All_Traffic.src_category!=common_rdp_source by All_Traffic.src All_Traffic.dest All_Traffic.dest_port | `drop_dm_object_name(\"All_Traffic\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `remote_desktop_network_traffic_filter` ",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "Hidden Cobra Malware",
                  "Lateral Movement"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 9",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "TEMP.Veles",
                  "Leviathan",
                  "APT39",
                  "Stolen Pencil",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "FIN8",
                  "APT3",
                  "OilRig",
                  "menuPass",
                  "FIN10",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "APT1",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1021.001"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Remote Desktop Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for the remote desktop process mstsc.exe running on systems upon which it doesn't typically run. This is accomplished by filtering out all systems that are noted in the `common_rdp_source category` in the Assets and Identity framework.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model in the processes node. The search requires you to identify systems that do not commonly use remote desktop. You can use the included support search \"Identify Systems Using Remote Desktop\" to identify these systems. After identifying them, you will need to add the \"common_rdp_source\" category to that system using the Enterprise Security Assets and Identities framework. This can be done by adding an entry in the assets.csv file located in `SA-IdentityManagement/lookups`.",
            "id": "f5939373-8054-40ad-8c64-cec478a22a4a",
            "known_false_positives": "Remote Desktop may be used legitimately by users on the network.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_desktop_process_running_on_system_filter"
               }
            ],
            "name": "Remote Desktop Process Running On System",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process=*mstsc.exe AND Processes.dest_category!=common_rdp_source by Processes.dest Processes.user Processes.process | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `remote_desktop_process_running_on_system_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "Lateral Movement"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 9",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "TEMP.Veles",
                  "Leviathan",
                  "APT39",
                  "Stolen Pencil",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "FIN8",
                  "APT3",
                  "OilRig",
                  "menuPass",
                  "FIN10",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "APT1",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1021.001"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Remote Desktop Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for flags passed to schtasks.exe on the command-line that indicate a job is being scheduled on a remote system.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "1297fb80-f42a-4b4a-9c8a-88c066237cf6",
            "known_false_positives": "Administrators may create jobs on remote systems, but this activity is usually limited to a small set of hosts or users. It is important to validate and investigate as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "schtasks_scheduling_job_on_remote_system_filter"
               }
            ],
            "name": "Schtasks scheduling job on remote system",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = schtasks.exe Processes.process=\"*/create*\" Processes.process=\"* /s *\" by Processes.process_name Processes.process Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `schtasks_scheduling_job_on_remote_system_filter`",
            "tags": {
               "analytics_story": [
                  "Lateral Movement"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "MuddyWater",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT-C-36",
                  "BRONZE BUTLER",
                  "APT41",
                  "Machete",
                  "Soft Cell",
                  "Silence",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Dragonfly 2.0",
                  "Patchwork",
                  "OilRig",
                  "Rancor",
                  "Cobalt Group",
                  "FIN8",
                  "menuPass",
                  "FIN10",
                  "APT32",
                  "FIN7",
                  "Stealth Falcon",
                  "FIN6",
                  "APT3",
                  "APT29"
               ],
               "mitre_attack_id": [
                  "T1053.005"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Scheduled Task"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "399d65dc-1f08-499b-a259-aad9051f38ad",
      "name": "Lateral Movement",
      "narrative": "Once attackers gain a foothold within an enterprise, they will seek to expand their accesses and leverage techniques that facilitate lateral movement. Attackers will often spend quite a bit of time and effort moving laterally. Because lateral movement renders an attacker the most vulnerable to detection, it's an excellent focus for detection and investigation.\\\nIndications of lateral movement can include the abuse of system utilities (such as `psexec.exe`), unauthorized use of remote desktop services, `file/admin$` shares, WMI, PowerShell, pass-the-hash, or the abuse of scheduled tasks. Organizations must be extra vigilant in detecting lateral movement techniques and look for suspicious activity in and around high-value strategic network assets, such as Active Directory, which are often considered the primary target or \"crown jewels\" to a persistent threat actor.\\\nAn adversary can use lateral movement for multiple purposes, including remote execution of tools, pivoting to additional systems, obtaining access to specific information or files, access to additional credentials, exfiltrating data, or delivering a secondary effect. Adversaries may use legitimate credentials alongside inherent network and operating-system functionality to remotely connect to other systems and remain under the radar of network defenders.\\\nIf there is evidence of lateral movement, it is imperative for analysts to collect evidence of the associated offending hosts. For example, an attacker might leverage host A to gain access to host B. From there, the attacker may try to move laterally to host C. In this example, the analyst should gather as much information as possible from all three hosts. \\\n It is also important to collect authentication logs for each host, to ensure that the offending accounts are well-documented. Analysts should account for all processes to ensure that the attackers did not install unauthorized software.",
      "references": [
         "https://www.fireeye.com/blog/executive-perspective/2015/08/malware_lateral_move.html"
      ],
      "tags": {
         "analytics_story": "Lateral Movement",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "TEMP.Veles",
            "Cobalt Group",
            "APT1",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "APT-C-36",
            "BRONZE BUTLER",
            "OilRig",
            "APT32",
            "Machete",
            "FIN10",
            "FIN7",
            "no",
            "Axiom",
            "Night Dragon",
            "MuddyWater",
            "Rancor",
            "Lazarus Group",
            "APT3",
            "Frankenstein",
            "Dragonfly 2.0",
            "Silence",
            "Stolen Pencil",
            "APT39",
            "APT33",
            "Blue Mockingbird",
            "FIN6",
            "APT28",
            "Soft Cell",
            "Patchwork",
            "menuPass",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1558.003",
            "T1021.001",
            "T1550.002",
            "T1053.005"
         ],
         "mitre_attack_tactics": [
            "Defense Evasion",
            "Lateral Movement",
            "Credential Access",
            "Execution",
            "Persistence",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Scheduled Task",
            "Remote Desktop Protocol",
            "Pass the Hash",
            "Kerberoasting"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2017-08-23",
      "description": "Attackers are finding stealthy ways \"live off the land,\" leveraging utilities and tools that come standard on the endpoint--such as PowerShell--to achieve their goals without downloading binary files. These searches can help you detect and investigate PowerShell command-line options that may be indicative of malicious intent.",
      "detections": [
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2020-07-21",
            "description": "Monitor for changes of the ExecutionPolicy in the registry to the values \"unrestricted\" or \"bypass,\" which allows the execution of malicious scripts.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Registry node. You must also be ingesting logs with the fields registry_path, registry_key_name, and registry_value_name from your endpoints.",
            "id": "c2590137-0b08-4985-9ec5-6ae23d92f63d",
            "known_false_positives": "Administrators may attempt to change the default execution policy on a system for a variety of reasons. However, setting the policy to \"unrestricted\" or \"bypass\" as this search is designed to identify, would be unusual. Hits should be reviewed and investigated as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "attempt_to_set_default_powershell_execution_policy_to_unrestricted_or_bypass_filter"
               }
            ],
            "name": "Attempt To Set Default PowerShell Execution Policy To Unrestricted or Bypass",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_path=*Software\\\\Microsoft\\\\Powershell\\\\1\\\\ShellIds\\\\Microsoft.PowerShell* Registry.registry_key_name=ExecutionPolicy (Registry.registry_value_name=Unrestricted OR Registry.registry_value_name=Bypass) by Registry.registry_path Registry.registry_key_name Registry.registry_value_name Registry.dest | `drop_dm_object_name(Registry)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `attempt_to_set_default_powershell_execution_policy_to_unrestricted_or_bypass_filter` ",
            "tags": {
               "analytics_story": [
                  "Malicious PowerShell",
                  "Credential Dumping"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1059.001"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for PowerShell processes started with parameters to modify the execution policy of the run, run in a hidden window, and connect to the Internet. This combination of command-line options is suspicious because it's overriding the default PowerShell execution policy, attempts to hide its activity from the user, and connects to the Internet.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "ee18ed37-0802-4268-9435-b3b91aaa18db",
            "known_false_positives": "Legitimate process can have this combination of command-line options, but it's not common.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "malicious_powershell_process___connect_to_internet_with_hidden_window_filter"
               }
            ],
            "name": "Malicious PowerShell Process - Connect To Internet With Hidden Window",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=powershell.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | search process=\"*-Exec*\" process=\"*-WindowStyle*\" process=\"*hidden*\" process=\"*New-Object*\" process=\"*System.Net.WebClient*\" | `malicious_powershell_process___connect_to_internet_with_hidden_window_filter`",
            "tags": {
               "analytics_story": [
                  "Malicious PowerShell",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 7",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1059.001"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for PowerShell processes that have encoded the script within the command-line. Malware has been seen using this parameter, as it obfuscates the code and makes it relatively easy to pass a script on the command-line.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c4db14d9-7909-48b4-a054-aa14d89dbb19",
            "known_false_positives": "System administrators may use this option, but it's not common.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "malicious_powershell_process___encoded_command_filter"
               }
            ],
            "name": "Malicious PowerShell Process - Encoded Command",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = powershell.exe (Processes.process=*-EncodedCommand* OR Processes.process=*-enc*) by Processes.user Processes.process_name Processes.process Processes.parent_process_name Processes.dest Processes.process_id | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `malicious_powershell_process___encoded_command_filter`",
            "tags": {
               "analytics_story": [
                  "Malicious PowerShell"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 7",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Rocke",
                  "Sandworm Team",
                  "Blue Mockingbird",
                  "Whitefly",
                  "Molerats",
                  "Wizard Spider",
                  "Mofang",
                  "Frankenstein",
                  "Inception",
                  "APT-C-36",
                  "APT41",
                  "Machete",
                  "Soft Cell",
                  "Turla",
                  "TA505",
                  "Silence",
                  "APT33",
                  "Night Dragon",
                  "Darkhotel",
                  "Gallmaker",
                  "APT29",
                  "APT18",
                  "Tropic Trooper",
                  "Cobalt Group",
                  "Patchwork",
                  "Leafminer",
                  "APT37",
                  "Threat Group-3390",
                  "Honeybee",
                  "Dark Caracal",
                  "menuPass",
                  "APT19",
                  "BlackOasis",
                  "FIN8",
                  "Leviathan",
                  "Elderwood",
                  "MuddyWater",
                  "FIN7",
                  "Magic Hound",
                  "OilRig",
                  "APT3",
                  "APT32",
                  "Group5",
                  "Dust Storm",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT28"
               ],
               "mitre_attack_id": [
                  "T1027"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Obfuscated Files or Information"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for PowerShell processes started with a base64 encoded command-line passed to it, with parameters to modify the execution policy for the process, and those that prevent the display of an interactive prompt to the user. This combination of command-line options is suspicious because it overrides the default PowerShell execution policy, attempts to hide itself from the user, and passes an encoded script to be run on the command-line.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "2cdb91d2-542c-497f-b252-be495e71f38c",
            "known_false_positives": "Legitimate process can have this combination of command-line options, but it's not common.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "malicious_powershell_process___multiple_suspicious_command_line_arguments_filter"
               }
            ],
            "name": "Malicious PowerShell Process - Multiple Suspicious Command-Line Arguments",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=powershell.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| search (process=*-EncodedCommand* OR process=*-enc*) process=*-Exec* AND process=*-NonI* | `malicious_powershell_process___multiple_suspicious_command_line_arguments_filter`",
            "tags": {
               "analytics_story": [
                  "Malicious PowerShell"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 7",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1059.001"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for PowerShell processes launched with arguments that have characters indicative of obfuscation on the command-line.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "cde75cf6-3c7a-4dd6-af01-27cdb4511fd4",
            "known_false_positives": "These characters might be legitimately on the command-line, but it is not common.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "malicious_powershell_process_with_obfuscation_techniques_filter"
               }
            ],
            "name": "Malicious PowerShell Process With Obfuscation Techniques",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=powershell.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest Processes.process | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| eval num_obfuscation = (mvcount(split(process, \"`\"))-1) + (mvcount(split(process, \"^\"))-1) | `malicious_powershell_process_with_obfuscation_techniques_filter` | search num_obfuscation > 0",
            "tags": {
               "analytics_story": [
                  "Malicious PowerShell"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 7",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1059.001"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "2c8ff66e-0b57-42af-8ad7-912438a403fc",
      "name": "Malicious PowerShell",
      "narrative": "The searches in this Analytic Story monitor for parameters often used for malicious purposes. It is helpful to understand how often the notable events generated by this story occur, as well as the commonalities between some of these events. These factors may provide clues about whether this is a common occurrence of minimal concern or a rare event that may require more extensive investigation. Likewise, it is important to determine whether the issue is restricted to a single user/system or is broader in scope.\\\nThe following factors may assist you in determining whether the event is malicious: \\\n1. Country of origin\\\n1. Responsible party\\\n1. Fully qualified domain names associated with the external IP address\\\n1. Registration of fully qualified domain names associated with external IP addressDetermining whether it is a dynamic domain frequently visited by others and/or how third parties categorize it can also help you answer some questions surrounding the attacker and details related to the external system. In addition, there are various sources--such as VirusTotal&#151; that can provide some reputation information on the IP address or domain name, which can assist in determining whether the event is malicious. Finally, determining whether there are other events associated with the IP address may help connect data points or show other events that should be brought into scope.\\\nGathering data on the system of interest can sometimes help you quickly determine whether something suspicious is happening. Some of these items include finding out who else may have recently logged into the system, whether any unusual scheduled tasks exist, whether the system is communicating on suspicious ports, whether there are modifications to sensitive registry keys, and whether there are any known vulnerabilities on the system. This information can often highlight other activity commonly seen in attack scenarios or give more information about how the system may have been targeted.\\\nOften, a simple inspection of the process name and path can tell you if the system has been compromised. For example, if `svchost.exe` is found running from a location other than `C:\\Windows\\System32`, it is likely something malicious designed to hide in plain sight when cursorily reviewing process names. Similarly, if the process itself seems legitimate, but the parent process is running from the temporary browser cache, that could be indicative of activity initiated via a compromised website a user visited.\\\nIt can also be very helpful to examine various behaviors of the process of interest or the parent of the process of interest. For example, if it turns out the process of interest is malicious, it would be good to see if the parent to that process spawned other processes that might be worth further scrutiny. If a process is suspect, a review of the network connections made in and around the time of the event and/or whether the process spawned any child processes could be helpful, as well.\\\nIn the event a system is suspected of having been compromised via a malicious website, we suggest reviewing the browsing activity from that system around the time of the event. If categories are given for the URLs visited, that can help you zero in on possible malicious sites.",
      "references": [
         "https://blogs.mcafee.com/mcafee-labs/malware-employs-powershell-to-infect-systems/",
         "https://www.crowdstrike.com/blog/bears-midst-intrusion-democratic-national-committee/"
      ],
      "tags": {
         "analytics_story": "Malicious PowerShell",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "TEMP.Veles",
            "Cobalt Group",
            "APT29",
            "Whitefly",
            "Dust Storm",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Group5",
            "Inception",
            "APT-C-36",
            "Kimsuky",
            "Putter Panda",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Thrip",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "Elderwood",
            "APT32",
            "Machete",
            "FIN10",
            "Dark Caracal",
            "FIN7",
            "APT19",
            "APT37",
            "BlackOasis",
            "TA459",
            "Leafminer",
            "Magic Hound",
            "Night Dragon",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Mofang",
            "Lazarus Group",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "Gallmaker",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "APT33",
            "Blue Mockingbird",
            "FIN6",
            "APT28",
            "Deep Panda",
            "Soft Cell",
            "Rocke",
            "APT18",
            "DarkVishnya",
            "DarkHydrus",
            "Patchwork",
            "Poseidon Group",
            "Tropic Trooper",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1059.001",
            "T1027"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Defense Evasion"
         ],
         "mitre_attack_technique": [
            "Obfuscated Files or Information",
            "PowerShell"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 4
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2017-09-12",
      "description": "Address common concerns when monitoring your backup processes. These searches can help you reduce risks from ransomware, device theft, or denial of physical access to a host by backing up data on endpoints.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2017-09-12",
            "description": "This search returns a list of hosts that have not successfully completed a backup in over a week.",
            "how_to_implement": "To successfully implement this search you need to first obtain data from your backup solution, either from the backup logs on your hosts, or from a central server responsible for performing the backups. If you do not use Netbackup, you can modify this search for your backup solution. Depending on how often you backup your systems, you may want to modify how far in the past to look for a successful backup, other than the default of seven days.",
            "id": "a34aae96-ccf8-4aef-952c-3ea214444440",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=\"netbackup_logs\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "netbackup"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "extended_period_without_successful_netbackup_backups_filter"
               }
            ],
            "name": "Extended Period Without Successful Netbackup Backups",
            "references": [],
            "search": "`netbackup` MESSAGE=\"Disk/Partition backup completed successfully.\" | stats latest(_time) as latestTime by COMPUTERNAME | `security_content_ctime(latestTime)` | rename COMPUTERNAME as dest | eval isOutlier=if(latestTime <= relative_time(now(), \"-7d@d\"), 1, 0) | search isOutlier=1 | table latestTime, dest | `extended_period_without_successful_netbackup_backups_filter`",
            "tags": {
               "analytics_story": [
                  "Monitor Backup Solution"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 10"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2017-09-12",
                  "description": "This search is intended to give you a feel for how often successful backups are conducted in your environment. Fluctuations in these numbers will allow you to determine when you should investigate.",
                  "how_to_implement": "To successfully implement this search you must be ingesting your backup logs.",
                  "id": "b4d0dfb2-2195-4f6e-93a3-48468ed9734e",
                  "name": "Monitor Successful Backups",
                  "search": "`netbackup` \"Disk/Partition backup completed successfully.\" | bucket _time span=1d | stats dc(COMPUTERNAME) as count values(COMPUTERNAME) as dest by _time, MESSAGE",
                  "tags": {
                     "analytics_story": [
                        "Monitor Backup Solution"
                     ],
                     "detections": [
                        "Unsuccessful Netbackup backups"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2017-09-12",
                  "description": "This search is intended to give you a feel for how often backup failures happen in your environments.  Fluctuations in these numbers will allow you to determine when you should investigate.",
                  "how_to_implement": "To successfully implement this search you must be ingesting your backup logs.",
                  "id": "b2178fed-592f-492b-b851-74161678aa56",
                  "name": "Monitor Unsuccessful Backups",
                  "search": "`netbackup` \"An error occurred, failed to backup.\" | bucket _time span=1d | stats dc(COMPUTERNAME) as count values(COMPUTERNAME) as dest by _time, MESSAGE",
                  "tags": {
                     "analytics_story": [
                        "Monitor Backup Solution"
                     ],
                     "detections": [
                        "Unsuccessful Netbackup backups"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2017-09-12",
            "description": "This search gives you the hosts where a backup was attempted and then failed.",
            "how_to_implement": "To successfully implement this search you need to obtain data from your backup solution, either from the backup logs on your endpoints or from a central server responsible for performing the backups. If you do not use Netbackup, you can modify this search for your specific backup solution.",
            "id": "a34aae96-ccf8-4aaa-952c-3ea21444444f",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=\"netbackup_logs\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "netbackup"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unsuccessful_netbackup_backups_filter"
               }
            ],
            "name": "Unsuccessful Netbackup backups",
            "references": [],
            "search": "`netbackup` | stats latest(_time) as latestTime by COMPUTERNAME, MESSAGE | search MESSAGE=\"An error occurred, failed to backup.\" | `security_content_ctime(latestTime)` | rename COMPUTERNAME as dest, MESSAGE as signature | table latestTime, dest, signature | `unsuccessful_netbackup_backups_filter`",
            "tags": {
               "analytics_story": [
                  "Monitor Backup Solution"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 10"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "abe807c7-1eb6-4304-ac32-6e7aacdb891d",
      "name": "Monitor Backup Solution",
      "narrative": "Having backups is a standard best practice that helps ensure continuity of business operations.  Having mature backup processes can also help you reduce the risks of many security-related incidents and streamline your response processes. The detection searches in this Analytic Story will help you identify systems that have backup failures, as well as systems that have not been backed up for an extended period of time. The story will also return the notable event history and all of the backup logs for an endpoint.",
      "references": [
         "https://www.carbonblack.com/2016/03/04/tracking-locky-ransomware-using-carbon-black/"
      ],
      "tags": {
         "analytics_story": "Monitor Backup Solution",
         "category": [
            "Best Practices"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Compliance"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2017-09-15",
      "description": "Identify and investigate prohibited/unauthorized software or processes that may be concealing malicious behavior within your environment. ",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2017-09-15",
                  "description": "This search takes the existing interesting process table from ES, filters out any existing additions added by ESCU and then updates the table with processes identified by ESCU that should be prohibited on your endpoints.",
                  "how_to_implement": "This search should be run on each new install of ESCU.",
                  "id": "251930a5-1451-4428-bb13-eed5775be0ce",
                  "name": "Add Prohibited Processes to Enterprise Security",
                  "search": "| inputlookup interesting_processes_lookup | search note!=ESCU* | inputlookup append=T prohibitedProcesses_lookup | fillnull value=* dest dest_pci_domain | fillnull value=false is_required is_secure | fillnull value=true is_prohibited | outputlookup interesting_processes_lookup | stats count",
                  "tags": {
                     "analytics_story": [
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Monitor for Unauthorized Software",
                        "SamSam Ransomware"
                     ],
                     "detections": [
                        "Prohibited Software On Endpoint"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2019-10-11",
            "description": "This search looks for applications on the endpoint that you have marked as prohibited.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model in the processes node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is usually generated via logs that report process tracking in your Windows audit settings. In addition, you must also have only the `process_name` (not the entire process path) marked as \"prohibited\" in the Enterprise Security `interesting processes` table. To include the process names marked as \"prohibited\", which is included with ES Content Updates, run the included search <code>Add Prohibited Processes to Enterprise Security</code>.",
            "id": "a51bfe1a-94f0-48cc-b4e4-b6ae50145893",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "definition": "lookup interesting_processes_lookup app as process_name OUTPUT is_prohibited | search is_prohibited=True",
                  "description": "This macro limits the output to process_names that have been marked as prohibited",
                  "name": "prohibited_softwares"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "prohibited_software_on_endpoint_filter"
               }
            ],
            "name": "Prohibited Software On Endpoint",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.dest Processes.user Processes.process_name | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `prohibited_softwares` | `prohibited_software_on_endpoint_filter`",
            "tags": {
               "analytics_story": [
                  "Monitor for Unauthorized Software",
                  "Emotet Malware  DHS Report TA18-201A ",
                  "SamSam Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "8892a655-6205-43f7-abba-06460e38c8ae",
      "name": "Monitor for Unauthorized Software",
      "narrative": "It is critical to identify unauthorized software and processes running on enterprise endpoints and determine whether they are likely to be malicious. This Analytic Story requires the user to populate the Interesting Processes table within Enterprise Security with prohibited processes. An included support search will augment this data, adding information on processes thought to be malicious. This search requires data from endpoint detection-and-response solutions, endpoint data sources (such as Sysmon), or Windows Event Logs--assuming that the Active Directory administrator has enabled process tracking within the System Event Audit Logs.\\\nIt is important to investigate any software identified as suspicious, in order to understand how it was installed or executed. Analyzing authentication logs or any historic notable events might elicit additional investigative leads of interest. For best results, schedule the search to run every two weeks. ",
      "references": [
         "https://www.crowdstrike.com/blog/bears-midst-intrusion-democratic-national-committee/"
      ],
      "tags": {
         "analytics_story": "Monitor for Unauthorized Software",
         "category": [
            "Best Practices"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Compliance"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2017-09-15",
      "description": "Monitor your enterprise to ensure that your endpoints are being patched and updated. Adversaries notoriously exploit known vulnerabilities that could be mitigated by applying routine security patches.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-15",
            "description": "This search looks for Windows endpoints that have not generated an event indicating a successful Windows update in the last 60 days. Windows updates are typically released monthly and applied shortly thereafter. An endpoint that has not successfully applied an update in this time frame indicates the endpoint is not regularly being patched for some reason.",
            "how_to_implement": "To successfully implement this search, it requires that the 'Update' data model is being populated. This can be accomplished by ingesting Windows events or the Windows Update log via a universal forwarder on the Windows endpoints you wish to monitor. The Windows add-on should be also be installed and configured to properly parse Windows events in Splunk. There may be other data sources which can populate this data model, including vulnerability management systems.",
            "id": "1a77c08c-2f56-409c-a2d3-7d64617edd4f",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "no_windows_updates_in_a_time_frame_filter"
               }
            ],
            "name": "No Windows Updates in a time frame",
            "references": [],
            "search": "| tstats `security_content_summariesonly` max(_time) as lastTime from datamodel=Updates where Updates.status=Installed Updates.vendor_product=\"Microsoft Windows\" by Updates.dest Updates.status Updates.vendor_product | rename Updates.dest as Host | rename Updates.status as \"Update Status\" | rename Updates.vendor_product as Product | eval isOutlier=if(lastTime <= relative_time(now(), \"-60d@d\"), 1, 0)  | `security_content_ctime(lastTime)`  | search isOutlier=1 | rename lastTime as \"Last Update Time\", | table Host, \"Update Status\", Product, \"Last Update Time\" | `no_windows_updates_in_a_time_frame_filter`",
            "tags": {
               "analytics_story": [
                  "Monitor for Updates"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 18"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "PR.MA"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "9ef8d677-7b52-4213-a038-99cfc7acc2d8",
      "name": "Monitor for Updates",
      "narrative": "It is a common best practice to ensure that endpoints are being patched and updated in a timely manner, in order to reduce the risk of compromise via a publicly disclosed vulnerability. Timely application of updates/patches is important to eliminate known vulnerabilities that may be exploited by various threat actors.\\\nSearches in this analytic story are designed to help analysts monitor endpoints for system patches and/or updates. This helps analysts identify any systems that are not successfully updated in a timely matter.\\\nMicrosoft releases updates for Windows systems on a monthly cadence. They should be installed as soon as possible after following internal testing and validation procedures. Patches and updates for other systems or applications are typically released as needed.",
      "references": [
         "https://learn.cisecurity.org/20-controls-download"
      ],
      "tags": {
         "analytics_story": "Monitor for Updates",
         "category": [
            "Best Practices"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Compliance"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2017-01-05",
      "description": "Detect activities and various techniques associated with the abuse of `netsh.exe`, which can disable local firewall settings or set up a remote connection to a host from an infected system.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for processes launching netsh.exe to execute various commands via the netsh command-line utility. Netsh.exe is a command-line scripting utility that allows you to, either locally or remotely, display or modify the network configuration of a computer that is currently running. Netsh can be used as a persistence proxy technique to execute a helper .dll when netsh.exe is executed. In this search, we are looking for processes spawned by netsh.exe that are executing commands via the command line.",
            "how_to_implement": "To successfully implement this search, you must be ingesting logs with the process name, command-line arguments, and parent processes from your endpoints. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
            "id": "b89919ed-fe5f-492c-b139-95dbb162041e",
            "known_false_positives": "It is unusual for netsh.exe to have any child processes in most environments. It makes sense to investigate the child process and verify whether the process spawned is legitimate. We explicitely exclude \"C:\\Program Files\\rempl\\sedlauncher.exe\" process path since it is a legitimate process by Mircosoft.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "processes_created_by_netsh_filter"
               }
            ],
            "name": "Processes created by netsh",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.parent_process=\"*C:\\\\Windows\\\\System32\\\\netsh.exe*\" AND Processes.process_path!=\"C:\\\\Program Files\\\\rempl\\\\sedlauncher.exe\") by Processes.user Processes.dest Processes.parent_process Processes.parent_process_name Processes.process_name | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `processes_created_by_netsh_filter`",
            "tags": {
               "analytics_story": [
                  "Netsh Abuse"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda",
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.001",
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell",
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Josef Kuepker, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the number of SMB connections observed each hour for every day of week. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search to identify outliers in the number of SMB connections for that hour and day of the week.",
                  "how_to_implement": "You must be ingesting network traffic and populating the Network_Traffic data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. To improve your results, you may consider adding \"src\" to the by clause, which will build the model for each unique source in your enviornment. However, if you have a large number of hosts in your environment, this search may be very resource intensive. In this case, you may need to raise the value of max_inputs and/or max_groups in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "df98763b-0b08-4281-8ef9-08db7ac572a9",
                  "name": "Baseline of SMB Traffic - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=10m, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(\"All_Traffic\")` | fit DensityFunction count by \"HourOfDay,DayOfWeek\" into smb_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Ransomware"
                     ],
                     "detections": [
                        "Processes launching netsh",
                        "SMB Traffic Spike - MLTK"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2019-03-01",
                  "description": "This search looks for command-line arguments where `cmd.exe /c` is used to execute a program, then creates a baseline of the earliest and latest times we have encountered this command-line argument in our dataset within the last 30 days.",
                  "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd23",
                  "name": "Previously seen command line arguments",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe AND Processes.process=\"* /c *\" by Processes.process | `drop_dm_object_name(Processes)`",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Orangeworm Attack Group",
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Processes launching netsh",
                        "First time seen command line argument"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2020-07-10",
            "description": "This search looks for processes launching netsh.exe. Netsh is a command-line scripting utility that allows you to, either locally or remotely, display or modify the network configuration of a computer that is currently running. Netsh can be used as a persistence proxy technique to execute a helper DLL when netsh.exe is executed. In this search, we are looking for processes spawned by netsh.exe and executing commands via the command line.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model",
            "id": "b89919ed-fe5f-492c-b139-95dbb162040e",
            "known_false_positives": "Some VPN applications are known to launch netsh.exe. Outside of these instances, it is unusual for an executable to launch netsh.exe and run commands.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "processes_launching_netsh_filter"
               }
            ],
            "name": "Processes launching netsh",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) AS Processes.process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=netsh.exe by Processes.parent_process_name Processes.parent_process Processes.process_name Processes.user Processes.dest |`drop_dm_object_name(\"Processes\")` |`security_content_ctime(firstTime)` |`security_content_ctime(lastTime)` |`processes_launching_netsh_filter`",
            "tags": {
               "analytics_story": [
                  "Netsh Abuse",
                  "Disabling Security Tools",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Lazarus Group",
                  "Kimsuky",
                  "Dragonfly 2.0",
                  "Carbanak"
               ],
               "mitre_attack_id": [
                  "T1562.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Disable or Modify System Firewall"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "2b1800dd-92f9-47ec-a981-fdf1351e5f65",
      "name": "Netsh Abuse",
      "narrative": "It is a common practice for attackers of all types to leverage native Windows tools and functionality to execute commands for malicious reasons. One such tool on Windows OS is `netsh.exe`,a command-line scripting utility that allows you to--either locally or remotely--display or modify the network configuration of a computer that is currently running. `Netsh.exe` can be used to discover and disable local firewall settings. It can also be used to set up a remote connection to a host from an infected system.\\\nTo get started, run the detection search to identify parent processes of `netsh.exe`.",
      "references": [
         "https://docs.microsoft.com/en-us/previous-versions/tn-archive/bb490939(v=technet.10)",
         "https://htmlpreview.github.io/?https://github.com/MatthewDemaske/blogbackup/blob/master/netshell.html",
         "http://blog.jpcert.or.jp/2016/01/windows-commands-abused-by-attackers.html"
      ],
      "tags": {
         "analytics_story": "Netsh Abuse",
         "category": [
            "Abuse"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sowbug",
            "TEMP.Veles",
            "Cobalt Group",
            "APT29",
            "APT1",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "Kimsuky",
            "admin@338",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Thrip",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "APT32",
            "Suckfly",
            "FIN10",
            "Dark Caracal",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "TA459",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "APT3",
            "Carbanak",
            "Darkhotel",
            "Frankenstein",
            "Gallmaker",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "APT38",
            "APT33",
            "Blue Mockingbird",
            "FIN6",
            "APT28",
            "Deep Panda",
            "Soft Cell",
            "APT18",
            "Rocke",
            "DarkVishnya",
            "DarkHydrus",
            "Patchwork",
            "Poseidon Group",
            "Tropic Trooper",
            "Threat Group-1314",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1059.001",
            "T1562.004",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Defense Evasion"
         ],
         "mitre_attack_technique": [
            "Disable or Modify System Firewall",
            "Windows Command Shell",
            "PowerShell"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2020-01-22",
      "description": "Detect activities and various techniques associated with the Orangeworm Attack Group, a group that frequently targets the healthcare industry.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2019-03-01",
                  "description": "This search looks for command-line arguments where `cmd.exe /c` is used to execute a program, then creates a baseline of the earliest and latest times we have encountered this command-line argument in our dataset within the last 30 days.",
                  "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd23",
                  "name": "Previously seen command line arguments",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe AND Processes.process=\"* /c *\" by Processes.process | `drop_dm_object_name(Processes)`",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Orangeworm Attack Group",
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Processes launching netsh",
                        "First time seen command line argument"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for command-line arguments that use a `/c` parameter to execute a command that has not previously been seen.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model. Please make sure you run the support search \"Previously seen command line arguments,\"&#151;which creates a lookup file called `previously_seen_cmd_line_arguments.csv`&#151;a historical baseline of all command-line arguments. You must also validate this list. For the search to do accurate calculation, ensure the search scheduling is the same value as the `relative_time` evaluation function.",
            "id": "9be56c82-b1cc-4318-87eb-q138afaaqa39",
            "known_false_positives": "Legitimate programs can also use command-line arguments to execute. Please verify the command-line arguments to check what command/program is being executed. We recommend customizing the `first_time_seen_cmd_line_filter` macro to exclude legitimate parent_process_name",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "first_time_seen_command_line_argument_filter"
               }
            ],
            "name": "First time seen command line argument",
            "references": [],
            "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process Processes.process_name Processes.parent_process_name Processes.dest| `drop_dm_object_name(Processes)`| `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search [| tstats `security_content_summariesonly` earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process | `drop_dm_object_name(Processes)` | inputlookup append=t previously_seen_cmd_line_arguments | stats min(firstTime) as firstTime, max(lastTime) as lastTime by process | outputlookup previously_seen_cmd_line_arguments | eval newCmdLineArgument=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newCmdLineArgument=1 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table process] | `first_time_seen_command_line_argument_filter` ",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A",
                  "Suspicious Command-Line Executions",
                  "Orangeworm Attack Group",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Hidden Cobra Malware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda",
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.001",
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell",
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2020-06-23",
                  "description": "This collects the services that have been started across your entire enterprise.",
                  "how_to_implement": "While this search does not require you to adhere to Splunk CIM, you must be ingesting your Windows security-event logs for it to execute successfully. Please ensure that the Splunk Add-on for Microsoft Windows is version 8.0.0 or above.",
                  "id": "64ce0ade-cb01-4678-bddd-d31c0b175394",
                  "name": "Previously Seen Running Windows Services - Initial",
                  "search": "`wineventlog_system` EventCode=7036 | rex field=Message \"The (?<service>[-\\(\\)\\s\\w]+) service entered the (?<state>\\w+) state\" | where state=\"running\" | stats earliest(_time) as firstTimeSeen, latest(_time) as lastTimeSeen by service | outputlookup previously_seen_running_windows_services",
                  "tags": {
                     "analytics_story": [
                        "Orangeworm Attack Group",
                        "Windows Service Abuse"
                     ],
                     "deployments": [
                        "90 Day Baseline"
                     ],
                     "detections": [
                        "First Time Seen Running Windows Service"
                     ]
                  },
                  "version": 3
               },
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2020-06-23",
                  "description": "This search returns the first and last time a Windows service was seen across your enterprise within the last hour. It then updates this information with historical data and filters out Windows services pairs that have not been seen within the specified time window. This updated table is then cached.",
                  "how_to_implement": "While this search does not require you to adhere to Splunk CIM, you must be ingesting your Windows security-event logs for it to execute successfully. Please ensure that the Splunk Add-on for Microsoft Windows is version 8.0.0 or above.",
                  "id": "2e3bdd68-1863-46ee-81f8-87273eee7f1c",
                  "name": "Previously Seen Running Windows Services - Update",
                  "search": "`wineventlog_system` EventCode=7036 | rex field=Message \"The (?<service>[-\\(\\)\\s\\w]+) service entered the (?<state>\\w+) state\" | where state=\"running\" | stats earliest(_time) as firstTimeSeen, latest(_time) as lastTimeSeen by service | inputlookup previously_seen_running_windows_services append=t | stats min(firstTimeSeen) as firstTimeSeen, max(lastTimeSeen) as lastTimeSeen by service | where lastTimeSeen > relative_time(now(), \"`previously_seen_windows_service_forget_window`\") | outputlookup previously_seen_running_windows_services",
                  "tags": {
                     "analytics_story": [
                        "Orangeworm Attack Group",
                        "Windows Service Abuse"
                     ],
                     "deployments": [
                        "Hourly Cache Updates"
                     ],
                     "detections": [
                        "First Time Seen Running Windows Service"
                     ]
                  },
                  "version": 3
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for the first and last time a Windows service is seen running in your environment. This table is then cached.",
            "how_to_implement": "While this search does not require you to adhere to Splunk CIM, you must be ingesting your Windows system event logs in order for this search to execute successfully. You should run the baseline search `Previously Seen Running Windows Services - Initial` to build the initial table of child processes and hostnames for this search to work. You should also schedule at the same interval as this search the second baseline search `Previously Seen Running Windows Services - Update` to keep this table up to date and to age out old Windows Services. Please update the `previously_seen_windows_service_window` macro to adjust the time window. Please ensure that the Splunk Add-on for Microsoft Windows is version 8.0.0 or above.",
            "id": "823136f2-d755-4b6d-ae04-372b486a5808",
            "known_false_positives": "A previously unseen service is not necessarily malicious. Verify that the service is legitimate and that was installed by a legitimate process.",
            "macros": [
               {
                  "definition": "-70m@m",
                  "description": "Use this macro to determine how far back you should be checking for new Windows services",
                  "name": "previously_seen_windows_service_window"
               },
               {
                  "definition": "eventtype=wineventlog_system",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wineventlog_system"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "first_time_seen_running_windows_service_filter"
               }
            ],
            "name": "First Time Seen Running Windows Service",
            "references": [],
            "search": "`wineventlog_system` EventCode=7036 | rex field=Message \"The (?<service>[-\\(\\)\\s\\w]+) service entered the (?<state>\\w+) state\" | where state=\"running\" | lookup previously_seen_running_windows_services service as service OUTPUT firstTimeSeen | where isnull(firstTimeSeen) OR firstTimeSeen > relative_time(now(), \"`previously_seen_windows_service_window`\") | table _time dest service | `first_time_seen_running_windows_service_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Service Abuse",
                  "Orangeworm Attack Group"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2",
                  "CIS 9"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT41",
                  "Silence",
                  "FIN6",
                  "APT32",
                  "Honeybee",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1569.002"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Service Execution"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS",
                  "PR.AC",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for arguments to sc.exe indicating the creation or modification of a Windows service.",
            "id": "f0c693d8-2a89-4ce7-80b4-98fea4c3ea6d",
            "known_false_positives": "Using sc.exe to manipulate Windows services is uncommon. However, there may be legitimate instances of this behavior. It is important to validate and investigate as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "sc_exe_manipulating_windows_services_filter"
               }
            ],
            "name": "Sc exe Manipulating Windows Services",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = sc.exe (Processes.process=\"* create *\" OR Processes.process=\"* config *\") by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `sc_exe_manipulating_windows_services_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Service Abuse",
                  "DHS Report TA18-074A",
                  "Orangeworm Attack Group",
                  "Windows Persistence Techniques",
                  "Disabling Security Tools"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "DarkVishnya",
                  "Wizard Spider",
                  "APT32",
                  "APT41",
                  "Kimsuky",
                  "Tropic Trooper",
                  "Cobalt Group",
                  "Ke3chang",
                  "Honeybee",
                  "FIN7",
                  "Threat Group-3390",
                  "APT19",
                  "APT3",
                  "Lazarus Group",
                  "Carbanak"
               ],
               "mitre_attack_id": [
                  "T1543.003"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Windows Service"
               ],
               "nist": [
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "PR.AT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "bb9f5ed2-916e-4364-bb6d-97c370efcf52",
      "name": "Orangeworm Attack Group",
      "narrative": "In May of 2018, the attack group Orangeworm was implicated for installing a custom backdoor called Trojan.Kwampirs within large international healthcare corporations in the United States, Europe, and Asia. This malware provides the attackers with remote access to the target system, decrypting and extracting a copy of its main DLL payload from its resource section. Before writing the payload to disk, it inserts a randomly generated string into the middle of the decrypted payload in an attempt to evade hash-based detections.\\\nAwareness of the Orangeworm group first surfaced in January, 2015. It has conducted targeted attacks against related industries, as well, such as pharmaceuticals and healthcare IT solution providers.\\\nAlthough the group's motivation is unknown, its goal may be stealing patient information to sell on the black market. Another possible explanation is corporate espionage. \\\nHealthcare may be a promising target, because it is notoriously behind in technology, often using older operating systems and neglecting to patch computers. Even so, the group was able to evade detection for a full three years. Sources say that the malware spread quickly within the target networks, infecting computers used to control medical devices, such as MRI and X-ray machines.\\\nThis Analytic Story is designed to help you detect and investigate suspicious activities that may be indicative of an Orangeworm attack. One detection search looks for command-line arguments. Another monitors for uses of sc.exe, a non-essential Windows file that can manipulate Windows services. One of the investigative searches helps you get more information on web hosts that you suspect have been compromised.",
      "references": [
         "https://www.symantec.com/blogs/threat-intelligence/orangeworm-targets-healthcare-us-europe-asia",
         "https://www.infosecurity-magazine.com/news/healthcare-targeted-by-hacker/"
      ],
      "tags": {
         "analytics_story": "Orangeworm Attack Group",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sowbug",
            "TEMP.Veles",
            "Cobalt Group",
            "APT29",
            "APT1",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "Kimsuky",
            "admin@338",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Thrip",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "APT32",
            "Suckfly",
            "FIN10",
            "Dark Caracal",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "TA459",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "APT3",
            "Carbanak",
            "Darkhotel",
            "Frankenstein",
            "Gallmaker",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "APT38",
            "APT33",
            "Blue Mockingbird",
            "FIN6",
            "APT28",
            "Deep Panda",
            "Soft Cell",
            "APT18",
            "DarkVishnya",
            "DarkHydrus",
            "Patchwork",
            "Poseidon Group",
            "Tropic Trooper",
            "Threat Group-1314",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1059.001",
            "T1543.003",
            "T1569.002",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Persistence",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Windows Service",
            "Service Execution",
            "Windows Command Shell",
            "PowerShell"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Splunk Research Team, Splunk",
      "date": "2019-04-29",
      "description": "Detect signs of malicious payloads that may indicate that your environment has been breached via a phishing attack.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for execution of process `outlook.exe` where the process is writing a `.zip` file to the disk.",
            "how_to_implement": "You must be ingesting data that records filesystem and process activity from your hosts to populate the Endpoint data model. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or endpoint data sources, such as Sysmon.",
            "id": "a51bfe1a-94f0-4822-b1e4-16ae10145893",
            "known_false_positives": "It is not uncommon for outlook to write legitimate zip files to the disk.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_oulook_exe_writing_a__zip_file_filter"
               }
            ],
            "name": "Detect Oulook exe writing a  zip file",
            "search": "| tstats `security_content_summariesonly`  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_name=outlook.exe OR Processes.process_name=explorer.exe by _time span=5m Processes.parent_process_id Processes.process_id Processes.dest Processes.process_name Processes.parent_process_name Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename process_id as malicious_id| rename parent_process_id as outlook_id| join malicious_id type=inner[| tstats `security_content_summariesonly` count values(Filesystem.file_path) as file_path values(Filesystem.file_name) as file_name  FROM datamodel=Endpoint.Filesystem where (Filesystem.file_path=*zip*   OR Filesystem.file_name=*.lnk ) AND (Filesystem.file_path=C:\\\\Users* OR Filesystem.file_path=*Local\\\\Temp*) by  _time span=5m Filesystem.process_id Filesystem.file_hash Filesystem.dest  | `drop_dm_object_name(Filesystem)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename process_id as malicious_id| fields malicious_id outlook_id dest file_path file_name file_hash count file_id] | table firstTime lastTime user malicious_id outlook_id process_name parent_process_name file_name  file_path | where file_name != \"\" | `detect_oulook_exe_writing_a__zip_file_filter` ",
            "tags": {
               "analytics_story": [
                  "Phishing Payloads"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Magic Hound",
                  "Windshift",
                  "APT33",
                  "Sandworm Team",
                  "Naikon",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Mofang",
                  "Wizard Spider",
                  "RTM",
                  "Frankenstein",
                  "Inception",
                  "BlackTech",
                  "APT-C-36",
                  "APT41",
                  "Machete",
                  "admin@338",
                  "Kimsuky",
                  "APT12",
                  "TA505",
                  "Silence",
                  "The White Company",
                  "APT39",
                  "FIN4",
                  "Darkhotel",
                  "Gallmaker",
                  "Tropic Trooper",
                  "Turla",
                  "Gorgon Group",
                  "Rancor",
                  "DarkHydrus",
                  "Cobalt Group",
                  "FIN7",
                  "OilRig",
                  "Lazarus Group",
                  "APT19",
                  "Dragonfly 2.0",
                  "BRONZE BUTLER",
                  "APT32",
                  "FIN8",
                  "MuddyWater",
                  "APT28",
                  "TA459",
                  "Leviathan",
                  "Patchwork",
                  "PLATINUM",
                  "Elderwood",
                  "APT29",
                  "APT37",
                  "menuPass"
               ],
               "mitre_attack_id": [
                  "T1566.001"
               ],
               "mitre_attack_tactics": [
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Spearphishing Attachment"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Jose Hernandez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for a ``*.lnk` file under `C:\\User*` or `*\\Local\\Temp\\*` executing a process. This is common behavior used by various spear phishing tools.",
            "how_to_implement": "You must be ingesting data that records filesystem and process activity from your hosts to populate the Endpoint data model. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or endpoint data sources, such as Sysmon.",
            "id": "5d814af1-1041-47b5-a9ac-d754e82e9a26",
            "known_false_positives": "This detection should yield little or no false positive results. It is uncommon for LNK files to execute process from temporary or user directories.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_lnk_file_launching_a_process_filter"
               }
            ],
            "name": "Suspicious LNK file launching a process",
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_name=\"*.lnk\" AND (Filesystem.file_path=\"C:\\\\Users*\" OR Filesystem.file_path=\"*Local\\\\Temp*\")  by _time span=1h Filesystem.process_id Filesystem.file_name Filesystem.file_path Filesystem.file_hash Filesystem.user | `drop_dm_object_name(Filesystem)` | rename process_id as lnk_pid | join lnk_pid, _time [| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.process_name=*  by _time span=1h Processes.parent_process_id Processes.process_id Processes.process_name Processes.dest Processes.process_path Processes.process | `drop_dm_object_name(Processes)` | rename parent_process_id as lnk_pid | fields _time lnk_pid process_id dest process_name process_path process] | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table firstTime, lastTime, lnk_pid, process_id, user, dest, file_name, file_path, process_name, process, process_path, file_hash | `suspicious_lnk_file_launching_a_process_filter` ",
            "tags": {
               "analytics_story": [
                  "Phishing Payloads"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Windshift",
                  "Molerats",
                  "Mofang",
                  "BlackTech",
                  "Machete",
                  "Kimsuky",
                  "TA505",
                  "Stolen Pencil",
                  "APT39",
                  "FIN4",
                  "APT32",
                  "Night Dragon",
                  "Turla",
                  "APT28",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "OilRig",
                  "APT33",
                  "Elderwood",
                  "Leviathan",
                  "Magic Hound",
                  "Patchwork",
                  "APT29",
                  "FIN8"
               ],
               "mitre_attack_id": [
                  "T1566.002"
               ],
               "mitre_attack_tactics": [
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Spearphishing Link"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "57226b40-94f3-4ce5-b101-a75f67759c27",
      "name": "Phishing Payloads",
      "narrative": "Despite its simplicity, phishing remains the most pervasive and dangerous cyberthreat. In fact, research shows that as many as [91% of all successful attacks](https://digitalguardian.com/blog/91-percent-cyber-attacks-start-phishing-email-heres-how-protect-against-phishing) are initiated via a phishing email. \\\nAs most people know, these emails use fraudulent domains, [email scraping](https://www.cyberscoop.com/emotet-trojan-phishing-scraping-templates-cofense-geodo/), familiar contact names inserted as senders, and other tactics to lure targets into clicking a malicious link, opening an attachment with a [nefarious payload](https://www.cyberscoop.com/emotet-trojan-phishing-scraping-templates-cofense-geodo/), or entering sensitive personal information that perpetrators may intercept. This attack technique requires a relatively low level of skill and allows adversaries to easily cast a wide net. Worse, because its success relies on the gullibility of humans, it's impossible to completely \"automate\" it out of your environment. However, you can use ES and ESCU to detect and investigate potentially malicious payloads injected into your environment subsequent to a phishing attack. \\\nhile any kind of file may contain a malicious payload, some are more likely to be perceived as benign (and thus more often escape notice) by the average victim&#151;especially when the attacker sends an email that seems to be from one of their contacts. An example is Microsoft Office files. Most corporate users are familiar with documents with the following suffixes: .doc/.docx (MS Word), .xls/.xlsx (MS Excel), and .ppt/.pptx (MS PowerPoint), so they may click without a second thought, slashing a hole in their organizations' security. \\\nFollowing is a typical series of events, according to an [article by Trend Micro](https://blog.trendmicro.com/trendlabs-security-intelligence/rising-trend-attackers-using-lnk-files-download-malware/):\\\n1. Attacker sends a phishing email. Recipient downloads the attached file, which is typically a .docx or .zip file with an embedded .lnk file\\\n1. The .lnk file executes a PowerShell script\\\n1. Powershell executes a reverse shell, rendering the exploit successful </ol>As a side note, adversaries are likely to use a tool like Empire to craft and obfuscate payloads and their post-injection activities, such as [exfiltration, lateral movement, and persistence](https://github.com/EmpireProject/Empire).\\\nThis Analytic Story focuses on detecting signs that a malicious payload has been injected into your environment. For example, one search detects outlook.exe writing a .zip file. Another looks for suspicious .lnk files launching processes.",
      "references": [
         "https://www.fireeye.com/blog/threat-research/2019/04/spear-phishing-campaign-targets-ukraine-government.html"
      ],
      "tags": {
         "analytics_story": "Phishing Payloads",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "Cobalt Group",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "APT-C-36",
            "Kimsuky",
            "admin@338",
            "Naikon",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Molerats",
            "OilRig",
            "Elderwood",
            "APT32",
            "Machete",
            "BlackTech",
            "PLATINUM",
            "FIN4",
            "FIN7",
            "APT12",
            "APT19",
            "APT37",
            "Windshift",
            "TA459",
            "Magic Hound",
            "Night Dragon",
            "MuddyWater",
            "Mofang",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "Darkhotel",
            "Frankenstein",
            "APT39",
            "Silence",
            "Gallmaker",
            "Dragonfly 2.0",
            "Stolen Pencil",
            "APT33",
            "APT28",
            "Tropic Trooper",
            "DarkHydrus",
            "Patchwork",
            "TA505",
            "menuPass",
            "The White Company"
         ],
         "mitre_attack_id": [
            "T1566.002",
            "T1566.001"
         ],
         "mitre_attack_tactics": [
            "Initial Access"
         ],
         "mitre_attack_technique": [
            "Spearphishing Link",
            "Spearphishing Attachment"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "iDefense Cyber Espionage Team, iDefense",
      "date": "2020-01-22",
      "description": "Monitor your environment for suspicious behaviors that resemble the techniques employed by the MUDCARP threat group.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2019-03-01",
                  "description": "This search looks for command-line arguments where `cmd.exe /c` is used to execute a program, then creates a baseline of the earliest and latest times we have encountered this command-line argument in our dataset within the last 30 days.",
                  "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd23",
                  "name": "Previously seen command line arguments",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe AND Processes.process=\"* /c *\" by Processes.process | `drop_dm_object_name(Processes)`",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Orangeworm Attack Group",
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Processes launching netsh",
                        "First time seen command line argument"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for command-line arguments that use a `/c` parameter to execute a command that has not previously been seen.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model. Please make sure you run the support search \"Previously seen command line arguments,\"&#151;which creates a lookup file called `previously_seen_cmd_line_arguments.csv`&#151;a historical baseline of all command-line arguments. You must also validate this list. For the search to do accurate calculation, ensure the search scheduling is the same value as the `relative_time` evaluation function.",
            "id": "9be56c82-b1cc-4318-87eb-q138afaaqa39",
            "known_false_positives": "Legitimate programs can also use command-line arguments to execute. Please verify the command-line arguments to check what command/program is being executed. We recommend customizing the `first_time_seen_cmd_line_filter` macro to exclude legitimate parent_process_name",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "first_time_seen_command_line_argument_filter"
               }
            ],
            "name": "First time seen command line argument",
            "references": [],
            "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process Processes.process_name Processes.parent_process_name Processes.dest| `drop_dm_object_name(Processes)`| `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search [| tstats `security_content_summariesonly` earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process | `drop_dm_object_name(Processes)` | inputlookup append=t previously_seen_cmd_line_arguments | stats min(firstTime) as firstTime, max(lastTime) as lastTime by process | outputlookup previously_seen_cmd_line_arguments | eval newCmdLineArgument=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newCmdLineArgument=1 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table process] | `first_time_seen_command_line_argument_filter` ",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A",
                  "Suspicious Command-Line Executions",
                  "Orangeworm Attack Group",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Hidden Cobra Malware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda",
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.001",
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell",
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for PowerShell processes started with parameters to modify the execution policy of the run, run in a hidden window, and connect to the Internet. This combination of command-line options is suspicious because it's overriding the default PowerShell execution policy, attempts to hide its activity from the user, and connects to the Internet.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "ee18ed37-0802-4268-9435-b3b91aaa18db",
            "known_false_positives": "Legitimate process can have this combination of command-line options, but it's not common.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "malicious_powershell_process___connect_to_internet_with_hidden_window_filter"
               }
            ],
            "name": "Malicious PowerShell Process - Connect To Internet With Hidden Window",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=powershell.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | search process=\"*-Exec*\" process=\"*-WindowStyle*\" process=\"*hidden*\" process=\"*New-Object*\" process=\"*System.Net.WebClient*\" | `malicious_powershell_process___connect_to_internet_with_hidden_window_filter`",
            "tags": {
               "analytics_story": [
                  "Malicious PowerShell",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 7",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1059.001"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The search looks for modifications to registry keys that can be used to launch an application or service at system startup.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "f5f6af30-7aa7-4295-bfe9-07fe87c01a4b",
            "known_false_positives": "There are many legitimate applications that must execute on system startup and will use these registry keys to accomplish that task.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_used_for_persistence_filter"
               }
            ],
            "name": "Registry Keys Used For Persistence",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*currentversion\\\\run* OR Registry.registry_path=*currentVersion\\\\Windows\\\\Appinit_Dlls* OR Registry.registry_path=CurrentVersion\\\\Winlogon\\\\Shell* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\Userinit* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\VmApplet* OR Registry.registry_path=*currentversion\\\\policies\\\\explorer\\\\run* OR Registry.registry_path=*currentversion\\\\runservices* OR Registry.registry_path=*\\\\CurrentControlSet\\\\Control\\\\Lsa\\\\* OR Registry.registry_path=\"*Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options*\" OR Registry.registry_path=HKLM\\\\SOFTWARE\\\\Microsoft\\\\Netsh\\\\*) by Registry.dest , Registry.status, Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `registry_keys_used_for_persistence_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Suspicious MSHTA Activity",
                  "DHS Report TA18-074A",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware",
                  "Windows Persistence Techniques",
                  "Emotet Malware  DHS Report TA18-201A "
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "Command lines that are extremely long may be indicative of malicious activity on your hosts.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships, from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c77162d3-f93c-45cc-80c8-22f6a4264e7f",
            "known_false_positives": "Some legitimate applications start with long command lines.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unusually_long_command_line_filter"
               }
            ],
            "name": "Unusually Long Command Line",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`|  eval processlen=len(process) | eventstats stdev(processlen) as stdev, avg(processlen) as avg by dest | stats max(processlen) as maxlen, values(stdev) as stdevperhost, values(avg) as avgperhost by dest, user, process_name, process | `unusually_long_command_line_filter` | eval threshold = 10 | where maxlen > ((threshold*stdevperhost) + avgperhost)",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the length of the command lines observed for each user in the environment. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search, which identifies outliers in the length of the command line.",
                  "how_to_implement": "You must be ingesting endpoint data and populating the Endpoint data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. Depending on the number of users in your environment, you may also need to adjust the value for max_inputs in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "d2a4d85b-fc6a-47a0-82f6-bc1ec2ebc459",
                  "name": "Baseline of Command Line Length - MLTK",
                  "search": "| tstats `security_content_summariesonly` count min(_time) as start_time max(_time) as end_time FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(Processes)` | search user!=unknown | `security_content_ctime(start_time)`| `security_content_ctime(end_time)`| eval processlen=len(process) | fit DensityFunction processlen by user into cmdline_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Ransomware",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity",
                        "Unusual Processes"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Unusually Long Command Line - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2019-05-08",
            "description": "Command lines that are extremely long may be indicative of malicious activity on your hosts. This search leverages the Machine Learning Toolkit (MLTK) to help identify command lines with lengths that are unusual for a given user.",
            "how_to_implement": "You must be ingesting endpoint data that monitors command lines and populates the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model. In addition, MLTK version >= 4.2 must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of Command Line Length - MLTK\" must be executed before this detection search, as it builds an ML model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.",
            "id": "57edaefa-a73b-45e5-bbae-f39c1473f941",
            "known_false_positives": "Some legitimate applications use long command lines for installs or updates. You should review identified command lines for legitimacy. You may modify the first part of the search to omit legitimate command lines from consideration. If you are seeing more results than desired, you may consider changing the value of threshold in the search to a smaller value. You should also periodically re-run the support search to re-build the ML model on the latest data. You may get unexpected results if the user identified in the results is not present in the data used to build the associated model.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unusually_long_command_line___mltk_filter"
               }
            ],
            "name": "Unusually Long Command Line - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| eval processlen=len(process) | search user!=unknown | apply cmdline_pdfmodel threshold=0.01 | rename \"IsOutlier(processlen)\" as isOutlier | search isOutlier > 0 | table firstTime lastTime user dest process_name process processlen count | `unusually_long_command_line___mltk_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "988C59C5-0A1C-45B6-A555-0C62276E327E",
      "name": "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
      "narrative": "This story was created as a joint effort between iDefense and Splunk.\\\niDefense analysts have recently discovered a Windows executable file that, upon execution, spoofs a decryption tool and then drops a file that appears to be the custom-built javascript backdoor, \"Orz,\" which is associated with the threat actors known as MUDCARP (as well as \"temp.Periscope\" and \"Leviathan\"). The file is executed using Wscript.\\\nThe MUDCARP techniques include the use of the compressed-folders module from Microsoft, zipfldr.dll, with RouteTheCall export to run the malicious process or command. After a successful reboot, the malware is made persistent by a manipulating `[HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run]'help'='c:\\\\windows\\\\system32\\\\rundll32.exe c:\\\\windows\\\\system32\\\\zipfldr.dll,RouteTheCall c:\\\\programdata\\\\winapp.exe'`. Though this technique is not exclusive to MUDCARP, it has been spotted in the group's arsenal of advanced techniques seen in the wild.\\\nThis Analytic Story searches for evidence of tactics, techniques, and procedures (TTPs) that allow for the use of a endpoint detection-and-response (EDR) bypass technique to mask the true parent of a malicious process. It can also be set as a registry key for further sandbox evasion and to allow the malware to launch only after reboot.\\\nIf behavioral searches included in this story yield positive hits, iDefense recommends conducting IOC searches for the following:\\\n\\\n1. www.chemscalere[.]com\\\n1. chemscalere[.]com\\\n1. about.chemscalere[.]com\\\n1. autoconfig.chemscalere[.]com\\\n1. autodiscover.chemscalere[.]com\\\n1. catalog.chemscalere[.]com\\\n1. cpanel.chemscalere[.]com\\\n1. db.chemscalere[.]com\\\n1. ftp.chemscalere[.]com\\\n1. mail.chemscalere[.]com\\\n1. news.chemscalere[.]com\\\n1. update.chemscalere[.]com\\\n1. webmail.chemscalere[.]com\\\n1. www.candlelightparty[.]org\\\n1. candlelightparty[.]org\\\n1. newapp.freshasianews[.]comIn addition, iDefense also recommends that organizations review their environments for activity related to the following hashes:\\\n\\\n1. cd195ee448a3657b5c2c2d13e9c7a2e2\\\n1. b43ad826fe6928245d3c02b648296b43\\\n1. 889a9b52566448231f112a5ce9b5dfaf\\\n1. b8ec65dab97cdef3cd256cc4753f0c54\\\n1. 04d83cd3813698de28cfbba326d7647c",
      "references": [
         "https://www.infosecurity-magazine.com/news/scope-of-mudcarp-attacks-highlight-1/",
         "http://blog.amossys.fr/badflick-is-not-so-bad.html"
      ],
      "tags": {
         "analytics_story": "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sowbug",
            "TEMP.Veles",
            "Cobalt Group",
            "APT29",
            "APT1",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "Kimsuky",
            "Putter Panda",
            "admin@338",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Thrip",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "APT32",
            "Suckfly",
            "FIN10",
            "Dark Caracal",
            "Machete",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "TA459",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "Gallmaker",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "APT38",
            "APT33",
            "Blue Mockingbird",
            "FIN6",
            "APT28",
            "Deep Panda",
            "Soft Cell",
            "APT18",
            "Rocke",
            "DarkVishnya",
            "DarkHydrus",
            "Patchwork",
            "Poseidon Group",
            "Tropic Trooper",
            "Threat Group-1314",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1059.001",
            "T1547.001",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Persistence",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Registry Run Keys / Startup Folder",
            "Windows Command Shell",
            "PowerShell"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2017-09-11",
      "description": "Detect instances of prohibited network traffic allowed in the environment, as well as protocols running on non-standard ports. Both of these types of behaviors typically violate policy and can be leveraged by attackers.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-01-16",
            "description": "Malicious actors often abuse legitimate Dynamic DNS services to host malicious payloads or interactive command and control nodes. Attackers will automate domain resolution changes by routing dynamic domains to countless IP addresses to circumvent firewall blocks, blacklists as well as frustrate a network defenders analytic and investigative processes. This search will look for DNS queries made from within your infrastructure to suspicious dynamic domains.",
            "how_to_implement": "First, you'll need to ingest data from your DNS operations. This can be done by ingesting logs from your server or data, collected passively by Splunk Stream or a similar solution. Specifically, data that contains the domain that is being queried and the IP of the host originating the request must be populating the `Network_Resolution` data model. This search also leverages a lookup file, `dynamic_dns_providers_default.csv`, which contains a non-exhaustive list of Dynamic DNS providers. Please consider updating the local lookup periodically by adding new domains to the list of `dynamic_dns_providers_local.csv`.\\\nThis search produces fields (query, answer, isDynDNS) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable event. To see the additional metadata, add the following fields, if not already present, to Incident Review. Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** DNS Query, **Field:** query\\\n1. \\\n1. **Label:** DNS Answer, **Field:** answer\\\n1. \\\n1. **Label:** IsDynamicDNS, **Field:** isDynDNS\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "c77162d3-f93c-45cc-80c8-22f6v5464g9f",
            "known_false_positives": "Some users and applications may leverage Dynamic DNS to reach out to some domains on the Internet since dynamic DNS by itself is not malicious, however this activity must be verified.",
            "macros": [
               {
                  "definition": "lookup update=true dynamic_dns_providers_default dynamic_dns_domains as query OUTPUTNEW isDynDNS_default | lookup update=true dynamic_dns_providers_local dynamic_dns_domains as query OUTPUTNEW isDynDNS_local| eval isDynDNS = coalesce(isDynDNS_default, isDynDNS_local)|fields - isDynDNS_default, isDynDNS_local| search isDynDNS=True",
                  "description": "This macro limits the output of the query field to dynamic dns domains. It looks up the domains in a file provided by Splunk and one intended to be updated by the end user.",
                  "name": "dynamic_dns_providers"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_hosts_connecting_to_dynamic_domain_providers_filter"
               }
            ],
            "name": "Detect hosts connecting to dynamic domain providers",
            "search": "| tstats `security_content_summariesonly` count values(DNS.answer) as answer min(_time) as firstTime from datamodel=Network_Resolution by DNS.src, DNS.query | `drop_dm_object_name(\"DNS\")` | `security_content_ctime(firstTime)` | `dynamic_dns_providers` | `detect_hosts_connecting_to_dynamic_domain_providers_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection",
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "DNS Hijacking",
                  "Suspicious DNS Traffic",
                  "Dynamic DNS",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.DS",
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for network traffic defined by port and transport layer protocol in the Enterprise Security lookup table \"lookup_interesting_ports\", that is marked as prohibited, and has an associated 'allow' action in the Network_Traffic data model. This could be indicative of a misconfigured network device.",
            "how_to_implement": "In order to properly run this search, Splunk needs to ingest data from firewalls or other network control devices that mediate the traffic allowed into an environment. This is necessary so that the search can identify an 'action' taken on the traffic of interest. The search requires the Network_Traffic data model be populated.",
            "id": "ce5a0962-849f-4720-a678-753fe6674479",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "prohibited_network_traffic_allowed_filter"
               }
            ],
            "name": "Prohibited Network Traffic Allowed",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.action = allowed by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action | lookup update=true interesting_ports_lookup dest_port as All_Traffic.dest_port OUTPUT app is_prohibited note transport | search is_prohibited=true | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `prohibited_network_traffic_allowed_filter`",
            "tags": {
               "analytics_story": [
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "Ransomware",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Delivery",
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1048"
               ],
               "mitre_attack_tactics": [
                  "Exfiltration"
               ],
               "mitre_attack_technique": [
                  "Exfiltration Over Alternative Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for network traffic on common ports where a higher layer protocol does not match the port that is being used. For example, this search should identify cases where protocols other than HTTP are running on TCP port 80. This can be used by attackers to circumvent firewall restrictions, or as an attempt to hide malicious communications over ports and protocols that are typically allowed and not well inspected.",
            "how_to_implement": "Running this search properly requires a technology that can inspect network traffic and identify common protocols. Technologies such as Bro and Palo Alto Networks firewalls are two examples that will identify protocols via inspection, and not just assume a specific protocol based on the transport protocol and ports.",
            "id": "54dc1265-2f74-4b6d-b30d-49eb506a31b3",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "protocol_or_port_mismatch_filter"
               }
            ],
            "name": "Protocol or Port Mismatch",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where (All_Traffic.app=dns NOT All_Traffic.dest_port=53) OR ((All_Traffic.app=web-browsing OR All_Traffic.app=http) NOT (All_Traffic.dest_port=80 OR All_Traffic.dest_port=8080 OR All_Traffic.dest_port=8000)) OR (All_Traffic.app=ssl NOT (All_Traffic.dest_port=443 OR All_Traffic.dest_port=8443)) OR (All_Traffic.app=smtp NOT All_Traffic.dest_port=25) by All_Traffic.src_ip, All_Traffic.dest_ip, All_Traffic.app, All_Traffic.dest_port |`security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `protocol_or_port_mismatch_filter`",
            "tags": {
               "analytics_story": [
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT32",
                  "APT33",
                  "Thrip",
                  "FIN8",
                  "OilRig",
                  "Lazarus Group"
               ],
               "mitre_attack_id": [
                  "T1048.003"
               ],
               "mitre_attack_tactics": [
                  "Exfiltration"
               ],
               "mitre_attack_technique": [
                  "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for network traffic identified as The Onion Router (TOR), a benign anonymity network which can be abused for a variety of nefarious purposes.",
            "how_to_implement": "In order to properly run this search, Splunk needs to ingest data from firewalls or other network control devices that mediate the traffic allowed into an environment. This is necessary so that the search can identify an 'action' taken on the traffic of interest. The search requires the Network_Traffic data model be populated.",
            "id": "ea688274-9c06-4473-b951-e4cb7a5d7a45",
            "known_false_positives": "None at this time",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "tor_traffic_filter"
               }
            ],
            "name": "TOR Traffic",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.app=tor AND All_Traffic.action=allowed by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `tor_traffic_filter`",
            "tags": {
               "analytics_story": [
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "Ransomware",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "TA505",
                  "Rocke",
                  "APT39",
                  "Tropic Trooper",
                  "MuddyWater",
                  "Wizard Spider",
                  "Inception",
                  "APT41",
                  "SilverTerrier",
                  "Machete",
                  "APT28",
                  "WIRTE",
                  "APT33",
                  "FIN4",
                  "Night Dragon",
                  "APT18",
                  "APT38",
                  "Cobalt Group",
                  "APT19",
                  "Threat Group-3390",
                  "Rancor",
                  "Orangeworm",
                  "APT37",
                  "Ke3chang",
                  "Dark Caracal",
                  "Turla",
                  "Lazarus Group",
                  "BRONZE BUTLER",
                  "APT32",
                  "OilRig",
                  "Magic Hound",
                  "Gamaredon Group",
                  "Stealth Falcon"
               ],
               "mitre_attack_id": [
                  "T1071.001"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "Web Protocols"
               ],
               "nist": [
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "6d13121c-90f3-446d-8ac3-27efbbc65218",
      "name": "Prohibited Traffic Allowed or Protocol Mismatch",
      "narrative": "A traditional security best practice is to control the ports, protocols, and services allowed within your environment. By limiting the services and protocols to those explicitly approved by policy, administrators can minimize the attack surface. The combined effect allows both network defenders and security controls to focus and not be mired in superfluous traffic or data types. Looking for deviations to policy can identify attacker activity that abuses services and protocols to run on alternate or non-standard ports in the attempt to avoid detection or frustrate forensic analysts.",
      "references": [
         "http://www.novetta.com/2015/02/advanced-methods-to-detect-advanced-cyber-attacks-protocol-abuse/"
      ],
      "tags": {
         "analytics_story": "Prohibited Traffic Allowed or Protocol Mismatch",
         "category": [
            "Best Practices"
         ],
         "mitre_attack_groups": [
            "SilverTerrier",
            "Sandworm Team",
            "Gamaredon Group",
            "Cobalt Group",
            "APT41",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "BRONZE BUTLER",
            "Thrip",
            "OilRig",
            "APT32",
            "Machete",
            "Dark Caracal",
            "FIN4",
            "Orangeworm",
            "APT19",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "no",
            "Night Dragon",
            "MuddyWater",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "APT39",
            "APT38",
            "APT33",
            "Rocke",
            "APT18",
            "APT28",
            "Tropic Trooper",
            "TA505",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1048",
            "T1071.001",
            "T1048.003"
         ],
         "mitre_attack_tactics": [
            "Exfiltration",
            "Command And Control"
         ],
         "mitre_attack_technique": [
            "Exfiltration Over Alternative Protocol",
            "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol",
            "Web Protocols"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2020-02-04",
      "description": "Leverage searches that allow you to detect and investigate unusual activities that might relate to ransomware--spikes in SMB traffic, suspicious wevtutil usage, the presence of common ransomware extensions, and system processes run from unexpected locations, and many others.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "The search looks for file modifications with extensions commonly used by Ransomware",
            "how_to_implement": "You must be ingesting data that records the filesystem activity from your hosts to populate the Endpoint file-system data model node. If you are using Sysmon, you will need a Splunk Universal Forwarder on each endpoint from which you want to collect data.\\\nThis search produces fields (`query`,`query_length`,`count`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** Name, **Field:** Name\\\n1. \\\n1. **Label:** File Extension, **Field:** file_extension\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "a9e5c5db-db11-43ca-86a8-c852d1b2c0ec",
            "known_false_positives": "It is possible for a legitimate file with these extensions to be created. If this is a true ransomware attack, there will be a large number of files created with these extensions.",
            "macros": [
               {
                  "definition": "lookup update=true ransomware_extensions_lookup Extensions AS file_extension OUTPUT Name | search Name !=False",
                  "description": "This macro limits the output to files that have extensions associated with ransomware",
                  "name": "ransomware_extensions"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "common_ransomware_extensions_filter"
               }
            ],
            "name": "Common Ransomware Extensions",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.file_name | `drop_dm_object_name(Filesystem)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)`| rex field=file_name \"(?<file_extension>\\.[^\\.]+)$\" | `ransomware_extensions` | `common_ransomware_extensions_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "The search looks for files created with names matching those typically used in ransomware notes that tell the victim how to get their data back.",
            "how_to_implement": "You must be ingesting data that records file-system activity from your hosts to populate the Endpoint Filesystem data-model node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or via other endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report file-system reads and writes.",
            "id": "ada0f478-84a8-4641-a3f1-d82362d6bd71",
            "known_false_positives": "It's possible that a legitimate file could be created with the same name used by ransomware note files.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "lookup ransomware_notes_lookup ransomware_notes as file_name OUTPUT status as \"Known Ransomware Notes\" | search \"Known Ransomware Notes\"=True",
                  "description": "This macro limits the output to files that have been identified as a ransomware note",
                  "name": "ransomware_notes"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "common_ransomware_notes_filter"
               }
            ],
            "name": "Common Ransomware Notes",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.file_name | `drop_dm_object_name(Filesystem)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `ransomware_notes` | `common_ransomware_notes_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The vssadmin.exe utility is used to interact with the Volume Shadow Copy Service.  Wmic is an interface to the Windows Management Instrumentation.  This search looks for either of these tools being used to delete shadow copies.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "b89919ed-ee5f-492c-b139-95dbb162039e",
            "known_false_positives": "vssadmin.exe and wmic.exe are standard applications shipped with modern versions of windows. They may be used by administrators to legitimately delete old backup copies, although this is typically rare.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "deleting_shadow_copies_filter"
               }
            ],
            "name": "Deleting Shadow Copies",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=vssadmin.exe OR Processes.process_name=wmic.exe)  by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | search process=*delete* AND process=*shadow* | `deleting_shadow_copies_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Log Manipulation",
                  "SamSam Ransomware",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 10"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Lazarus Group",
                  "APT38"
               ],
               "mitre_attack_id": [
                  "T1485"
               ],
               "mitre_attack_tactics": [
                  "Impact"
               ],
               "mitre_attack_technique": [
                  "Data Destruction"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for network traffic defined by port and transport layer protocol in the Enterprise Security lookup table \"lookup_interesting_ports\", that is marked as prohibited, and has an associated 'allow' action in the Network_Traffic data model. This could be indicative of a misconfigured network device.",
            "how_to_implement": "In order to properly run this search, Splunk needs to ingest data from firewalls or other network control devices that mediate the traffic allowed into an environment. This is necessary so that the search can identify an 'action' taken on the traffic of interest. The search requires the Network_Traffic data model be populated.",
            "id": "ce5a0962-849f-4720-a678-753fe6674479",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "prohibited_network_traffic_allowed_filter"
               }
            ],
            "name": "Prohibited Network Traffic Allowed",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.action = allowed by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action | lookup update=true interesting_ports_lookup dest_port as All_Traffic.dest_port OUTPUT app is_prohibited note transport | search is_prohibited=true | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `prohibited_network_traffic_allowed_filter`",
            "tags": {
               "analytics_story": [
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "Ransomware",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Delivery",
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1048"
               ],
               "mitre_attack_tactics": [
                  "Exfiltration"
               ],
               "mitre_attack_technique": [
                  "Exfiltration Over Alternative Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The search looks for modifications to registry keys that can be used to launch an application or service at system startup.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "f5f6af30-7aa7-4295-bfe9-07fe87c01a4b",
            "known_false_positives": "There are many legitimate applications that must execute on system startup and will use these registry keys to accomplish that task.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_used_for_persistence_filter"
               }
            ],
            "name": "Registry Keys Used For Persistence",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*currentversion\\\\run* OR Registry.registry_path=*currentVersion\\\\Windows\\\\Appinit_Dlls* OR Registry.registry_path=CurrentVersion\\\\Winlogon\\\\Shell* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\Userinit* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\VmApplet* OR Registry.registry_path=*currentversion\\\\policies\\\\explorer\\\\run* OR Registry.registry_path=*currentversion\\\\runservices* OR Registry.registry_path=*\\\\CurrentControlSet\\\\Control\\\\Lsa\\\\* OR Registry.registry_path=\"*Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options*\" OR Registry.registry_path=HKLM\\\\SOFTWARE\\\\Microsoft\\\\Netsh\\\\*) by Registry.dest , Registry.status, Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `registry_keys_used_for_persistence_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Suspicious MSHTA Activity",
                  "DHS Report TA18-074A",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware",
                  "Windows Persistence Techniques",
                  "Emotet Malware  DHS Report TA18-201A "
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for wmic.exe being launched with parameters to spawn a process on a remote system.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "d25d2c3d-d9d8-40ec-8fdf-e86fe155a3da",
            "known_false_positives": "The wmic.exe utility is a benign Windows application. It may be used legitimately by Administrators with these parameters for remote system administration, but it's relatively uncommon.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_process_instantiation_via_wmi_filter"
               }
            ],
            "name": "Remote Process Instantiation via WMI",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = wmic.exe Processes.process=\"*/node*\" Processes.process=\"*process*\" Processes.process=\"*call*\" Processes.process=\"*create*\"   by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` |`security_content_ctime(lastTime)` | `remote_process_instantiation_via_wmi_filter`",
            "tags": {
               "analytics_story": [
                  "Ransomware",
                  "Suspicious WMI Use"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "TEMP.Veles",
                  "Leviathan",
                  "APT39",
                  "Stolen Pencil",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "FIN8",
                  "APT3",
                  "OilRig",
                  "menuPass",
                  "FIN10",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "APT1",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1021.001"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Remote Desktop Protocol"
               ],
               "nist": [
                  "PR.PT",
                  "PR.AT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for flags passed to schtasks.exe on the command-line that indicate that task names related to the execution of Bad Rabbit ransomware were created or deleted.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "1297fb80-f42a-4b4a-9c8b-78c066437cf6",
            "known_false_positives": "No known false positives",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "scheduled_tasks_used_in_badrabbit_ransomware_filter"
               }
            ],
            "name": "Scheduled tasks used in BadRabbit ransomware",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.process) as process  from datamodel=Endpoint.Processes where Processes.process_name=schtasks.exe (Processes.process= \"*create*\"  OR Processes.process= \"*delete*\") by Processes.parent_process Processes.process_name Processes.user | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)` | search (process=*rhaegal* OR process=*drogon* OR *viserion_*) | `scheduled_tasks_used_in_badrabbit_ransomware_filter`",
            "tags": {
               "analytics_story": [
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "MuddyWater",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT-C-36",
                  "BRONZE BUTLER",
                  "APT41",
                  "Machete",
                  "Soft Cell",
                  "Silence",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Dragonfly 2.0",
                  "Patchwork",
                  "OilRig",
                  "Rancor",
                  "Cobalt Group",
                  "FIN8",
                  "menuPass",
                  "FIN10",
                  "APT32",
                  "FIN7",
                  "Stealth Falcon",
                  "FIN6",
                  "APT3",
                  "APT29"
               ],
               "mitre_attack_id": [
                  "T1053.005"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Scheduled Task"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for flags passed to schtasks.exe on the command-line that indicate that a forced reboot of system is scheduled.",
            "how_to_implement": "To successfully implement this search you need to be ingesting logs with both the process name and command-line from your endpoints. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
            "id": "1297fb80-f42a-4b4a-9c8a-88c066437cf6",
            "known_false_positives": "Administrators may create jobs on systems forcing reboots to perform updates, maintenance, etc.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "schtasks_used_for_forcing_a_reboot_filter"
               }
            ],
            "name": "Schtasks used for forcing a reboot",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = schtasks.exe Processes.process=\"*shutdown*\" Processes.process=\"*/r*\" Processes.process=\"*/f*\" by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `schtasks_used_for_forcing_a_reboot_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Persistence Techniques",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "MuddyWater",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT-C-36",
                  "BRONZE BUTLER",
                  "APT41",
                  "Machete",
                  "Soft Cell",
                  "Silence",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Dragonfly 2.0",
                  "Patchwork",
                  "OilRig",
                  "Rancor",
                  "Cobalt Group",
                  "FIN8",
                  "menuPass",
                  "FIN10",
                  "APT32",
                  "FIN7",
                  "Stealth Falcon",
                  "FIN6",
                  "APT3",
                  "APT29"
               ],
               "mitre_attack_id": [
                  "T1053.005"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Scheduled Task"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for spikes in the number of Server Message Block (SMB) traffic connections.",
            "how_to_implement": "This search requires you to be ingesting your network traffic logs and populating the `Network_Traffic` data model.",
            "id": "7f5fb3e1-4209-4914-90db-0ec21b936378",
            "known_false_positives": "A file server may experience high-demand loads that could cause this analytic to trigger.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "smb_traffic_spike_filter"
               }
            ],
            "name": "SMB Traffic Spike",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src | `drop_dm_object_name(\"All_Traffic\")` | eventstats max(_time) as maxtime | stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, \"-70m@m\"), count, null))) as count avg(eval(if(_time<relative_time(maxtime, \"-70m@m\"), count, null))) as avg stdev(eval(if(_time<relative_time(maxtime, \"-70m@m\"), count, null))) as stdev by src | eval upperBound=(avg+stdev*2), isOutlier=if(count > upperBound AND num_data_samples >=50, 1, 0) | where isOutlier=1 | table src count | `smb_traffic_spike_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Hidden Cobra Malware",
                  "Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT32",
                  "Orangeworm",
                  "FIN8",
                  "APT3",
                  "Lazarus Group",
                  "Threat Group-1314",
                  "Turla",
                  "Deep Panda",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1021.002"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "SMB/Windows Admin Shares"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the number of SMB connections observed each hour for every day of week. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search to identify outliers in the number of SMB connections for that hour and day of the week.",
                  "how_to_implement": "You must be ingesting network traffic and populating the Network_Traffic data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. To improve your results, you may consider adding \"src\" to the by clause, which will build the model for each unique source in your enviornment. However, if you have a large number of hosts in your environment, this search may be very resource intensive. In this case, you may need to raise the value of max_inputs and/or max_groups in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "df98763b-0b08-4281-8ef9-08db7ac572a9",
                  "name": "Baseline of SMB Traffic - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=10m, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(\"All_Traffic\")` | fit DensityFunction count by \"HourOfDay,DayOfWeek\" into smb_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Ransomware"
                     ],
                     "detections": [
                        "Processes launching netsh",
                        "SMB Traffic Spike - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-22",
            "description": "This search uses the Machine Learning Toolkit (MLTK) to identify spikes in the number of Server Message Block (SMB) connections.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, the Machine Learning Toolkit (MLTK) version 4.2 or greater must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of SMB Traffic - MLTK\" must be executed before this detection search, because it builds a machine-learning (ML) model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.\\\nThis search produces a field (Number of events,count) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. This field contributes additional context to the notable. To see the additional metadata, add the following field, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry): \\\n1. **Label:** Number of events, **Field:** count\\\nDetailed documentation on how to create a new field within Incident Review is found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "d25773ba-9ad8-48d1-858e-07ad0bbeb828",
            "known_false_positives": "If you are seeing more results than desired, you may consider reducing the value of the threshold in the search. You should also periodically re-run the support search to re-build the ML model on the latest data. Please update the `smb_traffic_spike_mltk_filter` macro to filter out false positive results",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "smb_traffic_spike___mltk_filter"
               }
            ],
            "name": "SMB Traffic Spike - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(All_Traffic.dest_ip) as dest values(All_Traffic.dest_port) as port from datamodel=Network_Traffic where All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=smb by _time span=1h, All_Traffic.src | eval HourOfDay=strftime(_time, \"%H\") | eval DayOfWeek=strftime(_time, \"%A\") | `drop_dm_object_name(All_Traffic)` | apply smb_pdfmodel threshold=0.001 | rename \"IsOutlier(count)\" as isOutlier | search isOutlier > 0 | sort -count | table _time src dest port count | `smb_traffic_spike___mltk_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Hidden Cobra Malware",
                  "Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT32",
                  "Orangeworm",
                  "FIN8",
                  "APT3",
                  "Lazarus Group",
                  "Threat Group-1314",
                  "Turla",
                  "Deep Panda",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1021.002"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "SMB/Windows Admin Shares"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "The search looks for a sharp increase in the number of files written to a particular host",
            "how_to_implement": "In order to implement this search, you must populate the Endpoint file-system data model node. This is typically populated via endpoint detection and response products, such as Carbon Black or endpoint data sources such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the file system.",
            "id": "fdb0f805-74e4-4539-8c00-618927333aae",
            "known_false_positives": "It is important to understand that if you happen to install any new applications on your hosts or are copying a large number of files, you can expect to see a large increase of file modifications.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "spike_in_file_writes_filter"
               }
            ],
            "name": "Spike in File Writes",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem where Filesystem.action=created by _time span=1h, Filesystem.dest | `drop_dm_object_name(Filesystem)` | eventstats max(_time) as maxtime | stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, \"-1d@d\"), count, null))) as \"count\" avg(eval(if(_time<relative_time(maxtime, \"-1d@d\"), count,null))) as avg stdev(eval(if(_time<relative_time(maxtime, \"-1d@d\"), count, null))) as stdev by \"dest\" | eval upperBound=(avg+stdev*4), isOutlier=if((count > upperBound) AND num_data_samples >=20, 1, 0) | search isOutlier=1 | `spike_in_file_writes_filter` ",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "The wevtutil.exe application is the windows event log utility. This searches for wevtutil.exe with parameters for clearing the application, security, setup, or system event logs.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "2827c0fd-e1be-4868-ae25-59d28e0f9d4f",
            "known_false_positives": "The wevtutil.exe application is a legitimate Windows event log utility. Administrators may use it to manage Windows event logs.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_wevtutil_usage_filter"
               }
            ],
            "name": "Suspicious wevtutil Usage",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = wevtutil.exe Processes.process=\"*cl*\" (Processes.process=\"*System*\" OR Processes.process=\"*Security*\" OR Processes.process=\"*Setup*\" OR Processes.process=\"*Application*\") by Processes.process_name Processes.parent_process_name Processes.dest Processes.user| `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` |`security_content_ctime(lastTime)` | `suspicious_wevtutil_usage_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Log Manipulation",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 6"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT41",
                  "APT38",
                  "Dragonfly 2.0",
                  "APT32",
                  "FIN8",
                  "FIN5",
                  "APT28"
               ],
               "mitre_attack_id": [
                  "T1070.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Clear Windows Event Logs"
               ],
               "nist": [
                  "DE.DP",
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "PR.AT",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-02-04",
            "description": "This search looks for system processes that normally run out of C:\\Windows\\System32\\ or C:\\Windows\\SysWOW64 that are not run from that location.  This can indicate a malicious process that is trying to hide as a legitimate process.",
            "how_to_implement": "To successfully implement this search you need to ingest details about process execution from your hosts. Specifically, this search requires the process name and the full path to the process executable.",
            "id": "a34aae96-ccf8-4aef-952c-3ea21444444d",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "definition": "lookup update=true is_windows_system_file filename as process_name OUTPUT systemFile | search systemFile=true",
                  "description": "This macro limits the output to process names that are in the Windows System directory",
                  "name": "is_windows_system_file"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "system_processes_run_from_unexpected_locations_filter"
               }
            ],
            "name": "System Processes Run From Unexpected Locations",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_path !=\"C:\\\\Windows\\\\System32*\" Processes.process_path !=\"C:\\\\Windows\\\\SysWOW64*\" by Processes.user Processes.dest Processes.process_name Processes.process_id Processes.process_path Processes.parent_process_name Processes.process_hash| `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| `is_windows_system_file` | `system_processes_run_from_unexpected_locations_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Windshift",
                  "APT32",
                  "BRONZE BUTLER",
                  "menuPass",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1036"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Masquerading"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for network traffic identified as The Onion Router (TOR), a benign anonymity network which can be abused for a variety of nefarious purposes.",
            "how_to_implement": "In order to properly run this search, Splunk needs to ingest data from firewalls or other network control devices that mediate the traffic allowed into an environment. This is necessary so that the search can identify an 'action' taken on the traffic of interest. The search requires the Network_Traffic data model be populated.",
            "id": "ea688274-9c06-4473-b951-e4cb7a5d7a45",
            "known_false_positives": "None at this time",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "tor_traffic_filter"
               }
            ],
            "name": "TOR Traffic",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.app=tor AND All_Traffic.action=allowed by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `tor_traffic_filter`",
            "tags": {
               "analytics_story": [
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "Ransomware",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "TA505",
                  "Rocke",
                  "APT39",
                  "Tropic Trooper",
                  "MuddyWater",
                  "Wizard Spider",
                  "Inception",
                  "APT41",
                  "SilverTerrier",
                  "Machete",
                  "APT28",
                  "WIRTE",
                  "APT33",
                  "FIN4",
                  "Night Dragon",
                  "APT18",
                  "APT38",
                  "Cobalt Group",
                  "APT19",
                  "Threat Group-3390",
                  "Rancor",
                  "Orangeworm",
                  "APT37",
                  "Ke3chang",
                  "Dark Caracal",
                  "Turla",
                  "Lazarus Group",
                  "BRONZE BUTLER",
                  "APT32",
                  "OilRig",
                  "Magic Hound",
                  "Gamaredon Group",
                  "Stealth Falcon"
               ],
               "mitre_attack_id": [
                  "T1071.001"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "Web Protocols"
               ],
               "nist": [
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "Command lines that are extremely long may be indicative of malicious activity on your hosts.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships, from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c77162d3-f93c-45cc-80c8-22f6a4264e7f",
            "known_false_positives": "Some legitimate applications start with long command lines.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unusually_long_command_line_filter"
               }
            ],
            "name": "Unusually Long Command Line",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`|  eval processlen=len(process) | eventstats stdev(processlen) as stdev, avg(processlen) as avg by dest | stats max(processlen) as maxlen, values(stdev) as stdevperhost, values(avg) as avgperhost by dest, user, process_name, process | `unusually_long_command_line_filter` | eval threshold = 10 | where maxlen > ((threshold*stdevperhost) + avgperhost)",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the length of the command lines observed for each user in the environment. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search, which identifies outliers in the length of the command line.",
                  "how_to_implement": "You must be ingesting endpoint data and populating the Endpoint data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. Depending on the number of users in your environment, you may also need to adjust the value for max_inputs in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "d2a4d85b-fc6a-47a0-82f6-bc1ec2ebc459",
                  "name": "Baseline of Command Line Length - MLTK",
                  "search": "| tstats `security_content_summariesonly` count min(_time) as start_time max(_time) as end_time FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(Processes)` | search user!=unknown | `security_content_ctime(start_time)`| `security_content_ctime(end_time)`| eval processlen=len(process) | fit DensityFunction processlen by user into cmdline_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Ransomware",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity",
                        "Unusual Processes"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Unusually Long Command Line - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2019-05-08",
            "description": "Command lines that are extremely long may be indicative of malicious activity on your hosts. This search leverages the Machine Learning Toolkit (MLTK) to help identify command lines with lengths that are unusual for a given user.",
            "how_to_implement": "You must be ingesting endpoint data that monitors command lines and populates the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model. In addition, MLTK version >= 4.2 must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of Command Line Length - MLTK\" must be executed before this detection search, as it builds an ML model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.",
            "id": "57edaefa-a73b-45e5-bbae-f39c1473f941",
            "known_false_positives": "Some legitimate applications use long command lines for installs or updates. You should review identified command lines for legitimacy. You may modify the first part of the search to omit legitimate command lines from consideration. If you are seeing more results than desired, you may consider changing the value of threshold in the search to a smaller value. You should also periodically re-run the support search to re-build the ML model on the latest data. You may get unexpected results if the user identified in the results is not present in the data used to build the associated model.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unusually_long_command_line___mltk_filter"
               }
            ],
            "name": "Unusually Long Command Line - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| eval processlen=len(process) | search user!=unknown | apply cmdline_pdfmodel threshold=0.01 | rename \"IsOutlier(processlen)\" as isOutlier | search isOutlier > 0 | table firstTime lastTime user dest process_name process processlen count | `unusually_long_command_line___mltk_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2018-12-03",
            "description": "The fsutil.exe application is a legitimate Windows utility used to perform tasks related to the file allocation table (FAT) and NTFS file systems. The update sequence number (USN) change journal provides a log of all changes made to the files on the disk. This search looks for fsutil.exe deleting the USN journal.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "b6e0ff70-b122-4227-9368-4cf322ab43c3",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "usn_journal_deletion_filter"
               }
            ],
            "name": "USN Journal Deletion",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=fsutil.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | search process=\"*deletejournal*\" AND process=\"*usn*\" | `usn_journal_deletion_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Log Manipulation",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 6",
                  "CIS 8",
                  "CIS 10"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1070"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Indicator Removal on Host"
               ],
               "nist": [
                  "DE.CM",
                  "PR.PT",
                  "DE.AE",
                  "DE.DP",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-06",
            "description": "This search looks for Windows events that indicate one of the Windows event logs has been purged.",
            "how_to_implement": "To successfully implement this search, you need to be ingesting Windows event logs from your hosts.",
            "id": "ad517544-aff9-4c96-bd99-d6eb43bfbb6a",
            "known_false_positives": "It is possible that these logs may be legitimately cleared by Administrators.",
            "macros": [
               {
                  "definition": "eventtype=wineventlog_security",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wineventlog_security"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "eventtype=wineventlog_system",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wineventlog_system"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "windows_event_log_cleared_filter"
               }
            ],
            "name": "Windows Event Log Cleared",
            "references": [],
            "search": "(`wineventlog_security` (EventID=1102 OR EventID=1100)) OR (`wineventlog_system` EventID=104) | stats count min(_time) as firstTime max(_time) as lastTime by EventID dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_event_log_cleared_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Log Manipulation",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 6"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT41",
                  "APT38",
                  "Dragonfly 2.0",
                  "APT32",
                  "FIN8",
                  "FIN5",
                  "APT28"
               ],
               "mitre_attack_id": [
                  "T1070.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Clear Windows Event Logs"
               ],
               "nist": [
                  "DE.DP",
                  "PR.IP",
                  "PR.AC",
                  "PR.AT",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "cf309d0d-d4aa-4fbb-963d-1e79febd3756",
      "name": "Ransomware",
      "narrative": "Ransomware is an ever-present risk to the enterprise, wherein an infected host encrypts business-critical data, holding it hostage until the victim pays the attacker a ransom. There are many types and varieties of ransomware that can affect an enterprise. Attackers can deploy ransomware to enterprises through spearphishing campaigns and driveby downloads, as well as through traditional remote service-based exploitation. In the case of the WannaCry campaign, there was self-propagating wormable functionality that was used to maximize infection. Fortunately, organizations can apply several techniques--such as those in this Analytic Story--to detect and or mitigate the effects of ransomware.",
      "references": [
         "https://www.carbonblack.com/2017/06/28/carbon-black-threat-research-technical-analysis-petya-notpetya-ransomware/",
         "https://www.splunk.com/blog/2017/06/27/closing-the-detection-to-mitigation-gap-or-to-petya-or-notpetya-whocares-.html"
      ],
      "tags": {
         "analytics_story": "Ransomware",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "SilverTerrier",
            "TEMP.Veles",
            "Cobalt Group",
            "APT29",
            "APT1",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN5",
            "FIN8",
            "Turla",
            "Inception",
            "APT-C-36",
            "Kimsuky",
            "Putter Panda",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Molerats",
            "OilRig",
            "APT32",
            "Machete",
            "FIN10",
            "Dark Caracal",
            "Orangeworm",
            "FIN4",
            "FIN7",
            "APT19",
            "APT37",
            "Windshift",
            "Ke3chang",
            "Magic Hound",
            "no",
            "Axiom",
            "Night Dragon",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "APT39",
            "Silence",
            "APT38",
            "Dragonfly 2.0",
            "Stolen Pencil",
            "APT33",
            "Rocke",
            "APT18",
            "FIN6",
            "Blue Mockingbird",
            "Soft Cell",
            "Deep Panda",
            "APT28",
            "Tropic Trooper",
            "Patchwork",
            "Threat Group-1314",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1021.001",
            "T1053.005",
            "T1070.001",
            "T1071.001",
            "T1485",
            "T1021.002",
            "T1048",
            "T1547.001",
            "T1036",
            "T1070"
         ],
         "mitre_attack_tactics": [
            "Command And Control",
            "Defense Evasion",
            "Lateral Movement",
            "Exfiltration",
            "Execution",
            "Persistence",
            "Privilege Escalation",
            "Impact"
         ],
         "mitre_attack_technique": [
            "Indicator Removal on Host",
            "Masquerading",
            "SMB/Windows Admin Shares",
            "Data Destruction",
            "Registry Run Keys / Startup Folder",
            "Clear Windows Event Logs",
            "Scheduled Task",
            "Exfiltration Over Alternative Protocol",
            "Web Protocols",
            "Remote Desktop Protocol"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2017-09-12",
      "description": "Validate the security configuration of network infrastructure and verify that only authorized users and systems are accessing critical assets. Core routing and switching infrastructure are common strategic targets for attackers.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-12",
            "description": "The search queries the authentication logs for assets that are categorized as routers in the ES Assets and Identity Framework, to identify connections that have not been seen before in the last 30 days.",
            "how_to_implement": "To successfully implement this search, you must ensure the network router devices are categorized as \"router\" in the Assets and identity table. You must also populate the Authentication data model with logs related to users authenticating to routing infrastructure.",
            "id": "104658f4-afdc-499e-9719-17243rr826f1",
            "known_false_positives": "Legitimate router connections may appear as new connections",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_new_login_attempts_to_routers_filter"
               }
            ],
            "name": "Detect New Login Attempts to Routers",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count earliest(_time) as earliest latest(_time) as latest from datamodel=Authentication where Authentication.dest_category=router by Authentication.dest Authentication.user| eval isOutlier=if(earliest >= relative_time(now(), \"-30d@d\"), 1, 0) | where isOutlier=1| `security_content_ctime(earliest)`| `security_content_ctime(latest)` | `drop_dm_object_name(\"Authentication\")` | `detect_new_login_attempts_to_routers_filter`",
            "tags": {
               "analytics_story": [
                  "Router and Infrastructure Security"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 11"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "91c676cf-0b23-438d-abee-f6335e177e77",
      "name": "Router and Infrastructure Security",
      "narrative": "Networking devices, such as routers and switches, are often overlooked as resources that attackers will leverage to subvert an enterprise. Advanced threats actors have shown a proclivity to target these critical assets as a means to siphon and redirect network traffic, flash backdoored operating systems, and implement cryptographic weakened algorithms to more easily decrypt network traffic.\\\nThis Analytic Story helps you gain a better understanding of how your network devices are interacting with your hosts. By compromising your network devices, attackers can obtain direct access to the company's internal infrastructure&#151; effectively increasing the attack surface and accessing private services/data.",
      "references": [
         "https://www.fireeye.com/blog/executive-perspective/2015/09/the_new_route_toper.html",
         "https://www.cisco.com/c/en/us/about/security-center/event-response/synful-knock.html"
      ],
      "tags": {
         "analytics_story": "Router and Infrastructure Security",
         "category": [
            "Best Practices"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2018-12-13",
      "description": "Leverage searches that allow you to detect and investigate unusual activities that might relate to the SamSam ransomware, including looking for file writes associated with SamSam, RDP brute force attacks, the presence of files with SamSam ransomware extensions, suspicious psexec use, and more.",
      "detections": [
         {
            "author": "Rico Valdez, Splunk",
            "date": "2018-12-14",
            "description": "The search looks for a batch file (.bat) written to the Windows system directory tree.",
            "how_to_implement": "You must be ingesting data that records the file-system activity from your hosts to populate the Endpoint file-system data-model node. If you are using Sysmon, you will need a Splunk Universal Forwarder on each endpoint from which you want to collect data.",
            "id": "503d17cb-9eab-4cf8-a20e-01d5c6987ae3",
            "known_false_positives": "It is possible for this search to generate a notable event for a batch file write to a path that includes the string \"system32\", but is not the actual Windows system directory. As such, you should confirm the path of the batch file identified by the search. In addition, a false positive may be generated by an administrator copying a legitimate batch file in this directory tree. You should confirm that the activity is legitimate and modify the search to add exclusions, as necessary.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "batch_file_write_to_system32_filter"
               }
            ],
            "name": "Batch File Write to System32",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.dest) as dest values(Filesystem.file_name) as file_name values(Filesystem.user) as user from datamodel=Endpoint.Filesystem by Filesystem.file_path | `drop_dm_object_name(Filesystem)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)`| rex field=file_name \"(?<file_extension>\\.[^\\.]+)$\" | search file_path=*system32* AND file_extension=.bat | `batch_file_write_to_system32_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "The search looks for file modifications with extensions commonly used by Ransomware",
            "how_to_implement": "You must be ingesting data that records the filesystem activity from your hosts to populate the Endpoint file-system data model node. If you are using Sysmon, you will need a Splunk Universal Forwarder on each endpoint from which you want to collect data.\\\nThis search produces fields (`query`,`query_length`,`count`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** Name, **Field:** Name\\\n1. \\\n1. **Label:** File Extension, **Field:** file_extension\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "a9e5c5db-db11-43ca-86a8-c852d1b2c0ec",
            "known_false_positives": "It is possible for a legitimate file with these extensions to be created. If this is a true ransomware attack, there will be a large number of files created with these extensions.",
            "macros": [
               {
                  "definition": "lookup update=true ransomware_extensions_lookup Extensions AS file_extension OUTPUT Name | search Name !=False",
                  "description": "This macro limits the output to files that have extensions associated with ransomware",
                  "name": "ransomware_extensions"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "common_ransomware_extensions_filter"
               }
            ],
            "name": "Common Ransomware Extensions",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.file_name | `drop_dm_object_name(Filesystem)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)`| rex field=file_name \"(?<file_extension>\\.[^\\.]+)$\" | `ransomware_extensions` | `common_ransomware_extensions_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "The search looks for files created with names matching those typically used in ransomware notes that tell the victim how to get their data back.",
            "how_to_implement": "You must be ingesting data that records file-system activity from your hosts to populate the Endpoint Filesystem data-model node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or via other endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report file-system reads and writes.",
            "id": "ada0f478-84a8-4641-a3f1-d82362d6bd71",
            "known_false_positives": "It's possible that a legitimate file could be created with the same name used by ransomware note files.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "lookup ransomware_notes_lookup ransomware_notes as file_name OUTPUT status as \"Known Ransomware Notes\" | search \"Known Ransomware Notes\"=True",
                  "description": "This macro limits the output to files that have been identified as a ransomware note",
                  "name": "ransomware_notes"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "common_ransomware_notes_filter"
               }
            ],
            "name": "Common Ransomware Notes",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.file_name | `drop_dm_object_name(Filesystem)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `ransomware_notes` | `common_ransomware_notes_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The vssadmin.exe utility is used to interact with the Volume Shadow Copy Service.  Wmic is an interface to the Windows Management Instrumentation.  This search looks for either of these tools being used to delete shadow copies.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "b89919ed-ee5f-492c-b139-95dbb162039e",
            "known_false_positives": "vssadmin.exe and wmic.exe are standard applications shipped with modern versions of windows. They may be used by administrators to legitimately delete old backup copies, although this is typically rare.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "deleting_shadow_copies_filter"
               }
            ],
            "name": "Deleting Shadow Copies",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=vssadmin.exe OR Processes.process_name=wmic.exe)  by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | search process=*delete* AND process=*shadow* | `deleting_shadow_copies_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Log Manipulation",
                  "SamSam Ransomware",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 10"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Lazarus Group",
                  "APT38"
               ],
               "mitre_attack_id": [
                  "T1485"
               ],
               "mitre_attack_tactics": [
                  "Impact"
               ],
               "mitre_attack_technique": [
                  "Data Destruction"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-23",
            "description": "This search looks for specific GET or HEAD requests to web servers that are indicative of reconnaissance attempts to identify vulnerable JBoss servers. JexBoss is described as the exploit tool of choice for this malicious activity.",
            "how_to_implement": "You must be ingesting data from the web server or network traffic that contains web specific information, and populating the Web data model.",
            "id": "104658f4-afdc-499e-9719-17243f982681",
            "known_false_positives": "It's possible for legitimate HTTP requests to be made to URLs containing the suspicious paths.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_attackers_scanning_for_vulnerable_jboss_servers_filter"
               }
            ],
            "name": "Detect attackers scanning for vulnerable JBoss servers",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where (Web.http_method=\"GET\" OR Web.http_method=\"HEAD\") AND (Web.url=\"*/web-console/ServerInfo.jsp*\" OR Web.url=\"*web-console*\" OR Web.url=\"*jmx-console*\" OR Web.url = \"*invoker*\") by Web.http_method, Web.url, Web.src, Web.dest | `drop_dm_object_name(\"Web\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `detect_attackers_scanning_for_vulnerable_jboss_servers_filter`",
            "tags": {
               "analytics_story": [
                  "JBoss Vulnerability",
                  "SamSam Ransomware"
               ],
               "asset_type": "Web Server",
               "kill_chain_phases": [
                  "Reconnaissance"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Sandworm Team",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "Inception",
                  "Kimsuky",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "Honeybee",
                  "APT19",
                  "APT37",
                  "APT32",
                  "Magic Hound",
                  "OilRig",
                  "APT3",
                  "Sowbug",
                  "Gamaredon Group",
                  "Patchwork",
                  "Stealth Falcon",
                  "Lazarus Group",
                  "admin@338",
                  "Turla",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1082"
               ],
               "mitre_attack_tactics": [
                  "Discovery"
               ],
               "mitre_attack_technique": [
                  "System Information Discovery"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-23",
            "description": "This search is used to detect malicious HTTP requests crafted to exploit jmx-console in JBoss servers. The malicious requests have a long URL length, as the payload is embedded in the URL.",
            "how_to_implement": "You must ingest data from the web server or capture network data that contains web specific information with solutions such as Bro or Splunk Stream, and populating the Web data model",
            "id": "c8bff7a4-11ea-4416-a27d-c5bca472913d",
            "known_false_positives": "No known false positives for this detection.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_malicious_requests_to_exploit_jboss_servers_filter"
               }
            ],
            "name": "Detect malicious requests to exploit JBoss servers",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web where (Web.http_method=\"GET\" OR Web.http_method=\"HEAD\") by Web.http_method, Web.url,Web.url_length Web.src, Web.dest | search Web.url=\"*jmx-console/HtmlAdaptor?action=invokeOpByName&name=jboss.admin*import*\" AND Web.url_length > 200 | `drop_dm_object_name(\"Web\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table src, dest_ip, http_method, url, firstTime, lastTime | `detect_malicious_requests_to_exploit_jboss_servers_filter`",
            "tags": {
               "analytics_story": [
                  "JBoss Vulnerability",
                  "SamSam Ransomware"
               ],
               "asset_type": "Web Server",
               "cis20": [
                  "CIS 12",
                  "CIS 4",
                  "CIS 18"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.RA",
                  "PR.PT",
                  "PR.IP",
                  "DE.AE",
                  "PR.MA",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2019-02-26",
            "description": "This search looks for events where `PsExec.exe` is run with the `accepteula` flag in the command line. PsExec is a built-in Windows utility that enables you to execute processes on other systems. It is fully interactive for console applications. This tool is widely used for launching interactive command prompts on remote systems. Threat actors leverage this extensively for executing code on compromised systems. If an attacker is running PsExec for the first time, they will be prompted to accept the end-user license agreement (EULA), which can be passed as the argument `accepteula` within the command line.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "b89919ed-fe5f-492c-b139-151xb162040e",
            "known_false_positives": "Administrators can leverage PsExec for accessing remote systems and might pass `accepteula` as an argument if they are running this tool for the first time. However, it is not likely that you'd see multiple occurrences of this event on a machine",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_psexec_with_accepteula_flag_filter"
               }
            ],
            "name": "Detect PsExec With accepteula Flag",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = PsExec.exe Processes.process = \"*accepteula*\" by Processes.process_name Processes.dest  Processes.parent_process_name | `drop_dm_object_name(Processes)`| `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `detect_psexec_with_accepteula_flag_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1",
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1059.003",
                  "T1059.001"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Command Shell",
                  "PowerShell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2018-12-14",
            "description": "The search looks for file writes with extensions consistent with a SamSam ransomware attack.",
            "how_to_implement": "You must be ingesting data that records file-system activity from your hosts to populate the Endpoint file-system data-model node. If you are using Sysmon, you will need a Splunk Universal Forwarder on each endpoint from which you want to collect data.",
            "id": "02c6cfc2-ae66-4735-bfc7-6291da834cbf",
            "known_false_positives": "Because these extensions are not typically used in normal operations, you should investigate all results.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "file_with_samsam_extension_filter"
               }
            ],
            "name": "File with Samsam Extension",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.file_name | `drop_dm_object_name(Filesystem)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)`| rex field=file_name \"(?<file_extension>\\.[^\\.]+)$\" | search file_extension=.stubbin OR file_extension=.berkshire OR file_extension=.satoshi OR file_extension=.sophos OR file_extension=.keyxml | `file_with_samsam_extension_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2017-09-15",
                  "description": "This search takes the existing interesting process table from ES, filters out any existing additions added by ESCU and then updates the table with processes identified by ESCU that should be prohibited on your endpoints.",
                  "how_to_implement": "This search should be run on each new install of ESCU.",
                  "id": "251930a5-1451-4428-bb13-eed5775be0ce",
                  "name": "Add Prohibited Processes to Enterprise Security",
                  "search": "| inputlookup interesting_processes_lookup | search note!=ESCU* | inputlookup append=T prohibitedProcesses_lookup | fillnull value=* dest dest_pci_domain | fillnull value=false is_required is_secure | fillnull value=true is_prohibited | outputlookup interesting_processes_lookup | stats count",
                  "tags": {
                     "analytics_story": [
                        "Emotet Malware  DHS Report TA18-201A ",
                        "Monitor for Unauthorized Software",
                        "SamSam Ransomware"
                     ],
                     "detections": [
                        "Prohibited Software On Endpoint"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2019-10-11",
            "description": "This search looks for applications on the endpoint that you have marked as prohibited.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model in the processes node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is usually generated via logs that report process tracking in your Windows audit settings. In addition, you must also have only the `process_name` (not the entire process path) marked as \"prohibited\" in the Enterprise Security `interesting processes` table. To include the process names marked as \"prohibited\", which is included with ES Content Updates, run the included search <code>Add Prohibited Processes to Enterprise Security</code>.",
            "id": "a51bfe1a-94f0-48cc-b4e4-b6ae50145893",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "definition": "lookup interesting_processes_lookup app as process_name OUTPUT is_prohibited | search is_prohibited=True",
                  "description": "This macro limits the output to process_names that have been marked as prohibited",
                  "name": "prohibited_softwares"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "prohibited_software_on_endpoint_filter"
               }
            ],
            "name": "Prohibited Software On Endpoint",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.dest Processes.user Processes.process_name | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `prohibited_softwares` | `prohibited_software_on_endpoint_filter`",
            "tags": {
               "analytics_story": [
                  "Monitor for Unauthorized Software",
                  "Emotet Malware  DHS Report TA18-201A ",
                  "SamSam Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Jose Hernandez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for RDP application network traffic and filters any source/destination pair generating more than twice the standard deviation of the average traffic.",
            "how_to_implement": "You must ensure that your network traffic data is populating the Network_Traffic data model.",
            "id": "a98727cc-286b-4ff2-b898-41df64695923",
            "known_false_positives": "RDP gateways may have unusually high amounts of traffic from all other hosts' RDP applications in the network.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_desktop_network_bruteforce_filter"
               }
            ],
            "name": "Remote Desktop Network Bruteforce",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.app=rdp by All_Traffic.src All_Traffic.dest All_Traffic.dest_port | eventstats stdev(count) AS stdev avg(count) AS avg p50(count) AS p50 | where count>(avg + stdev*2) | rename All_Traffic.src AS src All_Traffic.dest AS dest | table firstTime lastTime src dest count avg p50 stdev | `remote_desktop_network_bruteforce_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 12",
                  "CIS 9",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Reconnaissance",
                  "Delivery"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "TEMP.Veles",
                  "Leviathan",
                  "APT39",
                  "Stolen Pencil",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "FIN8",
                  "APT3",
                  "OilRig",
                  "menuPass",
                  "FIN10",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "APT1",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1021.001"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Remote Desktop Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-07",
            "description": "This search looks for network traffic on TCP/3389, the default port used by remote desktop. While remote desktop traffic is not uncommon on a network, it is usually associated with known hosts. This search allows for whitelisting both source and destination hosts to remove them from the output of the search so you can focus on the uncommon uses of remote desktop on your network.",
            "how_to_implement": "To successfully implement this search you need to identify systems that commonly originate remote desktop traffic and that commonly receive remote desktop traffic. You can use the included support search \"Identify Systems Creating Remote Desktop Traffic\" to identify systems that originate the traffic and the search \"Identify Systems Receiving Remote Desktop Traffic\" to identify systems that receive a lot of remote desktop traffic. After identifying these systems, you will need to add the \"common_rdp_source\" or \"common_rdp_destination\" category to that system depending on the usage, using the Enterprise Security Assets and Identities framework.  This can be done by adding an entry in the assets.csv file located in SA-IdentityManagement/lookups.",
            "id": "272b8407-842d-4b3d-bead-a704584003d3",
            "known_false_positives": "Remote Desktop may be used legitimately by users on the network.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_desktop_network_traffic_filter"
               }
            ],
            "name": "Remote Desktop Network Traffic",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.dest_port=3389 AND All_Traffic.dest_category!=common_rdp_destination AND All_Traffic.src_category!=common_rdp_source by All_Traffic.src All_Traffic.dest All_Traffic.dest_port | `drop_dm_object_name(\"All_Traffic\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `remote_desktop_network_traffic_filter` ",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "Hidden Cobra Malware",
                  "Lateral Movement"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 9",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "TEMP.Veles",
                  "Leviathan",
                  "APT39",
                  "Stolen Pencil",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "FIN8",
                  "APT3",
                  "OilRig",
                  "menuPass",
                  "FIN10",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "APT1",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1021.001"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Remote Desktop Protocol"
               ],
               "nist": [
                  "DE.AE",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2018-12-14",
            "description": "The search looks for a file named \"test.txt\" written to the windows system directory tree, which is consistent with Samsam propagation.",
            "how_to_implement": "You must be ingesting data that records the file-system activity from your hosts to populate the Endpoint file-system data-model node. If you are using Sysmon, you will need a Splunk Universal Forwarder on each endpoint from which you want to collect data.",
            "id": "69c12d59-d951-431e-ab77-ec426b8d65e6",
            "known_false_positives": "No false positives have been identified.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "samsam_test_file_write_filter"
               }
            ],
            "name": "Samsam Test File Write",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_name) as file_name from datamodel=Endpoint.Filesystem where Filesystem.file_path=*\\\\windows\\\\system32\\\\test.txt by Filesystem.file_path | `drop_dm_object_name(Filesystem)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `samsam_test_file_write_filter`",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "The search looks for a sharp increase in the number of files written to a particular host",
            "how_to_implement": "In order to implement this search, you must populate the Endpoint file-system data model node. This is typically populated via endpoint detection and response products, such as Carbon Black or endpoint data sources such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the file system.",
            "id": "fdb0f805-74e4-4539-8c00-618927333aae",
            "known_false_positives": "It is important to understand that if you happen to install any new applications on your hosts or are copying a large number of files, you can expect to see a large increase of file modifications.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "spike_in_file_writes_filter"
               }
            ],
            "name": "Spike in File Writes",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem where Filesystem.action=created by _time span=1h, Filesystem.dest | `drop_dm_object_name(Filesystem)` | eventstats max(_time) as maxtime | stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, \"-1d@d\"), count, null))) as \"count\" avg(eval(if(_time<relative_time(maxtime, \"-1d@d\"), count,null))) as avg stdev(eval(if(_time<relative_time(maxtime, \"-1d@d\"), count, null))) as stdev by \"dest\" | eval upperBound=(avg+stdev*4), isOutlier=if((count > upperBound) AND num_data_samples >=20, 1, 0) | search isOutlier=1 | `spike_in_file_writes_filter` ",
            "tags": {
               "analytics_story": [
                  "SamSam Ransomware",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "c4b89506-fbcf-4cb7-bfd6-527e54789604",
      "name": "SamSam Ransomware",
      "narrative": "The first version of the SamSam ransomware (a.k.a. Samas or SamsamCrypt) was launched in 2015 by a group of Iranian threat actors. The malicious software has affected and continues to affect thousands of victims and has raised almost $6M in ransom.\\\nAlthough categorized under the heading of ransomware, SamSam campaigns have some importance distinguishing characteristics. Most notable is the fact that conventional ransomware is a numbers game. Perpetrators use a \"spray-and-pray\" approach with phishing campaigns or other mechanisms, charging a small ransom (typically under $1,000). The goal is to find a large number of victims willing to pay these mini-ransoms, adding up to a lucrative payday. They use relatively simple methods for infecting systems.\\\nSamSam attacks are different beasts. They have become progressively more targeted and skillful than typical ransomware attacks. First, malicious actors break into a victim's network, surveil it, then run the malware manually. The attacks are tailored to cause maximum damage and the threat actors usually demand amounts in the tens of thousands of dollars.\\\nIn a typical attack on one large healthcare organization in 2018, the company ended up paying a ransom of four Bitcoins, then worth $56,707. Reports showed that access to the company's files was restored within two hours of paying the sum.\\\nAccording to Sophos, SamSam previously leveraged  RDP to gain access to targeted networks via brute force. SamSam is not spread automatically, like other malware. It requires skill because it forces the attacker to adapt their tactics to the individual environment. Next, the actors escalate their privileges to admin level. They scan the networks for worthy targets, using conventional tools, such as PsExec or PaExec, to deploy/execute, quickly encrypting files.\\\nThis Analytic Story includes searches designed to help detect and investigate signs of the SamSam ransomware, such as the creation of fileswrites to system32, writes with tell-tale extensions, batch files written to system32, and evidence of brute-force attacks via RDP.",
      "references": [
         "https://www.crowdstrike.com/blog/an-in-depth-analysis-of-samsam-ransomware-and-boss-spider/",
         "https://nakedsecurity.sophos.com/2018/07/31/samsam-the-almost-6-million-ransomware/",
         "https://thehackernews.com/2018/07/samsam-ransomware-attacks.html"
      ],
      "tags": {
         "analytics_story": "SamSam Ransomware",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "Sowbug",
            "TEMP.Veles",
            "Cobalt Group",
            "APT1",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "Kimsuky",
            "admin@338",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Thrip",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "APT32",
            "Suckfly",
            "FIN10",
            "Dark Caracal",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "TA459",
            "Magic Hound",
            "Axiom",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "APT38",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "Gallmaker",
            "Stolen Pencil",
            "APT33",
            "Blue Mockingbird",
            "Rocke",
            "APT18",
            "APT28",
            "Soft Cell",
            "FIN6",
            "Deep Panda",
            "Tropic Trooper",
            "Patchwork",
            "Threat Group-1314",
            "DarkVishnya",
            "DarkHydrus",
            "Poseidon Group",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1059.001",
            "T1021.001",
            "T1485",
            "T1082",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Discovery",
            "Impact",
            "Lateral Movement"
         ],
         "mitre_attack_technique": [
            "System Information Discovery",
            "Data Destruction",
            "Windows Command Shell",
            "PowerShell",
            "Remote Desktop Protocol"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2018-01-08",
      "description": "Assess and mitigate your systems' vulnerability to Spectre and Meltdown exploitation with the searches in this Analytic Story.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-01-08",
                  "description": "Some AV applications can cause the Spectre/Meltdown patch for Windows not to install successfully. This registry key is supposed to be created by the AV engine when it has been patched to be able to handle the Windows patch. If this key has been written, the system can then be patched for Spectre and Meltdown.",
                  "how_to_implement": "You need to be ingesting logs with both the process name and command-line from your endpoints. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd61",
                  "name": "Systems Ready for Spectre-Meltdown Windows Patch",
                  "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Change_Analysis.All_Changes where All_Changes.object_category=registry AND (All_Changes.object_path=\"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\QualityCompat*\") by All_Changes.dest, All_Changes.command, All_Changes.user, All_Changes.object, All_Changes.object_path | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(\"All_Changes\")`",
                  "tags": {
                     "analytics_story": [
                        "Spectre And Meltdown Vulnerabilities"
                     ],
                     "detections": [
                        "Spectre and Meltdown Vulnerable Systems"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2017-01-07",
            "description": "The search is used to detect systems that are still vulnerable to the Spectre and Meltdown vulnerabilities.",
            "how_to_implement": "The search requires that you are ingesting your vulnerability-scanner data and that it reports the CVE of the vulnerability identified.",
            "id": "354be8e0-32cd-4da0-8c47-796de13b60ea",
            "known_false_positives": "It is possible that your vulnerability scanner is not detecting that the patches have been applied.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "spectre_and_meltdown_vulnerable_systems_filter"
               }
            ],
            "name": "Spectre and Meltdown Vulnerable Systems",
            "references": [],
            "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Vulnerabilities where Vulnerabilities.cve =\"CVE-2017-5753\" OR Vulnerabilities.cve =\"CVE-2017-5715\" OR Vulnerabilities.cve =\"CVE-2017-5754\" by Vulnerabilities.dest | `drop_dm_object_name(Vulnerabilities)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `spectre_and_meltdown_vulnerable_systems_filter`",
            "tags": {
               "analytics_story": [
                  "Spectre And Meltdown Vulnerabilities"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 4"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.RA",
                  "RS.MI",
                  "PR.IP",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "6d3306f6-bb2b-4219-8609-8efad64032f2",
      "name": "Spectre And Meltdown Vulnerabilities",
      "narrative": "Meltdown and Spectre exploit critical vulnerabilities in modern CPUs that allow unintended access to data in memory. This Analytic Story will help you identify the systems can be patched for these vulnerabilities, as well as those that still need to be patched.",
      "references": [
         "https://meltdownattack.com/"
      ],
      "tags": {
         "analytics_story": "Spectre And Meltdown Vulnerabilities",
         "category": [
            "Vulnerability"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2017-09-19",
      "description": "Keeping your Splunk deployment up to date is critical and may help you reduce the risk of CVE-2016-4859, an open-redirection vulnerability within some older versions of Splunk Enterprise. The detection search will help ensure that users are being properly authenticated and not being redirected to malicious domains.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-19",
            "description": "This search allows you to look for evidence of exploitation for CVE-2016-4859, the Splunk Open Redirect Vulnerability.",
            "how_to_implement": "No extra steps needed to implement this search.",
            "id": "d199fb99-2312-451a-9daa-e5efa6ed76a7",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "open_redirect_in_splunk_web_filter"
               }
            ],
            "name": "Open Redirect in Splunk Web",
            "references": [],
            "search": "index=_internal sourcetype=splunk_web_access return_to=\"/%09/*\" | `open_redirect_in_splunk_web_filter`",
            "tags": {
               "analytics_story": [
                  "Splunk Enterprise Vulnerability"
               ],
               "asset_type": "Splunk Server",
               "cis20": [
                  "CIS 3",
                  "CIS 4",
                  "CIS 18"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.RA",
                  "RS.MI",
                  "PR.PT",
                  "PR.AC",
                  "PR.IP",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "4e692b96-de2d-4bd1-9105-37e2368a8db1",
      "name": "Splunk Enterprise Vulnerability",
      "narrative": "This Analytic Story is associated with CVE-2016-4859, an open-redirect vulnerability in the following versions of Splunk Enterprise:\\\n\\\n1. Splunk Enterprise 6.4.x, prior to 6.4.3\\\n1. Splunk Enterprise 6.3.x, prior to 6.3.6\\\n1. Splunk Enterprise 6.2.x, prior to 6.2.10\\\n1. Splunk Enterprise 6.1.x, prior to 6.1.11\\\n1. Splunk Enterprise 6.0.x, prior to 6.0.12\\\n1. Splunk Enterprise 5.0.x, prior to 5.0.16\\\n1. Splunk Light, prior to 6.4.3CVE-2016-4859 allows attackers to redirect users to arbitrary web sites and conduct phishing attacks via unspecified vectors. (Credit: Noriaki Iwasaki, Cyber Defense Institute, Inc.).\\\nIt is important to ensure that your Splunk deployment is being kept up to date and is properly configured. This detection search allows analysts to monitor internal logs to ensure users are properly authenticated and cannot be redirected to any malicious third-party websites.",
      "references": [
         "http://www.splunk.com/view/SP-CAAAPQ6#announce",
         "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-4859"
      ],
      "tags": {
         "analytics_story": "Splunk Enterprise Vulnerability",
         "category": [
            "Vulnerability"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2018-06-14",
      "description": "Reduce the risk of CVE-2018-11409, an information disclosure vulnerability within some older versions of Splunk Enterprise, with searches designed to help ensure that your Splunk system does not leak information to authenticated users.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2018-06-14",
            "description": "This search allows you to look for evidence of exploitation for CVE-2018-11409, a Splunk Enterprise Information Disclosure Bug.",
            "how_to_implement": "The REST endpoint that exposes system information is also necessary for the proper operation of Splunk clustering and instrumentation. Whitelisting your Splunk systems will reduce false positives.",
            "id": "f6a26b7b-7e80-4963-a9a8-d836e7534ebd",
            "known_false_positives": "Retrieving server information may be a legitimate API request. Verify that the attempt is a valid request for information.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "splunk_enterprise_information_disclosure_filter"
               }
            ],
            "name": "Splunk Enterprise Information Disclosure",
            "references": [],
            "search": "index=_internal sourcetype=splunkd_ui_access server-info | search clientip!=127.0.0.1 uri_path=\"*raw/services/server/info/server-info\" | rename clientip as src_ip, splunk_server as dest | stats earliest(_time) as firstTime, latest(_time) as lastTime, values(uri) as uri, values(useragent) as http_user_agent, values(user) as user by src_ip, dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `splunk_enterprise_information_disclosure_filter`",
            "tags": {
               "analytics_story": [
                  "Splunk Enterprise Vulnerability CVE-2018-11409"
               ],
               "asset_type": "Splunk Server",
               "cis20": [
                  "CIS 3",
                  "CIS 4",
                  "CIS 18"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.RA",
                  "RS.MI",
                  "PR.PT",
                  "PR.AC",
                  "PR.IP",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "1fc34cbc-34e9-43ba-87ab-6811c9e95400",
      "name": "Splunk Enterprise Vulnerability CVE-2018-11409",
      "narrative": "Although there have been no reports of it being exploited, Splunk Enterprise versions through 7.0.1 reportedly have a vulnerability that may expose information through a REST endpoint (read more here: https://www.splunk.com/view/SP-CAAAP5E#VulnerabilityDescriptionsandRatings). NIST has included it in its vulnerability database (read more here: https://nvd.nist.gov/vuln/detail/CVE-2018-11409). The REST endpoint that exposes system information is also necessary for the proper operation of Splunk clustering and instrumentation. Customers should upgrade to the latest version to reduce the risk of this vulnerability.\\\nSplunk Enterprise exposes partial information about the host operating system, hardware, and Splunk license. Splunk Enterprise before 6.6.0 exposes this information without authentication. Splunk Enterprise 6.6.0 and later exposes this information only to authenticated Splunk users. Based on the information exposure, Splunk characterizes this issue as a low severity impact.\\\nRead more in Splunk's official response: https://www.splunk.com/view/SP-CAAAP5E#VulnerabilityDescriptionsandRatings.\\\nA detection search within this Analytic Story looks for vulnerabilities described in CVE-2018-11409: Information Exposure (https://nvd.nist.gov/vuln/detail/CVE-2018-11409). If it turns up activities that may be specific, you can use the included investigative searches to return information regarding web activity and network traffic by src_ip.",
      "references": [
         "https://nvd.nist.gov/vuln/detail/CVE-2018-11409",
         "https://www.splunk.com/view/SP-CAAAP5E#VulnerabilityDescriptionsandRatings",
         "https://www.exploit-db.com/exploits/44865/"
      ],
      "tags": {
         "analytics_story": "Splunk Enterprise Vulnerability CVE-2018-11409",
         "category": [
            "Vulnerability"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2017-09-19",
      "description": "Use the searches in this Analytic Story to help you detect structured query language (SQL) injection attempts characterized by long URLs that contain malicious parameters.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for long URLs that have several SQL commands visible within them.",
            "how_to_implement": "To successfully implement this search, you need to be monitoring network communications to your web servers or ingesting your HTTP logs and populating the Web data model. You must also identify your web servers in the Enterprise Security assets table.",
            "id": "e0aad4cf-0790-423b-8328-7564d0d938f9",
            "known_false_positives": "It's possible that legitimate traffic will have long URLs or long user agent strings and that common SQL commands may be found within the URL. Please investigate as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "sql_injection_with_long_urls_filter"
               }
            ],
            "name": "SQL Injection with Long URLs",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Web where Web.dest_category=web_server AND (Web.url_length > 1024 OR Web.http_user_agent_length > 200) by Web.src Web.dest Web.url Web.url_length Web.http_user_agent | `drop_dm_object_name(\"Web\")` | eval num_sql_cmds=mvcount(split(url, \"alter%20table\")) + mvcount(split(url, \"between\")) + mvcount(split(url, \"create%20table\")) + mvcount(split(url, \"create%20database\")) + mvcount(split(url, \"create%20index\")) + mvcount(split(url, \"create%20view\")) + mvcount(split(url, \"delete\")) + mvcount(split(url, \"drop%20database\")) + mvcount(split(url, \"drop%20index\")) + mvcount(split(url, \"drop%20table\")) + mvcount(split(url, \"exists\")) + mvcount(split(url, \"exec\")) + mvcount(split(url, \"group%20by\")) + mvcount(split(url, \"having\")) + mvcount(split(url, \"insert%20into\")) + mvcount(split(url, \"inner%20join\")) + mvcount(split(url, \"left%20join\")) + mvcount(split(url, \"right%20join\")) + mvcount(split(url, \"full%20join\")) + mvcount(split(url, \"select\")) + mvcount(split(url, \"distinct\")) + mvcount(split(url, \"select%20top\")) + mvcount(split(url, \"union\")) + mvcount(split(url, \"xp_cmdshell\")) - 24 | where num_sql_cmds > 3 | `sql_injection_with_long_urls_filter`",
            "tags": {
               "analytics_story": [
                  "SQL Injection"
               ],
               "asset_type": "Database Server",
               "cis20": [
                  "CIS 4",
                  "CIS 13",
                  "CIS 18"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Rocke",
                  "APT39",
                  "BlackTech",
                  "APT41",
                  "Soft Cell",
                  "Night Dragon",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1190"
               ],
               "mitre_attack_tactics": [
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Exploit Public-Facing Application"
               ],
               "nist": [
                  "PR.DS",
                  "ID.RA",
                  "PR.PT",
                  "PR.IP",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "4f6632f5-449c-4686-80df-57625f59bab3",
      "name": "SQL Injection",
      "narrative": "It is very common for attackers to inject SQL parameters into vulnerable web applications, which then interpret the malicious SQL statements.\\\nThis Analytic Story contains a search designed to identify attempts by attackers to leverage this technique to compromise a host and gain a foothold in the target environment.",
      "references": [
         "https://capec.mitre.org/data/definitions/66.html",
         "https://www.incapsula.com/web-application-security/sql-injection.html"
      ],
      "tags": {
         "analytics_story": "SQL Injection",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Axiom",
            "Blue Mockingbird",
            "BlackTech",
            "APT41",
            "Rocke",
            "Soft Cell",
            "Night Dragon",
            "APT39"
         ],
         "mitre_attack_id": [
            "T1190"
         ],
         "mitre_attack_tactics": [
            "Initial Access"
         ],
         "mitre_attack_technique": [
            "Exploit Public-Facing Application"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2018-02-09",
      "description": "Use the searches in this Analytic Story to monitor your AWS EC2 instances for evidence of anomalous activity and suspicious behaviors, such as EC2 instances that originate from unusual locations or those launched by previously unseen users (among others). Included investigative searches will help you probe more deeply, when the information warrants it.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for CloudTrail events where a user successfully launches an abnormally high number of instances.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. The threshold value should be tuned to your environment.",
            "id": "2a9b80d3-6340-4345-b5ad-290bf5d0dac4",
            "known_false_positives": "Many service accounts configured within an AWS infrastructure are known to exhibit this behavior. Please adjust the threshold values and filter out service accounts from the output. Always verify if this search alerted on a human user.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "abnormally_high_aws_instances_launched_by_user_filter"
               }
            ],
            "name": "Abnormally High AWS Instances Launched by User",
            "references": [],
            "search": "`cloudtrail` eventName=RunInstances errorCode=success | bucket span=10m _time | stats count AS instances_launched by _time userName | eventstats avg(instances_launched) as total_launched_avg, stdev(instances_launched) as total_launched_stdev | eval threshold_value = 4 | eval isOutlier=if(instances_launched > total_launched_avg+(total_launched_stdev * threshold_value), 1, 0) | search isOutlier=1 AND _time >= relative_time(now(), \"-10m@m\") | eval num_standard_deviations_away = round(abs(instances_launched - total_launched_avg) / total_launched_stdev, 2) | table _time, userName, instances_launched, num_standard_deviations_away, total_launched_avg, total_launched_stdev | `abnormally_high_aws_instances_launched_by_user_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cryptomining",
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Jason Brewer, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2019-11-14",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model for how many RunInstances users do in the environment. By default, the search uses the last 90 days of data to build the model. The model created by this search is then used in the corresponding detection search, which identifies subsequent outliers in the number of RunInstances performed by a user in a small time window.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs.\\\nIn addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. Depending on the number of users in your environment, you may also need to adjust the value for max_inputs in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data.\\\nMore information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "fa5634df-fb05-4b4b-aba0-6115138bb1ba",
                  "name": "Baseline of Excessive AWS Instances Launched by User - MLTK",
                  "search": "`cloudtrail` eventName=RunInstances errorCode=success `ec2_excessive_runinstances_mltk_input_filter` | bucket span=10m _time | stats count as instances_launched by _time src_user | fit DensityFunction instances_launched threshold=0.0005 into ec2_excessive_runinstances_v1",
                  "tags": {
                     "analytics_story": [
                        "Cloud Cryptomining",
                        "Suspicious AWS EC2 Activities"
                     ],
                     "detections": [
                        "Abnormally High AWS Instances Launched by User - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for CloudTrail events where a user successfully launches an abnormally high number of instances.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. The threshold value should be tuned to your environment.",
            "id": "dec41ad5-d579-42cb-b4c6-f5dbb778bbe5",
            "known_false_positives": "Many service accounts configured within an AWS infrastructure are known to exhibit this behavior. Please adjust the threshold values and filter out service accounts from the output. Always verify if this search alerted on a human user.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "abnormally_high_aws_instances_launched_by_user___mltk_filter"
               }
            ],
            "name": "Abnormally High AWS Instances Launched by User - MLTK",
            "references": [],
            "search": "`cloudtrail` eventName=RunInstances errorCode=success `abnormally_high_aws_instances_launched_by_user___mltk_filter` | bucket span=10m _time  | stats count as instances_launched by _time src_user  | apply ec2_excessive_runinstances_v1  | rename \"IsOutlier(instances_launched)\" as isOutlier  | where isOutlier=1",
            "tags": {
               "analytics_story": [
                  "Cloud Cryptomining",
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for CloudTrail events where an abnormally high number of instances were successfully terminated by a user in a 10-minute window",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs.",
            "id": "ada0f478-84a8-4641-s3f3-d82362dffd75",
            "known_false_positives": "Many service accounts configured with your AWS infrastructure are known to exhibit this behavior. Please adjust the threshold values and filter out service accounts from the output. Always verify whether this search alerted on a human user.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "abnormally_high_aws_instances_terminated_by_user_filter"
               }
            ],
            "name": "Abnormally High AWS Instances Terminated by User",
            "references": [],
            "search": "`cloudtrail` eventName=TerminateInstances errorCode=success | bucket span=10m _time | stats count AS instances_terminated by _time userName | eventstats avg(instances_terminated) as total_terminations_avg, stdev(instances_terminated) as total_terminations_stdev | eval threshold_value = 4 | eval isOutlier=if(instances_terminated > total_terminations_avg+(total_terminations_stdev * threshold_value), 1, 0) | search isOutlier=1 AND _time >= relative_time(now(), \"-10m@m\")| eval num_standard_deviations_away = round(abs(instances_terminated - total_terminations_avg) / total_terminations_stdev, 2) |table _time, userName, instances_terminated, num_standard_deviations_away, total_terminations_avg, total_terminations_stdev | `abnormally_high_aws_instances_terminated_by_user_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Jason Brewer, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2019-11-14",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model for how many TerminateInstances users do in the environment. By default, the search uses the last 90 days of data to build the model. The model created by this search is then used in the corresponding detection search, which identifies subsequent outliers in the number of TerminateInstances performed by a user in a small time window.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs.\\\nIn addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. Depending on the number of users in your environment, you may also need to adjust the value for max_inputs in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data.\\\nMore information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "b28ed6de-e4ba-40f7-ae0a-93a088c774ab",
                  "name": "Baseline of Excessive AWS Instances Terminated by User - MLTK",
                  "search": "`cloudtrail` eventName=TerminateInstances errorCode=success `ec2_excessive_terminateinstances_mltk_input_filter` | bucket span=10m _time | stats count as instances_terminated by _time src_user | fit DensityFunction instances_terminated threshold=0.0005 into ec2_excessive_terminateinstances_v1",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS EC2 Activities"
                     ],
                     "detections": [
                        "Abnormally High AWS Instances Terminated by User - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for CloudTrail events where a user successfully terminates an abnormally high number of instances.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. The threshold value should be tuned to your environment.",
            "id": "1c02b86a-cd85-473e-a50b-014a9ac8fe3e",
            "known_false_positives": "Many service accounts configured within an AWS infrastructure are known to exhibit this behavior. Please adjust the threshold values and filter out service accounts from the output. Always verify if this search alerted on a human user.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "abnormally_high_aws_instances_terminated_by_user___mltk_filter"
               }
            ],
            "name": "Abnormally High AWS Instances Terminated by User - MLTK",
            "references": [],
            "search": "`cloudtrail` eventName=TerminateInstances errorCode=success `abnormally_high_aws_instances_terminated_by_user___mltk_filter` | bucket span=10m _time  | stats count as instances_terminated by _time src_user  | apply ec2_excessive_terminateinstances_v1  | rename \"IsOutlier(instances_terminated)\" as isOutlier  | where isOutlier=1",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-01-08",
                  "description": "This search looks for CloudTrail events where an AWS instance is started and creates a baseline of most recent time (latest) and the first time (earliest) we've seen this region in our dataset grouped by the value awsRegion for the last 30 days",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd63",
                  "name": "Previously Seen AWS Regions",
                  "search": "`cloudtrail` StartInstances | stats earliest(_time) as earliest latest(_time) as latest by awsRegion | outputlookup previously_seen_aws_regions.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Cryptomining",
                        "Suspicious AWS EC2 Activities"
                     ],
                     "detections": [
                        "EC2 Instance Started In Previously Unseen Region"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-02-23",
            "description": "This search looks for CloudTrail events where an instance is started in a particular region in the last one hour and then compares it to a lookup file of previously seen regions where an instance was started",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the \"Previously seen AWS Regions\" support search only once to create of baseline of previously seen regions.",
            "id": "ada0f478-84a8-4641-a3f3-d82362d6fd75",
            "known_false_positives": "It's possible that a user has unknowingly started an instance in a new region. Please verify that this activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "ec2_instance_started_in_previously_unseen_region_filter"
               }
            ],
            "name": "EC2 Instance Started In Previously Unseen Region",
            "references": [],
            "search": "`cloudtrail` earliest=-1h StartInstances | stats earliest(_time) as earliest latest(_time) as latest by awsRegion | inputlookup append=t previously_seen_aws_regions.csv | stats min(earliest) as earliest max(latest) as latest by awsRegion | outputlookup previously_seen_aws_regions.csv | eval regionStatus=if(earliest >= relative_time(now(),\"-1d@d\"), \"Instance Started in a New Region\",\"Previously Seen Region\") | `security_content_ctime(earliest)` | `security_content_ctime(latest)` | where regionStatus=\"Instance Started in a New Region\" | `ec2_instance_started_in_previously_unseen_region_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cryptomining",
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-03-15",
                  "description": "This search builds a table of previously seen ARNs that have launched a EC2 instance.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "6c767ac0-0906-4355-9a83-927f5ee7bdad",
                  "name": "Previously Seen EC2 Launches By User",
                  "search": "`cloudtrail` eventName=RunInstances errorCode=success | rename userIdentity.arn as arn | stats earliest(_time) as firstTime latest(_time) as lastTime by arn | outputlookup previously_seen_ec2_launches_by_user.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Cryptomining",
                        "Suspicious AWS EC2 Activities"
                     ],
                     "detections": [
                        "EC2 Instance Started With Previously Unseen User"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for EC2 instances being created by users who have not created them before.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously Seen EC2 Launches By User\" support search once to create a history of previously seen ARNs.",
            "id": "22773e84-bac0-4595-b086-20d3f735b4f1",
            "known_false_positives": "It's possible that a user will start to create EC2 instances when they haven't before for any number of reasons. Verify with the user that is launching instances that this is the intended behavior.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "ec2_instance_started_with_previously_unseen_user_filter"
               }
            ],
            "name": "EC2 Instance Started With Previously Unseen User",
            "references": [],
            "search": "`cloudtrail` eventName=RunInstances [search `cloudtrail` eventName=RunInstances errorCode=success | stats earliest(_time) as firstTime latest(_time) as lastTime by userIdentity.arn | rename userIdentity.arn as arn | inputlookup append=t previously_seen_ec2_launches_by_user.csv | stats min(firstTime) as firstTime, max(lastTime) as lastTime by arn | outputlookup previously_seen_ec2_launches_by_user.csv | eval newUser=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newUser=1 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename arn as userIdentity.arn | table userIdentity.arn] | rename requestParameters.instanceType as instanceType, responseElements.instancesSet.items{}.instanceId as dest, userIdentity.arn as user | table _time, user, dest, instanceType | `ec2_instance_started_with_previously_unseen_user_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Cryptomining",
                  "Suspicious AWS EC2 Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "2e8948a5-5239-406b-b56b-6c50f1268af3",
      "name": "Suspicious AWS EC2 Activities",
      "narrative": "AWS CloudTrail is an AWS service that helps you enable governance, compliance, and risk auditing within your AWS account. Actions taken by a user, role, or an AWS service are recorded as events in CloudTrail. It is crucial for a company to monitor events and actions taken in the AWS Console, AWS command-line interface, and AWS SDKs and APIs to ensure that your EC2 instances are not vulnerable to attacks. This Analytic Story identifies suspicious activities in your AWS EC2 instances and helps you respond and investigate those activities.",
      "references": [
         "https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf"
      ],
      "tags": {
         "analytics_story": "Suspicious AWS EC2 Activities",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "APT33",
            "no"
         ],
         "mitre_attack_id": [
            "T1535",
            "T1078.004"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Cloud Accounts",
            "Unused/Unsupported Cloud Regions"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2019-05-01",
      "description": "Monitor your AWS authentication events using your CloudTrail logs. Searches within this Analytic Story will help you stay aware of and investigate suspicious logins. ",
      "detections": [
         {
            "author": "Jason Brewer, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last 30 days.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd03",
                  "name": "Previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) as firstTime latest(_time) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by username, within the last 30 days.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "0a87ecf9-dc6a-43af-861a-205e75a09bf5",
                  "name": "Previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src | iplocation Authentication.src | rename Authentication.user as user Authentication.src as src | table user src City Region Country firstTime lastTime | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last hour.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "06c036e6-d6d7-4daa-bd76-411c3d356031",
                  "name": "Update previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) AS firstTime latest(_time) AS lastTime by user src City Region Country | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by user, within the last hour.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "66ff71c2-7e01-47dd-a041-906688c9d322",
                  "name": "Update previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authenticaiton.src | iplocation Authentication.src | rename Authentication.user as user Authentciation.src as src | table user src City Region Country firstTime lastTime | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-04-30",
            "description": "This search looks for CloudTrail events wherein a console login event by a user was recorded within the last hour, then compares the event to a lookup file of previously seen users (by ARN values) who have logged into the console. The alert is fired if the user has logged into the console for the first time within the last hour",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the \"Previously seen users in CloudTrail\" support search only once to create a baseline of previously seen IAM users within the last 30 days. Run \"Update previously seen users in CloudTrail\" hourly (or more frequently depending on how often you run the detection searches) to refresh the baselines.",
            "id": "121b0b11-f8ac-4ed6-a132-3800ca4fc07a",
            "known_false_positives": "When a legitimate new user logins for the first time, this activity will be detected. Check how old the account is and verify that the user activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_aws_console_login_by_user_from_new_city_filter"
               }
            ],
            "name": "Detect AWS Console Login by User from New City",
            "search": "| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user City | join user type=outer [| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) AS earliestseen by user | fields earliestseen user] | eval userStatus=if(firstTime >= relative_time(now(), \"@d\"), \"New City\",\"Previously Seen City\") | eval UserData=if(earliestseen >= relative_time(now(), \"@d\") OR isnull(earliestseen), \"New User\",\"Old User\") | where userStatus=\"New City\" AND UserData=\"Old User\" | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`| `security_content_ctime(earliestseen)` | table user City userStatus firstTime lastTime earliestseen | `detect_aws_console_login_by_user_from_new_city_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS Login Activities",
                  "Suspicious Cloud Authentication Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Jason Brewer, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last 30 days.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd03",
                  "name": "Previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) as firstTime latest(_time) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by username, within the last 30 days.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "0a87ecf9-dc6a-43af-861a-205e75a09bf5",
                  "name": "Previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src | iplocation Authentication.src | rename Authentication.user as user Authentication.src as src | table user src City Region Country firstTime lastTime | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last hour.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "06c036e6-d6d7-4daa-bd76-411c3d356031",
                  "name": "Update previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) AS firstTime latest(_time) AS lastTime by user src City Region Country | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by user, within the last hour.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "66ff71c2-7e01-47dd-a041-906688c9d322",
                  "name": "Update previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authenticaiton.src | iplocation Authentication.src | rename Authentication.user as user Authentciation.src as src | table user src City Region Country firstTime lastTime | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-04-30",
            "description": "This search looks for CloudTrail events wherein a console login event by a user was recorded within the last hour, then compares the event to a lookup file of previously seen users (by ARN values) who have logged into the console. The alert is fired if the user has logged into the console for the first time within the last hour",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the \"Previously seen users in CloudTrail\" support search only once to create a baseline of previously seen IAM users within the last 30 days. Run \"Update previously seen users in CloudTrail\" hourly (or more frequently depending on how often you run the detection searches) to refresh the baselines.",
            "id": "67bd3def-c41c-4bf6-837b-ae196b4257c6",
            "known_false_positives": "When a legitimate new user logins for the first time, this activity will be detected. Check how old the account is and verify that the user activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_aws_console_login_by_user_from_new_country_filter"
               }
            ],
            "name": "Detect AWS Console Login by User from New Country",
            "search": "| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user Country | join user type=outer [| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) AS earliestseen by user | fields earliestseen user] | eval userStatus=if(firstTime >= relative_time(now(), \"@d\"), \"New Country\",\"Previously Seen Country\") | eval UserData=if(earliestseen >= relative_time(now(), \"@d\") OR isnull(earliestseen), \"New User\",\"Old User\") | where userStatus=\"New Country\" AND UserData=\"Old User\" | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`|`security_content_ctime(earliestseen)` | table user Country userStatus firstTime lastTime earliestseen | `detect_aws_console_login_by_user_from_new_country_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS Login Activities",
                  "Suspicious Cloud Authentication Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Jason Brewer, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last 30 days.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd03",
                  "name": "Previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) as firstTime latest(_time) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by username, within the last 30 days.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "0a87ecf9-dc6a-43af-861a-205e75a09bf5",
                  "name": "Previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src | iplocation Authentication.src | rename Authentication.user as user Authentication.src as src | table user src City Region Country firstTime lastTime | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last hour.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "06c036e6-d6d7-4daa-bd76-411c3d356031",
                  "name": "Update previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) AS firstTime latest(_time) AS lastTime by user src City Region Country | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by user, within the last hour.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "66ff71c2-7e01-47dd-a041-906688c9d322",
                  "name": "Update previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authenticaiton.src | iplocation Authentication.src | rename Authentication.user as user Authentciation.src as src | table user src City Region Country firstTime lastTime | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-04-30",
            "description": "This search looks for CloudTrail events wherein a console login event by a user was recorded within the last hour, then compares the event to a lookup file of previously seen users (by ARN values) who have logged into the console. The alert is fired if the user has logged into the console for the first time within the last hour",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the \"Previously seen users in CloudTrail\" support search only once to create a baseline of previously seen IAM users within the last 30 days. Run \"Update previously seen users in CloudTrail\" hourly (or more frequently depending on how often you run the detection searches) to refresh the baselines.",
            "id": "9f31aa8e-e37c-46bc-bce1-8b3be646d026",
            "known_false_positives": "When a legitimate new user logins for the first time, this activity will be detected. Check how old the account is and verify that the user activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_aws_console_login_by_user_from_new_region_filter"
               }
            ],
            "name": "Detect AWS Console Login by User from New Region",
            "search": "| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user Region | join user type=outer [| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) AS earliestseen by user | fields earliestseen user] | eval userStatus=if(firstTime >= relative_time(now(), \"@d\"), \"New Region\",\"Previously Seen Region\") | eval UserData=if(earliestseen >= relative_time(now(), \"@d\") OR isnull(earliestseen), \"New User\",\"Old User\") | where userStatus=\"New Region\" AND UserData=\"Old User\" | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `security_content_ctime(earliestseen)` | table user Region userStatus firstTime lastTime earliestseen | `detect_aws_console_login_by_user_from_new_region_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS Login Activities",
                  "Suspicious Cloud Authentication Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last 30 days.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd03",
                  "name": "Previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) as firstTime latest(_time) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last hour.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "06c036e6-d6d7-4daa-bd76-411c3d356031",
                  "name": "Update previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) AS firstTime latest(_time) AS lastTime by user src City Region Country | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for CloudTrail events wherein a console login event by a user was recorded within the last hour, then compares the event to a lookup file of previously seen users (by ARN values) who have logged into the console. The alert is fired if the user has logged into the console for the first time within the last hour",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the \"Previously seen users in CloudTrail\" support search only once to create a baseline of previously seen IAM users within the last 30 days. Run \"Update previously seen users in CloudTrail\" hourly (or more frequently depending on how often you run the detection searches) to refresh the baselines.",
            "id": "ada0f478-84a8-4641-a3f3-d82362dffd75",
            "known_false_positives": "When a legitimate new user logins for the first time, this activity will be detected. Check how old the account is and verify that the user activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_new_user_aws_console_login_filter"
               }
            ],
            "name": "Detect new user AWS Console Login",
            "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | stats earliest(_time) as firstTime latest(_time) as lastTime by user | inputlookup append=t previously_seen_users_console_logins.csv  | stats min(firstTime) as firstTime max(lastTime) as lastTime by user | eval userStatus=if(firstTime >= relative_time(now(), \"-70m@m\"), \"First Time Logging into AWS Console\",\"Previously Seen User\") | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)`| where userStatus =\"First Time Logging into AWS Console\"  | `detect_new_user_aws_console_login_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS Login Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "2e8948a5-5239-406b-b56b-6c59f1268af3",
      "name": "Suspicious AWS Login Activities",
      "narrative": "It is important to monitor and control who has access to your AWS infrastructure. Detecting suspicious logins to your AWS infrastructure will provide good starting points for investigations. Abusive behaviors caused by compromised credentials can lead to direct monetary costs, as you will be billed for any EC2 instances created by the attacker.",
      "references": [
         "https://docs.aws.amazon.com/IAM/latest/UserGuide/cloudtrail-integration.html"
      ],
      "tags": {
         "analytics_story": "Suspicious AWS Login Activities",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "APT33",
            "no"
         ],
         "mitre_attack_id": [
            "T1535",
            "T1078.004"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Cloud Accounts",
            "Unused/Unsupported Cloud Regions"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2018-07-24",
      "description": "Use the searches in this Analytic Story to monitor your AWS S3 buckets for evidence of anomalous activity and suspicious behaviors, such as detecting open S3 buckets and buckets being accessed from a new IP. The contextual and investigative searches will give you more information, when required.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2018-07-25",
            "description": "This search looks for CloudTrail events where a user has created an open/public S3 bucket.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), and then configure your CloudTrail inputs. The threshold value should be tuned to your environment.",
            "id": "2a9b80d3-6340-4345-b5ad-290bf3d0dac4",
            "known_false_positives": "While this search has no known false positives, it is possible that an AWS admin has legitimately created a public bucket for a specific purpose. That said, AWS strongly advises against granting full control to the \"All Users\" group.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_new_open_s3_buckets_filter"
               }
            ],
            "name": "Detect New Open S3 buckets",
            "references": [],
            "search": "`cloudtrail` AllUsers eventName=PutBucketAcl | spath output=userIdentityArn path=userIdentity.arn | spath output=bucketName path=requestParameters.bucketName | spath output=aclControlList path=requestParameters.AccessControlPolicy.AccessControlList | spath input=aclControlList output=grantee path=Grant{} | mvexpand grantee | spath input=grantee | search Grantee.URI=*AllUsers | rename userIdentityArn as user| table _time, src,awsRegion Permission, Grantee.URI, bucketName, user | `detect_new_open_s3_buckets_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS S3 Activities"
               ],
               "asset_type": "S3 Bucket",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1530"
               ],
               "mitre_attack_tactics": [
                  "Collection"
               ],
               "mitre_attack_technique": [
                  "Data from Cloud Storage Object"
               ],
               "nist": [
                  "PR.DS",
                  "PR.AC",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-06-28",
                  "description": "This search looks for successful access to S3 buckets from remote IP addresses, then creates a baseline of the earliest and latest times we have encountered this remote IP within the last 30 days. In this support search, we are only looking for S3 access events where the HTTP response code from AWS is \"200\"",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your S3 access-logs inputs. You must validate the remote IP and bucket name entries in `previously_seen_S3_access_from_remote_ip.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "fc0edc15-fq2c-48b0-9f6f-63qa1281fd03",
                  "name": "Previously seen S3 bucket access by remote IP",
                  "search": "`aws_s3_accesslogs` http_status=200  | stats  earliest(_time) as earliest latest(_time) as latest by bucket_name remote_ip | outputlookup previously_seen_S3_access_from_remote_ip | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS S3 Activities"
                     ],
                     "detections": [
                        "Detect S3 access from a new IP"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-06-28",
            "description": "This search looks at S3 bucket-access logs and detects new or previously unseen remote IP addresses that have successfully accessed an S3 bucket.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your S3 access logs' inputs. This search works best when you run the \"Previously Seen S3 Bucket Access by Remote IP\" support search once to create a history of previously seen remote IPs and bucket names.",
            "id": "2a9b80d3-6340-4345-b5ad-291bq3d0daq4",
            "known_false_positives": "S3 buckets can be accessed from any IP, as long as it can make a successful connection. This will be a false postive, since the search is looking for a new IP within the past hour",
            "macros": [
               {
                  "definition": "sourcetype=aws:s3:accesslogs",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "aws_s3_accesslogs"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_s3_access_from_a_new_ip_filter"
               }
            ],
            "name": "Detect S3 access from a new IP",
            "references": [],
            "search": "`aws_s3_accesslogs` http_status=200  [search `aws_s3_accesslogs` http_status=200 | stats earliest(_time) as firstTime latest(_time) as lastTime by bucket_name remote_ip | inputlookup append=t previously_seen_S3_access_from_remote_ip.csv | stats min(firstTime) as firstTime, max(lastTime) as lastTime by bucket_name remote_ip | outputlookup previously_seen_S3_access_from_remote_ip.csv | eval newIP=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newIP=1 | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | table bucket_name remote_ip]| iplocation remote_ip |rename remote_ip as src_ip | table _time bucket_name src_ip City Country operation request_uri | `detect_s3_access_from_a_new_ip_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS S3 Activities"
               ],
               "asset_type": "S3 Bucket",
               "cis20": [
                  "CIS 13",
                  "CIS 14"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1530"
               ],
               "mitre_attack_tactics": [
                  "Collection"
               ],
               "mitre_attack_technique": [
                  "Data from Cloud Storage Object"
               ],
               "nist": [
                  "PR.DS",
                  "PR.AC",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-07-17",
                  "description": "This search establishes, on a per-hour basis, the average and standard deviation for the number of API calls related to deleting an S3 bucket by each user. Also recorded is the number of data points for each user. This table is then outputted to a lookup file to allow the detection search to operate quickly.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs.",
                  "id": "fc0edd96-ff2b-48b0-9f1f-63eq3783fd63",
                  "name": "Baseline of S3 Bucket deletion activity by ARN",
                  "search": "`cloudtrail` eventName=DeleteBucket | spath output=arn path=userIdentity.arn | bucket _time span=1h | stats count as apiCalls by _time, arn | stats count(apiCalls) as numDataPoints, latest(apiCalls) as latestCount, avg(apiCalls) as avgApiCalls, stdev(apiCalls) as stdevApiCalls by arn | table arn, latestCount, numDataPoints, avgApiCalls, stdevApiCalls | outputlookup s3_deletion_baseline | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS S3 Activities"
                     ],
                     "detections": [
                        "Detect Spike in S3 Bucket deletion"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-11-27",
            "description": "This search detects users creating spikes in API activity related to deletion of S3 buckets in your AWS environment. It will also update the cache file that factors in the latest data.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. You can modify `dataPointThreshold` and `deviationThreshold` to better fit your environment. The `dataPointThreshold` variable is the minimum number of data points required to have a statistically significant amount of data to determine. The `deviationThreshold` variable is the number of standard deviations away from the mean that the value must be to be considered a spike. This search works best when you run the \"Baseline of S3 Bucket deletion activity by ARN\" support search once to create a baseline of previously seen S3 bucket-deletion activity.",
            "id": "ad12w478-84a8-4641-a3w1-e32372q4bd53",
            "known_false_positives": "Based on the values of`dataPointThreshold` and `deviationThreshold`, the false positive rate may vary. Please modify this according the your environment.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_spike_in_s3_bucket_deletion_filter"
               }
            ],
            "name": "Detect Spike in S3 Bucket deletion",
            "references": [],
            "search": "`cloudtrail` eventName=DeleteBucket [search `cloudtrail` eventName=DeleteBucket | spath output=arn path=userIdentity.arn | stats count as apiCalls by arn | inputlookup s3_deletion_baseline append=t | fields - latestCount | stats values(*) as * by arn | rename apiCalls as latestCount | eval newAvgApiCalls=avgApiCalls + (latestCount-avgApiCalls)/720 | eval newStdevApiCalls=sqrt(((pow(stdevApiCalls, 2)*719 + (latestCount-newAvgApiCalls)*(latestCount-avgApiCalls))/720)) | eval avgApiCalls=coalesce(newAvgApiCalls, avgApiCalls), stdevApiCalls=coalesce(newStdevApiCalls, stdevApiCalls), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) | table arn, latestCount, numDataPoints, avgApiCalls, stdevApiCalls | outputlookup s3_deletion_baseline | eval dataPointThreshold = 15, deviationThreshold = 3 | eval isSpike=if((latestCount > avgApiCalls+deviationThreshold*stdevApiCalls) AND numDataPoints > dataPointThreshold, 1, 0) | where isSpike=1 | rename arn as userIdentity.arn | table userIdentity.arn] | spath output=user userIdentity.arn | spath output=bucketName path=requestParameters.bucketName | stats values(bucketName) as bucketName, count as numberOfApiCalls, dc(eventName) as uniqueApisCalled by user | `detect_spike_in_s3_bucket_deletion_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS S3 Activities"
               ],
               "asset_type": "S3 Bucket",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1530"
               ],
               "mitre_attack_tactics": [
                  "Collection"
               ],
               "mitre_attack_technique": [
                  "Data from Cloud Storage Object"
               ],
               "nist": [
                  "DE.DP",
                  "DE.CM",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "2e8948a5-5239-406b-b56b-6c50w3168af3",
      "name": "Suspicious AWS S3 Activities",
      "narrative": "As cloud computing has exploded, so has the number of creative attacks on virtual environments. And as the number-two cloud-service provider, Amazon Web Services (AWS) has certainly had its share.\\\nAmazon's \"shared responsibility\" model dictates that the company has responsibility for the environment outside of the VM and the customer is responsible for the security inside of the S3 container. As such, it's important to stay vigilant for activities that may belie suspicious behavior inside of your environment.\\\nAmong things to look out for are S3 access from unfamiliar locations and by unfamiliar users. Some of the searches in this Analytic Story help you detect suspicious behavior and others help you investigate more deeply, when the situation warrants.   ",
      "references": [
         "https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf",
         "https://www.tripwire.com/state-of-security/security-data-protection/cloud/public-aws-s3-buckets-writable/"
      ],
      "tags": {
         "analytics_story": "Suspicious AWS S3 Activities",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "no"
         ],
         "mitre_attack_id": [
            "T1530"
         ],
         "mitre_attack_tactics": [
            "Collection"
         ],
         "mitre_attack_technique": [
            "Data from Cloud Storage Object"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2018-05-07",
      "description": "Leverage these searches to monitor your AWS network traffic for evidence of anomalous activity and suspicious behaviors, such as a spike in blocked outbound traffic in your virtual private cloud (VPC).",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2018-05-07",
                  "description": "This search establishes, on a per-hour basis, the average and the standard deviation of the number of outbound connections blocked in your VPC flow logs by each source IP address (IP address of your EC2 instances). Also recorded is the number of data points for each source IP. This table outputs to a lookup file to allow the detection search to operate quickly.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your `VPC flow logs.`.",
                  "id": "fc0edd96-ff2b-48b0-9f1f-63da3782fd63",
                  "name": "Baseline of blocked outbound traffic from AWS",
                  "search": "`cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16) | bucket _time span=1h | stats count as numberOfBlockedConnections by _time, src_ip | stats count(numberOfBlockedConnections) as numDataPoints, latest(numberOfBlockedConnections) as latestCount, avg(numberOfBlockedConnections) as avgBlockedConnections, stdev(numberOfBlockedConnections) as stdevBlockedConnections by src_ip | table src_ip, latestCount, numDataPoints, avgBlockedConnections, stdevBlockedConnections | outputlookup baseline_blocked_outbound_connections | stats count",
                  "tags": {
                     "analytics_story": [
                        "AWS Network ACL Activity",
                        "Command and Control",
                        "Suspicious AWS Traffic"
                     ],
                     "detections": [
                        "Detect Spike in blocked Outbound Traffic from your AWS"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-05-07",
            "description": "This search will detect spike in blocked outbound network connections originating from within your AWS environment.  It will also update the cache file that factors in the latest data.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your VPC Flow logs. You can modify `dataPointThreshold` and `deviationThreshold` to better fit your environment. The `dataPointThreshold` variable is the number of data points required to meet the definition of \"spike.\" The `deviationThreshold` variable is the number of standard deviations away from the mean that the value must be to be considered a spike. This search works best when you run the \"Baseline of Blocked Outbound Connection\" support search once to create a history of previously seen blocked outbound connections.",
            "id": "ada0f278-84a8-46w1-a3f1-w32372d4bd53",
            "known_false_positives": "The false-positive rate may vary based on the values of`dataPointThreshold` and `deviationThreshold`. Additionally, false positives may result when AWS administrators roll out policies enforcing network blocks, causing sudden increases in the number of blocked outbound connections.",
            "macros": [
               {
                  "definition": "sourcetype=aws:cloudwatchlogs:vpcflow",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudwatchlogs_vpcflow"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_spike_in_blocked_outbound_traffic_from_your_aws_filter"
               }
            ],
            "name": "Detect Spike in blocked Outbound Traffic from your AWS",
            "references": [],
            "search": "`cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  [search  `cloudwatchlogs_vpcflow` action=blocked (src_ip=10.0.0.0/8 OR src_ip=172.16.0.0/12 OR src_ip=192.168.0.0/16) ( dest_ip!=10.0.0.0/8 AND dest_ip!=172.16.0.0/12 AND dest_ip!=192.168.0.0/16)  | stats count as numberOfBlockedConnections by src_ip | inputlookup baseline_blocked_outbound_connections append=t | fields - latestCount | stats values(*) as * by src_ip | rename numberOfBlockedConnections as latestCount | eval newAvgBlockedConnections=avgBlockedConnections + (latestCount-avgBlockedConnections)/720 | eval newStdevBlockedConnections=sqrt(((pow(stdevBlockedConnections, 2)*719 + (latestCount-newAvgBlockedConnections)*(latestCount-avgBlockedConnections))/720)) | eval avgBlockedConnections=coalesce(newAvgBlockedConnections, avgBlockedConnections), stdevBlockedConnections=coalesce(newStdevBlockedConnections, stdevBlockedConnections), numDataPoints=if(isnull(latestCount), numDataPoints, numDataPoints+1) | table src_ip, latestCount, numDataPoints, avgBlockedConnections, stdevBlockedConnections | outputlookup baseline_blocked_outbound_connections | eval dataPointThreshold = 5, deviationThreshold = 3 | eval isSpike=if((latestCount > avgBlockedConnections+deviationThreshold*stdevBlockedConnections) AND numDataPoints > dataPointThreshold, 1, 0) | where isSpike=1 | table src_ip] | stats values(dest_ip) as \"Blocked Destination IPs\", values(interface_id) as \"resourceId\" count as numberOfBlockedConnections, dc(dest_ip) as uniqueDestConnections by src_ip | `detect_spike_in_blocked_outbound_traffic_from_your_aws_filter`",
            "tags": {
               "analytics_story": [
                  "AWS Network ACL Activity",
                  "Suspicious AWS Traffic",
                  "Command and Control"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 11"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives",
                  "Command and Control"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.AE",
                  "DE.CM",
                  "PR.AC"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "2e8948a5-5239-406b-b56b-6c50f2168af3",
      "name": "Suspicious AWS Traffic",
      "narrative": "A virtual private cloud (VPC) is an on-demand managed cloud-computing service that isolates computing resources for each client. Inside the VPC container, the environment resembles a physical network. \\\nAmazon's VPC service enables you to launch EC2 instances and leverage other Amazon resources. The traffic that flows in and out of this VPC can be controlled via network access-control rules and security groups. Amazon also has a feature called VPC Flow Logs that enables you to log IP traffic going to and from the network interfaces in your VPC. This data is stored using Amazon CloudWatch Logs.\\\n Attackers may abuse the AWS infrastructure with insecure VPCs so they can co-opt AWS resources for command-and-control nodes, data exfiltration, and more. Once an EC2 instance is compromised, an attacker may initiate outbound network connections for malicious reasons. Monitoring these network traffic behaviors is crucial for understanding the type of traffic flowing in and out of your network and to alert you to suspicious activities.\\\nThe searches in this Analytic Story will monitor your AWS network traffic for evidence of anomalous activity and suspicious behaviors.",
      "references": [
         "https://rhinosecuritylabs.com/aws/hiding-cloudcobalt-strike-beacon-c2-using-amazon-apis/"
      ],
      "tags": {
         "analytics_story": "Suspicious AWS Traffic",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2020-06-04",
      "description": "Monitor your cloud authentication events. Searches within this Analytic Story leverage the recent cloud updates to the Authentication data model to help you stay aware of and investigate suspicious login activity. ",
      "detections": [
         {
            "author": "Jason Brewer, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last 30 days.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd03",
                  "name": "Previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) as firstTime latest(_time) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by username, within the last 30 days.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "0a87ecf9-dc6a-43af-861a-205e75a09bf5",
                  "name": "Previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src | iplocation Authentication.src | rename Authentication.user as user Authentication.src as src | table user src City Region Country firstTime lastTime | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last hour.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "06c036e6-d6d7-4daa-bd76-411c3d356031",
                  "name": "Update previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) AS firstTime latest(_time) AS lastTime by user src City Region Country | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by user, within the last hour.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "66ff71c2-7e01-47dd-a041-906688c9d322",
                  "name": "Update previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authenticaiton.src | iplocation Authentication.src | rename Authentication.user as user Authentciation.src as src | table user src City Region Country firstTime lastTime | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-04-30",
            "description": "This search looks for CloudTrail events wherein a console login event by a user was recorded within the last hour, then compares the event to a lookup file of previously seen users (by ARN values) who have logged into the console. The alert is fired if the user has logged into the console for the first time within the last hour",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the \"Previously seen users in CloudTrail\" support search only once to create a baseline of previously seen IAM users within the last 30 days. Run \"Update previously seen users in CloudTrail\" hourly (or more frequently depending on how often you run the detection searches) to refresh the baselines.",
            "id": "121b0b11-f8ac-4ed6-a132-3800ca4fc07a",
            "known_false_positives": "When a legitimate new user logins for the first time, this activity will be detected. Check how old the account is and verify that the user activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_aws_console_login_by_user_from_new_city_filter"
               }
            ],
            "name": "Detect AWS Console Login by User from New City",
            "search": "| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user City | join user type=outer [| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) AS earliestseen by user | fields earliestseen user] | eval userStatus=if(firstTime >= relative_time(now(), \"@d\"), \"New City\",\"Previously Seen City\") | eval UserData=if(earliestseen >= relative_time(now(), \"@d\") OR isnull(earliestseen), \"New User\",\"Old User\") | where userStatus=\"New City\" AND UserData=\"Old User\" | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`| `security_content_ctime(earliestseen)` | table user City userStatus firstTime lastTime earliestseen | `detect_aws_console_login_by_user_from_new_city_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS Login Activities",
                  "Suspicious Cloud Authentication Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Jason Brewer, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last 30 days.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd03",
                  "name": "Previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) as firstTime latest(_time) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by username, within the last 30 days.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "0a87ecf9-dc6a-43af-861a-205e75a09bf5",
                  "name": "Previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src | iplocation Authentication.src | rename Authentication.user as user Authentication.src as src | table user src City Region Country firstTime lastTime | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last hour.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "06c036e6-d6d7-4daa-bd76-411c3d356031",
                  "name": "Update previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) AS firstTime latest(_time) AS lastTime by user src City Region Country | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by user, within the last hour.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "66ff71c2-7e01-47dd-a041-906688c9d322",
                  "name": "Update previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authenticaiton.src | iplocation Authentication.src | rename Authentication.user as user Authentciation.src as src | table user src City Region Country firstTime lastTime | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-04-30",
            "description": "This search looks for CloudTrail events wherein a console login event by a user was recorded within the last hour, then compares the event to a lookup file of previously seen users (by ARN values) who have logged into the console. The alert is fired if the user has logged into the console for the first time within the last hour",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the \"Previously seen users in CloudTrail\" support search only once to create a baseline of previously seen IAM users within the last 30 days. Run \"Update previously seen users in CloudTrail\" hourly (or more frequently depending on how often you run the detection searches) to refresh the baselines.",
            "id": "67bd3def-c41c-4bf6-837b-ae196b4257c6",
            "known_false_positives": "When a legitimate new user logins for the first time, this activity will be detected. Check how old the account is and verify that the user activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_aws_console_login_by_user_from_new_country_filter"
               }
            ],
            "name": "Detect AWS Console Login by User from New Country",
            "search": "| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user Country | join user type=outer [| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) AS earliestseen by user | fields earliestseen user] | eval userStatus=if(firstTime >= relative_time(now(), \"@d\"), \"New Country\",\"Previously Seen Country\") | eval UserData=if(earliestseen >= relative_time(now(), \"@d\") OR isnull(earliestseen), \"New User\",\"Old User\") | where userStatus=\"New Country\" AND UserData=\"Old User\" | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`|`security_content_ctime(earliestseen)` | table user Country userStatus firstTime lastTime earliestseen | `detect_aws_console_login_by_user_from_new_country_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS Login Activities",
                  "Suspicious Cloud Authentication Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Jason Brewer, Splunk",
            "baselines": [
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last 30 days.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd03",
                  "name": "Previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) as firstTime latest(_time) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by username, within the last 30 days.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "0a87ecf9-dc6a-43af-861a-205e75a09bf5",
                  "name": "Previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src | iplocation Authentication.src | rename Authentication.user as user Authentication.src as src | table user src City Region Country firstTime lastTime | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Jason Brewer, Splunk",
                  "date": "2018-04-30",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by ARN, within the last hour.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Please validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created as a result of running this support search.",
                  "id": "06c036e6-d6d7-4daa-bd76-411c3d356031",
                  "name": "Update previously seen users in CloudTrail",
                  "search": "`cloudtrail` eventName=ConsoleLogin | rename userIdentity.arn as user | iplocation src | eval City=if(City LIKE \"\",src,City),Region=if(Region LIKE \"\",src,Region) | stats earliest(_time) AS firstTime latest(_time) AS lastTime by user src City Region Country | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious AWS Login Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by user, within the last hour.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "66ff71c2-7e01-47dd-a041-906688c9d322",
                  "name": "Update previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authenticaiton.src | iplocation Authentication.src | rename Authentication.user as user Authentciation.src as src | table user src City Region Country firstTime lastTime | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2018-04-30",
            "description": "This search looks for CloudTrail events wherein a console login event by a user was recorded within the last hour, then compares the event to a lookup file of previously seen users (by ARN values) who have logged into the console. The alert is fired if the user has logged into the console for the first time within the last hour",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. Run the \"Previously seen users in CloudTrail\" support search only once to create a baseline of previously seen IAM users within the last 30 days. Run \"Update previously seen users in CloudTrail\" hourly (or more frequently depending on how often you run the detection searches) to refresh the baselines.",
            "id": "9f31aa8e-e37c-46bc-bce1-8b3be646d026",
            "known_false_positives": "When a legitimate new user logins for the first time, this activity will be detected. Check how old the account is and verify that the user activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_aws_console_login_by_user_from_new_region_filter"
               }
            ],
            "name": "Detect AWS Console Login by User from New Region",
            "search": "| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user Region | join user type=outer [| inputlookup previously_seen_users_console_logins.csv | stats min(firstTime) AS earliestseen by user | fields earliestseen user] | eval userStatus=if(firstTime >= relative_time(now(), \"@d\"), \"New Region\",\"Previously Seen Region\") | eval UserData=if(earliestseen >= relative_time(now(), \"@d\") OR isnull(earliestseen), \"New User\",\"Old User\") | where userStatus=\"New Region\" AND UserData=\"Old User\" | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `security_content_ctime(earliestseen)` | table user Region userStatus firstTime lastTime earliestseen | `detect_aws_console_login_by_user_from_new_region_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious AWS Login Activities",
                  "Suspicious Cloud Authentication Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1535"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Unused/Unsupported Cloud Regions"
               ],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then creates a baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by username, within the last 30 days.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "0a87ecf9-dc6a-43af-861a-205e75a09bf5",
                  "name": "Previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authentication.src | iplocation Authentication.src | rename Authentication.user as user Authentication.src as src | table user src City Region Country firstTime lastTime | outputlookup previously_seen_users_console_logins.csv | stats count",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2020-05-28",
                  "description": "This search looks for CloudTrail events where a user logs into the console, then updates the baseline of the latest and earliest times, City, Region, and Country we have encountered this user in our dataset, grouped by user, within the last hour.",
                  "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Validate the user name entries in `previously_seen_users_console_logins.csv`, which is a lookup file created by this support search.",
                  "id": "66ff71c2-7e01-47dd-a041-906688c9d322",
                  "name": "Update previously seen users in CloudTrail - DM",
                  "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user Authenticaiton.src | iplocation Authentication.src | rename Authentication.user as user Authentciation.src as src | table user src City Region Country firstTime lastTime | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user src City Region Country | outputlookup previously_seen_users_console_logins.csv",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Cloud Authentication Activities"
                     ],
                     "detections": [
                        "Detect AWS Console Login by User from New Country",
                        "Detect AWS Console Login by User from New Region",
                        "Detect AWS Console Login by User from New City",
                        "Detect new user AWS Console Login - DM"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-05-28",
            "description": "This search looks for CloudTrail events wherein a console login event by a user was recorded within the last hour, then compares the event to a lookup file of previously seen users (by ARN values) who have logged into the console. The alert is fired if the user has logged into the console for the first time within the last hour",
            "how_to_implement": "You must install and configure the Splunk Add-on for AWS (version 5.1.0 or later) and Enterprise Security 6.2, which contains the required updates to the Authentication data model for cloud use cases. Run the \"Previously seen users in CloudTrail\" support search only once to create a baseline of previously seen IAM users within the last 30 days. Run \"Update previously seen users in CloudTrail\" hourly (or more frequently depending on how often you run the detection searches) to refresh the baselines.",
            "id": "bc91a8cd-35e7-4bb2-6140-e756cc46fd71",
            "known_false_positives": "When a legitimate new user logins for the first time, this activity will be detected. Check how old the account is and verify that the user activity is legitimate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_new_user_aws_console_login___dm_filter"
               }
            ],
            "name": "Detect new user AWS Console Login - DM",
            "search": "| tstats earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Authentication where Authentication.signature=ConsoleLogin by Authentication.user | `drop_dm_object_name(Authentication)` | inputlookup append=t previously_seen_users_console_logins.csv | stats min(firstTime) as firstTime max(lastTime) as lastTime by user | eval userStatus=if(firstTime >=relative_time(now(), '-70m@m'), 'First Time Logging into AWS Console','Previously Seen User')| `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`| `detect_new_user_aws_console_login___dm_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Cloud Authentication Activities"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.DP",
                  "DE.AE"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "6380ebbb-55c5-4fce-b754-01fd565fb73c",
      "name": "Suspicious Cloud Authentication Activities",
      "narrative": "It is important to monitor and control who has access to your cloud infrastructure. Detecting suspicious logins will provide good starting points for investigations. Abusive behaviors caused by compromised credentials can lead to direct monetary costs, as you will be billed for any compute activity whether legitimate or otherwise.\\\nThis Analytic Story has data model versions of cloud searches leveraging Authentication data, including those looking for suspicious login activity, and cross-account activity for AWS.",
      "references": [
         "https://aws.amazon.com/blogs/security/aws-cloudtrail-now-tracks-cross-account-activity-to-its-origin/",
         "https://docs.aws.amazon.com/IAM/latest/UserGuide/cloudtrail-integration.html"
      ],
      "tags": {
         "analytics_story": "Suspicious Cloud Authentication Activities",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "no"
         ],
         "mitre_attack_id": [
            "T1535"
         ],
         "mitre_attack_tactics": [
            "Defense Evasion"
         ],
         "mitre_attack_technique": [
            "Unused/Unsupported Cloud Regions"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2020-02-03",
      "description": "Leveraging the Windows command-line interface (CLI) is one of the most common attack techniques--one that is also detailed in the MITRE ATT&CK framework. Use this Analytic Story to help you identify unusual or suspicious use of the CLI on Windows systems.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for executions of cmd.exe spawned by a process that is often abused by attackers and that does not typically launch cmd.exe.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts and populates the Endpoint data model with the resultant dataset. This search includes a lookup file, `prohibited_apps_launching_cmd.csv`, that contains a list of processes that should not be spawning cmd.exe. You can modify this lookup to better suit your environment.",
            "id": "dcfd6b40-42f9-469d-a433-2e53f7486664",
            "known_false_positives": "There are circumstances where an application may legitimately execute and interact with the Windows command-line interface. Investigate and modify the lookup file, as appropriate.",
            "macros": [
               {
                  "definition": "| inputlookup prohibited_apps_launching_cmd | rename prohibited_applications as parent_process_name | eval parent_process_name=\"*\" . parent_process_name | table parent_process_name",
                  "description": "This macro outputs a list of process that should not be the parent process of cmd.exe",
                  "name": "prohibited_apps_launching_cmd"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_prohibited_applications_spawning_cmd_exe_filter"
               }
            ],
            "name": "Detect Prohibited Applications Spawning cmd exe",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe by Processes.parent_process_name Processes.process_name Processes.dest Processes.user| `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` |search [`prohibited_apps_launching_cmd`] | `detect_prohibited_applications_spawning_cmd_exe_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Suspicious MSHTA Activity",
                  "Suspicious Zoom Child Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for the execution of the cscript.exe or wscript.exe processes, with a parent of cmd.exe. The search will return the count, the first and last time this execution was seen on a machine, the user, and the destination of the machine",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model in the processes node. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
            "id": "b89919ed-fe5f-492c-b139-95dbb162039e",
            "known_false_positives": "Some legitimate applications may exhibit this behavior.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_use_of_cmd_exe_to_launch_script_interpreters_filter"
               }
            ],
            "name": "Detect Use of cmd exe to Launch Script Interpreters",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=\"cmd.exe\" (Processes.process_name=cscript.exe OR Processes.process_name =wscript.exe) by Processes.parent_process Processes.process_name Processes.user Processes.dest | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)` | `detect_use_of_cmd_exe_to_launch_script_interpreters_filter`",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Suspicious Command-Line Executions"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "baselines": [
               {
                  "author": "Bhavin Patel, Splunk",
                  "date": "2019-03-01",
                  "description": "This search looks for command-line arguments where `cmd.exe /c` is used to execute a program, then creates a baseline of the earliest and latest times we have encountered this command-line argument in our dataset within the last 30 days.",
                  "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
                  "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd23",
                  "name": "Previously seen command line arguments",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe AND Processes.process=\"* /c *\" by Processes.process | `drop_dm_object_name(Processes)`",
                  "tags": {
                     "analytics_story": [
                        "DHS Report TA18-074A",
                        "Disabling Security Tools",
                        "Hidden Cobra Malware",
                        "Netsh Abuse",
                        "Orangeworm Attack Group",
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Processes launching netsh",
                        "First time seen command line argument"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for command-line arguments that use a `/c` parameter to execute a command that has not previously been seen.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must be ingesting logs with both the process name and command line from your endpoints. The complete process name with command-line arguments are mapped to the \"process\" field in the Endpoint data model. Please make sure you run the support search \"Previously seen command line arguments,\"&#151;which creates a lookup file called `previously_seen_cmd_line_arguments.csv`&#151;a historical baseline of all command-line arguments. You must also validate this list. For the search to do accurate calculation, ensure the search scheduling is the same value as the `relative_time` evaluation function.",
            "id": "9be56c82-b1cc-4318-87eb-q138afaaqa39",
            "known_false_positives": "Legitimate programs can also use command-line arguments to execute. Please verify the command-line arguments to check what command/program is being executed. We recommend customizing the `first_time_seen_cmd_line_filter` macro to exclude legitimate parent_process_name",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "first_time_seen_command_line_argument_filter"
               }
            ],
            "name": "First time seen command line argument",
            "references": [],
            "search": "| tstats `security_content_summariesonly` min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process Processes.process_name Processes.parent_process_name Processes.dest| `drop_dm_object_name(Processes)`| `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search [| tstats `security_content_summariesonly` earliest(_time) as firstTime latest(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = cmd.exe Processes.process = \"* /c *\" by Processes.process | `drop_dm_object_name(Processes)` | inputlookup append=t previously_seen_cmd_line_arguments | stats min(firstTime) as firstTime, max(lastTime) as lastTime by process | outputlookup previously_seen_cmd_line_arguments | eval newCmdLineArgument=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newCmdLineArgument=1 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table process] | `first_time_seen_command_line_argument_filter` ",
            "tags": {
               "analytics_story": [
                  "DHS Report TA18-074A",
                  "Suspicious Command-Line Executions",
                  "Orangeworm Attack Group",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Hidden Cobra Malware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "DarkVishnya",
                  "Molerats",
                  "Wizard Spider",
                  "Frankenstein",
                  "Inception",
                  "Silence",
                  "APT41",
                  "Kimsuky",
                  "Soft Cell",
                  "TA505",
                  "WIRTE",
                  "TEMP.Veles",
                  "APT33",
                  "Gallmaker",
                  "Turla",
                  "APT19",
                  "DarkHydrus",
                  "APT28",
                  "Thrip",
                  "Gorgon Group",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "Leviathan",
                  "TA459",
                  "FIN8",
                  "MuddyWater",
                  "Magic Hound",
                  "OilRig",
                  "BRONZE BUTLER",
                  "CopyKittens",
                  "APT32",
                  "FIN7",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Patchwork",
                  "Stealth Falcon",
                  "FIN6",
                  "Poseidon Group",
                  "APT3",
                  "APT29",
                  "Deep Panda",
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.001",
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "PowerShell",
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-02-04",
            "description": "This search looks for system processes that normally run out of C:\\Windows\\System32\\ or C:\\Windows\\SysWOW64 that are not run from that location.  This can indicate a malicious process that is trying to hide as a legitimate process.",
            "how_to_implement": "To successfully implement this search you need to ingest details about process execution from your hosts. Specifically, this search requires the process name and the full path to the process executable.",
            "id": "a34aae96-ccf8-4aef-952c-3ea21444444d",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "definition": "lookup update=true is_windows_system_file filename as process_name OUTPUT systemFile | search systemFile=true",
                  "description": "This macro limits the output to process names that are in the Windows System directory",
                  "name": "is_windows_system_file"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "system_processes_run_from_unexpected_locations_filter"
               }
            ],
            "name": "System Processes Run From Unexpected Locations",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_path !=\"C:\\\\Windows\\\\System32*\" Processes.process_path !=\"C:\\\\Windows\\\\SysWOW64*\" by Processes.user Processes.dest Processes.process_name Processes.process_id Processes.process_path Processes.parent_process_name Processes.process_hash| `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| `is_windows_system_file` | `system_processes_run_from_unexpected_locations_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Windshift",
                  "APT32",
                  "BRONZE BUTLER",
                  "menuPass",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1036"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Masquerading"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "Command lines that are extremely long may be indicative of malicious activity on your hosts.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships, from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c77162d3-f93c-45cc-80c8-22f6a4264e7f",
            "known_false_positives": "Some legitimate applications start with long command lines.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unusually_long_command_line_filter"
               }
            ],
            "name": "Unusually Long Command Line",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`|  eval processlen=len(process) | eventstats stdev(processlen) as stdev, avg(processlen) as avg by dest | stats max(processlen) as maxlen, values(stdev) as stdevperhost, values(avg) as avgperhost by dest, user, process_name, process | `unusually_long_command_line_filter` | eval threshold = 10 | where maxlen > ((threshold*stdevperhost) + avgperhost)",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the length of the command lines observed for each user in the environment. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search, which identifies outliers in the length of the command line.",
                  "how_to_implement": "You must be ingesting endpoint data and populating the Endpoint data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. Depending on the number of users in your environment, you may also need to adjust the value for max_inputs in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "d2a4d85b-fc6a-47a0-82f6-bc1ec2ebc459",
                  "name": "Baseline of Command Line Length - MLTK",
                  "search": "| tstats `security_content_summariesonly` count min(_time) as start_time max(_time) as end_time FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(Processes)` | search user!=unknown | `security_content_ctime(start_time)`| `security_content_ctime(end_time)`| eval processlen=len(process) | fit DensityFunction processlen by user into cmdline_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Ransomware",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity",
                        "Unusual Processes"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Unusually Long Command Line - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2019-05-08",
            "description": "Command lines that are extremely long may be indicative of malicious activity on your hosts. This search leverages the Machine Learning Toolkit (MLTK) to help identify command lines with lengths that are unusual for a given user.",
            "how_to_implement": "You must be ingesting endpoint data that monitors command lines and populates the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model. In addition, MLTK version >= 4.2 must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of Command Line Length - MLTK\" must be executed before this detection search, as it builds an ML model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.",
            "id": "57edaefa-a73b-45e5-bbae-f39c1473f941",
            "known_false_positives": "Some legitimate applications use long command lines for installs or updates. You should review identified command lines for legitimacy. You may modify the first part of the search to omit legitimate command lines from consideration. If you are seeing more results than desired, you may consider changing the value of threshold in the search to a smaller value. You should also periodically re-run the support search to re-build the ML model on the latest data. You may get unexpected results if the user identified in the results is not present in the data used to build the associated model.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unusually_long_command_line___mltk_filter"
               }
            ],
            "name": "Unusually Long Command Line - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| eval processlen=len(process) | search user!=unknown | apply cmdline_pdfmodel threshold=0.01 | rename \"IsOutlier(processlen)\" as isOutlier | search isOutlier > 0 | table firstTime lastTime user dest process_name process processlen count | `unusually_long_command_line___mltk_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "f4368ddf-d59f-4192-84f6-778ac5a3ffc7",
      "name": "Suspicious Command-Line Executions",
      "narrative": "The ability to execute arbitrary commands via the Windows CLI is a primary goal for the adversary. With access to the shell, an attacker can easily run scripts and interact with the target system. Often, attackers may only have limited access to the shell or may obtain access in unusual ways. In addition, malware may execute and interact with the CLI in ways that would be considered unusual and inconsistent with typical user activity. This provides defenders with opportunities to identify suspicious use and investigate, as appropriate. This Analytic Story contains various searches to help identify this suspicious activity, as well as others to aid you in deeper investigation.",
      "references": [
         "https://attack.mitre.org/wiki/Technique/T1059",
         "https://www.microsoft.com/en-us/wdsi/threats/macro-malware",
         "https://www.fireeye.com/content/dam/fireeye-www/services/pdfs/mandiant-apt1-report.pdf"
      ],
      "tags": {
         "analytics_story": "Suspicious Command-Line Executions",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sowbug",
            "TEMP.Veles",
            "Cobalt Group",
            "APT1",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "Kimsuky",
            "admin@338",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Thrip",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "APT32",
            "Suckfly",
            "FIN10",
            "Dark Caracal",
            "FIN7",
            "APT19",
            "APT37",
            "Windshift",
            "Ke3chang",
            "TA459",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "APT38",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "Gallmaker",
            "APT33",
            "Blue Mockingbird",
            "APT18",
            "APT28",
            "FIN6",
            "Soft Cell",
            "Deep Panda",
            "Tropic Trooper",
            "Patchwork",
            "Threat Group-1314",
            "DarkVishnya",
            "DarkHydrus",
            "Poseidon Group",
            "TA505",
            "menuPass",
            "WIRTE",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1059.001",
            "T1036",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Defense Evasion"
         ],
         "mitre_attack_technique": [
            "Masquerading",
            "Windows Command Shell",
            "PowerShell"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2017-09-18",
      "description": "Attackers often attempt to hide within or otherwise abuse the domain name system (DNS). You can thwart attempts to manipulate this omnipresent protocol by monitoring for these types of abuses.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search allows you to identify the endpoints that have connected to more than five DNS servers and made DNS Queries over the time frame of the search.",
            "how_to_implement": "This search requires that DNS data is being ingested and populating the `Network_Resolution` data model. This data can come from DNS logs or from solutions that parse network traffic for this data, such as Splunk Stream or Bro.\\\nThis search produces fields (`dest_count`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** Distinct DNS Connections, **Field:** dest_count\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "74ec6f18-604b-4202-a567-86b2066be3ce",
            "known_false_positives": "It's possible that an enterprise has more than five DNS servers that are configured in a round-robin rotation. Please customize the search, as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "clients_connecting_to_multiple_dns_servers_filter"
               }
            ],
            "name": "Clients Connecting to Multiple DNS Servers",
            "search": "| tstats `security_content_summariesonly` count, values(DNS.dest) AS dest dc(DNS.dest) as dest_count from datamodel=Network_Resolution where DNS.message_type=QUERY by DNS.src | `drop_dm_object_name(\"Network_Resolution\")` |where dest_count > 5 | `clients_connecting_to_multiple_dns_servers_filter` ",
            "tags": {
               "analytics_story": [
                  "DNS Hijacking",
                  "Command and Control",
                  "Suspicious DNS Traffic",
                  "Host Redirection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT32",
                  "APT33",
                  "Thrip",
                  "FIN8",
                  "OilRig",
                  "Lazarus Group"
               ],
               "mitre_attack_id": [
                  "T1048.003"
               ],
               "mitre_attack_tactics": [
                  "Exfiltration"
               ],
               "mitre_attack_technique": [
                  "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-01-16",
            "description": "Malicious actors often abuse legitimate Dynamic DNS services to host malicious payloads or interactive command and control nodes. Attackers will automate domain resolution changes by routing dynamic domains to countless IP addresses to circumvent firewall blocks, blacklists as well as frustrate a network defenders analytic and investigative processes. This search will look for DNS queries made from within your infrastructure to suspicious dynamic domains.",
            "how_to_implement": "First, you'll need to ingest data from your DNS operations. This can be done by ingesting logs from your server or data, collected passively by Splunk Stream or a similar solution. Specifically, data that contains the domain that is being queried and the IP of the host originating the request must be populating the `Network_Resolution` data model. This search also leverages a lookup file, `dynamic_dns_providers_default.csv`, which contains a non-exhaustive list of Dynamic DNS providers. Please consider updating the local lookup periodically by adding new domains to the list of `dynamic_dns_providers_local.csv`.\\\nThis search produces fields (query, answer, isDynDNS) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable event. To see the additional metadata, add the following fields, if not already present, to Incident Review. Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** DNS Query, **Field:** query\\\n1. \\\n1. **Label:** DNS Answer, **Field:** answer\\\n1. \\\n1. **Label:** IsDynamicDNS, **Field:** isDynDNS\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "c77162d3-f93c-45cc-80c8-22f6v5464g9f",
            "known_false_positives": "Some users and applications may leverage Dynamic DNS to reach out to some domains on the Internet since dynamic DNS by itself is not malicious, however this activity must be verified.",
            "macros": [
               {
                  "definition": "lookup update=true dynamic_dns_providers_default dynamic_dns_domains as query OUTPUTNEW isDynDNS_default | lookup update=true dynamic_dns_providers_local dynamic_dns_domains as query OUTPUTNEW isDynDNS_local| eval isDynDNS = coalesce(isDynDNS_default, isDynDNS_local)|fields - isDynDNS_default, isDynDNS_local| search isDynDNS=True",
                  "description": "This macro limits the output of the query field to dynamic dns domains. It looks up the domains in a file provided by Splunk and one intended to be updated by the end user.",
                  "name": "dynamic_dns_providers"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_hosts_connecting_to_dynamic_domain_providers_filter"
               }
            ],
            "name": "Detect hosts connecting to dynamic domain providers",
            "search": "| tstats `security_content_summariesonly` count values(DNS.answer) as answer min(_time) as firstTime from datamodel=Network_Resolution by DNS.src, DNS.query | `drop_dm_object_name(\"DNS\")` | `security_content_ctime(firstTime)` | `dynamic_dns_providers` | `detect_hosts_connecting_to_dynamic_domain_providers_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection",
                  "Prohibited Traffic Allowed or Protocol Mismatch",
                  "DNS Hijacking",
                  "Suspicious DNS Traffic",
                  "Dynamic DNS",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.DS",
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search is used to detect attempts to use DNS tunneling, by calculating the length of responses to DNS TXT queries. Endpoints using DNS as a method of transmission for data exfiltration, command and control, or evasion of security controls can often be detected by noting unusually large volumes of DNS traffic.",
            "how_to_implement": "To successfully implement this search you need to ingest data from your DNS logs, or monitor DNS traffic using Stream, Bro or something similar. Specifically, this query requires that the DNS data model is populated with information regarding the DNS record type that is being returned as well as the data in the answer section of the protocol.",
            "id": "05437c07-62f5-452e-afdc-04dd44815bb9",
            "known_false_positives": "It's possible that legitimate TXT record responses can be long enough to trigger this search. You can modify the packet threshold for this search to help mitigate false positives.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_long_dns_txt_record_response_filter"
               }
            ],
            "name": "Detect Long DNS TXT Record Response",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Resolution where DNS.message_type=response AND DNS.record_type=TXT by DNS.src DNS.dest DNS.answer DNS.record_type |  `drop_dm_object_name(\"DNS\")` | eval anslen=len(answer) | search anslen>100 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename src as \"Source IP\", dest as \"Destination IP\", answer as \"DNS Answer\" anslen as \"Answer Length\" record_type as \"DNS Record Type\" firstTime as \"First Time\" lastTime as \"Last Time\" count as Count | table \"Source IP\" \"Destination IP\" \"DNS Answer\" \"DNS Record Type\"  \"Answer Length\" Count \"First Time\" \"Last Time\" | `detect_long_dns_txt_record_response_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12",
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.DS",
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2017-09-18",
            "description": "This search is used to detect DNS tunneling, by calculating the sum of the length of DNS queries and DNS answers. The search also filters out potential false positives by filtering out queries made to internal systems and the queries originating from internal DNS, Web, and Email servers. Endpoints using DNS as a method of transmission for data exfiltration, command and control, or evasion of security controls can often be detected by noting an unusually large volume of DNS traffic.",
            "how_to_implement": "To successfully implement this search, we must ensure that DNS data is being ingested and mapped to the appropriate fields in the Network_Resolution data model. Fields like src_category are automatically provided by the Assets and Identity Framework shipped with Splunk Enterprise Security. You will need to ensure you are using the Assets and Identity Framework and populating the src_category field. You will also need to enable the `cim_corporate_web_domain_search()` macro which will essentially filter out the DNS queries made to the corporate web domains to reduce alert fatigue.",
            "id": "104658f4-afdc-499f-9719-17a43f9826f4",
            "known_false_positives": "It's possible that normal DNS traffic will exhibit this behavior. If an alert is generated, please investigate and validate as appropriate. The threshold can also be modified to better suit your environment.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detection_of_dns_tunnels_filter"
               }
            ],
            "name": "Detection of DNS Tunnels",
            "references": [],
            "search": "| tstats `security_content_summariesonly` dc(\"DNS.query\") as count  from datamodel=Network_Resolution  where nodename=DNS \"DNS.message_type\"=\"QUERY\" NOT (`cim_corporate_web_domain_search(\"DNS.query\")`) NOT \"DNS.query\"=\"*.in-addr.arpa\" NOT (\"DNS.src_category\"=\"svc_infra_dns\" OR \"DNS.src_category\"=\"svc_infra_webproxy\" OR \"DNS.src_category\"=\"svc_infra_email*\"   ) by \"DNS.src\",\"DNS.query\" | rename \"DNS.src\" as src  \"DNS.query\" as message | eval length=len(message) | stats sum(length) as length by src | append [ tstats `security_content_summariesonly` dc(\"DNS.answer\") as count  from datamodel=Network_Resolution  where nodename=DNS \"DNS.message_type\"=\"QUERY\" NOT (`cim_corporate_web_domain_search(\"DNS.query\")`) NOT \"DNS.query\"=\"*.in-addr.arpa\" NOT (\"DNS.src_category\"=\"svc_infra_dns\" OR \"DNS.src_category\"=\"svc_infra_webproxy\" OR \"DNS.src_category\"=\"svc_infra_email*\"   ) by \"DNS.src\",\"DNS.answer\" | rename \"DNS.src\" as src  \"DNS.answer\" as message | eval message=if(message==\"unknown\",\"\", message) | eval length=len(message) | stats sum(length) as length by src ] | stats sum(length) as length by src | where length > 10000 | `detection_of_dns_tunnels_filter`",
            "tags": {
               "analytics_story": [
                  "Data Protection",
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 13"
               ],
               "kill_chain_phases": [
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the length of the DNS queries for each DNS record type observed in the environment. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search, which uses it to identify outliers in the length of the DNS query.",
                  "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "c914844c-0ff5-4efc-8d44-c063443129ba",
                  "name": "Baseline of DNS Query Length - MLTK",
                  "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution by DNS.query DNS.record_type | search DNS.record_type=* | `drop_dm_object_name(\"DNS\")` | eval query_length = len(query) | fit DensityFunction query_length by record_type into dns_query_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "Command and Control",
                        "Hidden Cobra Malware",
                        "Suspicious DNS Traffic"
                     ],
                     "detections": [
                        "DNS Query Length Outliers - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-01-22",
            "description": "This search allows you to identify DNS requests that are unusually large for the record type being requested in your environment.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model. In addition, the Machine Learning Toolkit (MLTK) version 4.2 or greater must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of DNS Query Length - MLTK\" must be executed before this detection search, because it builds a machine-learning (ML) model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.\\\nThis search produces fields (`query`,`query_length`,`count`) that are not yet supported by ES Incident Review and therefore cannot be viewed when a notable event is raised. These fields contribute additional context to the notable. To see the additional metadata, add the following fields, if not already present, to Incident Review - Event Attributes (Configure > Incident Management > Incident Review Settings > Add New Entry):\\\\n1. **Label:** DNS Query, **Field:** query\\\n1. \\\n1. **Label:** DNS Query Length, **Field:** query_length\\\n1. \\\n1. **Label:** Number of events, **Field:** count\\\nDetailed documentation on how to create a new field within Incident Review may be found here: `https://docs.splunk.com/Documentation/ES/5.3.0/Admin/Customizenotables#Add_a_field_to_the_notable_event_details`",
            "id": "85fbcfe8-9718-4911-adf6-7000d077a3a9",
            "known_false_positives": "If you are seeing more results than desired, you may consider reducing the value for threshold in the search. You should also periodically re-run the support search to re-build the ML model on the latest data.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_length_outliers___mltk_filter"
               }
            ],
            "name": "DNS Query Length Outliers - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as start_time max(_time) as end_time values(DNS.src) as src values(DNS.dest) as dest from datamodel=Network_Resolution by DNS.query DNS.record_type | search DNS.record_type=* |  `drop_dm_object_name(DNS)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | eval query_length = len(query) | apply dns_query_pdfmodel threshold=0.01 | rename \"IsOutlier(query_length)\" as isOutlier | search isOutlier > 0 | sort -query_length | table start_time end_time query record_type count src dest query_length | `dns_query_length_outliers___mltk_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search allows you to identify DNS requests and compute the standard deviation on the length of the names being resolved, then filter on two times the standard deviation to show you those queries that are unusually large for your environment.",
            "how_to_implement": "To successfully implement this search, you will need to ensure that DNS data is populating the Network_Resolution data model.",
            "id": "1a67f15a-f4ff-4170-84e9-08cf6f75d6f5",
            "known_false_positives": "It's possible there can be long domain names that are legitimate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_length_with_high_standard_deviation_filter"
               }
            ],
            "name": "DNS Query Length With High Standard Deviation",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution by DNS.query DNS.record_type |  `drop_dm_object_name(\"DNS\")` | eval query_length = len(query) | table query query_length record_type count | eventstats stdev(query_length) AS stdev avg(query_length) AS avg p50(query_length) AS p50| where query_length>(avg+stdev*2) | eval z_score=(query_length-avg)/stdev | `dns_query_length_with_high_standard_deviation_filter` ",
            "tags": {
               "analytics_story": [
                  "Hidden Cobra Malware",
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search will detect DNS requests resolved by unauthorized DNS servers. Legitimate DNS servers should be identified in the Enterprise Security Assets and Identity Framework.",
            "how_to_implement": "To successfully implement this search you will need to ensure that DNS data is populating the Network_Resolution data model. It also requires that your DNS servers are identified correctly in the Assets and Identity table of Enterprise Security.",
            "id": "1a67f15a-f4ff-4170-84e9-08cf6f75d6f6",
            "known_false_positives": "Legitimate DNS activity can be detected in this search. Investigate, verify and update the list of authorized DNS servers as appropriate.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "dns_query_requests_resolved_by_unauthorized_dns_servers_filter"
               }
            ],
            "name": "DNS Query Requests Resolved by Unauthorized DNS Servers",
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution where DNS.dest_category != dns_server AND DNS.src_category != dns_server by DNS.src DNS.dest | `drop_dm_object_name(\"DNS\")` | `dns_query_requests_resolved_by_unauthorized_dns_servers_filter` ",
            "tags": {
               "analytics_story": [
                  "DNS Hijacking",
                  "Command and Control",
                  "Suspicious DNS Traffic",
                  "Host Redirection"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 1",
                  "CIS 3",
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS",
                  "PR.IP",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search identifies DNS query failures by counting the number of DNS responses that do not indicate success, and trigger on more than 50 occurrences.",
            "how_to_implement": "To successfully implement this search you must ensure that DNS data is populating the Network_Resolution data model.",
            "id": "104658f4-afdc-499e-9719-17243f9826f1",
            "known_false_positives": "It is possible legitimate traffic can trigger this rule. Please investigate as appropriate. The threshold for generating an event can also be customized to better suit your environment.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "excessive_dns_failures_filter"
               }
            ],
            "name": "Excessive DNS Failures",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(\"DNS.query\") as queries from datamodel=Network_Resolution where nodename=DNS \"DNS.reply_code\"!=\"No Error\" \"DNS.reply_code\"!=\"NoError\" DNS.reply_code!=\"unknown\" NOT \"DNS.query\"=\"*.arpa\" \"DNS.query\"=\"*.*\" by \"DNS.src\",\"DNS.query\"| `drop_dm_object_name(\"DNS\")`| lookup cim_corporate_web_domain_lookup domain as query OUTPUT domain| where isnull(domain)| lookup update=true alexa_lookup_by_str domain as query OUTPUT rank| where isnull(rank)| stats sum(count) as count mode(queries) as queries by src| `get_asset(src)`| where count>50 | `excessive_dns_failures_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious DNS Traffic",
                  "Command and Control"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 9",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Command and Control"
               ],
               "mitre_attack_groups": [
                  "APT39",
                  "Tropic Trooper",
                  "OilRig",
                  "Ke3chang",
                  "Cobalt Group",
                  "APT18",
                  "APT41",
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1071.004"
               ],
               "mitre_attack_tactics": [
                  "Command And Control"
               ],
               "mitre_attack_technique": [
                  "DNS"
               ],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "3c3835c0-255d-4f9e-ab84-e29ec9ec9b56",
      "name": "Suspicious DNS Traffic",
      "narrative": "Although DNS is one of the fundamental underlying protocols that make the Internet work, it is often ignored (perhaps because of its complexity and effectiveness).  However, attackers have discovered ways to abuse the protocol to meet their objectives. One potential abuse involves manipulating DNS to hijack traffic and redirect it to an IP address under the attacker's control. This could inadvertently send users intending to visit google.com, for example, to an unrelated malicious website. Another technique involves using the DNS protocol for command-and-control activities with the attacker's malicious code or to covertly exfiltrate data. The searches within this Analytic Story look for these types of abuses.",
      "references": [
         "http://blogs.splunk.com/2015/10/01/random-words-on-entropy-and-dns/",
         "http://www.darkreading.com/analytics/security-monitoring/got-malware-three-signs-revealed-in-dns-traffic/d/d-id/1139680",
         "https://live.paloaltonetworks.com/t5/Threat-Vulnerability-Articles/What-are-suspicious-DNS-queries/ta-p/71454"
      ],
      "tags": {
         "analytics_story": "Suspicious DNS Traffic",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Thrip",
            "Ke3chang",
            "OilRig",
            "Cobalt Group",
            "APT32",
            "APT33",
            "APT18",
            "APT41",
            "FIN8",
            "Tropic Trooper",
            "FIN7",
            "Lazarus Group",
            "APT39"
         ],
         "mitre_attack_id": [
            "T1071.004",
            "T1048.003"
         ],
         "mitre_attack_tactics": [
            "Exfiltration",
            "Command And Control"
         ],
         "mitre_attack_technique": [
            "DNS",
            "Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2020-01-27",
      "description": "Email remains one of the primary means for attackers to gain an initial foothold within the modern enterprise. Detect and investigate suspicious emails in your environment with the help of the searches in this Analytic Story.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2017-09-19",
            "description": "Attackers often use spaces as a means to obfuscate an attachment's file extension. This search looks for messages with email attachments that have many spaces within the file names.",
            "how_to_implement": "You need to ingest data from emails. Specifically, the sender's address and the file names of any attachments must be mapped to the Email data model. The threshold ratio is set to 10%, but this value can be configured to suit each environment. \\\n **Splunk Phantom Playbook Integration**\\\nIf Splunk Phantom is also configured in your environment, a playbook called \"Suspicious Email Attachment Investigate and Delete\" can be configured to run when any results are found by this detection search. To use this integration, install the Phantom App for Splunk `https://splunkbase.splunk.com/app/3411/` and add the correct hostname to the \"Phantom Instance\" field in the Adaptive Response Actions when configuring this detection search. The notable event will be sent to Phantom and the playbook will gather further information about the file attachment and its network behaviors. If Phantom finds malicious behavior and an analyst approves of the results, the email will be deleted from the user's inbox.",
            "id": "56e877a6-1455-4479-ada6-0550dc1e22f8",
            "known_false_positives": "None at this time",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "email_attachments_with_lots_of_spaces_filter"
               }
            ],
            "name": "Email Attachments With Lots Of Spaces",
            "search": "| tstats `security_content_summariesonly` count values(All_Email.recipient) as recipient_address min(_time) as firstTime max(_time) as lastTime from datamodel=Email where All_Email.file_name=\"*\" by All_Email.src_user, All_Email.file_name All_Email.message_id | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Email\")` | eval space_ratio = (mvcount(split(file_name,\" \"))-1)/len(file_name) | search space_ratio >= 0.1 |  rex field=recipient_address \"(?<recipient_user>.*)@\" | `email_attachments_with_lots_of_spaces_filter`",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Suspicious Emails"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-10-08",
                  "description": "This search creates permutations of your existing domains, removes the valid domain names and stores them in a specified lookup file so they can be checked for in the associated detection searches.",
                  "how_to_implement": "To successfully implement this search you need to update the file called domains.csv in the DA-ESS-SOC/lookup directory. Or `cim_corporate_email_domains.csv` and `cim_corporate_web_domains.csv` from **Splunk\\_SA\\_CIM**.",
                  "id": "19f7d2ec-6028-4d01-bcdb-bda9a034c17f",
                  "name": "DNSTwist Domain Names",
                  "search": "| dnstwist domainlist=domains.csv | `remove_valid_domains` | eval domain_abuse=\"true\" | table domain, domain_abuse | outputlookup brandMonitoring_lookup | stats count",
                  "tags": {
                     "analytics_story": [
                        "Brand Monitoring",
                        "Suspicious Emails"
                     ],
                     "detections": [
                        "Monitor Email For Brand Abuse",
                        "Monitor DNS For Brand Abuse",
                        "Monitor Web Traffic For Brand Abuse"
                     ]
                  },
                  "version": 2
               }
            ],
            "date": "2018-01-05",
            "description": "This search looks for emails claiming to be sent from a domain similar to one that you want to have monitored for abuse.",
            "how_to_implement": "You need to ingest email header data. Specifically the sender's address (src_user) must be populated.  You also need to have run the search \"ESCU - DNSTwist Domain Names\", which creates the permutations of the domain that will be checked for.",
            "id": "b2ea1f38-3a3e-4b8a-9cf1-82760d86a6b8",
            "known_false_positives": "None at this time",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "monitor_email_for_brand_abuse_filter"
               }
            ],
            "name": "Monitor Email For Brand Abuse",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(All_Email.recipient) as recipients, min(_time) as firstTime, max(_time) as lastTime from datamodel=Email by All_Email.src_user, All_Email.message_id | `drop_dm_object_name(\"All_Email\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | eval temp=split(src_user, \"@\") | eval email_domain=mvindex(temp, 1) | lookup update=true brandMonitoring_lookup domain as email_domain OUTPUT domain_abuse | search domain_abuse=true | table message_id, src_user, email_domain, recipients, firstTime, lastTime | `monitor_email_for_brand_abuse_filter`",
            "tags": {
               "analytics_story": [
                  "Brand Monitoring",
                  "Suspicious Emails"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-22",
            "description": "This detection looks for emails that are suspicious because of their sender, domain rareness, or behavior differences. This is an anomaly generated by Splunk User Behavior Analytics (UBA).",
            "how_to_implement": "You must be ingesting data from email logs and have Splunk integrated with UBA. This anomaly is raised by a UBA detection model called  \"SuspiciousEmailDetectionModel.\" Ensure that this model is enabled on your UBA instance.",
            "id": "56e877a6-1455-4479-ad16-0550dc1e33f8",
            "known_false_positives": "This detection model will alert on any sender domain that is seen for the first time. This could be a potential false positive. The next step is to investigate and whitelist the URL if you determine that it is a legitimate sender.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_email___uba_anomaly_filter"
               }
            ],
            "name": "Suspicious Email - UBA Anomaly",
            "search": "|tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(All_UEBA_Events.category) as category from datamodel=UEBA where nodename=All_UEBA_Events.UEBA_Anomalies All_UEBA_Events.UEBA_Anomalies.uba_model = \"SuspiciousEmailDetectionModel\" by All_UEBA_Events.description All_UEBA_Events.severity All_UEBA_Events.user All_UEBA_Events.uba_event_type All_UEBA_Events.link All_UEBA_Events.signature All_UEBA_Events.url All_UEBA_Events.UEBA_Anomalies.uba_model | `drop_dm_object_name(All_UEBA_Events)` | `drop_dm_object_name(UEBA_Anomalies)`| `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `suspicious_email___uba_anomaly_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Emails"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 7"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1566"
               ],
               "mitre_attack_tactics": [
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Phishing"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for emails that have attachments with suspicious file extensions.",
            "how_to_implement": "You need to ingest data from emails. Specifically, the sender's address and the file names of any attachments must be mapped to the Email data model. \\\n **Splunk Phantom Playbook Integration**\\\nIf Splunk Phantom is also configured in your environment, a Playbook called \"Suspicious Email Attachment Investigate and Delete\" can be configured to run when any results are found by this detection search. To use this integration, install the Phantom App for Splunk `https://splunkbase.splunk.com/app/3411/`, and add the correct hostname to the \"Phantom Instance\" field in the Adaptive Response Actions when configuring this detection search. The notable event will be sent to Phantom and the playbook will gather further information about the file attachment and its network behaviors. If Phantom finds malicious behavior and an analyst approves of the results, the email will be deleted from the user's inbox.",
            "id": "473bd65f-06ca-4dfe-a2b8-ba04ab4a0084",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "definition": "lookup update=true is_suspicious_file_extension_lookup file_name OUTPUT suspicious | search suspicious=true",
                  "description": "This macro limits the output to email attachments that have suspicious extensions",
                  "name": "suspicious_email_attachments"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_email_attachment_extensions_filter"
               }
            ],
            "name": "Suspicious Email Attachment Extensions",
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Email where All_Email.file_name=\"*\" by All_Email.src_user, All_Email.file_name All_Email.message_id | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Email\")` | `suspicious_email_attachments` | `suspicious_email_attachment_extensions_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Suspicious Emails"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 7",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Delivery"
               ],
               "mitre_attack_groups": [
                  "Magic Hound",
                  "Windshift",
                  "APT33",
                  "Sandworm Team",
                  "Naikon",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Mofang",
                  "Wizard Spider",
                  "RTM",
                  "Frankenstein",
                  "Inception",
                  "BlackTech",
                  "APT-C-36",
                  "APT41",
                  "Machete",
                  "admin@338",
                  "Kimsuky",
                  "APT12",
                  "TA505",
                  "Silence",
                  "The White Company",
                  "APT39",
                  "FIN4",
                  "Darkhotel",
                  "Gallmaker",
                  "Tropic Trooper",
                  "Turla",
                  "Gorgon Group",
                  "Rancor",
                  "DarkHydrus",
                  "Cobalt Group",
                  "FIN7",
                  "OilRig",
                  "Lazarus Group",
                  "APT19",
                  "Dragonfly 2.0",
                  "BRONZE BUTLER",
                  "APT32",
                  "FIN8",
                  "MuddyWater",
                  "APT28",
                  "TA459",
                  "Leviathan",
                  "Patchwork",
                  "PLATINUM",
                  "Elderwood",
                  "APT29",
                  "APT37",
                  "menuPass"
               ],
               "mitre_attack_id": [
                  "T1566.001"
               ],
               "mitre_attack_tactics": [
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Spearphishing Attachment"
               ],
               "nist": [
                  "DE.AE",
                  "PR.IP"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "2b1800dd-92f9-47ec-a981-fdf1351e5d55",
      "name": "Suspicious Emails",
      "narrative": "It is a common practice for attackers of all types to leverage targeted spearphishing campaigns and mass mailers to deliver weaponized email messages and attachments. Fortunately, there are a number of ways to monitor email data in Splunk to detect suspicious content.\\\nOnce a phishing message has been detected, the next steps are to answer the following questions: \\\n1. Which users have received this or a similar message in the past?\\\n1. When did the targeted campaign begin?\\\n1. Have any users interacted with the content of the messages (by downloading an attachment or clicking on a malicious URL)?This Analytic Story provides detection searches to identify suspicious emails, as well as contextual and investigative searches to help answer some of these questions.",
      "references": [
         "https://www.splunk.com/blog/2015/06/26/phishing-hits-a-new-level-of-quality/"
      ],
      "tags": {
         "analytics_story": "Suspicious Emails",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "Cobalt Group",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "APT-C-36",
            "Kimsuky",
            "admin@338",
            "Naikon",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Molerats",
            "OilRig",
            "Elderwood",
            "APT32",
            "Machete",
            "BlackTech",
            "PLATINUM",
            "FIN4",
            "FIN7",
            "APT12",
            "APT19",
            "APT37",
            "Windshift",
            "TA459",
            "Magic Hound",
            "no",
            "MuddyWater",
            "Mofang",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "Darkhotel",
            "Frankenstein",
            "APT39",
            "Silence",
            "Gallmaker",
            "Dragonfly 2.0",
            "APT33",
            "APT28",
            "Tropic Trooper",
            "DarkHydrus",
            "Patchwork",
            "TA505",
            "menuPass",
            "The White Company"
         ],
         "mitre_attack_id": [
            "T1566",
            "T1566.001"
         ],
         "mitre_attack_tactics": [
            "Initial Access"
         ],
         "mitre_attack_technique": [
            "Phishing",
            "Spearphishing Attachment"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2020-02-03",
      "description": "Monitor and detect techniques used by attackers who leverage the mshta.exe process to execute malicious code.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for the execution of \"mshta.exe\" with command-line arguments that launch a script. The search will return the first time and last time these command-line arguments were used for these executions, as well as the target system, the user, process \"mshta.exe\" and its parent process.",
            "how_to_implement": "To successfully implement this search, you need to be ingesting logs with the process name, parent process, and command-line executions from your endpoints. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
            "id": "b89919ed-fe5f-492c-b139-95dqb161039e",
            "known_false_positives": "Although unlikely, some legitimate applications may exhibit this behavior, triggering a false positive.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_mshta_exe_running_scripts_in_command_line_arguments_filter"
               }
            ],
            "name": "Detect mshta exe running scripts in command-line arguments",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=mshta.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| search (process=*vbscript* OR process=*javascript*) | `detect_mshta_exe_running_scripts_in_command_line_arguments_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious MSHTA Activity"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for executions of cmd.exe spawned by a process that is often abused by attackers and that does not typically launch cmd.exe.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts and populates the Endpoint data model with the resultant dataset. This search includes a lookup file, `prohibited_apps_launching_cmd.csv`, that contains a list of processes that should not be spawning cmd.exe. You can modify this lookup to better suit your environment.",
            "id": "dcfd6b40-42f9-469d-a433-2e53f7486664",
            "known_false_positives": "There are circumstances where an application may legitimately execute and interact with the Windows command-line interface. Investigate and modify the lookup file, as appropriate.",
            "macros": [
               {
                  "definition": "| inputlookup prohibited_apps_launching_cmd | rename prohibited_applications as parent_process_name | eval parent_process_name=\"*\" . parent_process_name | table parent_process_name",
                  "description": "This macro outputs a list of process that should not be the parent process of cmd.exe",
                  "name": "prohibited_apps_launching_cmd"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_prohibited_applications_spawning_cmd_exe_filter"
               }
            ],
            "name": "Detect Prohibited Applications Spawning cmd exe",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe by Processes.parent_process_name Processes.process_name Processes.dest Processes.user| `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` |search [`prohibited_apps_launching_cmd`] | `detect_prohibited_applications_spawning_cmd_exe_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Suspicious MSHTA Activity",
                  "Suspicious Zoom Child Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The search looks for modifications to registry keys that can be used to launch an application or service at system startup.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "f5f6af30-7aa7-4295-bfe9-07fe87c01a4b",
            "known_false_positives": "There are many legitimate applications that must execute on system startup and will use these registry keys to accomplish that task.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_used_for_persistence_filter"
               }
            ],
            "name": "Registry Keys Used For Persistence",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*currentversion\\\\run* OR Registry.registry_path=*currentVersion\\\\Windows\\\\Appinit_Dlls* OR Registry.registry_path=CurrentVersion\\\\Winlogon\\\\Shell* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\Userinit* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\VmApplet* OR Registry.registry_path=*currentversion\\\\policies\\\\explorer\\\\run* OR Registry.registry_path=*currentversion\\\\runservices* OR Registry.registry_path=*\\\\CurrentControlSet\\\\Control\\\\Lsa\\\\* OR Registry.registry_path=\"*Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options*\" OR Registry.registry_path=HKLM\\\\SOFTWARE\\\\Microsoft\\\\Netsh\\\\*) by Registry.dest , Registry.status, Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `registry_keys_used_for_persistence_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Suspicious MSHTA Activity",
                  "DHS Report TA18-074A",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware",
                  "Windows Persistence Techniques",
                  "Emotet Malware  DHS Report TA18-201A "
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "2b1800dd-92f9-47dd-a981-fdf13w1q5d55",
      "name": "Suspicious MSHTA Activity",
      "narrative": "One common adversary tactic is to bypass application white-listing solutions via the mshta.exe process, which executes Microsoft HTML applications with the .hta suffix. In these cases, attackers use the trusted Windows utility to eproxy execution of malicious files, whether an .hta application, javascript, or VBScript.\\\nOne example of a notable mshta.exe attack was the Kovter malware (https://medium.com/@mbromileyDFIR/malware-monday-aebb456356c5) that was implicated in ransomware and click-fraud attacks. Kovter utilized .hta to execute a series of javascript commands, each progressively more dangerous. According to the Mitre Parternship Network (https://attack.mitre.org/wiki/Technique/T1170), FIN7 has leveraged mshta.exe, as has the MuddyWater group, who used it to execute its POWERSTATS payload (which then used the utility to execute additional payloads).\\\nThe searches in this story help you detect and investigate suspicious activity that may indicate that an attacker is leveraging mshta.exe to execute malicious code.",
      "references": [
         "https://redcanary.com/blog/windows-registry-attacks-threat-detection/",
         "https://medium.com/@mbromileyDFIR/malware-monday-aebb456356c5",
         "https://attack.mitre.org/wiki/Technique/T1170"
      ],
      "tags": {
         "analytics_story": "Suspicious MSHTA Activity",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sowbug",
            "Cobalt Group",
            "APT1",
            "APT29",
            "APT41",
            "Leviathan",
            "FIN8",
            "Turla",
            "Inception",
            "Kimsuky",
            "Putter Panda",
            "admin@338",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Molerats",
            "OilRig",
            "APT32",
            "Suckfly",
            "FIN10",
            "Dark Caracal",
            "Machete",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "APT38",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "APT33",
            "Blue Mockingbird",
            "APT18",
            "APT28",
            "Rocke",
            "Soft Cell",
            "FIN6",
            "Tropic Trooper",
            "Patchwork",
            "Threat Group-1314",
            "TA505",
            "menuPass"
         ],
         "mitre_attack_id": [
            "T1547.001",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Persistence",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Windows Command Shell",
            "Registry Run Keys / Startup Folder"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2020-04-02",
      "description": "Monitor your Okta environment for suspicious activities. Due to the Covid outbreak, many users are migrating over to leverage cloud services more and more. Okta is a popular tool to manage multiple users and the web-based applications they need to stay productive. The searches in this story will help monitor your Okta environment for suspicious activities and associated user behaviors.",
      "detections": [
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search detects Okta login failures due to bad credentials for multiple users originating from the same ip address.",
            "how_to_implement": "This search is specific to Okta and requires Okta logs are being ingested in your Splunk deployment.",
            "id": "19cba45f-cad3-4032-8911-0c09e0444552",
            "known_false_positives": "A single public IP address servicing multiple legitmate users may trigger this search. In addition, the threshold of 5 distinct users may be too low for your needs. You may modify the included filter macro XXXXXXXXXXXXX to raise the threshold or except specific IP adresses from triggering this search.",
            "macros": [
               {
                  "definition": "eventtype=okta_log",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "okta"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "multiple_okta_users_with_invalid_credentails_from_the_same_ip_filter"
               }
            ],
            "name": "Multiple Okta Users With Invalid Credentails From The Same IP",
            "search": "`okta` outcome.reason=INVALID_CREDENTIALS | rename client.geographicalContext.country as country, client.geographicalContext.state as state, client.geographicalContext.city as city | stats min(_time) as firstTime max(_time) as lastTime dc(user) as distinct_users values(user) as users by src_ip, displayMessage, outcome.reason, country, state, city  | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` |  search distinct_users > 5| `multiple_okta_users_with_invalid_credentails_from_the_same_ip_filter` ",
            "tags": {
               "analytics_story": [
                  "Suspicious Okta Activity"
               ],
               "asset_type": "Infrastructure",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1078.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Default Accounts"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "Detect Okta user lockout events",
            "how_to_implement": "This search is specific to Okta and requires Okta logs are being ingested in your Splunk deployment.",
            "id": "62b70968-a0a5-4724-8ac4-67871e6f544d",
            "known_false_positives": "None. Account lockouts should be followed up on to determine if the actual user was the one who caused the lockout, or if it was an unauthorized actor.",
            "macros": [
               {
                  "definition": "eventtype=okta_log",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "okta"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "okta_account_lockout_events_filter"
               }
            ],
            "name": "Okta Account Lockout Events",
            "search": "`okta` displayMessage=\"Max sign in attempts exceeded\" | rename client.geographicalContext.country as country, client.geographicalContext.state as state, client.geographicalContext.city as city | table _time, user, country, state, city, src_ip | `okta_account_lockout_events_filter` ",
            "tags": {
               "analytics_story": [
                  "Suspicious Okta Activity"
               ],
               "asset_type": "Infrastructure",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1078.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Default Accounts"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "Detect failed Okta SSO events",
            "how_to_implement": "This search is specific to Okta and requires Okta logs are being ingested in your Splunk deployment.",
            "id": "371a6545-2618-4032-ad84-93386b8698c5",
            "known_false_positives": "There may be a faulty config preventing legitmate users from accessing apps they should have access to.",
            "macros": [
               {
                  "definition": "eventtype=okta_log",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "okta"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "okta_failed_sso_attempts_filter"
               }
            ],
            "name": "Okta Failed SSO Attempts",
            "search": "`okta` displayMessage=\"User attempted unauthorized access to app\" | stats  min(_time) as firstTime max(_time) as lastTime values(app) as Apps count by user, result ,displayMessage, src_ip | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `okta_failed_sso_attempts_filter` ",
            "tags": {
               "analytics_story": [
                  "Suspicious Okta Activity"
               ],
               "asset_type": "Infrastructure",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1078.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Default Accounts"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search detects logins from the same user from different states in a 24 hour period.",
            "how_to_implement": "This search is specific to Okta and requires Okta logs are being ingested in your Splunk deployment.",
            "id": "7594fa07-9f34-4d01-81cc-d6af6a5db9e8",
            "known_false_positives": "Users in your enviornment may legitmately be travelling and loggin in from different locations. This search is useful for those users that should *not* be travelling for some reason, such as the COVID-19 pandemic. The search also relies on the geographical information being populated in the Okta logs. It is also possible that a connection from another region may be attributed to a login from a remote VPN endpoint.",
            "macros": [
               {
                  "definition": "eventtype=okta_log",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "okta"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "okta_user_logins_from_multiple_cities_filter"
               }
            ],
            "name": "Okta User Logins From Multiple Cities",
            "search": "`okta` displayMessage=\"User login to Okta\" client.geographicalContext.city!=null | stats min(_time) as firstTime max(_time) as lastTime dc(client.geographicalContext.city) as locations values(client.geographicalContext.city) as cities values(client.geographicalContext.state) as states by user | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `okta_user_logins_from_multiple_cities_filter` | search locations > 1",
            "tags": {
               "analytics_story": [
                  "Suspicious Okta Activity"
               ],
               "asset_type": "Infrastructure",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1078.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Default Accounts"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "access"
            },
            "type": "ESCU",
            "version": 2
         }
      ],
      "id": "9cbd34af-8f39-4476-a423-bacd126c750b",
      "name": "Suspicious Okta Activity",
      "narrative": "Okta is the leading single sign on (SSO) provider, allowing users to authenticate once to Okta, and from there access a variety of web-based applications. These applications are assigned to users and allow administrators to centrally manage which users are allowed to access which applications. It also provides centralized logging to help understand how the applications are used and by whom. \\\nWhile SSO is a major convenience for users, it also provides attackers with an opportunity. If the attacker can gain access to Okta, they can access a variety of applications. As such monitoring the environment is important. \\\nWith people moving quickly to adopt web-based applications and ways to manage them, many are still struggling to understand how best to monitor these environments. This analytic story provides searches to help monitor this environment, and identify events and activity that warrant further investigation such as credential stuffing or password spraying attacks, and users logging in from multiple locations when travel is disallowed.",
      "references": [
         "https://attack.mitre.org/wiki/Technique/T1078",
         "https://owasp.org/www-community/attacks/Credential_stuffing",
         "https://searchsecurity.techtarget.com/answer/What-is-a-password-spraying-attack-and-how-does-it-work"
      ],
      "tags": {
         "analytics_story": "Suspicious Okta Activity",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "no"
         ],
         "mitre_attack_id": [
            "T1078.001"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Default Accounts"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2018-05-31",
      "description": "Monitor and detect registry changes initiated from remote locations, which can be a sign that an attacker has infiltrated your system.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-02",
            "description": "The search looks for modifications to registry keys that control the enforcement of Windows User Account Control (UAC).",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or via other endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report registry modifications.",
            "id": "bbc644bc-37df-4e1a-9c88-ec9a53e2038c",
            "known_false_positives": "This registry key may be modified via administrators to implement a change in system policy. This type of change should be a very rare occurrence.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "disabling_remote_user_account_control_filter"
               }
            ],
            "name": "Disabling Remote User Account Control",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path=\"*Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\LocalAccountTokenFilterPolicy\" by Registry.dest, Registry.registry_key_name Registry.user Registry.registry_path Registry.action | `drop_dm_object_name(Registry)` | `disabling_remote_user_account_control_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Suspicious Windows Registry Activities"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "Turla",
                  "APT32",
                  "APT38",
                  "Dragonfly 2.0",
                  "APT19",
                  "Threat Group-3390",
                  "Honeybee",
                  "Patchwork",
                  "Gorgon Group",
                  "FIN8"
               ],
               "mitre_attack_id": [
                  "T1112"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Modify Registry"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2018-11-02",
            "description": "This search looks for registry activity associated with modifications to the registry key `HKLM\\SYSTEM\\CurrentControlSet\\Control\\Print\\Monitors`. In this scenario, an attacker can load an arbitrary .dll into the print-monitor registry by giving the full path name to the after.dll. The system will execute the .dll with elevated (SYSTEM) permissions and will persist after reboot.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or via other endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report registry modifications.",
            "id": "f5f6af30-7ba7-4295-bfe9-07de87c01bbc",
            "known_false_positives": "You will encounter noise from legitimate print-monitor registry entries.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "monitor_registry_keys_for_print_monitors_filter"
               }
            ],
            "name": "Monitor Registry Keys for Print Monitors",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.action=modified AND Registry.registry_path=\"*CurrentControlSet\\\\Control\\\\Print\\\\Monitors*\" by Registry.dest, Registry.registry_key_name Registry.status Registry.user Registry.registry_path Registry.action | `drop_dm_object_name(Registry)` | `monitor_registry_keys_for_print_monitors_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.AC"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2019-02-27",
            "description": "The search looks for command-line arguments used to hide a file or directory using the reg add command.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c77162d3-f93c-45cc-80c8-22f6b5264x9f",
            "known_false_positives": "None at the moment",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "reg_exe_used_to_hide_files_directories_via_registry_keys_filter"
               }
            ],
            "name": "Reg exe used to hide files directories via registry keys",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = reg.exe Processes.process=\"*add*\" Processes.process=\"*Hidden*\" Processes.process=\"*REG_DWORD*\" by Processes.process_name Processes.parent_process_name Processes.dest Processes.user| `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` |`security_content_ctime(lastTime)`| regex process = \"(/d\\s+2)\" | `reg_exe_used_to_hide_files_directories_via_registry_keys_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for registry activity associated with application compatibility shims, which can be leveraged by attackers for various nefarious purposes.",
            "how_to_implement": "To successfully implement this search, you must populate the Change_Analysis data model. This is typically populated via endpoint detection and response products, such as Carbon Black or other endpoint data sources such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "f5f6af30-7aa7-4295-bfe9-07fe87c01bbb",
            "known_false_positives": "There are many legitimate applications that leverage shim databases for compatibility purposes for legacy applications",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_for_creating_shim_databases_filter"
               }
            ],
            "name": "Registry Keys for Creating SHIM Databases",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Change_Analysis.All_Changes where All_Changes.object_category=registry AND (All_Changes.object_path=\"*CurrentVersion\\\\AppCompatFlags\\\\Custom*\" OR All_Changes.object_path=\"*CurrentVersion\\\\AppCompatFlags\\\\InstalledSDB*\") by All_Changes.dest, All_Changes.command, All_Changes.user, All_Changes.object, All_Changes.object_path | `drop_dm_object_name(\"All_Changes\")` | `registry_keys_for_creating_shim_databases_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1546.011"
               ],
               "mitre_attack_tactics": [
                  "Privilege Escalation",
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Application Shimming"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The search looks for modifications to registry keys that can be used to launch an application or service at system startup.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "f5f6af30-7aa7-4295-bfe9-07fe87c01a4b",
            "known_false_positives": "There are many legitimate applications that must execute on system startup and will use these registry keys to accomplish that task.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_used_for_persistence_filter"
               }
            ],
            "name": "Registry Keys Used For Persistence",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*currentversion\\\\run* OR Registry.registry_path=*currentVersion\\\\Windows\\\\Appinit_Dlls* OR Registry.registry_path=CurrentVersion\\\\Winlogon\\\\Shell* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\Userinit* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\VmApplet* OR Registry.registry_path=*currentversion\\\\policies\\\\explorer\\\\run* OR Registry.registry_path=*currentversion\\\\runservices* OR Registry.registry_path=*\\\\CurrentControlSet\\\\Control\\\\Lsa\\\\* OR Registry.registry_path=\"*Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options*\" OR Registry.registry_path=HKLM\\\\SOFTWARE\\\\Microsoft\\\\Netsh\\\\*) by Registry.dest , Registry.status, Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `registry_keys_used_for_persistence_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Suspicious MSHTA Activity",
                  "DHS Report TA18-074A",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware",
                  "Windows Persistence Techniques",
                  "Emotet Malware  DHS Report TA18-201A "
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for modifications to registry keys that can be used to elevate privileges. The registry keys under \"Image File Execution Options\" are used to intercept calls to an executable and can be used to attach malicious binaries to benign system binaries.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "c9f4b923-f8af-4155-b697-1354f5bcbc5e",
            "known_false_positives": "There are many legitimate applications that must execute upon system startup and will use these registry keys to accomplish that task.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_used_for_privilege_escalation_filter"
               }
            ],
            "name": "Registry Keys Used For Privilege Escalation",
            "references": [
               "https://blog.malwarebytes.com/101/2015/12/an-introduction-to-image-file-execution-options/"
            ],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=\"*Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options*\") AND (Registry.registry_key_name=GlobalFlag OR Registry.registry_key_name=Debugger) by Registry.dest  Registry.user | `security_content_ctime(lastTime)`  | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `registry_keys_used_for_privilege_escalation_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Privilege Escalation",
                  "Suspicious Windows Registry Activities"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-03-02",
            "description": "This search monitors for remote modifications to registry keys.",
            "how_to_implement": "To successfully implement this search, you must populate the `Endpoint` data model. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "c9f4b923-f8af-4155-b697-1354f5dcbc5e",
            "known_false_positives": "This technique may be legitimately used by administrators to modify remote registries, so it's important to filter these events out.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_registry_key_modifications_filter"
               }
            ],
            "name": "Remote Registry Key modifications",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where  Registry.registry_path=\"\\\\\\\\*\"  by Registry.dest , Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `remote_registry_key_modifications_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for changes to registry values that control Windows file associations, executed by a process that is not typical for legitimate, routine changes to this area.",
            "how_to_implement": "To successfully implement this search you need to be ingesting information on registry changes that include the name of the process responsible for the changes from your endpoints into the `Endpoint` datamodel in the `Processes` and `Registry` nodes.",
            "id": "1b989a0e-0129-4446-a695-f193a5b746fc",
            "known_false_positives": "There may be other processes in your environment that users may legitimately use to modify file associations. If this is the case and you are finding false positives, you can modify the search to add those processes as exceptions.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_changes_to_file_associations_filter"
               }
            ],
            "name": "Suspicious Changes to File Associations",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.process_name) as process_name values(Processes.parent_process_name) as parent_process_name FROM datamodel=Endpoint.Processes where Processes.process_name!=Explorer.exe AND Processes.process_name!=OpenWith.exe by Processes.process_id Processes.dest | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | join [| tstats `security_content_summariesonly` values(Registry.registry_path) as registry_path count  FROM datamodel=Endpoint.Registry where Registry.registry_path=*\\\\Explorer\\\\FileExts* by Registry.process_id Registry.dest | `drop_dm_object_name(\"Registry\")` | table process_id dest registry_path]| `suspicious_changes_to_file_associations_filter` ",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Windows File Extension and Association Abuse"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Kimsuky"
               ],
               "mitre_attack_id": [
                  "T1546.001"
               ],
               "mitre_attack_tactics": [
                  "Privilege Escalation",
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Change Default File Association"
               ],
               "nist": [
                  "DE.CM",
                  "PR.PT",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "2b1800dd-92f9-47dd-a981-fdf1351e5d55",
      "name": "Suspicious Windows Registry Activities",
      "narrative": "Attackers are developing increasingly sophisticated techniques for hijacking target servers, while evading detection. One such technique that has become progressively more common is registry modification.\\\n The registry is a key component of the Windows operating system. It has a hierarchical database called \"registry\" that contains settings, options, and values for executables. Once the threat actor gains access to a machine, they can use reg.exe to modify their account to obtain administrator-level privileges, maintain persistence, and move laterally within the environment.\\\n The searches in this story are designed to help you detect behaviors associated with manipulation of the Windows registry.",
      "references": [
         "https://redcanary.com/blog/windows-registry-attacks-threat-detection/",
         "https://attack.mitre.org/wiki/Technique/T1112"
      ],
      "tags": {
         "analytics_story": "Suspicious Windows Registry Activities",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Cobalt Group",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "Kimsuky",
            "Putter Panda",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Molerats",
            "APT32",
            "Machete",
            "FIN10",
            "Dark Caracal",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Darkhotel",
            "Dragonfly 2.0",
            "Silence",
            "APT38",
            "APT39",
            "APT33",
            "Blue Mockingbird",
            "Rocke",
            "APT18",
            "FIN6",
            "Tropic Trooper",
            "Patchwork"
         ],
         "mitre_attack_id": [
            "T1112",
            "T1547.001",
            "T1546.011",
            "T1546.001"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Change Default File Association",
            "Registry Run Keys / Startup Folder",
            "Modify Registry",
            "Application Shimming"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2018-10-23",
      "description": "Attackers are increasingly abusing Windows Management Instrumentation (WMI), a framework and associated utilities available on all modern Windows operating systems. Because WMI can be leveraged to manage both local and remote systems, it is important to identify the processes executed and the user context within which the activity occurred.",
      "detections": [
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-03-16",
            "description": "This search looks for processes launched via WMI.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "24869767-8579-485d-9a4f-d9ddfd8f0cac",
            "known_false_positives": "Although unlikely, administrators may use wmi to execute commands for legitimate purposes.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "process_execution_via_wmi_filter"
               }
            ],
            "name": "Process Execution via WMI",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.parent_process_name = *WmiPrvSE.exe by Processes.user Processes.dest Processes.process_name  | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| `process_execution_via_wmi_filter` ",
            "tags": {
               "analytics_story": [
                  "Suspicious WMI Use"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT41",
                  "FIN6",
                  "Soft Cell",
                  "APT32",
                  "MuddyWater",
                  "OilRig",
                  "Threat Group-3390",
                  "FIN8",
                  "Leviathan",
                  "menuPass",
                  "Stealth Falcon",
                  "Lazarus Group",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1047"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Management Instrumentation"
               ],
               "nist": [
                  "PR.PT",
                  "PR.AT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for wmic.exe being launched with parameters to spawn a process on a remote system.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "d25d2c3d-d9d8-40ec-8fdf-e86fe155a3da",
            "known_false_positives": "The wmic.exe utility is a benign Windows application. It may be used legitimately by Administrators with these parameters for remote system administration, but it's relatively uncommon.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_process_instantiation_via_wmi_filter"
               }
            ],
            "name": "Remote Process Instantiation via WMI",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = wmic.exe Processes.process=\"*/node*\" Processes.process=\"*process*\" Processes.process=\"*call*\" Processes.process=\"*create*\"   by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` |`security_content_ctime(lastTime)` | `remote_process_instantiation_via_wmi_filter`",
            "tags": {
               "analytics_story": [
                  "Ransomware",
                  "Suspicious WMI Use"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "TEMP.Veles",
                  "Leviathan",
                  "APT39",
                  "Stolen Pencil",
                  "Cobalt Group",
                  "Dragonfly 2.0",
                  "FIN8",
                  "APT3",
                  "OilRig",
                  "menuPass",
                  "FIN10",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "APT1",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1021.001"
               ],
               "mitre_attack_tactics": [
                  "Lateral Movement"
               ],
               "mitre_attack_technique": [
                  "Remote Desktop Protocol"
               ],
               "nist": [
                  "PR.PT",
                  "PR.AT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2018-12-03",
            "description": "This search looks for wmic.exe being launched with parameters to operate on remote systems.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "272df6de-61f1-4784-877c-1fbc3e2d0838",
            "known_false_positives": "Administrators may use this legitimately to gather info from remote systems.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_wmi_command_attempt_filter"
               }
            ],
            "name": "Remote WMI Command Attempt",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=wmic.exe  AND Processes.process= */node* by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `remote_wmi_command_attempt_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious WMI Use"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT41",
                  "FIN6",
                  "Soft Cell",
                  "APT32",
                  "MuddyWater",
                  "OilRig",
                  "Threat Group-3390",
                  "FIN8",
                  "Leviathan",
                  "menuPass",
                  "Stealth Falcon",
                  "Lazarus Group",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1047"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Management Instrumentation"
               ],
               "nist": [
                  "PR.PT",
                  "PR.AT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-03-16",
            "description": "This search looks for scripts launched via WMI.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "aa73f80d-d728-4077-b226-81ea0c8be589",
            "known_false_positives": "Although unlikely, administrators may use wmi to launch scripts for legitimate purposes.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "script_execution_via_wmi_filter"
               }
            ],
            "name": "Script Execution via WMI",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_name = \"scrcons.exe\" by Processes.user Processes.dest Processes.process_name  | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| `script_execution_via_wmi_filter` ",
            "tags": {
               "analytics_story": [
                  "Suspicious WMI Use"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT41",
                  "FIN6",
                  "Soft Cell",
                  "APT32",
                  "MuddyWater",
                  "OilRig",
                  "Threat Group-3390",
                  "FIN8",
                  "Leviathan",
                  "menuPass",
                  "Stealth Falcon",
                  "Lazarus Group",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1047"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Management Instrumentation"
               ],
               "nist": [
                  "PR.PT",
                  "PR.AT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2018-10-23",
            "description": "This search looks for the creation of WMI permanent event subscriptions.",
            "how_to_implement": "To successfully implement this search, you must be ingesting the Windows WMI activity logs. This can be done by adding a stanza to inputs.conf on the system generating logs with a title of [WinEventLog://Microsoft-Windows-WMI-Activity/Operational].",
            "id": "71bfdb13-f200-4c6c-b2c9-a2e07adf437d",
            "known_false_positives": "Although unlikely, administrators may use event subscriptions for legitimate purposes.",
            "macros": [
               {
                  "definition": "sourcetype=\"wineventlog:microsoft-windows-wmi-activity/operational\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wmi"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "wmi_permanent_event_subscription_filter"
               }
            ],
            "name": "WMI Permanent Event Subscription",
            "references": [],
            "search": "`wmi` EventCode=5861 Binding | rex field=Message \"Consumer =\\s+(?<consumer>[^;|^$]+)\" | search consumer!=\"NTEventLogEventConsumer=\\\"SCM Event Log Consumer\\\"\" | stats count min(_time) as firstTime max(_time) as lastTime by ComputerName, consumer, Message | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | rename ComputerName as dest | `wmi_permanent_event_subscription_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious WMI Use"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT41",
                  "FIN6",
                  "Soft Cell",
                  "APT32",
                  "MuddyWater",
                  "OilRig",
                  "Threat Group-3390",
                  "FIN8",
                  "Leviathan",
                  "menuPass",
                  "Stealth Falcon",
                  "Lazarus Group",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1047"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Management Instrumentation"
               ],
               "nist": [
                  "PR.PT",
                  "PR.AT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2018-10-23",
            "description": "This search looks for the creation of WMI permanent event subscriptions.",
            "how_to_implement": "To successfully implement this search, you must be collecting Sysmon data using Sysmon version 6.1 or greater and have Sysmon configured to generate alerts for WMI activity. In addition, you must have at least version 6.0.4 of the Sysmon TA installed to properly parse the fields.",
            "id": "ad05aae6-3b2a-4f73-af97-57bd26cee3b9",
            "known_false_positives": "Although unlikely, administrators may use event subscriptions for legitimate purposes.",
            "macros": [
               {
                  "definition": "sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "sysmon"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "wmi_permanent_event_subscription___sysmon_filter"
               }
            ],
            "name": "WMI Permanent Event Subscription - Sysmon",
            "references": [],
            "search": "`sysmon` EventCode=21 | rename host as dest | table _time, dest, user, Operation, EventType, Query, Consumer, Filter | `wmi_permanent_event_subscription___sysmon_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious WMI Use"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT41",
                  "FIN6",
                  "Soft Cell",
                  "APT32",
                  "MuddyWater",
                  "OilRig",
                  "Threat Group-3390",
                  "FIN8",
                  "Leviathan",
                  "menuPass",
                  "Stealth Falcon",
                  "Lazarus Group",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1047"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Management Instrumentation"
               ],
               "nist": [
                  "PR.PT",
                  "PR.AT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2018-10-23",
            "description": "This search looks for the creation of WMI temporary event subscriptions.",
            "how_to_implement": "To successfully implement this search, you must be ingesting the Windows WMI activity logs. This can be done by adding a stanza to inputs.conf on the system generating logs with a title of [WinEventLog://Microsoft-Windows-WMI-Activity/Operational].",
            "id": "38cbd42c-1098-41bb-99cf-9d6d2b296d83",
            "known_false_positives": "Some software may create WMI temporary event subscriptions for various purposes. The included search contains an exception for two of these that occur by default on Windows 10 systems. You may need to modify the search to create exceptions for other legitimate events.",
            "macros": [
               {
                  "definition": "sourcetype=\"wineventlog:microsoft-windows-wmi-activity/operational\"",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wmi"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "wmi_temporary_event_subscription_filter"
               }
            ],
            "name": "WMI Temporary Event Subscription",
            "references": [],
            "search": "`wmi` EventCode=5860 Temporary | rex field=Message \"NotificationQuery =\\s+(?<query>[^;|^$]+)\" | search query!=\"SELECT * FROM Win32_ProcessStartTrace WHERE ProcessName = 'wsmprovhost.exe'\" AND query!=\"SELECT * FROM __InstanceOperationEvent WHERE TargetInstance ISA 'AntiVirusProduct' OR TargetInstance ISA 'FirewallProduct' OR TargetInstance ISA 'AntiSpywareProduct'\" | stats count min(_time) as firstTime max(_time) as lastTime by ComputerName, query  | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `wmi_temporary_event_subscription_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious WMI Use"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT41",
                  "FIN6",
                  "Soft Cell",
                  "APT32",
                  "MuddyWater",
                  "OilRig",
                  "Threat Group-3390",
                  "FIN8",
                  "Leviathan",
                  "menuPass",
                  "Stealth Falcon",
                  "Lazarus Group",
                  "APT29",
                  "Deep Panda"
               ],
               "mitre_attack_id": [
                  "T1047"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Management Instrumentation"
               ],
               "nist": [
                  "PR.PT",
                  "PR.AT",
                  "PR.AC",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "c8ddc5be-69bc-4202-b3ab-4010b27d7ad5",
      "name": "Suspicious WMI Use",
      "narrative": "WMI is a Microsoft infrastructure for management data and operations on Windows operating systems. It includes of a set of utilities that can be leveraged to manage both local and remote Windows systems. Attackers are increasingly turning to WMI abuse in their efforts to conduct nefarious tasks, such as reconnaissance, detection of antivirus and virtual machines, code execution, lateral movement, persistence, and data exfiltration. \\\nThe detection searches included in this Analytic Story are used to look for suspicious use of WMI commands that attackers may leverage to interact with remote systems. The searches specifically look for the use of WMI to run processes on remote systems.\\\nIn the event that unauthorized WMI execution occurs, it will be important for analysts and investigators to determine the context of the event. These details may provide insights related to how WMI was used and to what end.",
      "references": [
         "https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf",
         "https://www.fireeye.com/blog/threat-research/2017/03/wmimplant_a_wmi_ba.html"
      ],
      "tags": {
         "analytics_story": "Suspicious WMI Use",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "TEMP.Veles",
            "APT29",
            "Cobalt Group",
            "APT1",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "OilRig",
            "APT32",
            "FIN10",
            "Axiom",
            "MuddyWater",
            "Threat Group-3390",
            "Lazarus Group",
            "APT3",
            "Frankenstein",
            "APT39",
            "Silence",
            "Stolen Pencil",
            "Dragonfly 2.0",
            "FIN6",
            "Blue Mockingbird",
            "Deep Panda",
            "Soft Cell",
            "Patchwork",
            "menuPass",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1047",
            "T1021.001"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Lateral Movement"
         ],
         "mitre_attack_technique": [
            "Windows Management Instrumentation",
            "Remote Desktop Protocol"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2020-04-13",
      "description": "Attackers are using Zoom as an vector to increase privileges on a sytems. This story detects new child processes of zoom and provides investigative actions for this detection.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for executions of cmd.exe spawned by a process that is often abused by attackers and that does not typically launch cmd.exe.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts and populates the Endpoint data model with the resultant dataset. This search includes a lookup file, `prohibited_apps_launching_cmd.csv`, that contains a list of processes that should not be spawning cmd.exe. You can modify this lookup to better suit your environment.",
            "id": "dcfd6b40-42f9-469d-a433-2e53f7486664",
            "known_false_positives": "There are circumstances where an application may legitimately execute and interact with the Windows command-line interface. Investigate and modify the lookup file, as appropriate.",
            "macros": [
               {
                  "definition": "| inputlookup prohibited_apps_launching_cmd | rename prohibited_applications as parent_process_name | eval parent_process_name=\"*\" . parent_process_name | table parent_process_name",
                  "description": "This macro outputs a list of process that should not be the parent process of cmd.exe",
                  "name": "prohibited_apps_launching_cmd"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_prohibited_applications_spawning_cmd_exe_filter"
               }
            ],
            "name": "Detect Prohibited Applications Spawning cmd exe",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe by Processes.parent_process_name Processes.process_name Processes.dest Processes.user| `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` |search [`prohibited_apps_launching_cmd`] | `detect_prohibited_applications_spawning_cmd_exe_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Suspicious MSHTA Activity",
                  "Suspicious Zoom Child Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "TA505",
                  "Blue Mockingbird",
                  "Tropic Trooper",
                  "Frankenstein",
                  "OilRig",
                  "Lazarus Group",
                  "Honeybee",
                  "Cobalt Group",
                  "FIN7",
                  "APT41",
                  "Soft Cell",
                  "Turla",
                  "Silence",
                  "APT32",
                  "APT39",
                  "Darkhotel",
                  "MuddyWater",
                  "APT18",
                  "APT38",
                  "Dark Caracal",
                  "Gorgon Group",
                  "Dragonfly 2.0",
                  "Rancor",
                  "Ke3chang",
                  "APT37",
                  "Leviathan",
                  "FIN8",
                  "APT28",
                  "Magic Hound",
                  "Sowbug",
                  "BRONZE BUTLER",
                  "FIN10",
                  "Threat Group-3390",
                  "menuPass",
                  "Gamaredon Group",
                  "Suckfly",
                  "Patchwork",
                  "Threat Group-1314",
                  "APT3",
                  "admin@338",
                  "APT1"
               ],
               "mitre_attack_id": [
                  "T1059.003"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Windows Command Shell"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2020-05-20",
                  "description": "This search returns the first and last time a process was seen per endpoint with a parent process of zoom.exe (Windows) or zoom.us (macOS). This table is then cached.",
                  "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints, to populate the Endpoint data model in the Processes node.",
                  "id": "60b9c00f-a9d6-4e51-803c-5d63ea21b95b",
                  "name": "Previously Seen Zoom Child Processes - Initial",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTimeSeen max(_time) as lastTimeSeen from datamodel=Endpoint.Processes where (Processes.parent_process_name=zoom.exe OR Processes.parent_process_name=zoom.us) by Processes.process_name Processes.dest| `drop_dm_object_name(Processes)` | table dest, process_name, firstTimeSeen, lastTimeSeen | outputlookup zoom_first_time_child_process",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Zoom Child Processes"
                     ],
                     "deployments": [
                        "90 Day Baseline"
                     ],
                     "detections": [
                        "First Time Seen Child Process of Zoom"
                     ]
                  },
                  "version": 1
               },
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2020-05-20",
                  "description": "This search returns the first and last time a process was seen per endpoint with a parent process of zoom.exe (Windows) or zoom.us (macOS) within the last hour. It then updates this information with historical data and filters out proces_name and endpoint pairs that have not been seen within the specified time window. This updated table is outputed to disk.",
                  "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints, to populate the Endpoint data model in the Processes node.",
                  "id": "80aea7fd-5da2-4533-b3c2-560533bfbaee",
                  "name": "Previously Seen Zoom Child Processes - Update",
                  "search": "| tstats `security_content_summariesonly` min(_time) as firstTimeSeen max(_time) as lastTimeSeen from datamodel=Endpoint.Processes where (Processes.parent_process_name=zoom.exe OR Processes.parent_process_name=zoom.us) by Processes.process_name Processes.dest| `drop_dm_object_name(Processes)` | table firstTimeSeen, lastTimeSeen, process_name, dest | inputlookup zoom_first_time_child_process append=t | stats min(firstTimeSeen) as firstTimeSeen max(lastTimeSeen) as lastTimeSeen by process_name, dest | where lastTimeSeen > relative_time(now(), \"`previously_seen_zoom_child_processes_forget_window`\") | outputlookup zoom_first_time_child_process",
                  "tags": {
                     "analytics_story": [
                        "Suspicious Zoom Child Processes"
                     ],
                     "deployments": [
                        "Hourly Cache Updates"
                     ],
                     "detections": [
                        "First Time Seen Child Process of Zoom"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-05-20",
            "description": "This search looks for child processes spawned by zoom.exe or zoom.us that has not previously been seen.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You should run the baseline search `Previously Seen Zoom Child Processes - Initial` to build the initial table of child processes and hostnames for this search to work. You should also schedule at the same interval as this search the second baseline search `Previously Seen Zoom Child Processes - Update` to keep this table up to date and to age out old child processes. Please update the `previously_seen_zoom_child_processes_window` macro to adjust the time window.",
            "id": "e91bd102-d630-4e76-ab73-7e3ba22c5961",
            "known_false_positives": "A new child process of zoom isn't malicious by that fact alone. Further investigation of the actions of the child process is needed to verify any malicious behavior is taken.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "-70m@m",
                  "description": "Use this macro to determine how far back you should be checking for new zoom child processes",
                  "name": "previously_seen_zoom_child_processes_window"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "first_time_seen_child_process_of_zoom_filter"
               }
            ],
            "name": "First Time Seen Child Process of Zoom",
            "references": [],
            "search": "| tstats `security_content_summariesonly` min(_time) as firstTime values(Processes.parent_process_name) as parent_process_name values(Processes.parent_process_id) as parent_process_id values(Processes.process_name) as process_name values(Processes.process) as process from datamodel=Endpoint.Processes where (Processes.parent_process_name=zoom.exe OR Processes.parent_process_name=zoom.us) by Processes.process_id Processes.dest | `drop_dm_object_name(Processes)` | lookup zoom_first_time_child_process dest as dest process_name as process_name OUTPUT firstTimeSeen | where isnull(firstTimeSeen) OR firstTimeSeen > relative_time(now(), \"`previously_seen_zoom_child_processes_window`\") | `security_content_ctime(firstTime)` | table firstTime dest, process_id, process_name, parent_process_id, parent_process_name |`first_time_seen_child_process_of_zoom_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Zoom Child Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Whitefly",
                  "APT33",
                  "Cobalt Group",
                  "PLATINUM",
                  "FIN8",
                  "APT32",
                  "Threat Group-3390",
                  "FIN6",
                  "APT28"
               ],
               "mitre_attack_id": [
                  "T1068"
               ],
               "mitre_attack_tactics": [
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Exploitation for Privilege Escalation"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "aa3749a6-49c7-491e-a03f-4eaee5fe0258",
      "name": "Suspicious Zoom Child Processes",
      "narrative": "Zoom is a leader in modern enterprise video communications and its usage has increased dramatically with a large amount of the population under stay-at-home orders due to the COVID-19 pandemic. With increased usage has come increased scrutiny and several security flaws have been found with this application on both Windows and macOS systems.\\\nCurrent detections focus on finding new child processes of this application on a per host basis. Investigative searches are included to gather information needed during an investigation.",
      "references": [
         "https://blog.rapid7.com/2020/04/02/dispelling-zoom-bugbears-what-you-need-to-know-about-the-latest-zoom-vulnerabilities/",
         "https://threatpost.com/two-zoom-zero-day-flaws-uncovered/154337/"
      ],
      "tags": {
         "analytics_story": "Suspicious Zoom Child Processes",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sowbug",
            "Whitefly",
            "Cobalt Group",
            "APT1",
            "APT41",
            "Leviathan",
            "FIN8",
            "Turla",
            "admin@338",
            "Gorgon Group",
            "BRONZE BUTLER",
            "OilRig",
            "APT32",
            "Suckfly",
            "FIN10",
            "Dark Caracal",
            "PLATINUM",
            "FIN7",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "APT38",
            "Silence",
            "APT39",
            "Dragonfly 2.0",
            "APT33",
            "Blue Mockingbird",
            "APT18",
            "APT28",
            "FIN6",
            "Soft Cell",
            "Tropic Trooper",
            "Patchwork",
            "Threat Group-1314",
            "TA505",
            "menuPass"
         ],
         "mitre_attack_id": [
            "T1068",
            "T1059.003"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Exploitation for Privilege Escalation",
            "Windows Command Shell"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2018-04-09",
      "description": "Identify unusual changes to your AWS EC2 instances that may indicate malicious activity. Modifications to your EC2 instances by previously unseen users is an example of an activity that may warrant further investigation.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2018-04-05",
                  "description": "This search builds a table of previously seen ARNs that have launched a EC2 instance.",
                  "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS version (4.4.0 or later), then configure your CloudTrail inputs. To add or remove APIs that modify an EC2 instance, edit the macro `ec2_modification_api_calls`.",
                  "id": "4d69091b-d975-4267-85df-888bd41034eb",
                  "name": "Previously Seen EC2 Modifications By User",
                  "search": "`cloudtrail` `ec2_modification_api_calls` errorCode=success | spath output=arn userIdentity.arn | stats earliest(_time) as firstTime latest(_time) as lastTime by arn | outputlookup previously_seen_ec2_modifications_by_user | stats count",
                  "tags": {
                     "analytics_story": [
                        "Unusual AWS EC2 Modifications"
                     ],
                     "detections": [
                        "EC2 Instance Modified With Previously Unseen User"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for EC2 instances being modified by users who have not previously modified them.",
            "how_to_implement": "You must install the AWS App for Splunk (version 5.1.0 or later) and Splunk Add-on for AWS (version 4.4.0 or later), then configure your CloudTrail inputs. This search works best when you run the \"Previously Seen EC2 Launches By User\" support search once to create a history of previously seen ARNs. To add or remove APIs that modify an EC2 instance, edit the macro `ec2_modification_api_calls`.",
            "id": "56f91724-cf3f-4666-84e1-e3712fb41e76",
            "known_false_positives": "It's possible that a new user will start to modify EC2 instances when they haven't before for any number of reasons. Verify with the user that is modifying instances that this is the intended behavior.",
            "macros": [
               {
                  "definition": "(eventName=AssociateAddress OR eventName=AssociateIamInstanceProfile OR eventName=AttachClassicLinkVpc OR eventName=AttachNetworkInterface OR eventName=AttachVolume OR eventName=BundleInstance OR eventName=DetachClassicLinkVpc OR eventName=DetachVolume OR eventName=GetConsoleOutput OR eventName=GetConsoleScreenshot OR eventName=ModifyInstanceAttribute OR eventName=ModifyInstancePlacement OR eventName=MonitorInstances OR eventName=RebootInstances OR eventName=ResetInstanceAttribute OR eventName=StartInstances OR eventName=StopInstances OR eventName=TerminateInstances OR eventName=UnmonitorInstances)",
                  "description": "This is a list of AWS event names that have to do with modifying Amazon EC2 instances",
                  "name": "ec2_modification_api_calls"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "sourcetype=aws:cloudtrail",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "cloudtrail"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "ec2_instance_modified_with_previously_unseen_user_filter"
               }
            ],
            "name": "EC2 Instance Modified With Previously Unseen User",
            "references": [],
            "search": "`cloudtrail` `ec2_modification_api_calls` [search `cloudtrail` `ec2_modification_api_calls` errorCode=success | stats earliest(_time) as firstTime latest(_time) as lastTime by userIdentity.arn | rename userIdentity.arn as arn | inputlookup append=t previously_seen_ec2_modifications_by_user | stats min(firstTime) as firstTime, max(lastTime) as lastTime by arn | outputlookup previously_seen_ec2_modifications_by_user | eval newUser=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newUser=1 | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename arn as userIdentity.arn | table userIdentity.arn] | spath output=dest responseElements.instancesSet.items{}.instanceId | spath output=user userIdentity.arn | table _time, user, dest | `ec2_instance_modified_with_previously_unseen_user_filter`",
            "tags": {
               "analytics_story": [
                  "Unusual AWS EC2 Modifications"
               ],
               "asset_type": "AWS Instance",
               "cis20": [
                  "CIS 1"
               ],
               "mitre_attack_groups": [
                  "APT33"
               ],
               "mitre_attack_id": [
                  "T1078.004"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Cloud Accounts"
               ],
               "nist": [
                  "ID.AM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "73de57ef-0dfc-411f-b1e7-fa24428aeae0",
      "name": "Unusual AWS EC2 Modifications",
      "narrative": "A common attack technique is to infiltrate a cloud instance and make modifications. The adversary can then secure access to your infrastructure or hide their activities. So it's important to stay alert to changes that may indicate that your environment has been compromised. \\\n Searches within this Analytic Story can help you detect the presence of a threat by monitoring for EC2 instances that have been created or changed--either by users that have never previously performed these activities or by known users who modify or create instances in a way that have not been done before. This story also provides investigative searches that help you go deeper once you detect suspicious behavior.",
      "references": [
         "https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf"
      ],
      "tags": {
         "analytics_story": "Unusual AWS EC2 Modifications",
         "category": [
            "Cloud Security"
         ],
         "mitre_attack_groups": [
            "APT33"
         ],
         "mitre_attack_id": [
            "T1078.004"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Cloud Accounts"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2020-02-04",
      "description": "Quickly identify systems running new or unusual processes in your environment that could be indicators of suspicious activity. Processes run from unusual locations, those with conspicuously long command lines, and rare executables are all examples of activities that may warrant deeper investigation.",
      "detections": [
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2018-11-20",
            "description": "This search looks for fast execution of processes used for system network configuration discovery on the endpoint.",
            "how_to_implement": "You must be ingesting data that records registry activity from your hosts to populate the Endpoint data model in the processes node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or endpoint data sources, such as Sysmon. The data used for this search is usually generated via logs that report reads and writes to the registry or that are populated via Windows event logs, after enabling process tracking in your Windows audit settings.",
            "id": "a51bfe1a-94f0-48cc-b1e4-16ae10145893",
            "known_false_positives": "It is uncommon for normal users to execute a series of commands used for network discovery. System administrators often use scripts to execute these commands. These can generate false positives.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "(process_name= \"arp.exe\" OR process_name= \"at.exe\" OR process_name= \"attrib.exe\" OR process_name= \"cscript.exe\" OR process_name= \"dsquery.exe\" OR process_name= \"hostname.exe\" OR process_name= \"ipconfig.exe\" OR process_name= \"mimikatz.exe\" OR process_name= \"nbstat.exe\" OR process_name= \"net.exe\" OR process_name= \"netsh.exe\" OR process_name= \"nslookup.exe\" OR process_name= \"ping.exe\" OR process_name= \"quser.exe\" OR process_name= \"qwinsta.exe\" OR process_name= \"reg.exe\" OR process_name= \"runas.exe\" OR process_name= \"sc.exe\" OR process_name= \"schtasks.exe\" OR process_name= \"ssh.exe\" OR process_name= \"systeminfo.exe\" OR process_name= \"taskkill.exe\" OR process_name= \"telnet.exe\" OR process_name= \"tracert.exe\" OR process_name=\"wscript.exe\" OR process_name= \"xcopy.exe\")",
                  "description": "This macro is a list of process that can be used to discover the network configuration",
                  "name": "system_network_configuration_discovery_tools"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_processes_used_for_system_network_configuration_discovery_filter"
               }
            ],
            "name": "Detect processes used for System Network Configuration Discovery",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.dest Processes.process_name Processes.user _time | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | search `system_network_configuration_discovery_tools` | transaction dest connected=false maxpause=5m |where eventcount>=5 | table firstTime lastTime dest user process_name process parent_process eventcount | `detect_processes_used_for_system_network_configuration_discovery_filter`",
            "tags": {
               "analytics_story": [
                  "Unusual Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-03-16",
            "description": "This search will return a table of rare processes, the names of the systems running them, and the users who initiated each process.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts and populating the endpoint data model with the resultant dataset. The macro `filter_rare_process_whitelist` searches two lookup files to whitelist your processes.  These consist of `rare_process_whitelist_default.csv` and `rare_process_whitelist_local.csv`. To add your own processes to the whitelist, add them to `rare_process_whitelist_local.csv`. If you wish to remove an entry from the default lookup file, you will have to modify the macro itself to set the whitelist value for that process to false. You can modify the limit parameter and search scheduling to better suit your environment.",
            "id": "44fddcb2-8d3b-454c-874e-7c6de5a4f7ac",
            "known_false_positives": "Some legitimate processes may be only rarely executed in your environment. As these are identified, update `rare_process_whitelist_local.csv` to filter them out of your search results.",
            "macros": [
               {
                  "definition": "lookup update=true lookup_rare_process_whitelist_default process as process OUTPUTNEW whitelist | where whitelist=\"false\" | lookup update=true lookup_rare_process_whitelist_local process as process OUTPUT whitelist | where whitelist=\"false\"",
                  "description": "This macro is intended to whitelist processes that have been definied as rare",
                  "name": "filter_rare_process_whitelist"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_rare_executables_filter"
               }
            ],
            "name": "Detect Rare Executables",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.dest) as dest values(Processes.user) as user min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.process_name  | rename Processes.process_name as process | rex field=user \"(?<user_domain>.*)\\\\\\\\(?<user_name>.*)\" | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| search [| tstats count from datamodel=Endpoint.Processes by Processes.process_name | rare Processes.process_name limit=30 | rename Processes.process_name as process| `filter_rare_process_whitelist`| table process ] | `detect_rare_executables_filter` ",
            "tags": {
               "analytics_story": [
                  "Emotet Malware  DHS Report TA18-201A ",
                  "Unusual Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Command and Control",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "ID.AM",
                  "PR.PT",
                  "PR.DS",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for DLLs under %AppData% being loaded by rundll32.exe that are calling the exported function at ordinal 2. Calling exported functions by ordinal is not as common as calling by exported name. There was a bug fixed in IDAPro on 2016-08-08 that would not display functions without names.  Calling functions by ordinal would overcome the lack of name and make it harder for analyst to reverse engineer.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "6c135f8d-5e60-454e-80b7-c56eed739833",
            "known_false_positives": "While not common, loading a DLL under %AppData% and calling a function by ordinal is possible by a legitimate process",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "rundll_loading_dll_by_ordinal_filter"
               }
            ],
            "name": "RunDLL Loading DLL By Ordinal",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = rundll32.exe Processes.process=\"*AppData*\" Processes.process=\"*,#2\" by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `rundll_loading_dll_by_ordinal_filter`",
            "tags": {
               "analytics_story": [
                  "Unusual Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation"
               ],
               "mitre_attack_groups": [
                  "APT32",
                  "Sandworm Team",
                  "Blue Mockingbird",
                  "TA505",
                  "MuddyWater",
                  "APT29",
                  "APT19",
                  "CopyKittens",
                  "APT3",
                  "Carbanak",
                  "APT28"
               ],
               "mitre_attack_id": [
                  "T1218.011"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Rundll32"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-02-04",
            "description": "This search looks for system processes that normally run out of C:\\Windows\\System32\\ or C:\\Windows\\SysWOW64 that are not run from that location.  This can indicate a malicious process that is trying to hide as a legitimate process.",
            "how_to_implement": "To successfully implement this search you need to ingest details about process execution from your hosts. Specifically, this search requires the process name and the full path to the process executable.",
            "id": "a34aae96-ccf8-4aef-952c-3ea21444444d",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "definition": "lookup update=true is_windows_system_file filename as process_name OUTPUT systemFile | search systemFile=true",
                  "description": "This macro limits the output to process names that are in the Windows System directory",
                  "name": "is_windows_system_file"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "system_processes_run_from_unexpected_locations_filter"
               }
            ],
            "name": "System Processes Run From Unexpected Locations",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_path !=\"C:\\\\Windows\\\\System32*\" Processes.process_path !=\"C:\\\\Windows\\\\SysWOW64*\" by Processes.user Processes.dest Processes.process_name Processes.process_id Processes.process_path Processes.parent_process_name Processes.process_hash| `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| `is_windows_system_file` | `system_processes_run_from_unexpected_locations_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Windshift",
                  "APT32",
                  "BRONZE BUTLER",
                  "menuPass",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1036"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Masquerading"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 5
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for applications on the endpoint that you have marked as uncommon.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model. This search uses a lookup file `uncommon_processes_default.csv` to track various features of process names that are usually uncommon in most environments. Please consider updating `uncommon_processes_local.csv` to hunt for processes that are uncommon in your environment.",
            "id": "29ccce64-a10c-4389-a45f-337cb29ba1f7",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "lookup update=true lookup_uncommon_processes_default process_name as process_name outputnew uncommon_default,category_default,analytic_story_default,kill_chain_phase_default,mitre_attack_default | lookup update=true  lookup_uncommon_processes_local process_name as process_name outputnew uncommon_local,category_local,analytic_story_local,kill_chain_phase_local,mitre_attack_local | eval uncommon = coalesce(uncommon_default, uncommon_local), analytic_story = coalesce(analytic_story_default, analytic_story_local), category=coalesce(category_default, category_local), kill_chain_phase=coalesce(kill_chain_phase_default, kill_chain_phase_local), mitre_attack=coalesce(mitre_attack_default, mitre_attack_local) | fields - analytic_story_default, analytic_story_local, category_default, category_local, kill_chain_phase_default, kill_chain_phase_local, mitre_attack_default, mitre_attack_local, uncommon_default, uncommon_local | search uncommon=true",
                  "description": "This macro limits the output to processes that have been marked as uncommon",
                  "name": "uncommon_processes"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "uncommon_processes_on_endpoint_filter"
               }
            ],
            "name": "Uncommon Processes On Endpoint",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.dest Processes.user Processes.process Processes.process_name | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `uncommon_processes` |`uncommon_processes_on_endpoint_filter` ",
            "tags": {
               "analytics_story": [
                  "Windows Privilege Escalation",
                  "Unusual Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Magic Hound",
                  "Windshift",
                  "APT33",
                  "Sandworm Team",
                  "Naikon",
                  "Whitefly",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Wizard Spider",
                  "Mofang",
                  "Frankenstein",
                  "RTM",
                  "Inception",
                  "BlackTech",
                  "APT-C-36",
                  "Machete",
                  "admin@338",
                  "APT12",
                  "TA505",
                  "Silence",
                  "The White Company",
                  "APT39",
                  "FIN4",
                  "Darkhotel",
                  "Gallmaker",
                  "APT19",
                  "Dragonfly 2.0",
                  "BRONZE BUTLER",
                  "Cobalt Group",
                  "DarkHydrus",
                  "Gorgon Group",
                  "Patchwork",
                  "OilRig",
                  "Dark Caracal",
                  "MuddyWater",
                  "Lazarus Group",
                  "FIN7",
                  "APT32",
                  "Rancor",
                  "APT37",
                  "FIN8",
                  "APT28",
                  "Elderwood",
                  "TA459",
                  "APT29",
                  "Leviathan",
                  "menuPass",
                  "PLATINUM"
               ],
               "mitre_attack_id": [
                  "T1204.002"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Malicious File"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-16",
            "description": "Command lines that are extremely long may be indicative of malicious activity on your hosts.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships, from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c77162d3-f93c-45cc-80c8-22f6a4264e7f",
            "known_false_positives": "Some legitimate applications start with long command lines.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unusually_long_command_line_filter"
               }
            ],
            "name": "Unusually Long Command Line",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`|  eval processlen=len(process) | eventstats stdev(processlen) as stdev, avg(processlen) as avg by dest | stats max(processlen) as maxlen, values(stdev) as stdevperhost, values(avg) as avgperhost by dest, user, process_name, process | `unusually_long_command_line_filter` | eval threshold = 10 | where maxlen > ((threshold*stdevperhost) + avgperhost)",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "baselines": [
               {
                  "author": "Rico Valdez, Splunk",
                  "date": "2019-05-08",
                  "description": "This search is used to build a Machine Learning Toolkit (MLTK) model to characterize the length of the command lines observed for each user in the environment. By default, the search uses the last 30 days of data to build the model. The model created by this search is then used in the corresponding detection search, which identifies outliers in the length of the command line.",
                  "how_to_implement": "You must be ingesting endpoint data and populating the Endpoint data model. In addition, you must have the Machine Learning Toolkit (MLTK) version >= 4.2 installed, along with any required dependencies. Depending on the number of users in your environment, you may also need to adjust the value for max_inputs in the MLTK settings for the DensityFunction algorithm, then ensure that the search completes in a reasonable timeframe. By default, the search builds the model using the past 30 days of data. You can modify the search window to build the model over a longer period of time, which may give you better results. You may also want to periodically re-run this search to rebuild the model with the latest data. More information on the algorithm used in the search can be found at `https://docs.splunk.com/Documentation/MLApp/4.2.0/User/Algorithms#DensityFunction`.",
                  "id": "d2a4d85b-fc6a-47a0-82f6-bc1ec2ebc459",
                  "name": "Baseline of Command Line Length - MLTK",
                  "search": "| tstats `security_content_summariesonly` count min(_time) as start_time max(_time) as end_time FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(Processes)` | search user!=unknown | `security_content_ctime(start_time)`| `security_content_ctime(end_time)`| eval processlen=len(process) | fit DensityFunction processlen by user into cmdline_pdfmodel",
                  "tags": {
                     "analytics_story": [
                        "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                        "Ransomware",
                        "Suspicious Command-Line Executions",
                        "Suspicious MSHTA Activity",
                        "Unusual Processes"
                     ],
                     "detections": [
                        "Detect Prohibited Applications Spawning cmd.exe",
                        "Unusually Long Command Line - MLTK"
                     ]
                  },
                  "version": 1
               }
            ],
            "date": "2019-05-08",
            "description": "Command lines that are extremely long may be indicative of malicious activity on your hosts. This search leverages the Machine Learning Toolkit (MLTK) to help identify command lines with lengths that are unusual for a given user.",
            "how_to_implement": "You must be ingesting endpoint data that monitors command lines and populates the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model. In addition, MLTK version >= 4.2 must be installed on your search heads, along with any required dependencies. Finally, the support search \"Baseline of Command Line Length - MLTK\" must be executed before this detection search, as it builds an ML model over the historical data used by this search. It is important that this search is run in the same app context as the associated support search, so that the model created by the support search is available for use. You should periodically re-run the support search to rebuild the model with the latest data available in your environment.",
            "id": "57edaefa-a73b-45e5-bbae-f39c1473f941",
            "known_false_positives": "Some legitimate applications use long command lines for installs or updates. You should review identified command lines for legitimacy. You may modify the first part of the search to omit legitimate command lines from consideration. If you are seeing more results than desired, you may consider changing the value of threshold in the search to a smaller value. You should also periodically re-run the support search to re-build the ML model on the latest data. You may get unexpected results if the user identified in the results is not present in the data used to build the associated model.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "unusually_long_command_line___mltk_filter"
               }
            ],
            "name": "Unusually Long Command Line - MLTK",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes by Processes.user Processes.dest Processes.process_name Processes.process | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)`| eval processlen=len(process) | search user!=unknown | apply cmdline_pdfmodel threshold=0.01 | rename \"IsOutlier(processlen)\" as isOutlier | search isOutlier > 0 | table firstTime lastTime user dest process_name process processlen count | `unusually_long_command_line___mltk_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Command-Line Executions",
                  "Unusual Processes",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "f4368e3f-d59f-4192-84f6-748ac5a3ddb6",
      "name": "Unusual Processes",
      "narrative": "Being able to profile a host's processes within your environment can help you more quickly identify processes that seem out of place when compared to the rest of the population of hosts or asset types.\\\nThis Analytic Story lets you identify processes that are either a) not typically seen running or b) have some sort of suspicious command-line arguments associated with them. This Analytic Story will also help you identify the user running these processes and the associated process activity on the host.\\\nIn the event an unusual process is identified, it is imperative to better understand how that process was able to execute on the host, when it first executed, and whether other hosts are affected. This extra information may provide clues that can help the analyst further investigate any suspicious activity.",
      "references": [
         "https://www.fireeye.com/blog/threat-research/2017/08/monitoring-windows-console-activity-part-two.html",
         "https://www.splunk.com/pdfs/technical-briefs/advanced-threat-detection-and-response-tech-brief.pdf",
         "https://www.sans.org/reading-room/whitepapers/logging/detecting-security-incidents-windows-workstation-event-logs-34262"
      ],
      "tags": {
         "analytics_story": "Unusual Processes",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "Whitefly",
            "APT29",
            "Cobalt Group",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Inception",
            "APT-C-36",
            "admin@338",
            "Naikon",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "CopyKittens",
            "Molerats",
            "OilRig",
            "Elderwood",
            "APT32",
            "Machete",
            "BlackTech",
            "Dark Caracal",
            "PLATINUM",
            "FIN4",
            "FIN7",
            "APT19",
            "APT12",
            "APT37",
            "Windshift",
            "TA459",
            "Magic Hound",
            "MuddyWater",
            "Mofang",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Carbanak",
            "Darkhotel",
            "Frankenstein",
            "Dragonfly 2.0",
            "Silence",
            "APT39",
            "Gallmaker",
            "APT33",
            "Blue Mockingbird",
            "APT28",
            "Tropic Trooper",
            "DarkHydrus",
            "Patchwork",
            "TA505",
            "menuPass",
            "The White Company"
         ],
         "mitre_attack_id": [
            "T1218.011",
            "T1204.002",
            "T1036"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Defense Evasion"
         ],
         "mitre_attack_technique": [
            "Masquerading",
            "Malicious File",
            "Rundll32"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2017-09-15",
      "description": "Leverage searches that detect cleartext network protocols that may leak credentials or should otherwise be encrypted.",
      "detections": [
         {
            "author": "Rico Valdez, Splunk",
            "date": "2017-09-15",
            "description": "This search looks for cleartext protocols at risk of leaking credentials. Currently, this consists of legacy protocols such as telnet, POP3, IMAP, and non-anonymous FTP sessions. While some of these protocols can be used over SSL, they typically run on different assigned ports in those cases.",
            "how_to_implement": "This search requires you to be ingesting your network traffic, and populating the Network_Traffic data model.",
            "id": "6923cd64-17a0-453c-b945-81ac2d8c6db9",
            "known_false_positives": "Some networks may use kerberized FTP or telnet servers, however, this is rare.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "protocols_passing_authentication_in_cleartext_filter"
               }
            ],
            "name": "Protocols passing authentication in cleartext",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.protocol=\"tcp\" AND (All_Traffic.dest_port=\"23\" OR All_Traffic.dest_port=\"143\" OR All_Traffic.dest_port=\"110\" OR (All_Traffic.dest_port=\"21\" AND All_Traffic.user != \"anonymous\")) groupby All_Traffic.user All_Traffic.src All_Traffic.dest All_Traffic.dest_port | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(\"All_Traffic\")` | `protocols_passing_authentication_in_cleartext_filter`",
            "tags": {
               "analytics_story": [
                  "Use of Cleartext Protocols"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 9",
                  "CIS 14"
               ],
               "kill_chain_phases": [
                  "Reconnaissance",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.AE",
                  "PR.AC",
                  "PR.DS"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "826e6431-aeef-41b4-9fc0-6d0985d65a21",
      "name": "Use of Cleartext Protocols",
      "narrative": "Various legacy protocols operate by default in the clear, without the protections of encryption. This potentially leaks sensitive information that can be exploited by passively sniffing network traffic. Depending on the protocol, this information could be highly sensitive, or could allow for session hijacking. In addition, these protocols send authentication information, which would allow for the harvesting of usernames and passwords that could potentially be used to authenticate and compromise secondary systems.",
      "references": [
         "https://www.monkey.org/~dugsong/dsniff/"
      ],
      "tags": {
         "analytics_story": "Use of Cleartext Protocols",
         "category": [
            "Best Practices"
         ],
         "mitre_attack_groups": [],
         "mitre_attack_id": [],
         "mitre_attack_tactics": [],
         "mitre_attack_technique": [],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Jim Apger, Splunk",
      "date": "2018-10-08",
      "description": "Monitor your environment for activity consistent with common attack techniques bad actors use when attempting to compromise web servers or other web-related assets.",
      "detections": [
         {
            "author": "Jim Apger, Splunk",
            "date": "2018-10-08",
            "description": "This search is used to identify the creation of multiple user accounts using the same email domain name.",
            "how_to_implement": "We start with a dataset that provides visibility into the email address used for the account creation. In this example, we are narrowing our search down to the single web page that hosts the Magento2 e-commerce platform (via URI) used for account creation, the single http content-type to grab only the user's clicks, and the http field that provides the username (form_data), for performance reasons.  After we have the username and email domain, we look for numerous account creations per email domain.  Common data sources used for this detection are customized Apache logs or Splunk Stream.",
            "id": "31337aaa-941d-4ada-81ac-q2a17be5bf0d",
            "known_false_positives": "As is common with many fraud-related searches, we are usually looking to attribute risk or synthesize relevant context with loosely written detections that simply detect anamolous behavior. This search will need to be customized to fit your environment&#151;improving its fidelity by counting based on something much more specific, such as a device ID that may be present in your dataset. Consideration for whether the large number of registrations are occuring from a first-time seen domain may also be important.  Extending the search window to look further back in time, or even calculating the average per hour/day for each email domain to look for an anomalous spikes, will improve this search.  You can also use Shannon entropy or Levenshtein Distance (both courtesy of URL Toolbox) to consider the randomness or similarity of the email name or email domain, as the names are often machine-generated.",
            "macros": [
               {
                  "definition": "sourcetype=stream:http",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "stream_http"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "web_fraud___account_harvesting_filter"
               }
            ],
            "name": "Web Fraud - Account Harvesting",
            "references": [
               "https://splunkbase.splunk.com/app/2734/",
               "https://splunkbase.splunk.com/app/1809/"
            ],
            "search": "`stream_http` http_content_type=text* uri=\"/magento2/customer/account/loginPost/\" | rex field=cookie \"form_key=(?<SessionID>\\w+)\" | rex field=form_data \"login\\[username\\]=(?<Username>[^&|^$]+)\" | search Username=* | rex field=Username \"@(?<email_domain>.*)\" | stats dc(Username) as UniqueUsernames list(Username) as src_user by email_domain | where UniqueUsernames> 25 | `web_fraud___account_harvesting_filter`",
            "tags": {
               "analytics_story": [
                  "Web Fraud Detection"
               ],
               "asset_type": "Account",
               "cis20": [
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1136"
               ],
               "mitre_attack_tactics": [
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Create Account"
               ],
               "nist": [
                  "DE.CM",
                  "DE.DP"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Jim Apger, Splunk",
            "date": "2018-10-08",
            "description": "This search is used to examine web sessions to identify those where the clicks are occurring too quickly for a human or are occurring with a near-perfect cadence (high periodicity or low standard deviation), resembling a script driven session.",
            "how_to_implement": "Start with a dataset that allows you to see clickstream data for each user click on the website. That data must have a time stamp and must contain a reference to the session identifier being used by the website. This ties the clicks together into clickstreams. This value is usually found in the http cookie. With a bit of tuning, a version of this search could be used in high-volume scenarios, such as scraping, crawling, application DDOS, credit-card testing, account takeover, etc. Common data sources used for this detection are customized Apache logs, customized IIS, and Splunk Stream.",
            "id": "31337bbb-bc22-4752-b599-ef192df2dc7a",
            "known_false_positives": "As is common with many fraud-related searches, we are usually looking to attribute risk or synthesize relevant context with loosly written detections that simply detect anamoluous behavior.",
            "macros": [
               {
                  "definition": "sourcetype=stream:http",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "stream_http"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "web_fraud___anomalous_user_clickspeed_filter"
               }
            ],
            "name": "Web Fraud - Anomalous User Clickspeed",
            "references": [
               "https://en.wikipedia.org/wiki/Session_ID",
               "https://en.wikipedia.org/wiki/Session_(computer_science)",
               "https://en.wikipedia.org/wiki/HTTP_cookie",
               "https://splunkbase.splunk.com/app/1809/"
            ],
            "search": "`stream_http` http_content_type=text* | rex field=cookie \"form_key=(?<session_id>\\w+)\" | streamstats window=2 current=1 range(_time) as TimeDelta by session_id | where TimeDelta>0 |stats count stdev(TimeDelta) as ClickSpeedStdDev avg(TimeDelta) as ClickSpeedAvg by session_id | where count>5 AND (ClickSpeedStdDev<.5 OR ClickSpeedAvg<.5) | `web_fraud___anomalous_user_clickspeed_filter`",
            "tags": {
               "analytics_story": [
                  "Web Fraud Detection"
               ],
               "asset_type": "account",
               "cis20": [
                  "CIS 6"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "Soft Cell",
                  "TEMP.Veles",
                  "APT39",
                  "FIN4",
                  "Night Dragon",
                  "Dragonfly 2.0",
                  "FIN8",
                  "Leviathan",
                  "APT33",
                  "OilRig",
                  "FIN5",
                  "menuPass",
                  "APT28",
                  "FIN10",
                  "Suckfly",
                  "FIN6",
                  "Threat Group-3390",
                  "APT18",
                  "PittyTiger",
                  "Carbanak"
               ],
               "mitre_attack_id": [
                  "T1078"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion",
                  "Persistence",
                  "Privilege Escalation",
                  "Initial Access"
               ],
               "mitre_attack_technique": [
                  "Valid Accounts"
               ],
               "nist": [
                  "DE.AE",
                  "DE.CM"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Jim Apger, Splunk",
            "date": "2018-10-08",
            "description": "This search is used to identify user accounts that share a common password.",
            "how_to_implement": "We need to start with a dataset that allows us to see the values of usernames and passwords that users are submitting to the website hosting the Magento2 e-commerce platform (commonly found in the HTTP form_data field). A tokenized or hashed value of a password is acceptable and certainly preferable to a clear-text password. Common data sources used for this detection are customized Apache logs, customized IIS, and Splunk Stream.",
            "id": "31337a1a-53b9-4e05-96e9-55c934cb71d3",
            "known_false_positives": "As is common with many fraud-related searches, we are usually looking to attribute risk or synthesize relevant context with loosely written detections that simply detect anamoluous behavior.",
            "macros": [
               {
                  "definition": "sourcetype=stream:http",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "stream_http"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "web_fraud___password_sharing_across_accounts_filter"
               }
            ],
            "name": "Web Fraud - Password Sharing Across Accounts",
            "references": [
               "https://en.wikipedia.org/wiki/Session_ID",
               "https://en.wikipedia.org/wiki/Session_(computer_science)",
               "https://en.wikipedia.org/wiki/HTTP_cookie",
               "https://splunkbase.splunk.com/app/1809/"
            ],
            "search": "`stream_http` http_content_type=text* uri=/magento2/customer/account/loginPost*  | rex field=form_data \"login\\[username\\]=(?<Username>[^&|^$]+)\" | rex field=form_data \"login\\[password\\]=(?<Password>[^&|^$]+)\" | stats dc(Username) as UniqueUsernames values(Username) as user list(src_ip) as src_ip by Password|where UniqueUsernames>5 | `web_fraud___password_sharing_across_accounts_filter`",
            "tags": {
               "analytics_story": [
                  "Web Fraud Detection"
               ],
               "asset_type": "account",
               "cis20": [
                  "CIS 16"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.DP"
               ],
               "security_domain": "threat"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "31337aaa-bc22-4752-b599-ef112dq1dq7a",
      "name": "Web Fraud Detection",
      "narrative": "The Federal Bureau of Investigations (FBI) defines Internet fraud as the use of Internet services or software with Internet access to defraud victims or to otherwise take advantage of them. According to the Bureau, Internet crime schemes are used to steal millions of dollars each year from victims and continue to plague the Internet through various methods. The agency includes phishing scams, data breaches, Denial of Service (DOS) attacks, email account compromise, malware, spoofing, and ransomware in this category.\\\nThese crimes are not the fraud itself, but rather the attack techniques commonly employed by fraudsters in their pursuit of data that enables them to commit malicious actssuch as obtaining and using stolen credit cards. They represent a serious problem that is steadily increasing and not likely to go away anytime soon.\\\nhen developing a strategy for preventing fraud in your environment, its important to  look across all of your web services for evidence that attackers are abusing enterprise resources to enumerate systems, harvest data for secondary fraudulent activity, or abuse terms of service.This Analytic Story looks for evidence of common Internet attack techniques that could be indicative of web fraud in your environmentincluding account harvesting, anomalous user clickspeed, and password sharing across accounts, to name just a few.\\\nThe account-harvesting search focuses on web pages used for user-account registration. It detects the creation of a large number of user accounts using the same email domain name, a type of activity frequently seen in advance of a fraud campaign.\\\nThe anomalous clickspeed search looks for users who are moving through your website at a faster-than-normal speed or with a perfect click cadence (high periodicity or low standard deviation), which could indicate that the user is a script, not an actual human.\\\nAnother search detects incidents wherein a single password is used across multiple accounts, which may indicate that a fraudster has infiltrated your environment and embedded a common password within a script.",
      "references": [
         "https://www.fbi.gov/scams-and-safety/common-fraud-schemes/internet-fraud",
         "https://www.fbi.gov/news/stories/2017-internet-crime-report-released-050718"
      ],
      "tags": {
         "analytics_story": "Web Fraud Detection",
         "category": [
            "Abuse"
         ],
         "mitre_attack_groups": [
            "Sandworm Team",
            "TEMP.Veles",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN5",
            "FIN8",
            "OilRig",
            "Suckfly",
            "FIN10",
            "FIN4",
            "PittyTiger",
            "no",
            "Night Dragon",
            "Threat Group-3390",
            "Carbanak",
            "Dragonfly 2.0",
            "Silence",
            "APT39",
            "APT33",
            "FIN6",
            "APT18",
            "APT28",
            "Soft Cell",
            "menuPass"
         ],
         "mitre_attack_id": [
            "T1136",
            "T1078"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Initial Access",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Valid Accounts",
            "Create Account"
         ],
         "usecase": "Fraud Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2018-05-31",
      "description": "Detect tactics used by malware to evade defenses on Windows endpoints. A few of these include suspicious `reg.exe` processes, files hidden with `attrib.exe` and disabling user-account control, among many others ",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-03-02",
            "description": "The search looks for modifications to registry keys that control the enforcement of Windows User Account Control (UAC).",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or via other endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report registry modifications.",
            "id": "bbc644bc-37df-4e1a-9c88-ec9a53e2038c",
            "known_false_positives": "This registry key may be modified via administrators to implement a change in system policy. This type of change should be a very rare occurrence.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "disabling_remote_user_account_control_filter"
               }
            ],
            "name": "Disabling Remote User Account Control",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.registry_path=\"*Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\LocalAccountTokenFilterPolicy\" by Registry.dest, Registry.registry_key_name Registry.user Registry.registry_path Registry.action | `drop_dm_object_name(Registry)` | `disabling_remote_user_account_control_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Suspicious Windows Registry Activities"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "Turla",
                  "APT32",
                  "APT38",
                  "Dragonfly 2.0",
                  "APT19",
                  "Threat Group-3390",
                  "Honeybee",
                  "Patchwork",
                  "Gorgon Group",
                  "FIN8"
               ],
               "mitre_attack_id": [
                  "T1112"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Modify Registry"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "Attackers leverage an existing Windows binary, attrib.exe, to mark specific as hidden by using specific flags so that the victim does not see the file.  The search looks for specific command-line arguments to detect the use of attrib.exe to hide files.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c77162d3-f93c-45cc-80c8-22f6b5264g9f",
            "known_false_positives": "Some applications and users may legitimately use attrib.exe to interact with the files. ",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "hiding_files_and_directories_with_attrib_exe_filter"
               }
            ],
            "name": "Hiding Files And Directories With Attrib exe",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=attrib.exe (Processes.process=*+h*) by Processes.parent_process Processes.process_name Processes.user Processes.dest | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)`| `hiding_files_and_directories_with_attrib_exe_filter` ",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1222.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Windows File and Directory Permissions Modification"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2019-02-27",
            "description": "The search looks for command-line arguments used to hide a file or directory using the reg add command.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c77162d3-f93c-45cc-80c8-22f6b5264x9f",
            "known_false_positives": "None at the moment",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "reg_exe_used_to_hide_files_directories_via_registry_keys_filter"
               }
            ],
            "name": "Reg exe used to hide files directories via registry keys",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = reg.exe Processes.process=\"*add*\" Processes.process=\"*Hidden*\" Processes.process=\"*REG_DWORD*\" by Processes.process_name Processes.parent_process_name Processes.dest Processes.user| `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` |`security_content_ctime(lastTime)`| regex process = \"(/d\\s+2)\" | `reg_exe_used_to_hide_files_directories_via_registry_keys_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-03-02",
            "description": "This search monitors for remote modifications to registry keys.",
            "how_to_implement": "To successfully implement this search, you must populate the `Endpoint` data model. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "c9f4b923-f8af-4155-b697-1354f5dcbc5e",
            "known_false_positives": "This technique may be legitimately used by administrators to modify remote registries, so it's important to filter these events out.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_registry_key_modifications_filter"
               }
            ],
            "name": "Remote Registry Key modifications",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where  Registry.registry_path=\"\\\\\\\\*\"  by Registry.dest , Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `remote_registry_key_modifications_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for reg.exe being launched from a command prompt not started by the user. When a user launches cmd.exe, the parent process is usually explorer.exe. This search filters out those instances.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "a6b3ab4e-dd77-4213-95fa-fc94701995e0",
            "known_false_positives": "It's possible for system administrators to write scripts that exhibit this behavior. If this is the case, the search will need to be modified to filter them out.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_reg_exe_process_filter"
               }
            ],
            "name": "Suspicious Reg exe Process",
            "references": [
               "https://car.mitre.org/wiki/CAR-2013-03-001"
            ],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.parent_process_name != explorer.exe Processes.process_name =cmd.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest Processes.process_id Processes.parent_process_id | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | search [| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Processes where Processes.parent_process_name=cmd.exe Processes.process_name= reg.exe by Processes.parent_process_id Processes.dest Processes.process_name | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | rename parent_process_id as process_id |dedup process_id| table process_id dest] | `suspicious_reg_exe_process_filter` ",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Disabling Security Tools",
                  "DHS Report TA18-074A"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "Wizard Spider",
                  "Silence",
                  "APT41",
                  "Turla",
                  "APT32",
                  "APT38",
                  "Dragonfly 2.0",
                  "APT19",
                  "Threat Group-3390",
                  "Honeybee",
                  "Patchwork",
                  "Gorgon Group",
                  "FIN8"
               ],
               "mitre_attack_id": [
                  "T1112"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Modify Registry"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "56e24a28-5003-4047-b2db-e8f3c4618064",
      "name": "Windows Defense Evasion Tactics",
      "narrative": "Defense evasion is a tactic--identified in the MITRE ATT&CK framework--that adversaries employ in a variety of ways to bypass or defeat defensive security measures. There are many techniques enumerated by the MITRE ATT&CK framework that are applicable in this context. This Analytic Story includes searches designed to identify the use of such techniques on Windows platforms.",
      "references": [
         "https://attack.mitre.org/wiki/Defense_Evasion"
      ],
      "tags": {
         "analytics_story": "Windows Defense Evasion Tactics",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Silence",
            "no",
            "APT32",
            "Blue Mockingbird",
            "APT41",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Threat Group-3390",
            "Honeybee",
            "Patchwork",
            "APT19",
            "Gorgon Group",
            "Dragonfly 2.0",
            "APT38"
         ],
         "mitre_attack_id": [
            "T1112",
            "T1222.001"
         ],
         "mitre_attack_tactics": [
            "Defense Evasion"
         ],
         "mitre_attack_technique": [
            "Windows File and Directory Permissions Modification",
            "Modify Registry"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Shannon Davis, Splunk",
      "date": "2020-07-28",
      "description": "Uncover activity consistent with CVE-2020-1350, or SIGRed. Discovered by Checkpoint researchers, this vulnerability affects Windows 2003 to 2019, and is triggered by a malicious DNS response (only affects DNS over TCP). An attacker can use the malicious payload to cause a buffer overflow on the vulnerable system, leading to compromise.  The included searches in this Analytic Story are designed to identify the large response payload for SIG and KEY DNS records which can be used for the exploit.",
      "detections": [
         {
            "author": "Shannon Davis, Splunk",
            "date": "2020-07-28",
            "description": "This search detects SIGRed via Splunk Stream.",
            "how_to_implement": "You must be ingesting Splunk Stream DNS and Splunk Stream TCP. We are detecting SIG and KEY records via stream:dns and TCP payload over 65KB in size via stream:tcp.  Replace the macro definitions ('stream:dns' and 'stream:tcp') with configurations for your Splunk environment.",
            "id": "babd8d10-d073-11ea-87d0-0242ac130003",
            "known_false_positives": "unknown",
            "macros": [
               {
                  "definition": "sourcetype=stream:dns",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "stream_dns"
               },
               {
                  "definition": "sourcetype=stream:tcp",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "stream_tcp"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_windows_dns_sigred_via_splunk_stream_filter"
               }
            ],
            "name": "Detect Windows DNS SIGRed via Splunk Stream",
            "references": [
               "https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/"
            ],
            "search": "`stream_dns` | spath \"query_type{}\" | search \"query_type{}\" IN (SIG,KEY) | spath protocol_stack | search protocol_stack=\"ip:tcp:dns\" | append [search `stream_tcp` bytes_out>65000] | `detect_windows_dns_sigred_via_splunk_stream_filter` | stats count by flow_id | where count>1 | fields - count",
            "tags": {
               "analytics_story": [
                  "Windows DNS SIGRed CVE-2020-1350"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 12"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "MuddyWater",
                  "Frankenstein",
                  "Inception",
                  "BlackTech",
                  "APT41",
                  "admin@338",
                  "Threat Group-3390",
                  "APT12",
                  "The White Company",
                  "APT33",
                  "APT32",
                  "APT28",
                  "Tropic Trooper",
                  "Lazarus Group",
                  "BRONZE BUTLER",
                  "Cobalt Group",
                  "APT37",
                  "Patchwork",
                  "Leviathan",
                  "Elderwood",
                  "TA459",
                  "APT29"
               ],
               "mitre_attack_id": [
                  "T1203"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Exploitation for Client Execution"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "network"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Shannon Davis, Splunk",
            "date": "2020-07-28",
            "description": "This search detects SIGRed via Zeek DNS and Zeek Conn data.",
            "how_to_implement": "You must be ingesting Zeek DNS and Zeek Conn data into Splunk. Zeek data should also be getting ingested in JSON format.  We are detecting SIG and KEY records via bro:dns:json and TCP payload over 65KB in size via bro:conn:json.  The Network Resolution and Network Traffic datamodels are in use for this search.",
            "id": "c5c622e4-d073-11ea-87d0-0242ac130003",
            "known_false_positives": "unknown",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_windows_dns_sigred_via_zeek_filter"
               }
            ],
            "name": "Detect Windows DNS SIGRed via Zeek",
            "references": [
               "https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/"
            ],
            "search": "| tstats `security_content_summariesonly` count from datamodel=Network_Resolution where DNS.query_type IN (SIG,KEY) by DNS.flow_id | rename DNS.flow_id as flow_id | append [| tstats  `security_content_summariesonly` count from datamodel=Network_Traffic where All_Traffic.bytes_in>65000 by All_Traffic.flow_id | rename All_Traffic.flow_id as flow_id] | `detect_windows_dns_sigred_via_zeek_filter` | stats count by flow_id | where count>1 | fields - count ",
            "tags": {
               "analytics_story": [
                  "Windows DNS SIGRed CVE-2020-1350"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 16"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "MuddyWater",
                  "Frankenstein",
                  "Inception",
                  "BlackTech",
                  "APT41",
                  "admin@338",
                  "Threat Group-3390",
                  "APT12",
                  "The White Company",
                  "APT33",
                  "APT32",
                  "APT28",
                  "Tropic Trooper",
                  "Lazarus Group",
                  "BRONZE BUTLER",
                  "Cobalt Group",
                  "APT37",
                  "Patchwork",
                  "Leviathan",
                  "Elderwood",
                  "TA459",
                  "APT29"
               ],
               "mitre_attack_id": [
                  "T1203"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Exploitation for Client Execution"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         }
      ],
      "id": "36dbb206-d073-11ea-87d0-0242ac130003",
      "name": "Windows DNS SIGRed CVE-2020-1350",
      "narrative": "When a client requests a DNS record for a particular domain, that request gets routed first through the client's locally configured DNS server, then to any DNS server(s) configured as forwarders, and then onto the target domain's own DNS server(s).  If a attacker wanted to, they could host a malicious DNS server that responds to the initial request with a specially crafted large response (~65KB).  This response would flow through to the client's local DNS server, which if not patched for CVE-2020-1350, would cause the buffer overflow. The detection searches in this Analytic Story use wire data to detect the malicious behavior. Searches for Splunk Stream and Zeek are included.  The Splunk Stream search correlates across stream:dns and stream:tcp, while the Zeek search correlates across bro:dns:json and bro:conn:json.  These correlations are required to pick up both the DNS record types (SIG and KEY) along with the payload size (>65KB).",
      "references": [
         "https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/",
         "https://support.microsoft.com/en-au/help/4569509/windows-dns-server-remote-code-execution-vulnerability"
      ],
      "tags": {
         "analytics_story": "Windows DNS SIGRed CVE-2020-1350",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Sandworm Team",
            "Cobalt Group",
            "APT29",
            "APT41",
            "Leviathan",
            "Inception",
            "admin@338",
            "BRONZE BUTLER",
            "Elderwood",
            "APT32",
            "BlackTech",
            "APT12",
            "APT37",
            "TA459",
            "MuddyWater",
            "Threat Group-3390",
            "Lazarus Group",
            "Frankenstein",
            "APT33",
            "APT28",
            "Tropic Trooper",
            "Patchwork",
            "The White Company"
         ],
         "mitre_attack_id": [
            "T1203"
         ],
         "mitre_attack_tactics": [
            "Execution"
         ],
         "mitre_attack_technique": [
            "Exploitation for Client Execution"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2018-01-26",
      "description": "Detect and investigate suspected abuse of file extensions and Windows file associations. Some of the malicious behaviors involved may include inserting spaces before file extensions or prepending the file extension with a different one, among other techniques.",
      "detections": [
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for processes launched from files that have double extensions in the file name. This is typically done to obscure the \"real\" file extension and make it appear as though the file being accessed is a data file, as opposed to executable content.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model in the processes node.",
            "id": "b06a555e-dce0-417d-a2eb-28a5d8d66ef7",
            "known_false_positives": "None identified.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "execution_of_file_with_multiple_extensions_filter"
               }
            ],
            "name": "Execution of File with Multiple Extensions",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = *.doc.exe OR Processes.process = *.htm.exe OR Processes.process = *.html.exe OR Processes.process = *.txt.exe OR Processes.process = *.pdf.exe OR Processes.process = *.doc.exe by Processes.dest Processes.user Processes.process Processes.parent_process | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `execution_of_file_with_multiple_extensions_filter`",
            "tags": {
               "analytics_story": [
                  "Windows File Extension and Association Abuse"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Windshift",
                  "APT32",
                  "BRONZE BUTLER",
                  "menuPass",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1036"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Masquerading"
               ],
               "nist": [
                  "DE.CM",
                  "PR.PT",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for processes launched from files with at least five spaces in the name before the extension. This is typically done to obfuscate the file extension by pushing it outside of the default view.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records process activity from your hosts to populate the endpoint data model in the processes node. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
            "id": "ab0353e6-a956-420b-b724-a8b4846d5d5a",
            "known_false_positives": "None identified.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "execution_of_file_with_spaces_before_extension_filter"
               }
            ],
            "name": "Execution of File With Spaces Before Extension",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process_path) as process_path min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process = \"*     .*\" by Processes.dest Processes.user Processes.process Processes.process_name | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `execution_of_file_with_spaces_before_extension_filter`",
            "tags": {
               "analytics_story": [
                  "Windows File Extension and Association Abuse"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Windshift",
                  "APT32",
                  "BRONZE BUTLER",
                  "menuPass",
                  "Dragonfly 2.0"
               ],
               "mitre_attack_id": [
                  "T1036"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Masquerading"
               ],
               "nist": [
                  "DE.CM",
                  "PR.PT",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for changes to registry values that control Windows file associations, executed by a process that is not typical for legitimate, routine changes to this area.",
            "how_to_implement": "To successfully implement this search you need to be ingesting information on registry changes that include the name of the process responsible for the changes from your endpoints into the `Endpoint` datamodel in the `Processes` and `Registry` nodes.",
            "id": "1b989a0e-0129-4446-a695-f193a5b746fc",
            "known_false_positives": "There may be other processes in your environment that users may legitimately use to modify file associations. If this is the case and you are finding false positives, you can modify the search to add those processes as exceptions.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_changes_to_file_associations_filter"
               }
            ],
            "name": "Suspicious Changes to File Associations",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.process_name) as process_name values(Processes.parent_process_name) as parent_process_name FROM datamodel=Endpoint.Processes where Processes.process_name!=Explorer.exe AND Processes.process_name!=OpenWith.exe by Processes.process_id Processes.dest | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | join [| tstats `security_content_summariesonly` values(Registry.registry_path) as registry_path count  FROM datamodel=Endpoint.Registry where Registry.registry_path=*\\\\Explorer\\\\FileExts* by Registry.process_id Registry.dest | `drop_dm_object_name(\"Registry\")` | table process_id dest registry_path]| `suspicious_changes_to_file_associations_filter` ",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Windows File Extension and Association Abuse"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Kimsuky"
               ],
               "mitre_attack_id": [
                  "T1546.001"
               ],
               "mitre_attack_tactics": [
                  "Privilege Escalation",
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Change Default File Association"
               ],
               "nist": [
                  "DE.CM",
                  "PR.PT",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "30552a76-ac78-48e4-b3c0-de4e34e9563d",
      "name": "Windows File Extension and Association Abuse",
      "narrative": "Attackers use a variety of techniques to entice users to run malicious code or to persist on an endpoint. One way to accomplish these goals is to leverage file extensions and the mechanism Windows uses to associate files with specific applications. \\\n Since its earliest days, Windows has used extensions to identify file types. Users have become familiar with these extensions and their application associations. For example, if users see that a file ends in `.doc` or `.docx`, they will assume that it is a Microsoft Word document and expect that double-clicking will open it using `winword.exe`. The user will typically also presume that the `.docx` file is safe. \\\n Attackers take advantage of this expectation by obfuscating the true file extension. They can accomplish this in a couple of ways. One technique involves inserting multiple spaces in the file name before the extension to hide the extension from the GUI, obscuring the true nature of the file. Another approach involves prepending the real extension with a different one. This is especially effective when Windows is configured to \"hide extensions for known file types.\" In this case, the real extension is not displayed, but the prepended one is, leading end users to believe the file is a different type than it actually is.\\\nChanging the association between a file extension and an application can allow an attacker to execute arbitrary code. The technique typically involves changing the association for an often-launched file type to associate instead with a malicious program the attacker has dropped on the endpoint. When the end user launches a file that has been manipulated in this way, it will execute the attacker's malware. It will also execute the application the end user expected to run, cleverly obscuring the fact that something suspicious has occurred.\\\nRun the searches in this story to detect and investigate suspicious behavior that may indicate abuse or manipulation of Windows file extensions and/or associations.",
      "references": [
         "https://blog.malwarebytes.com/cybercrime/2013/12/file-extensions-2/",
         "https://attack.mitre.org/wiki/Technique/T1042"
      ],
      "tags": {
         "analytics_story": "Windows File Extension and Association Abuse",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "APT32",
            "BRONZE BUTLER",
            "Kimsuky",
            "menuPass",
            "Windshift",
            "Dragonfly 2.0"
         ],
         "mitre_attack_id": [
            "T1546.001",
            "T1036"
         ],
         "mitre_attack_tactics": [
            "Persistence",
            "Defense Evasion",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Masquerading",
            "Change Default File Association"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 1
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2017-09-12",
      "description": "Adversaries often try to cover their tracks by manipulating Windows logs. Use these searches to help you monitor for suspicious activity surrounding log files--an essential component of an effective defense.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The vssadmin.exe utility is used to interact with the Volume Shadow Copy Service.  Wmic is an interface to the Windows Management Instrumentation.  This search looks for either of these tools being used to delete shadow copies.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "b89919ed-ee5f-492c-b139-95dbb162039e",
            "known_false_positives": "vssadmin.exe and wmic.exe are standard applications shipped with modern versions of windows. They may be used by administrators to legitimately delete old backup copies, although this is typically rare.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "deleting_shadow_copies_filter"
               }
            ],
            "name": "Deleting Shadow Copies",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=vssadmin.exe OR Processes.process_name=wmic.exe)  by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | search process=*delete* AND process=*shadow* | `deleting_shadow_copies_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Log Manipulation",
                  "SamSam Ransomware",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 10"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Sandworm Team",
                  "Lazarus Group",
                  "APT38"
               ],
               "mitre_attack_id": [
                  "T1485"
               ],
               "mitre_attack_tactics": [
                  "Impact"
               ],
               "mitre_attack_technique": [
                  "Data Destruction"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "The wevtutil.exe application is the windows event log utility. This searches for wevtutil.exe with parameters for clearing the application, security, setup, or system event logs.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "2827c0fd-e1be-4868-ae25-59d28e0f9d4f",
            "known_false_positives": "The wevtutil.exe application is a legitimate Windows event log utility. Administrators may use it to manage Windows event logs.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "suspicious_wevtutil_usage_filter"
               }
            ],
            "name": "Suspicious wevtutil Usage",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = wevtutil.exe Processes.process=\"*cl*\" (Processes.process=\"*System*\" OR Processes.process=\"*Security*\" OR Processes.process=\"*Setup*\" OR Processes.process=\"*Application*\") by Processes.process_name Processes.parent_process_name Processes.dest Processes.user| `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` |`security_content_ctime(lastTime)` | `suspicious_wevtutil_usage_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Log Manipulation",
                  "Ransomware"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 6"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT41",
                  "APT38",
                  "Dragonfly 2.0",
                  "APT32",
                  "FIN8",
                  "FIN5",
                  "APT28"
               ],
               "mitre_attack_id": [
                  "T1070.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Clear Windows Event Logs"
               ],
               "nist": [
                  "DE.DP",
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "PR.AT",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2018-12-03",
            "description": "The fsutil.exe application is a legitimate Windows utility used to perform tasks related to the file allocation table (FAT) and NTFS file systems. The update sequence number (USN) change journal provides a log of all changes made to the files on the disk. This search looks for fsutil.exe deleting the USN journal.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "b6e0ff70-b122-4227-9368-4cf322ab43c3",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "usn_journal_deletion_filter"
               }
            ],
            "name": "USN Journal Deletion",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=fsutil.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest  | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | search process=\"*deletejournal*\" AND process=\"*usn*\" | `usn_journal_deletion_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Log Manipulation",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 6",
                  "CIS 8",
                  "CIS 10"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1070"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Indicator Removal on Host"
               ],
               "nist": [
                  "DE.CM",
                  "PR.PT",
                  "DE.AE",
                  "DE.DP",
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-06",
            "description": "This search looks for Windows events that indicate one of the Windows event logs has been purged.",
            "how_to_implement": "To successfully implement this search, you need to be ingesting Windows event logs from your hosts.",
            "id": "ad517544-aff9-4c96-bd99-d6eb43bfbb6a",
            "known_false_positives": "It is possible that these logs may be legitimately cleared by Administrators.",
            "macros": [
               {
                  "definition": "eventtype=wineventlog_security",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wineventlog_security"
               },
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "eventtype=wineventlog_system",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wineventlog_system"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "windows_event_log_cleared_filter"
               }
            ],
            "name": "Windows Event Log Cleared",
            "references": [],
            "search": "(`wineventlog_security` (EventID=1102 OR EventID=1100)) OR (`wineventlog_system` EventID=104) | stats count min(_time) as firstTime max(_time) as lastTime by EventID dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_event_log_cleared_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Log Manipulation",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 6"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT41",
                  "APT38",
                  "Dragonfly 2.0",
                  "APT32",
                  "FIN8",
                  "FIN5",
                  "APT28"
               ],
               "mitre_attack_id": [
                  "T1070.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Clear Windows Event Logs"
               ],
               "nist": [
                  "DE.DP",
                  "PR.IP",
                  "PR.AC",
                  "PR.AT",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "b6db2c60-a281-48b4-95f1-2cd99ed56835",
      "name": "Windows Log Manipulation",
      "narrative": "Because attackers often modify system logs to cover their tracks and/or to thwart the investigative process, log monitoring is an industry-recognized best practice. While there are legitimate reasons to manipulate system logs, it is still worthwhile to keep track of who manipulated the logs, when they manipulated them, and in what way they manipulated them (determining which accesses, tools, or utilities were employed). Even if no malicious activity is detected, the knowledge of an attempt to manipulate system logs may be indicative of a broader security risk that should be thoroughly investigated.\\\nThe Analytic Story gives users two different ways to detect manipulation of Windows Event Logs and one way to detect deletion of the Update Sequence Number (USN) Change Journal. The story helps determine the history of the host and the users who have accessed it. Finally, the story aides in investigation by retrieving all the information on the process that caused these events (if the process has been identified).",
      "references": [
         "https://www.crowdstrike.com/blog/bears-midst-intrusion-democratic-national-committee/",
         "https://zeltser.com/security-incident-log-review-checklist/",
         "http://journeyintoir.blogspot.com/2013/01/re-introducing-usnjrnl.html"
      ],
      "tags": {
         "analytics_story": "Windows Log Manipulation",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Sandworm Team",
            "no",
            "APT32",
            "APT41",
            "APT28",
            "FIN5",
            "FIN8",
            "Lazarus Group",
            "APT38",
            "Dragonfly 2.0"
         ],
         "mitre_attack_id": [
            "T1070.001",
            "T1485",
            "T1070"
         ],
         "mitre_attack_tactics": [
            "Defense Evasion",
            "Impact"
         ],
         "mitre_attack_technique": [
            "Indicator Removal on Host",
            "Data Destruction",
            "Clear Windows Event Logs"
         ],
         "usecase": "Security Monitoring"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Bhavin Patel, Splunk",
      "date": "2018-05-31",
      "description": "Monitor for activities and techniques associated with maintaining persistence on a Windows system--a sign that an adversary may have compromised your environment.",
      "detections": [
         {
            "author": "Patrick Bareiss, Splunk",
            "date": "2020-07-03",
            "description": "The detection Detect Path Interception By Creation Of program exe is detecting the abuse of unquoted service paths, which is a popular technique for privilege escalation. ",
            "id": "c77162d3-f93c-45cc-80c8-22f6v5264g9f",
            "known_false_positives": "unknown",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "detect_path_interception_by_creation_of_program_exe_filter"
               }
            ],
            "name": "Detect Path Interception By Creation Of program exe",
            "references": [
               "https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae"
            ],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=services.exe by Processes.user Processes.process_name Processes.process Processes.dest | `drop_dm_object_name(Processes)` | rex field=process \"^.*\\\\\\\\(?<service_process>.*\\.(?:exe|bat|com|ps1))\" | eval process_name = lower(process_name) | eval service_process = lower(service_process)| where process_name != service_process | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `detect_path_interception_by_creation_of_program_exe_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1574.009"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation",
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Path Interception by Unquoted Path"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "Attackers leverage an existing Windows binary, attrib.exe, to mark specific as hidden by using specific flags so that the victim does not see the file.  The search looks for specific command-line arguments to detect the use of attrib.exe to hide files.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c77162d3-f93c-45cc-80c8-22f6b5264g9f",
            "known_false_positives": "Some applications and users may legitimately use attrib.exe to interact with the files. ",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "hiding_files_and_directories_with_attrib_exe_filter"
               }
            ],
            "name": "Hiding Files And Directories With Attrib exe",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) values(Processes.process) as process max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=attrib.exe (Processes.process=*+h*) by Processes.parent_process Processes.process_name Processes.user Processes.dest | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)`|`security_content_ctime(lastTime)`| `hiding_files_and_directories_with_attrib_exe_filter` ",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "no"
               ],
               "mitre_attack_id": [
                  "T1222.001"
               ],
               "mitre_attack_tactics": [
                  "Defense Evasion"
               ],
               "mitre_attack_technique": [
                  "Windows File and Directory Permissions Modification"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2018-11-02",
            "description": "This search looks for registry activity associated with modifications to the registry key `HKLM\\SYSTEM\\CurrentControlSet\\Control\\Print\\Monitors`. In this scenario, an attacker can load an arbitrary .dll into the print-monitor registry by giving the full path name to the after.dll. The system will execute the .dll with elevated (SYSTEM) permissions and will persist after reboot.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or via other endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report registry modifications.",
            "id": "f5f6af30-7ba7-4295-bfe9-07de87c01bbc",
            "known_false_positives": "You will encounter noise from legitimate print-monitor registry entries.",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "monitor_registry_keys_for_print_monitors_filter"
               }
            ],
            "name": "Monitor Registry Keys for Print Monitors",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where Registry.action=modified AND Registry.registry_path=\"*CurrentControlSet\\\\Control\\\\Print\\\\Monitors*\" by Registry.dest, Registry.registry_key_name Registry.status Registry.user Registry.registry_path Registry.action | `drop_dm_object_name(Registry)` | `monitor_registry_keys_for_print_monitors_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8",
                  "CIS 5"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "PR.AC"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 1
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "The search looks for reg.exe modifying registry keys that define Windows services and their configurations.",
            "id": "8470d755-0c13-45b3-bd63-387a373c10cf",
            "known_false_positives": "It is unusual for a service to be created or modified by directly manipulating the registry. However, there may be legitimate instances of this behavior. It is important to validate and investigate, as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "reg_exe_manipulating_windows_services_registry_keys_filter"
               }
            ],
            "name": "Reg exe Manipulating Windows Services Registry Keys",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.process_name) as process_name values(Processes.parent_process_name) as parent_process_name values(Processes.user) as user FROM datamodel=Endpoint.Processes where Processes.process_name=reg.exe Processes.process=*reg* Processes.process=*add* Processes.process=*Services* by Processes.process_id Processes.dest Processes.process | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `reg_exe_manipulating_windows_services_registry_keys_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Service Abuse",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "PR.AT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2019-02-27",
            "description": "The search looks for command-line arguments used to hide a file or directory using the reg add command.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "c77162d3-f93c-45cc-80c8-22f6b5264x9f",
            "known_false_positives": "None at the moment",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "reg_exe_used_to_hide_files_directories_via_registry_keys_filter"
               }
            ],
            "name": "Reg exe used to hide files directories via registry keys",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = reg.exe Processes.process=\"*add*\" Processes.process=\"*Hidden*\" Processes.process=\"*REG_DWORD*\" by Processes.process_name Processes.parent_process_name Processes.dest Processes.user| `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` |`security_content_ctime(lastTime)`| regex process = \"(/d\\s+2)\" | `reg_exe_used_to_hide_files_directories_via_registry_keys_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for registry activity associated with application compatibility shims, which can be leveraged by attackers for various nefarious purposes.",
            "how_to_implement": "To successfully implement this search, you must populate the Change_Analysis data model. This is typically populated via endpoint detection and response products, such as Carbon Black or other endpoint data sources such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "f5f6af30-7aa7-4295-bfe9-07fe87c01bbb",
            "known_false_positives": "There are many legitimate applications that leverage shim databases for compatibility purposes for legacy applications",
            "macros": [
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_for_creating_shim_databases_filter"
               }
            ],
            "name": "Registry Keys for Creating SHIM Databases",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Change_Analysis.All_Changes where All_Changes.object_category=registry AND (All_Changes.object_path=\"*CurrentVersion\\\\AppCompatFlags\\\\Custom*\" OR All_Changes.object_path=\"*CurrentVersion\\\\AppCompatFlags\\\\InstalledSDB*\") by All_Changes.dest, All_Changes.command, All_Changes.user, All_Changes.object, All_Changes.object_path | `drop_dm_object_name(\"All_Changes\")` | `registry_keys_for_creating_shim_databases_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1546.011"
               ],
               "mitre_attack_tactics": [
                  "Privilege Escalation",
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Application Shimming"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 2
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "The search looks for modifications to registry keys that can be used to launch an application or service at system startup.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "f5f6af30-7aa7-4295-bfe9-07fe87c01a4b",
            "known_false_positives": "There are many legitimate applications that must execute on system startup and will use these registry keys to accomplish that task.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_used_for_persistence_filter"
               }
            ],
            "name": "Registry Keys Used For Persistence",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=*currentversion\\\\run* OR Registry.registry_path=*currentVersion\\\\Windows\\\\Appinit_Dlls* OR Registry.registry_path=CurrentVersion\\\\Winlogon\\\\Shell* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\Userinit* OR Registry.registry_path=*CurrentVersion\\\\Winlogon\\\\VmApplet* OR Registry.registry_path=*currentversion\\\\policies\\\\explorer\\\\run* OR Registry.registry_path=*currentversion\\\\runservices* OR Registry.registry_path=*\\\\CurrentControlSet\\\\Control\\\\Lsa\\\\* OR Registry.registry_path=\"*Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options*\" OR Registry.registry_path=HKLM\\\\SOFTWARE\\\\Microsoft\\\\Netsh\\\\*) by Registry.dest , Registry.status, Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `registry_keys_used_for_persistence_filter`",
            "tags": {
               "analytics_story": [
                  "Suspicious Windows Registry Activities",
                  "Suspicious MSHTA Activity",
                  "DHS Report TA18-074A",
                  "Possible Backdoor Activity Associated With MUDCARP Espionage Campaigns",
                  "Ransomware",
                  "Windows Persistence Techniques",
                  "Emotet Malware  DHS Report TA18-201A "
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-03-02",
            "description": "This search monitors for remote modifications to registry keys.",
            "how_to_implement": "To successfully implement this search, you must populate the `Endpoint` data model. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "c9f4b923-f8af-4155-b697-1354f5dcbc5e",
            "known_false_positives": "This technique may be legitimately used by administrators to modify remote registries, so it's important to filter these events out.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "remote_registry_key_modifications_filter"
               }
            ],
            "name": "Remote Registry Key modifications",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where  Registry.registry_path=\"\\\\\\\\*\"  by Registry.dest , Registry.user | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `remote_registry_key_modifications_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Defense Evasion Tactics",
                  "Suspicious Windows Registry Activities",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [],
               "mitre_attack_tactics": [],
               "mitre_attack_technique": [],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for arguments to sc.exe indicating the creation or modification of a Windows service.",
            "id": "f0c693d8-2a89-4ce7-80b4-98fea4c3ea6d",
            "known_false_positives": "Using sc.exe to manipulate Windows services is uncommon. However, there may be legitimate instances of this behavior. It is important to validate and investigate as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "sc_exe_manipulating_windows_services_filter"
               }
            ],
            "name": "Sc exe Manipulating Windows Services",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = sc.exe (Processes.process=\"* create *\" OR Processes.process=\"* config *\") by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `sc_exe_manipulating_windows_services_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Service Abuse",
                  "DHS Report TA18-074A",
                  "Orangeworm Attack Group",
                  "Windows Persistence Techniques",
                  "Disabling Security Tools"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "DarkVishnya",
                  "Wizard Spider",
                  "APT32",
                  "APT41",
                  "Kimsuky",
                  "Tropic Trooper",
                  "Cobalt Group",
                  "Ke3chang",
                  "Honeybee",
                  "FIN7",
                  "Threat Group-3390",
                  "APT19",
                  "APT3",
                  "Lazarus Group",
                  "Carbanak"
               ],
               "mitre_attack_id": [
                  "T1543.003"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Windows Service"
               ],
               "nist": [
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "PR.AT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Bhavin Patel, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for flags passed to schtasks.exe on the command-line that indicate that a forced reboot of system is scheduled.",
            "how_to_implement": "To successfully implement this search you need to be ingesting logs with both the process name and command-line from your endpoints. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
            "id": "1297fb80-f42a-4b4a-9c8a-88c066437cf6",
            "known_false_positives": "Administrators may create jobs on systems forcing reboots to perform updates, maintenance, etc.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "schtasks_used_for_forcing_a_reboot_filter"
               }
            ],
            "name": "Schtasks used for forcing a reboot",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = schtasks.exe Processes.process=\"*shutdown*\" Processes.process=\"*/r*\" Processes.process=\"*/f*\" by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `schtasks_used_for_forcing_a_reboot_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Persistence Techniques",
                  "Ransomware"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Gamaredon Group",
                  "Blue Mockingbird",
                  "MuddyWater",
                  "Wizard Spider",
                  "Frankenstein",
                  "APT-C-36",
                  "BRONZE BUTLER",
                  "APT41",
                  "Machete",
                  "Soft Cell",
                  "Silence",
                  "TEMP.Veles",
                  "APT33",
                  "APT39",
                  "Dragonfly 2.0",
                  "Patchwork",
                  "OilRig",
                  "Rancor",
                  "Cobalt Group",
                  "FIN8",
                  "menuPass",
                  "FIN10",
                  "APT32",
                  "FIN7",
                  "Stealth Falcon",
                  "FIN6",
                  "APT3",
                  "APT29"
               ],
               "mitre_attack_id": [
                  "T1053.005"
               ],
               "mitre_attack_tactics": [
                  "Execution",
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Scheduled Task"
               ],
               "nist": [
                  "PR.IP"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for shim database files being written to default directories. The sdbinst.exe application is used to install shim database files (.sdb). According to Microsoft, a shim is a small library that transparently intercepts an API, changes the parameters passed, handles the operation itself, or redirects the operation elsewhere.",
            "how_to_implement": "You must be ingesting data that records the filesystem activity from your hosts to populate the Endpoint file-system data model node. If you are using Sysmon, you will need a Splunk Universal Forwarder on each endpoint from which you want to collect data.",
            "id": "6e4c4588-ba2f-42fa-97e6-9f6f548eaa33",
            "known_false_positives": "Because legitimate shim files are created and used all the time, this event, in itself, is not suspicious. However, if there are other correlating events, it may warrant further investigation.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "shim_database_file_creation_filter"
               }
            ],
            "name": "Shim Database File Creation",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Filesystem.action) values(Filesystem.file_hash) as file_hash values(Filesystem.file_path) as file_path  min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path=*Windows\\AppPatch\\Custom* by Filesystem.file_name Filesystem.dest | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` |`drop_dm_object_name(Filesystem)` | `shim_database_file_creation_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1546.011"
               ],
               "mitre_attack_tactics": [
                  "Privilege Escalation",
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Application Shimming"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search detects the process execution and arguments required to silently create a shim database.  The sdbinst.exe application is used to install shim database files (.sdb). A shim is a small library which transparently intercepts an API, changes the parameters passed, handles the operation itself, or redirects the operation elsewhere.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model.",
            "id": "404620de-46d8-48b6-90cc-8a8d7b0876a3",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "shim_database_installation_with_suspicious_parameters_filter"
               }
            ],
            "name": "Shim Database Installation With Suspicious Parameters",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = sdbinst.exe Processes.process=\"*-p*\" Processes.process=\"*-q*\" by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `shim_database_installation_with_suspicious_parameters_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "FIN7"
               ],
               "mitre_attack_id": [
                  "T1546.011"
               ],
               "mitre_attack_tactics": [
                  "Privilege Escalation",
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Application Shimming"
               ],
               "nist": [
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         }
      ],
      "id": "30874d4f-20a1-488f-85ec-5d52ef74e3f9",
      "name": "Windows Persistence Techniques",
      "narrative": "Maintaining persistence is one of the first steps taken by attackers after the initial compromise. Attackers leverage various custom and built-in tools to ensure survivability and persistent access within a compromised enterprise. This Analytic Story provides searches to help you identify various behaviors used by attackers to maintain persistent access to a Windows environment.",
      "references": [
         "http://www.fuzzysecurity.com/tutorials/19.html",
         "https://www.fireeye.com/blog/threat-research/2010/07/malware-persistence-windows-registry.html",
         "http://resources.infosecinstitute.com/common-malware-persistence-mechanisms/",
         "https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html",
         "https://www.youtube.com/watch?v=dq2Hv7J9fvk"
      ],
      "tags": {
         "analytics_story": "Windows Persistence Techniques",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "TEMP.Veles",
            "Cobalt Group",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "APT-C-36",
            "Kimsuky",
            "Putter Panda",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Molerats",
            "OilRig",
            "APT32",
            "Machete",
            "FIN10",
            "Dark Caracal",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "no",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Carbanak",
            "Darkhotel",
            "Frankenstein",
            "APT39",
            "Silence",
            "Dragonfly 2.0",
            "APT33",
            "Rocke",
            "APT18",
            "FIN6",
            "Blue Mockingbird",
            "Soft Cell",
            "Tropic Trooper",
            "Patchwork",
            "DarkVishnya",
            "menuPass",
            "Stealth Falcon"
         ],
         "mitre_attack_id": [
            "T1053.005",
            "T1546.011",
            "T1543.003",
            "T1222.001",
            "T1574.009",
            "T1547.001"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Persistence",
            "Defense Evasion",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Path Interception by Unquoted Path",
            "Windows File and Directory Permissions Modification",
            "Application Shimming",
            "Registry Run Keys / Startup Folder",
            "Windows Service",
            "Scheduled Task"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "David Dorsey, Splunk",
      "date": "2020-02-04",
      "description": "Monitor for and investigate activities that may be associated with a Windows privilege-escalation attack, including unusual processes running on endpoints, modified registry keys, and more.",
      "detections": [
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-03-16",
            "description": "This search looks for child processes of spoolsv.exe. This activity is associated with a POC privilege-escalation exploit associated with CVE-2018-8440. Spoolsv.exe is the process associated with the Print Spooler service in Windows and typically runs as SYSTEM.",
            "how_to_implement": "You must be ingesting endpoint data that tracks process activity, including parent-child relationships from your endpoints to populate the Endpoint data model in the Processes node. The command-line arguments are mapped to the \"process\" field in the Endpoint data model. Update the `children_of_spoolsv_filter` macro to filter out legitimate child processes spawned by spoolsv.exe.",
            "id": "aa0c4aeb-5b18-41c4-8c07-f1442d7599df",
            "known_false_positives": "Some legitimate printer-related processes may show up as children of spoolsv.exe. You should confirm that any activity as legitimate and may be added as exclusions in the search.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "child_processes_of_spoolsv_exe_filter"
               }
            ],
            "name": "Child Processes of Spoolsv exe",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name=spoolsv.exe AND Processes.process_name!=regsvr32.exe by Processes.dest Processes.parent_process Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `child_processes_of_spoolsv_exe_filter` ",
            "tags": {
               "analytics_story": [
                  "Windows Privilege Escalation"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Exploitation"
               ],
               "mitre_attack_groups": [
                  "Whitefly",
                  "APT33",
                  "Cobalt Group",
                  "PLATINUM",
                  "FIN8",
                  "APT32",
                  "Threat Group-3390",
                  "FIN6",
                  "APT28"
               ],
               "mitre_attack_id": [
                  "T1068"
               ],
               "mitre_attack_tactics": [
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Exploitation for Privilege Escalation"
               ],
               "nist": [
                  "PR.AC",
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "Microsoft Windows contains accessibility features that can be launched with a key combination before a user has logged in. An adversary can modify or replace these programs so they can get a command prompt or backdoor without logging in to the system. This search looks for modifications to these binaries.",
            "how_to_implement": "You must be ingesting data that records the filesystem activity from your hosts to populate the Endpoint file-system data model node. If you are using Sysmon, you will need a Splunk Universal Forwarder on each endpoint from which you want to collect data.",
            "id": "13c2f6c3-10c5-4deb-9ba1-7c4460ebe4ae",
            "known_false_positives": "Microsoft may provide updates to these binaries. Verify that these changes do not correspond with your normal software update cycle.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "overwriting_accessibility_binaries_filter"
               }
            ],
            "name": "Overwriting Accessibility Binaries",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem where (Filesystem.file_path=*\\\\Windows\\\\System32\\\\sethc.exe* OR Filesystem.file_path=*\\\\Windows\\\\System32\\\\utilman.exe* OR Filesystem.file_path=*\\\\Windows\\\\System32\\\\osk.exe* OR Filesystem.file_path=*\\\\Windows\\\\System32\\\\Magnify.exe* OR Filesystem.file_path=*\\\\Windows\\\\System32\\\\Narrator.exe* OR Filesystem.file_path=*\\\\Windows\\\\System32\\\\DisplaySwitch.exe* OR Filesystem.file_path=*\\\\Windows\\\\System32\\\\AtBroker.exe*) by Filesystem.file_name Filesystem.dest | `drop_dm_object_name(Filesystem)` | `security_content_ctime(lastTime)` | `security_content_ctime(firstTime)` | `overwriting_accessibility_binaries_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Privilege Escalation"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "APT41",
                  "APT3",
                  "APT29",
                  "Deep Panda",
                  "Axiom"
               ],
               "mitre_attack_id": [
                  "T1546.008"
               ],
               "mitre_attack_tactics": [
                  "Privilege Escalation",
                  "Persistence"
               ],
               "mitre_attack_technique": [
                  "Accessibility Features"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for modifications to registry keys that can be used to elevate privileges. The registry keys under \"Image File Execution Options\" are used to intercept calls to an executable and can be used to attach malicious binaries to benign system binaries.",
            "how_to_implement": "To successfully implement this search, you must be ingesting data that records registry activity from your hosts to populate the endpoint data model in the registry node. This is typically populated via endpoint detection-and-response products, such as Carbon Black, or endpoint data sources, such as Sysmon. The data used for this search is typically generated via logs that report reads and writes to the registry.",
            "id": "c9f4b923-f8af-4155-b697-1354f5bcbc5e",
            "known_false_positives": "There are many legitimate applications that must execute upon system startup and will use these registry keys to accomplish that task.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "registry_keys_used_for_privilege_escalation_filter"
               }
            ],
            "name": "Registry Keys Used For Privilege Escalation",
            "references": [
               "https://blog.malwarebytes.com/101/2015/12/an-introduction-to-image-file-execution-options/"
            ],
            "search": "| tstats `security_content_summariesonly` count values(Registry.registry_key_name) as registry_key_name values(Registry.registry_path) as registry_path min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Registry where (Registry.registry_path=\"*Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options*\") AND (Registry.registry_key_name=GlobalFlag OR Registry.registry_key_name=Debugger) by Registry.dest  Registry.user | `security_content_ctime(lastTime)`  | `security_content_ctime(firstTime)` | `drop_dm_object_name(Registry)` | `registry_keys_used_for_privilege_escalation_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Privilege Escalation",
                  "Suspicious Windows Registry Activities"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.PT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 3
         },
         {
            "author": "David Dorsey, Splunk",
            "date": "2020-07-22",
            "description": "This search looks for applications on the endpoint that you have marked as uncommon.",
            "how_to_implement": "You must be ingesting data that records process activity from your hosts to populate the Endpoint data model in the Processes node. You must also be ingesting logs with both the process name and command line from your endpoints. The command-line arguments are mapped to the \"process\" field in the Endpoint data model. This search uses a lookup file `uncommon_processes_default.csv` to track various features of process names that are usually uncommon in most environments. Please consider updating `uncommon_processes_local.csv` to hunt for processes that are uncommon in your environment.",
            "id": "29ccce64-a10c-4389-a45f-337cb29ba1f7",
            "known_false_positives": "None identified",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "lookup update=true lookup_uncommon_processes_default process_name as process_name outputnew uncommon_default,category_default,analytic_story_default,kill_chain_phase_default,mitre_attack_default | lookup update=true  lookup_uncommon_processes_local process_name as process_name outputnew uncommon_local,category_local,analytic_story_local,kill_chain_phase_local,mitre_attack_local | eval uncommon = coalesce(uncommon_default, uncommon_local), analytic_story = coalesce(analytic_story_default, analytic_story_local), category=coalesce(category_default, category_local), kill_chain_phase=coalesce(kill_chain_phase_default, kill_chain_phase_local), mitre_attack=coalesce(mitre_attack_default, mitre_attack_local) | fields - analytic_story_default, analytic_story_local, category_default, category_local, kill_chain_phase_default, kill_chain_phase_local, mitre_attack_default, mitre_attack_local, uncommon_default, uncommon_local | search uncommon=true",
                  "description": "This macro limits the output to processes that have been marked as uncommon",
                  "name": "uncommon_processes"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "uncommon_processes_on_endpoint_filter"
               }
            ],
            "name": "Uncommon Processes On Endpoint",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes by Processes.dest Processes.user Processes.process Processes.process_name | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | `drop_dm_object_name(Processes)` | `uncommon_processes` |`uncommon_processes_on_endpoint_filter` ",
            "tags": {
               "analytics_story": [
                  "Windows Privilege Escalation",
                  "Unusual Processes"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2"
               ],
               "kill_chain_phases": [
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Magic Hound",
                  "Windshift",
                  "APT33",
                  "Sandworm Team",
                  "Naikon",
                  "Whitefly",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Wizard Spider",
                  "Mofang",
                  "Frankenstein",
                  "RTM",
                  "Inception",
                  "BlackTech",
                  "APT-C-36",
                  "Machete",
                  "admin@338",
                  "APT12",
                  "TA505",
                  "Silence",
                  "The White Company",
                  "APT39",
                  "FIN4",
                  "Darkhotel",
                  "Gallmaker",
                  "APT19",
                  "Dragonfly 2.0",
                  "BRONZE BUTLER",
                  "Cobalt Group",
                  "DarkHydrus",
                  "Gorgon Group",
                  "Patchwork",
                  "OilRig",
                  "Dark Caracal",
                  "MuddyWater",
                  "Lazarus Group",
                  "FIN7",
                  "APT32",
                  "Rancor",
                  "APT37",
                  "FIN8",
                  "APT28",
                  "Elderwood",
                  "TA459",
                  "APT29",
                  "Leviathan",
                  "menuPass",
                  "PLATINUM"
               ],
               "mitre_attack_id": [
                  "T1204.002"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Malicious File"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "644e22d3-598a-429c-a007-16fdb802cae5",
      "name": "Windows Privilege Escalation",
      "narrative": "Privilege escalation is a \"land-and-expand\" technique, wherein an adversary gains an initial foothold on a host and then exploits its weaknesses to increase his privileges. The motivation is simple: certain actions on a Windows machine--such as installing software--may require higher-level privileges than those the attacker initially acquired. By increasing his privilege level, the attacker can gain the control required to carry out his malicious ends. This Analytic Story provides searches to detect and investigate behaviors that attackers may use to elevate their privileges in your environment.",
      "references": [
         "https://attack.mitre.org/tactics/TA0004/"
      ],
      "tags": {
         "analytics_story": "Windows Privilege Escalation",
         "category": [
            "Adversary Tactics"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Sandworm Team",
            "Whitefly",
            "Cobalt Group",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "FIN8",
            "Turla",
            "Inception",
            "APT-C-36",
            "Kimsuky",
            "Putter Panda",
            "admin@338",
            "Naikon",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Molerats",
            "OilRig",
            "Elderwood",
            "APT32",
            "Machete",
            "FIN10",
            "Dark Caracal",
            "BlackTech",
            "PLATINUM",
            "FIN4",
            "FIN7",
            "APT19",
            "APT12",
            "APT37",
            "Windshift",
            "Ke3chang",
            "TA459",
            "Magic Hound",
            "Axiom",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Mofang",
            "Rancor",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Darkhotel",
            "Frankenstein",
            "APT39",
            "Silence",
            "Dragonfly 2.0",
            "Gallmaker",
            "APT33",
            "FIN6",
            "Deep Panda",
            "APT28",
            "Rocke",
            "APT18",
            "Tropic Trooper",
            "Patchwork",
            "DarkHydrus",
            "TA505",
            "menuPass",
            "The White Company"
         ],
         "mitre_attack_id": [
            "T1068",
            "T1204.002",
            "T1547.001",
            "T1546.008"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Persistence",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Exploitation for Privilege Escalation",
            "Accessibility Features",
            "Malicious File",
            "Registry Run Keys / Startup Folder"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 2
   },
   {
      "author": "Rico Valdez, Splunk",
      "date": "2017-11-02",
      "description": "Windows services are often used by attackers for persistence and the ability to load drivers or otherwise interact with the Windows kernel. This Analytic Story helps you monitor your environment for indications that Windows services are being modified or created in a suspicious manner.",
      "detections": [
         {
            "author": "David Dorsey, Splunk",
            "baselines": [
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2020-06-23",
                  "description": "This collects the services that have been started across your entire enterprise.",
                  "how_to_implement": "While this search does not require you to adhere to Splunk CIM, you must be ingesting your Windows security-event logs for it to execute successfully. Please ensure that the Splunk Add-on for Microsoft Windows is version 8.0.0 or above.",
                  "id": "64ce0ade-cb01-4678-bddd-d31c0b175394",
                  "name": "Previously Seen Running Windows Services - Initial",
                  "search": "`wineventlog_system` EventCode=7036 | rex field=Message \"The (?<service>[-\\(\\)\\s\\w]+) service entered the (?<state>\\w+) state\" | where state=\"running\" | stats earliest(_time) as firstTimeSeen, latest(_time) as lastTimeSeen by service | outputlookup previously_seen_running_windows_services",
                  "tags": {
                     "analytics_story": [
                        "Orangeworm Attack Group",
                        "Windows Service Abuse"
                     ],
                     "deployments": [
                        "90 Day Baseline"
                     ],
                     "detections": [
                        "First Time Seen Running Windows Service"
                     ]
                  },
                  "version": 3
               },
               {
                  "author": "David Dorsey, Splunk",
                  "date": "2020-06-23",
                  "description": "This search returns the first and last time a Windows service was seen across your enterprise within the last hour. It then updates this information with historical data and filters out Windows services pairs that have not been seen within the specified time window. This updated table is then cached.",
                  "how_to_implement": "While this search does not require you to adhere to Splunk CIM, you must be ingesting your Windows security-event logs for it to execute successfully. Please ensure that the Splunk Add-on for Microsoft Windows is version 8.0.0 or above.",
                  "id": "2e3bdd68-1863-46ee-81f8-87273eee7f1c",
                  "name": "Previously Seen Running Windows Services - Update",
                  "search": "`wineventlog_system` EventCode=7036 | rex field=Message \"The (?<service>[-\\(\\)\\s\\w]+) service entered the (?<state>\\w+) state\" | where state=\"running\" | stats earliest(_time) as firstTimeSeen, latest(_time) as lastTimeSeen by service | inputlookup previously_seen_running_windows_services append=t | stats min(firstTimeSeen) as firstTimeSeen, max(lastTimeSeen) as lastTimeSeen by service | where lastTimeSeen > relative_time(now(), \"`previously_seen_windows_service_forget_window`\") | outputlookup previously_seen_running_windows_services",
                  "tags": {
                     "analytics_story": [
                        "Orangeworm Attack Group",
                        "Windows Service Abuse"
                     ],
                     "deployments": [
                        "Hourly Cache Updates"
                     ],
                     "detections": [
                        "First Time Seen Running Windows Service"
                     ]
                  },
                  "version": 3
               }
            ],
            "date": "2020-07-21",
            "description": "This search looks for the first and last time a Windows service is seen running in your environment. This table is then cached.",
            "how_to_implement": "While this search does not require you to adhere to Splunk CIM, you must be ingesting your Windows system event logs in order for this search to execute successfully. You should run the baseline search `Previously Seen Running Windows Services - Initial` to build the initial table of child processes and hostnames for this search to work. You should also schedule at the same interval as this search the second baseline search `Previously Seen Running Windows Services - Update` to keep this table up to date and to age out old Windows Services. Please update the `previously_seen_windows_service_window` macro to adjust the time window. Please ensure that the Splunk Add-on for Microsoft Windows is version 8.0.0 or above.",
            "id": "823136f2-d755-4b6d-ae04-372b486a5808",
            "known_false_positives": "A previously unseen service is not necessarily malicious. Verify that the service is legitimate and that was installed by a legitimate process.",
            "macros": [
               {
                  "definition": "-70m@m",
                  "description": "Use this macro to determine how far back you should be checking for new Windows services",
                  "name": "previously_seen_windows_service_window"
               },
               {
                  "definition": "eventtype=wineventlog_system",
                  "description": "customer specific splunk configurations(eg- index, source, sourcetype). Replace the macro definition with configurations for your Splunk Environmnent.",
                  "name": "wineventlog_system"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "first_time_seen_running_windows_service_filter"
               }
            ],
            "name": "First Time Seen Running Windows Service",
            "references": [],
            "search": "`wineventlog_system` EventCode=7036 | rex field=Message \"The (?<service>[-\\(\\)\\s\\w]+) service entered the (?<state>\\w+) state\" | where state=\"running\" | lookup previously_seen_running_windows_services service as service OUTPUT firstTimeSeen | where isnull(firstTimeSeen) OR firstTimeSeen > relative_time(now(), \"`previously_seen_windows_service_window`\") | table _time dest service | `first_time_seen_running_windows_service_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Service Abuse",
                  "Orangeworm Attack Group"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 2",
                  "CIS 9"
               ],
               "kill_chain_phases": [
                  "Installation",
                  "Actions On Objectives"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "APT39",
                  "APT41",
                  "Silence",
                  "FIN6",
                  "APT32",
                  "Honeybee",
                  "Ke3chang"
               ],
               "mitre_attack_id": [
                  "T1569.002"
               ],
               "mitre_attack_tactics": [
                  "Execution"
               ],
               "mitre_attack_technique": [
                  "Service Execution"
               ],
               "nist": [
                  "ID.AM",
                  "PR.DS",
                  "PR.AC",
                  "DE.AE"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "The search looks for reg.exe modifying registry keys that define Windows services and their configurations.",
            "id": "8470d755-0c13-45b3-bd63-387a373c10cf",
            "known_false_positives": "It is unusual for a service to be created or modified by directly manipulating the registry. However, there may be legitimate instances of this behavior. It is important to validate and investigate, as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "reg_exe_manipulating_windows_services_registry_keys_filter"
               }
            ],
            "name": "Reg exe Manipulating Windows Services Registry Keys",
            "references": [],
            "search": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Processes.process_name) as process_name values(Processes.parent_process_name) as parent_process_name values(Processes.user) as user FROM datamodel=Endpoint.Processes where Processes.process_name=reg.exe Processes.process=*reg* Processes.process=*add* Processes.process=*Services* by Processes.process_id Processes.dest Processes.process | `drop_dm_object_name(\"Processes\")` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `reg_exe_manipulating_windows_services_registry_keys_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Service Abuse",
                  "Windows Persistence Techniques"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation"
               ],
               "mitre_attack_groups": [
                  "Rocke",
                  "Tropic Trooper",
                  "Gamaredon Group",
                  "Sharpshooter",
                  "Molerats",
                  "Silence",
                  "RTM",
                  "Inception",
                  "APT41",
                  "Machete",
                  "Kimsuky",
                  "APT33",
                  "APT39",
                  "APT32",
                  "APT18",
                  "Turla",
                  "Dark Caracal",
                  "Cobalt Group",
                  "Honeybee",
                  "Threat Group-3390",
                  "Dragonfly 2.0",
                  "Gorgon Group",
                  "Ke3chang",
                  "APT19",
                  "Leviathan",
                  "MuddyWater",
                  "APT37",
                  "BRONZE BUTLER",
                  "Magic Hound",
                  "APT3",
                  "FIN10",
                  "FIN7",
                  "Patchwork",
                  "FIN6",
                  "Lazarus Group",
                  "Putter Panda",
                  "APT29",
                  "Darkhotel"
               ],
               "mitre_attack_id": [
                  "T1547.001"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Registry Run Keys / Startup Folder"
               ],
               "nist": [
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "PR.AT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         },
         {
            "author": "Rico Valdez, Splunk",
            "date": "2020-07-21",
            "description": "This search looks for arguments to sc.exe indicating the creation or modification of a Windows service.",
            "id": "f0c693d8-2a89-4ce7-80b4-98fea4c3ea6d",
            "known_false_positives": "Using sc.exe to manipulate Windows services is uncommon. However, there may be legitimate instances of this behavior. It is important to validate and investigate as appropriate.",
            "macros": [
               {
                  "arguments": [
                     "field"
                  ],
                  "definition": "convert timeformat=\"%m/%d/%Y %H:%M:%S\" ctime($field$)",
                  "description": "convert epoch time to string",
                  "name": "security_content_ctime"
               },
               {
                  "definition": "summariesonly=false allow_old_summaries=true",
                  "description": "search data model's summaries only",
                  "name": "security_content_summariesonly"
               },
               {
                  "definition": "search *",
                  "description": "Update this macro to limit the output results to filter out false positives. ",
                  "name": "sc_exe_manipulating_windows_services_filter"
               }
            ],
            "name": "Sc exe Manipulating Windows Services",
            "references": [],
            "search": "| tstats `security_content_summariesonly` values(Processes.process) as process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name = sc.exe (Processes.process=\"* create *\" OR Processes.process=\"* config *\") by Processes.process_name Processes.parent_process_name Processes.dest Processes.user | `drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `sc_exe_manipulating_windows_services_filter`",
            "tags": {
               "analytics_story": [
                  "Windows Service Abuse",
                  "DHS Report TA18-074A",
                  "Orangeworm Attack Group",
                  "Windows Persistence Techniques",
                  "Disabling Security Tools"
               ],
               "asset_type": "Endpoint",
               "cis20": [
                  "CIS 3",
                  "CIS 5",
                  "CIS 8"
               ],
               "kill_chain_phases": [
                  "Installation"
               ],
               "mitre_attack_groups": [
                  "Blue Mockingbird",
                  "DarkVishnya",
                  "Wizard Spider",
                  "APT32",
                  "APT41",
                  "Kimsuky",
                  "Tropic Trooper",
                  "Cobalt Group",
                  "Ke3chang",
                  "Honeybee",
                  "FIN7",
                  "Threat Group-3390",
                  "APT19",
                  "APT3",
                  "Lazarus Group",
                  "Carbanak"
               ],
               "mitre_attack_id": [
                  "T1543.003"
               ],
               "mitre_attack_tactics": [
                  "Persistence",
                  "Privilege Escalation"
               ],
               "mitre_attack_technique": [
                  "Windows Service"
               ],
               "nist": [
                  "PR.IP",
                  "PR.PT",
                  "PR.AC",
                  "PR.AT",
                  "DE.CM"
               ],
               "security_domain": "endpoint"
            },
            "type": "ESCU",
            "version": 4
         }
      ],
      "id": "6dbd810e-f66d-414b-8dfc-e46de55cbfe2",
      "name": "Windows Service Abuse",
      "narrative": "The Windows operating system uses a services architecture to allow for running code in the background, similar to a UNIX daemon. Attackers will often leverage Windows services for persistence, hiding in plain sight, seeking the ability to run privileged code that can interact with the kernel. In many cases, attackers will create a new service to host their malicious code. Attackers have also been observed modifying unnecessary or unused services to point to their own code, as opposed to what was intended. In these cases, attackers often use tools to create or modify services in ways that are not typical for most environments, providing opportunities for detection.",
      "references": [
         "https://attack.mitre.org/wiki/Technique/T1050",
         "https://attack.mitre.org/wiki/Technique/T1031"
      ],
      "tags": {
         "analytics_story": "Windows Service Abuse",
         "category": [
            "Malware"
         ],
         "mitre_attack_groups": [
            "Gamaredon Group",
            "Cobalt Group",
            "APT29",
            "APT41",
            "Leviathan",
            "Wizard Spider",
            "Turla",
            "Inception",
            "Kimsuky",
            "Putter Panda",
            "Gorgon Group",
            "BRONZE BUTLER",
            "Sharpshooter",
            "Molerats",
            "APT32",
            "Machete",
            "FIN10",
            "Dark Caracal",
            "FIN7",
            "APT19",
            "APT37",
            "Ke3chang",
            "Magic Hound",
            "MuddyWater",
            "Honeybee",
            "Threat Group-3390",
            "Lazarus Group",
            "RTM",
            "APT3",
            "Carbanak",
            "Darkhotel",
            "APT39",
            "Silence",
            "Dragonfly 2.0",
            "APT33",
            "Blue Mockingbird",
            "FIN6",
            "Rocke",
            "APT18",
            "Tropic Trooper",
            "Patchwork",
            "DarkVishnya"
         ],
         "mitre_attack_id": [
            "T1543.003",
            "T1569.002",
            "T1547.001"
         ],
         "mitre_attack_tactics": [
            "Execution",
            "Persistence",
            "Privilege Escalation"
         ],
         "mitre_attack_technique": [
            "Service Execution",
            "Registry Run Keys / Startup Folder",
            "Windows Service"
         ],
         "usecase": "Advanced Threat Detection"
      },
      "type": "ESCU",
      "version": 3
   }
]