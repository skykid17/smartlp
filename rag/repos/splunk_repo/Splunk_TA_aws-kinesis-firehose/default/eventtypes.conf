##
## SPDX-FileCopyrightText: 2020 Splunk, Inc. <sales@splunk.com>
## SPDX-License-Identifier: LicenseRef-Splunk-1-2020
##
##

[aws_cloudtrail_auth]
search = sourcetype="aws:cloudtrail" eventName="AssumeRole*" OR eventName="GetFederationToken" OR eventName="GetSessionToken" OR eventName="ConsoleLogin"
# Filtering based on the eventNames that have to do with authentication - AssumeRole*,GetFederationToken,GetSessionToken,ConsoleLogin

[aws_cloudtrail_consolelogin_auth]
search = sourcetype="aws:cloudtrail" (eventName="ConsoleLogin" additionalEventData.LoginTo=*)
# authentication

[aws_cloudtrail_auth_privileged]
search = sourcetype="aws:cloudtrail" (eventName="ConsoleLogin" AND (NOT additionalEventData.LoginTo=*))
# authentication privilege 
# Filtering for privileged authentication events

[aws_cloudtrail_assumeRole_auth]
search = sourcetype="aws:cloudtrail" (eventName="AssumeRole" OR eventName="AssumeRoleWithSAML" OR eventName="AssumeRoleWithWebIdentity") AND "userIdentity.type" != "AWSService"
# Filtering based on privilege escalation AssumeRole events, while while removing automated "bot" events. Ex.) CloudWatch Delivery,EC2,etc.

[aws_cloudtrail_multifactor_auth]
search = sourcetype="aws:cloudtrail" "additionalEventData.MFAUsed"="Yes"
# Filtering based on events with multifactor authentication

[aws_cloudtrail_endpoint_change]
search = sourcetype="aws:cloudtrail" eventName="DeleteEndpoint" OR eventName="CreatePlatformEndpoint" OR eventName="CreateVolume" OR eventName="DeleteVolume" OR eventName="AttachVolume" OR eventName="DetachVolume" OR eventName="DeleteBucket" OR eventName="CreateBucket" OR eventName="PutBucketPublicAccessBlock" OR eventName="PutObject"
#change
#endpoint

[aws_cloudtrail_change]
search = sourcetype="aws:cloudtrail" eventName="Create*" OR eventName IN ("ListRoles","ListAliases","PutBucketAcl" ,"GetBucketEncryption")
#change

[aws_cloudtrail_iam_change]
search = sourcetype="aws:cloudtrail" (eventSource=*iam*.amazonaws.com OR eventName=PutBucketAcl) eventName!=*get* AND eventName!=*list* AND eventName!=*describe*

[aws_cloudtrail_iam_change_acctmgmt]
search = sourcetype="aws:cloudtrail" (eventSource=*iam*.amazonaws.com) eventName!=*get* AND eventName!=*list* AND eventName!=*describe*
# change
# account
# management

[aws_cloudtrail_acctmgmt]
search = sourcetype="aws:cloudtrail"  eventName IN ("ListSigningCertificates","ListAccessKeys","ListAccountAliases","GetUser","GetAccountSummary") errorCode="*UnauthorizedOperation" OR errorCode="AccessDenied" OR errorCode="AuthFailure" OR errorCode="OperationNotPermitted" NOT (eventName="RunInstances" OR eventName="CreateVpc" OR eventName="CreateVolume" OR eventName="AllocateAddress")
# change
# account
# management

[aws_cloudtrail_delete_events]
search = sourcetype="aws:cloudtrail" *Delete* OR *Remove* OR *Reboot*
# change

[aws_cloudtrail_notable_network_events]
search = sourcetype="aws:cloudtrail" eventName!=Get* AND eventName!=List* AND eventName!=Describe* AND eventName!=PutBucketAcl AND (eventName="*address*" OR eventName="*gateway*" OR eventName="*acl*" OR eventName="*interface*" OR eventName="*security*" OR eventName="*route*" OR eventName="*subnet*" OR eventName="*vpc*")
# change
# network

[aws_cloudtrail_errors]
search = sourcetype="aws:cloudtrail" (errorCode="*" errorCode!="success")
# error

[aws_cloudtrail_ec2_events]
search = sourcetype="aws:cloudtrail" eventName="RunInstances" OR eventName="StartInstances" OR eventName="StopInstances" OR eventName="TerminateInstances" OR eventName="RebootInstances"

[aws_cloudtrail_instance]
search = sourcetype="aws:cloudtrail" object_category="instance"
# change
# instance


##################################
###        AWS Metadata        ###
##################################
# Eventtype definitions for ES A&I integration
[aws_metadata_iam_users]
search = sourcetype="aws:metadata" source="*:iam_users"

[aws_metadata_ec2_instances]
search = sourcetype="aws:metadata" source="*:ec2_instances"


##################################
###          VPC Flow          ###
##################################


[vpcflow]
search = sourcetype=aws:cloudwatchlogs:vpcflow AND (dest!="unknown" AND action!="unknown" AND app!="unknown" AND protocol!="unknown" AND src!="unknown")


##################################
###        Guard Duty          ###
##################################
[guard_duty_events]
search = index=* (sourcetype=aws:cloudwatch:guardduty)

[guard_duty_events_alert]
search = (sourcetype=aws:cloudwatch:guardduty AND severity_id < 8 AND subject!="UnauthorizedAccess:EC2/*")
# alerts

[guard_duty_events_ids]
search = (sourcetype=aws:cloudwatch:guardduty AND (severity_id >= 8 OR subject="UnauthorizedAccess:EC2/*"))
# ids


####################################
###         Security Hub         ###
####################################
[securityhub_events]
search = (sourcetype=aws:securityhub:finding)
# alerts