##
## SPDX-FileCopyrightText: 2024 Splunk, Inc.
## SPDX-License-Identifier: LicenseRef-Splunk-8-2021
##
##
[mysql:slowQueryLog]
pulldown_type = true
category = Database
description = Mysql Slow Query Logs
MAX_TIMESTAMP_LOOKAHEAD = 128
TIME_FORMAT = %s
TIME_PREFIX = timestamp=

# Change Event Breaking mechanism to improve the UF load balancing
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE = true
EVENT_BREAKER = ([\r\n]+)# Time
LINE_BREAKER = ([\r\n]+)# Time
PREAMBLE_REGEX = ^[\\/\w]+mysqld,\sVersion:|^Tcp\sport:|^Time\s

# search time field extraction
EXTRACT-userhost = # User@Host: (?<user>\w+)\[(?<userid>\w+)\] @ (?<hostname>\w+) \[(?<ip>.*)\]  Id:\s+(?<id>\d+)
REPORT-querytime = mysql_querytime
EXTRACT-sqlstatement = timestamp=\d+;(?<sql_query>[^\r]+;|.+)
FIELDALIAS-query = sql_query AS query
FIELDALIAS-duration = Query_time AS duration
FIELDALIAS-src = hostname AS src
EVAL-vendor_product = "Mysql Database Server"
KV_MODE = NONE

[mysql:slowQueryLogDb]
FIELDALIAS-dest = host AS dest
FIELDALIAS-object = db AS object
FIELDALIAS-query = sql_text AS query
FIELDALIAS-query_time = start_time AS query_time

EVAL-vendor_product = "Mysql Database Server"

[mysql:generalQueryLog]
pulldown_type = true
category = Database
description = Mysql General Query Logs

TRUNCATE = 0
PREAMBLE_REGEX = ^[\\/\w]+mysqld,\sVersion:|^Tcp\sport:|^Time\s

# Change Event Breaking mechanism to improve the UF load balancing
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE = true
EVENT_BREAKER = ([\r\n]+)\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{6}Z[\s\d]+(Query|Quit|Connect|Field|Init)
LINE_BREAKER = ([\r\n]+)\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{6}Z[\s\d]+(Query|Quit|Connect|Field|Init)

REPORT-generalquerylog = mysql_general_query_log
EXTRACT-login_failure = Connect\s+Access denied for user '?(?<user>[^@\s]+?)'?@\'?(?<client_host>[^\s']+)\'?
EXTRACT-login_success = Connect\s+(?<user>[^@\s]+)@(?<client_host>\S+)\son\s+using Socket
EVAL-action = case((Command="Connect" AND like(Argument,"%Access denied for user%")), "failure", (Command="Connect" AND like(Argument,"%on  using Socket%")), "success")
EVAL-Id = case(isint(Id), Id)
MAX_TIMESTAMP_LOOKAHEAD = 128

[mysql:generalQueryLogDb]
#For ITSI
EVAL-query = case(command_type=="Query",argument)
EXTRACT-argument_preprocess = argument="(?:\/\*.*?\*\/)*(?<argument>[^"]*)"
EVAL-query_type = if(NOT lower(trim(mvindex(split(argument," "),0),"*@/"))=="" AND command_type=="Query",lower(trim(mvindex(split(argument," "),0),"*@/")),null)
EXTRACT-query_user = (?<query_user>\w+)(?:\[\w*\])?\s@\s+\[(?<query_client_host>\S+)\]
EVAL-database_instance = hostname+":"+port
EXTRACT-login_user = argument="(?<login_user>[^@\s]+)@(?<login_client_host>\S+)
EVAL-user = case(isnotnull(login_user), login_user, isnotnull(query_user), query_user)
EVAL-client_host = case(isnotnull(login_client_host), login_client_host, isnotnull(query_client_host), query_client_host)
EVAL-action = case((command_type="Connect" AND like(argument,"%Access denied for user%")),"failure", (command_type="Connect" AND NOT like(argument,"%Access denied for user%")),"success")

[mysql:errorLog]
pulldown_type = true
category = Database
description = Mysql Error Query Logs

# Change Event Breaking mechanism to improve the UF load balancing
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE = true
EVENT_BREAKER = ([\r\n]+)(?:=+[\r\n]+)?\d{4}
LINE_BREAKER = ([\r\n]+)(?:=+[\r\n]+)?\d{4}

TRANSFORMS-status = mysql_status,mysql_status_remove_empty
EXTRACT-errorlogs = ^[\d-]+T+[\d:]+\.[\d:]+Z\s+(?<pid>\d+)\s+\[(?<level>\w+)\]\s+(?<message>.*)
EXTRACT-login_failed = (?<vendor_action>Access\s*denied)\s*for\s*user\s*'(?<user>[^']+)'@'(?<client_host>[^']+)'
EVAL-action = case(vendor_action == "Access denied", "failure")
MAX_TIMESTAMP_LOOKAHEAD = 128

[mysql:database]
FIELDALIAS-cim_builder = host AS dest
FIELDALIAS-object = Database AS object
EVAL-vendor_product = "Mysql Database Server"

[mysql:databaseProcess]
EVAL-src = replace(Host, "(^.*(?=:)).*", "\1")
FIELDALIAS-dest = host AS dest
FIELDALIAS-object = db AS object
FIELDALIAS-user = User AS user
EVAL-vendor_product = "Mysql Database Server"

[mysql:processInfo]
FIELDALIAS-dest = host AS dest
FIELDALIAS-object = db AS object
FIELDALIAS-field_user = user AS field_user
EVAL-src = mvindex(split(user, "@"), 1)
EVAL-user = mvindex(split(user, "@"), 0)
EVAL-vendor_product = "Mysql Database Server"

[mysql:status]
EVAL-uptime = case(VARIABLE_NAME == "Uptime", VARIABLE_VALUE)
FIELDALIAS-dest =  host as dest

[mysql:user]
EVAL-user_name = user+"@"+user_host
EVAL-database_instance = hostname+":"+port

# for ITSI
[mysql:variables]
FIELDALIAS-VARIABLE_NAME = VARIABLE_NAME as Variable_name
FIELDALIAS-VARIABLE_VALUE = VARIABLE_VALUE as Value
EVAL-storage_engine = case(VARIABLE_NAME=="default_storage_engine" OR VARIABLE_NAME=="DEFAULT_STORAGE_ENGINE",VARIABLE_VALUE)
EVAL-character_set = case(VARIABLE_NAME=="CHARACTER_SET_DATABASE" OR VARIABLE_NAME=="character_set_database",VARIABLE_VALUE)
EVAL-collation= case(VARIABLE_NAME=="collation_database" OR VARIABLE_NAME=="COLLATION_DATABASE",VARIABLE_VALUE)
EVAL-version = case(VARIABLE_NAME=="version" OR VARIABLE_NAME=="VERSION",VARIABLE_VALUE)
EVAL-database_instance = hostname+":"+port
EVAL-vendor = "Oracle"
EVAL-vendor_product = "Mysql Database Server"
EVAL-instance_role  = "database_instance"

[mysql:tableStatus]
FIELDALIAS-database_name = TABLE_SCHEMA as database_name
FIELDALIAS-table_name = TABLE_NAME as table_name
FIELDALIAS-rows = TABLE_ROWS as row_count
EVAL-size = DATA_LENGTH/1024/1024
EVAL-last_update_time = if(UPDATE_TIME !="", UPDATE_TIME , CREATE_TIME)
EVAL-database_instance = hostname+":"+port

[mysql:instance:stats]
EVAL-current_size = tonumber(database_size)
EVAL-database_instance = hostname+":"+port
FIELDALIAS-instance_read_iops = Reads_Per_Second as instance_read_iops
FIELDALIAS-instance_write_iops = Writes_Per_Second as instance_write_iops
FIELDALIAS-deadlock_rate = Deadlocks_Per_Second as deadlock_rate
FIELDALIAS-error_rate = Errors_Per_Second as error_rate

[mysql:transaction:stats]
EVAL-database_instance = hostname+":"+port
FIELDALIAS-transaction_rate = Transactions_Per_Second as transaction_rate
FIELDALIAS-active_transactions = active_trx_count as active_transactions

[mysql:connection:stats]
EVAL-database_instance = hostname+":"+port

[mysql:innodbStatus]
MAX_TIMESTAMP_LOOKAHEAD = 128

FIELDALIAS-cim_builder = writes_per_sec AS write_ops reads_per_sec AS read_ops
EXTRACT-avg_period = Per second averages calculated from the last (?<avg_period>[\.\d]+) seconds

# BACKGROUND THREAD
EXTRACT-srv_active_loops = (?<srv_active_loops>[\.\d]+) srv_active
EXTRACT-srv_shutdown_loops = (?<srv_shutdown_loops>[\.\d]+) srv_shutdown
EXTRACT-srv_idle_loops = (?<srv_idle_loops>[\.\d]+) srv_idle
EXTRACT-srv_log_flush_and_write_loops = srv_master_thread log flush and writes: (?<srv_log_flush_and_write_loops>[\.\d]+)

# SEMAPHORES
EXTRACT-os_wait_reservation_count = OS WAIT ARRAY INFO: reservation count (?<os_wait_reservation_count>[\.\d]+)
EXTRACT-os_wait_signal_count = OS WAIT ARRAY INFO: signal count (?<os_wait_signal_count>[\.\d]+)
# EXTRACT-mutex_spin = Mutex spin waits (?<mutex_spin>[\.\d]+), rounds (?<mutex_round>[\.\d]+), OS waits (?<mutex_os_wait>[\.\d]+) # Its not showing this info anymore
EXTRACT-rw_shared_spin = RW-shared spins (?<rw_shared_spin>[\.\d]+), rounds (?<rw_shared_round>[\.\d]+), OS waits (?<rw_shared_os_wait>[\.\d]+)
EXTRACT-rw_excl_spin = RW-excl spins (?<rw_excl_spin>[\.\d]+), rounds (?<rw_excl_round>[\.\d]+), OS waits (?<rw_excl_os_wait>[\.\d]+)
EXTRACT-rw_sx_spin = RW-sx spins (?<rw_sx_spin>[\.\d]+), rounds (?<rw_sx_round>[\.\d]+), OS waits (?<rw_sx_os_wait>[\.\d]+)
EXTRACT-Spin_rounds_per_wait = Spin rounds per wait: (?<rw_shared_spin_rounds_per_wait>[\.\d]+) RW-shared, (?<rw_excl_spin_rounds_per_wait>[\.\d]+) RW-excl, (?<rw_sx_spin_rounds_per_wait>[\.\d]+) RW-sx

# TRANSACTIONS
EXTRACT-transactions_trx_id_counter = Trx id counter (?<transactions_trx_id_counter>[\.\d]+)
EXTRACT-transactions_history_list_length = History list length (?<transactions_history_list_length>[\.\d]+)

# FILE I/O
# EXTRACT-pending_normal_aio_reads = Pending normal aio reads: (?<pending_normal_aio_reads>[\.\d]+) # There is a bug in mysql that not allow us to extract it anymore https://bugs.mysql.com/bug.php?id=94441
# EXTRACT-pending_aio_writes = aio writes: (?<pending_aio_writes>[\.\d]+) # There is a bug in mysql that not allow us to extract it anymore https://bugs.mysql.com/bug.php?id=94441
# EXTRACT-pending_ibuf_aio_reads = ibuf aio reads: (?<pending_ibuf_aio_reads>[\.\d]+) # There is a bug in mysql that not allow us to extract it anymore https://bugs.mysql.com/bug.php?id=94441
# EXTRACT-pending_log_ios = log i/o's: (?<pending_log_ios>[\.\d]+) # There is a bug in mysql that not allow us to extract it anymore https://bugs.mysql.com/bug.php?id=94441
# EXTRACT-pending_sync_ios = sync i/o's: (?<pending_sync_ios>[\.\d]+) # There is a bug in mysql that not allow us to extract it anymore https://bugs.mysql.com/bug.php?id=94441
EXTRACT-pending_flushes = Pending flushes \(fsync\) log: (?<pending_log_flushes>[\.\d]+); buffer pool: (?<pending_buffer_pool_flushes>[\.\d]+)
EXTRACT-os_file_reads = (?<os_file_reads>[\.\d]+) OS file reads
EXTRACT-os_file_writes = (?<os_file_writes>[\.\d]+) OS file writes
EXTRACT-os_file_fsyncs = (?<os_file_fsyncs>[\.\d]+) OS fsyncs
EXTRACT-reads_per_sec = (?<reads_per_sec>[\.\d]+) reads/s
EXTRACT-bytes_per_read = (?<bytes_per_read>[\.\d]+) avg bytes/read
EXTRACT-writes_per_sec = (?<writes_per_sec>[\.\d]+) writes/s
EXTRACT-fsyncs_per_sec = (?<fsyncs_per_sec>[\.\d]+) fsyncs/s

# INSERT BUFFER AND ADAPTIVE HASH INDEX
EXTRACT-ibuf_size = Ibuf: size (?<ibuf_size>[\.\d]+)
EXTRACT-ibuf_free_list_len = free list len (?<ibuf_free_list_len>[\.\d]+)
EXTRACT-ibuf_seg_size = seg size (?<ibuf_seg_size>[\.\d]+)
EXTRACT-ibuf_merges = (?<ibuf_merges>[\.\d]+) merges
EXTRACT-merged_operations = merged operations:[\r\n]+\s*insert (?<merged_insert_ops>[\.\d]+), delete mark (?<merged_delete_mark_ops>[\.\d]+), delete (?<merged_delete_ops>[\.\d]+)
EXTRACT-discarded_operations = discarded operations:[\r\n]+\s*insert (?<discarded_insert_ops>[\.\d]+), delete mark (?<discarded_delete_mark_ops>[\.\d]+), delete (?<discarded_delete_ops>[\.\d]+)
EXTRACT-hash_table_size = Hash table size (?<hash_table_size>[\.\d]+)
EXTRACT-node_heap_buffers = node heap has (?<node_heap_buffers>[\.\d]+) buffer\(s\)
EXTRACT-hash_searches_per_sec = (?<hash_searches_per_sec>[\.\d]+) hash searches/s
EXTRACT-non_hash_searches_per_sec = (?<non_hash_searches_per_sec>[\.\d]+) non-hash searches/s

# LOG
EXTRACT-log_sequence_number = Log sequence number\s*(?<log_sequence_number>[\.\d]+)
EXTRACT-log_flushed_up_to = Log flushed up to\s*(?<log_flushed_up_to>[\.\d]+)
EXTRACT-pages_flushed_up_to = Pages flushed up to\s*(?<pages_flushed_up_to>[\.\d]+)
EXTRACT-last_checkpoint = Last checkpoint at\s*(?<last_checkpoint>[\.\d]+)
# EXTRACT-pending_log_writes = (?<pending_log_writes>[\.\d]+) pending log writes # Its not showing this info anymore
EXTRACT-pending_chkp_writes = (?<pending_chkp_writes>[\.\d]+) pending chkp writes
EXTRACT-log_ios_done = (?<log_ios_done>[\.\d]+) log i/o's done
EXTRACT-log_ios_per_sec = (?<log_ios_per_sec>[\.\d]+) log i/o's/second

# BUFFER POOL AND MEMORY
EXTRACT-total_memory_allocated = Total large memory allocated (?<total_memory_allocated>[\.\d]+)
# EXTRACT-total_memory_in_additional_pool = in additional pool allocated (?<total_memory_in_additional_pool>[\.\d]+) # Its not showing this info anymore
EXTRACT-total_dictionary_memory = Dictionary memory allocated (?<total_dictionary_memory>[\.\d]+)
EXTRACT-buffer_pool_size = Buffer pool size\s*(?<buffer_pool_size>[\.\d]+)
EXTRACT-free_buffers = Free buffers\s*(?<free_buffers>[\.\d]+)
EXTRACT-db_pages = Database pages\s*(?<db_pages>[\.\d]+)
EXTRACT-old_db_pages = Old database pages (?<old_db_pages>[\.\d]+)
EXTRACT-modified_db_pages = Modified db pages\s*(?<modified_db_pages>[\.\d]+)
EXTRACT-pending_reads = Pending reads\s+(?<pending_reads>[\.\d]+)
EXTRACT-pending_writes = Pending writes: LRU (?<pending_LRU_writes>[\.\d]+), flush list (?<pending_flush_list_writes>[\.\d]+), single page (?<pending_single_page_writes>[\.\d]+)
EXTRACT-pages_made_young = Pages made young (?<pages_made_young>[\.\d]+), not young (?<pages_made_not_young>[\.\d]+)
EXTRACT-pages_made_young_per_sec = (?<pages_made_young_per_sec>[\.\d]+) youngs/s, (?<pages_made_not_young_per_sec>[\.\d]+) non-youngs/s
EXTRACT-pages_rcw = Pages read (?<pages_read>[\.\d]+), created (?<pages_created>[\.\d]+), written (?<pages_written>[\.\d]+)
EXTRACT-pages_read_per_sec = (?<page_reads_per_sec>[\.\d]+) reads/s, (?<page_creates_per_sec>[\.\d]+) creates/s, (?<page_writes_per_sec>[\.\d]+) writes/s
EXTRACT-pages_read_ahead_per_sec = Pages read ahead (?<pages_read_ahead_per_sec>[\.\d]+)/s
EXTRACT-evicted_without_access_per_sec = evicted without access (?<evicted_without_access_per_sec>[\.\d]+)/s
EXTRACT-random_read_ahead_per_sec = Random read ahead (?<random_read_ahead_per_sec>[\.\d]+)/s
EXTRACT-LRU_len = LRU len: (?<LRU_len>[\.\d]+)
EXTRACT-unzip_LRU_len = unzip_LRU len: (?<unzip_LRU_len>[\.\d]+)
EXTRACT-io_sum_cur = I/O sum\[(?<io_sum>[\.\d]+)\]:cur\[(?<io_cur>[\.\d]+)\]
EXTRACT-unzip_sum_cur = unzip sum\[(?<unzip_sum>[\.\d]+)\]:cur\[(?<unzip_cur>[\.\d]+)\]

# ROW OPERATIONS
EXTRACT-queries_in_innodb = (?<queries_in_innodb>[\.\d]+) queries inside InnoDB
EXTRACT-queries_in_queue = (?<queries_in_queue>[\.\d]+) queries\sin\squeue
EXTRACT-views_open_in_innodb = (?<views_open_in_innodb>[\.\d]+) read views open inside InnoDB
EXTRACT-main_thread = Process ID=(?<main_thread_pid>[\.\d]+), Main thread ID=(?<main_thread_id>[\.\d]+)( )?, state((: )?(=)?)(?<main_thread_state>\w+)
EXTRACT-rows_operated = Number of rows inserted (?<rows_inserted>[\.\d]+), updated (?<rows_updated>[\.\d]+), deleted (?<rows_deleted>[\.\d]+), read (?<rows_read>[\.\d]+)
EXTRACT-ops_per_sec = (?<inserts_per_sec>[\.\d]+) inserts/s, (?<updates_per_sec>[\.\d]+) updates/s, (?<deletes_per_sec>[\.\d]+) deletes/s, (?<reads_per_sec>[\.\d]+) reads/s

[mysql:innodbLockWaits]
FIELDALIAS-cim_builder = locked_table AS obj_name, host AS dest
EVAL-vendor_product = "Mysql Database Server"

[mysql:audit]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\[,][\r\n]+)\s*{
KV_MODE = json

REPORT-object_for_db = object_for_db
REPORT-object_for_tablespace = object_for_tablespace
REPORT-object_for_user = object_for_user
REPORT-tablespace_name = tablespace_name

FIELDALIAS-user = login.user AS user
FIELDALIAS-query = general_data.query AS query
FIELDALIAS-query_time = query_statistics.query_time AS query_time
FIELDALIAS-records_affected = query_statistics.rows_examined AS records_affected

EVAL-dest = if(coalesce('account.host', "") != "" AND 'account.host' != "null", 'account.host', null())
EVAL-object = case(class="table_access" AND event IN ("insert","read","delete","update"), 'table_access_data.db', class="connection" AND event="connect",'connection_data.db',true(), object)
EVAL-user = case(class=="general" AND 'general_data.sql_command' IN ("drop_user", "alter_user", "create_user"), 'login.user', class=="audit" AND event="startup", 'account.user',true(), user)
EVAL-vendor_product = "Mysql Database Server"
EVAL-tablespace_status = case(class=="general" AND 'general_data.sql_command'=="alter_tablespace", 'general_data.status')
EVAL-action = case(class=="general" AND 'general_data.sql_command'=="drop_user", "deleted", class=="general" AND 'general_data.sql_command'=="alter_user", "modified", class=="general" AND 'general_data.sql_command'=="create_user", "created")
EVAL-change_type = case(class=="general" AND 'general_data.sql_command' IN ("drop_user", "alter_user", "create_user"), "AAA")
EVAL-command = case(class=="general" AND 'general_data.sql_command' IN ("drop_user", "alter_user", "create_user"), 'general_data.sql_command')
EVAL-dvc = case(class=="general" AND 'general_data.sql_command' IN ("drop_user", "alter_user", "create_user"), 'account.host')
EVAL-object_category = case(class=="general" AND 'general_data.sql_command' IN ("drop_user","alter_user","create_user"), "user")
EVAL-object_attrs = case(class=="general" AND 'general_data.sql_command' IN ("drop_user","alter_user","create_user"), "user")
EVAL-object_id = case(class=="general" AND 'general_data.sql_command' IN ("drop_user","alter_user","create_user"), object)
EVAL-user_name = case(class=="general" AND 'general_data.sql_command' IN ("drop_user", "alter_user", "create_user"), user)
EVAL-status = case(class=="general" AND 'general_data.sql_command' IN ("drop_user", "alter_user","create_user") AND 'general_data.status'==0, "success", class=="general" AND 'general_data.sql_command' IN ("drop_user", "alter_user", "create_user") AND 'general_data.status'!=0, "failure")
EVAL-src = if(coalesce('login.ip', "") != "" AND 'login.ip' != "null", 'login.ip', null())
EVAL-src_user = case(class=="general" AND 'general_data.sql_command' IN ("drop_user", "alter_user", "create_user"), 'account.user')
EVAL-src_user_name = case(class=="general" AND 'general_data.sql_command' IN ("drop_user", "alter_user", "create_user"), 'account.user')
EVAL-result_id = case('general_data.status'!=0, 'general_data.status')

LOOKUP-mysql_audit_error_lookup = mysql_audit_error_lookup "Error number" AS general_data.status OUTPUT Symbol AS result
